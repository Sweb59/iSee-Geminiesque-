<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Assistant R√©fraction - iSee Logic</title>
<style>
  /* --- CHARTE GRAPHIQUE ISEE --- */
  :root { 
      --bg-main: #F4F6F8;        
      --primary: #00B4D8;        /* CYAN VIF */
      --primary-dark: #0096B4;   
      --primary-light: #E0F7FA;  
      --text-main: #37474F;      
      --text-muted: #90A4AE;     
      --panel: #FFFFFF;          
      --border: #CFD8DC;
      --accent: #0077B6;         
      --success: #28a745;
      --danger: #D32F2F;
  }

  /* RESET & BASE */
  * { box-sizing: border-box; }
  body { 
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
      background-color: var(--bg-main); 
      color: var(--text-main); 
      margin: 0; padding: 0;
      height: 100vh; overflow: hidden; font-size: 14px;
  }

  .app-container { display: flex; flex-direction: column; height: 100%; max-width: 1600px; margin: 0 auto; padding: 15px; }

  header { 
      flex: 0 0 auto; margin-bottom: 10px; border-bottom: 3px solid var(--primary); padding-bottom: 10px;
      display: flex; align-items: center; justify-content: space-between;
  }
  h1 { margin: 0; color: var(--text-main); font-size: 1.4rem; font-weight: 800; text-transform: uppercase; }

  .dashboard-wrapper { display: flex; flex: 1; gap: 20px; overflow: hidden; }

  /* PANNEAUX */
  .left-panel { flex: 0 0 320px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 5px; }
  .right-panel { flex: 1; background: var(--panel); border-radius: 20px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0, 180, 216, 0.05); position: relative; }
  .section { background: var(--panel); border-radius: 16px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid white; }
  
  .hidden { display: none !important; }

  /* GRILLE ISEE */
  .isee-grid-container {
      display: grid;
      grid-template-columns: 70px 70px 1fr 60px 1fr 70px 70px; 
      gap: 10px 15px; align-items: center; margin-top: 10px;
  }
  .col-header { text-align: center; font-weight: 700; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; }
  .header-subj { color: var(--primary); font-size: 1rem; }

  .isee-input {
      width: 100%; padding: 10px 5px; text-align: center; font-family: 'Roboto Mono', monospace;
      font-size: 1.2rem; font-weight: 600; color: var(--text-muted); background: #FFFFFF;
      border: 2px solid #E0E0E0; border-radius: 12px;
  }
  .isee-input-subj {
      font-size: 2.2rem; padding: 15px 0; color: var(--text-main);
      border: 3px solid var(--primary); background: #FFFFFF;
      box-shadow: 0 4px 15px rgba(0, 180, 216, 0.1);
  }
  .isee-input-ro { background: #F9FAFB; border-color: transparent; font-size: 1rem; color: #B0BEC5; }

  /* LOGIQUE VISUELLE OEUIL ACTIF */
  .active-eye-col input { background: #FFF; border-color: var(--primary); color: var(--text-main); opacity: 1; }
  .inactive-eye-col input { background: #F0F2F5; border-color: #E0E0E0; color: #CFD8DC; box-shadow: none; pointer-events: none; opacity: 0.6; }

  .center-pill {
      width: 40px; height: 40px; background: var(--text-main); color: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; margin: 0 auto;
  }

  /* INFO BAR */
  .info-bar { 
      text-align: center; font-size: 1.1rem; color: var(--text-muted); 
      background: var(--primary-light); padding: 10px 30px; border-radius: 8px; margin-bottom: 20px; display: inline-block;
  }
  .letter-display { 
      font-family: 'Segoe UI', sans-serif; font-size: 4rem; font-weight: 800; text-align: center; color: var(--text-main); 
      min-height: 90px; margin: 10px 0; letter-spacing: 5px;
  }

  /* BOUTONS */
  .btn-grid { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
  .btn-resp { 
      width: 60px; height: 60px; border-radius: 12px; border: 2px solid transparent; background: white; 
      color: var(--text-main); font-size: 1.5rem; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer;
  }
  .btn-resp:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-3px); }
  
  .locked { opacity: 0.5; pointer-events: none; }

  .btn-action { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; color: white; margin-top: 5px; }
  .btn-start { background: var(--primary); }
  .btn-manual { background: var(--text-muted); }
  .btn-import { background: var(--text-main); }
  
  .btn-tortue, .btn-lapin { background: var(--primary-light); color: var(--primary-dark); border: 2px solid var(--primary-border); font-size: 1.3rem; padding: 15px 40px; border-radius: 8px; cursor: pointer; }
  .btn-tortue:hover, .btn-lapin:hover { background: var(--primary); color: white; }

  .exam-controls { display: flex; gap: 20px; justify-content: center; margin: 20px 0; }
  .eye-btn { padding: 12px 30px; background: white; border: 2px solid #E0E0E0; border-radius: 50px; color: var(--text-muted); font-weight: 700; cursor: pointer; min-width: 140px; }
  .eye-btn.active { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-2px); }

  /* CONFIG GAUCHE */
  .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  label { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
  select, input { width: 100%; padding: 10px; border: 2px solid #E0E0E0; border-radius: 8px; background: white; }
  
  .check-grid { display:grid; grid-template-columns: 1fr 1fr; gap:5px; text-align: left; }
  .check-lbl { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; padding: 5px; cursor: pointer; }

  /* MODALES */
  .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(55,71,79, 0.9); z-index: 999; display: flex; align-items: center; justify-content: center; }
  .modal-content { background: white; padding: 30px; border-radius: 20px; width: 500px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
  
  /* CHECK PLUS */
  .btn-timer { background: var(--accent); color: white; padding: 15px 40px; border-radius: 50px; border: none; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: block; margin: 0 auto; }
  .decision-row { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
  .btn-decision { padding: 12px 25px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; }
  .btn-blue { background: var(--primary); } .btn-red { background: #EF5350; } .btn-orange { background: #FFA726; } .btn-grey { background: #B0BEC5; }

  /* AXE */
  .jcc-visual { width: 100px; height: 100px; border-radius: 50%; border: 6px solid #CFD8DC; display: flex; align-items: center; justify-content: center; opacity: 0.3; }
  .jcc-visual.active { opacity: 1; border-color: var(--primary); transform: scale(1.1); box-shadow: 0 0 20px var(--primary-border); }
  .jcc-label { font-weight: bold; font-size: 1.8rem; color: var(--text-main); }
</style>
</head>
<body onload="window.startAppSequence()">

<div id="modalPatientID" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Identification</h2>
        <div class="config-grid" style="text-align:left; margin: 20px 0;">
            <div><label>Nom</label><input type="text" id="inName"></div>
            <div><label>Pr√©nom</label><input type="text" id="inForename"></div>
            <div><label>Date Naiss.</label><input type="date" id="inDob"></div>
            <div><label>UID</label><input type="text" id="inUID" readonly style="background:#F0F2F5;"></div>
        </div>
        <button class="btn-action btn-start" onclick="window.validatePatientID()">VALIDER</button>
    </div>
</div>

<div id="modalProfileCalc" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Profil</h2>
        <div class="config-grid" style="text-align:left; margin-bottom:15px;">
            <div><label>Rythme</label><select id="inRhythm"><option value="0">...</option><option value="1">1x/an</option><option value="2">1x/2ans</option><option value="3">< 1x/2ans</option></select></div>
            <div><label>Plaintes</label><select id="inSigns"><option value="0">0</option><option value="2">3-4</option><option value="3">> 4</option></select></div>
        </div>
        <div class="check-grid">
            <label class="check-lbl"><input type="checkbox" id="chkMyopia" onchange="window.toggleMyopiaHyper('myopia')"> Myopie > 3</label>
            <label class="check-lbl"><input type="checkbox" id="chkHyper" onchange="window.toggleMyopiaHyper('hyper')"> Hyper < 1</label>
            <label class="check-lbl"><input type="checkbox" id="chkNear"> VP Intense</label>
            <label class="check-lbl"><input type="checkbox" id="chkNoSpecs"> Pas de lunettes</label>
            <label class="check-lbl"><input type="checkbox" id="chkMono"> Monophtalme</label>
        </div>
        <button class="btn-action btn-start" onclick="window.calculateProfileAndShowData()">CALCULER LE PROFIL</button>
        <div style="margin-top:10px; font-size:0.8rem; color:#999;">Ou forcer :</div>
        <div style="display:flex; gap:5px; justify-content:center; margin-top:5px;">
            <button onclick="window.forceProfileAndShowData('1')" style="padding:5px 10px; background:#26A69A; color:white; border:none; border-radius:4px; cursor:pointer;">1</button>
            <button onclick="window.forceProfileAndShowData('2')" style="padding:5px 10px; background:#42A5F5; color:white; border:none; border-radius:4px; cursor:pointer;">2</button>
            <button onclick="window.forceProfileAndShowData('3')" style="padding:5px 10px; background:#FFA726; color:white; border:none; border-radius:4px; cursor:pointer;">3</button>
            <button onclick="window.forceProfileAndShowData('3+')" style="padding:5px 10px; background:#EF5350; color:white; border:none; border-radius:4px; cursor:pointer;">3+</button>
        </div>
    </div>
</div>

<div id="modalEntryMethod" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Donn√©es Initiales</h2>
        <p style="color:#777; margin-bottom:20px;">Source des donn√©es ?</p>
        <div style="display:flex; gap:10px;">
            <button class="btn-action btn-manual" onclick="window.handleMethodChoice('manual')">MANUEL</button>
            <button class="btn-action btn-import" onclick="window.handleMethodChoice('import')">IMPORT</button>
        </div>
    </div>
</div>

<div id="modalInputData" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Saisie</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:15px; text-align:left;">
            <div style="grid-column:1/-1; text-align:center; color:var(--primary); font-weight:bold;">OD</div>
            <div><label>Sph</label><input type="text" id="mod_raOD_sph" class="isee-input"></div>
            <div><label>Cyl</label><input type="text" id="mod_raOD_cyl" class="isee-input" onchange="window.forceNegativeCyl(this)"></div>
            <div><label>Axe</label><input type="text" id="mod_raOD_axe" class="isee-input" onchange="window.checkAxis(this)"></div>
            <div style="grid-column:1/-1; text-align:center; color:var(--primary); font-weight:bold; margin-top:10px;">OG</div>
            <div><label>Sph</label><input type="text" id="mod_raOG_sph" class="isee-input"></div>
            <div><label>Cyl</label><input type="text" id="mod_raOG_cyl" class="isee-input" onchange="window.forceNegativeCyl(this)"></div>
            <div><label>Axe</label><input type="text" id="mod_raOG_axe" class="isee-input" onchange="window.checkAxis(this)"></div>
        </div>
        <button class="btn-action btn-start" onclick="window.confirmDataAndPosition()">VALIDER</button>
    </div>
</div>

<div id="modalAskAxis" class="modal-overlay hidden">
    <div class="modal-content" style="border-top: 5px solid #FFA726;">
        <h2 style="color:#EF6C00;">Axe Manquant</h2>
        <p>Axe du cylindre positif requis :</p>
        <input type="number" id="inputTranspAxis" style="font-size:1.5rem; padding:10px; width:100px; text-align:center; border:2px solid #FFA726; border-radius:8px; display:block; margin:10px auto;">
        <div style="display:flex; gap:15px; justify-content:center; margin-top:20px;">
            <button class="btn-action btn-manual" style="width:auto;" onclick="document.getElementById('modalAskAxis').classList.add('hidden')">Annuler</button>
            <button class="btn-action btn-start" style="width:auto; background:#EF6C00;" onclick="window.validateTranspositionAxis()">OK</button>
        </div>
    </div>
</div>

<div id="modalPosition" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Installation</h2>
        <p style="font-size:1.1rem; line-height:1.6; color:#555;">Installez le patient (Front/Menton).</p>
        <button class="btn-action btn-start" onclick="window.startRulesAndIntro()">R√àGLES DE LECTURE</button>
    </div>
</div>

<div id="modalIntroConfirmation" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Pr√™t ?</h2>
        <button class="btn-action btn-start" onclick="window.confirmAndLaunch()">LANCER</button>
    </div>
</div>

<div id="modalDefogLimit" class="modal-overlay hidden"><div class="modal-content"><h2 style="color:#D32F2F;">Plafond Atteint</h2><p>Le d√©brouillage n'aide plus.</p><div style="display:flex; gap:10px; margin-top:10px;"><button class="btn-action btn-manual" onclick="window.restartExam()">Recommencer</button><button class="btn-action btn-start" style="background:#D32F2F;" onclick="window.prepareCycloStop()">Stop (Cyclo)</button></div></div></div>
<div id="modalTqsLimit" class="modal-overlay hidden"><div class="modal-content"><h2 style="color:#D32F2F;">√âchec T.Q.S</h2><p>Trop d'accommodation.</p><button class="btn-action btn-manual" onclick="window.restartExam()">Recommencer</button></div></div>
<div id="modalIncoherent" class="modal-overlay hidden"><div class="modal-content"><h2 style="color:#D32F2F;">Incoh√©rence</h2><p>R√©ponses contradictoires.</p><button class="btn-action btn-start" onclick="window.restartSb10()">Refaire cette √©tape</button></div></div>
<div id="modalWarning" class="modal-overlay hidden"><div class="modal-content"><h2>Hors Limites</h2><button class="btn-action btn-start" onclick="document.getElementById('modalWarning').classList.add('hidden')">OK</button></div></div>


<div class="app-container">
  <header>
      <h1>R√©fraction Assist√©e</h1>
      <div id="patientSummaryContent" style="display:flex; gap:15px; font-size:0.9rem; color:var(--text-muted);"><span>En attente...</span></div>
  </header>

  <div class="dashboard-wrapper">
      <div class="left-panel">
          <div class="section">
              <h2>Patient</h2>
              <button class="btn-action btn-manual" onclick="location.reload()">NOUVEAU</button>
          </div>
          <div class="section" style="flex:1;">
              <h2>Notes</h2>
              <textarea style="width:100%; height:100%; border:none; resize:none; background:transparent;" placeholder="Saisir notes..."></textarea>
          </div>
      </div>

      <div class="right-panel">
          <div id="waitingMsg" style="text-align:center; color:#B0BEC5; margin-top:50px;">
              <p style="font-size:1.2rem;">En attente de configuration...</p>
          </div>

          <div id="examContent" class="hidden" style="width:100%; display:flex; flex-direction:column; height:100%;">
              
              <div class="exam-controls">
                  <button id="btnOD" class="eye-btn active" onclick="window.setEye('OD')">OD</button>
                  <button id="btnOG" class="eye-btn" onclick="window.setEye('OG')">OG</button>
              </div>

              <div class="isee-grid-container">
                  <div class="col-header">AR</div> <div class="col-header">Lun</div> <div class="col-header header-subj">OD (Subj)</div> <div class="col-header"></div> <div class="col-header header-subj">OG (Subj)</div> <div class="col-header">Lun</div> <div class="col-header">AR</div>

                  <input type="hidden" id="raOD_sph"> <input type="hidden" id="raOD_cyl"> <input type="hidden" id="raOD_axe">
                  <input type="hidden" id="raOG_sph"> <input type="hidden" id="raOG_cyl"> <input type="hidden" id="raOG_axe">

                  <div><input id="disp_raOD_sph" class="isee-input isee-input-ro" readonly></div>
                  <div><input class="isee-input isee-input-ro" readonly value="+0.00"></div>
                  <div id="colSubjOD"><input id="subjOD_sph" class="isee-input isee-input-subj" readonly></div>
                  <div class="center-pill">S</div>
                  <div id="colSubjOG"><input id="subjOG_sph" class="isee-input isee-input-subj" readonly></div>
                  <div><input class="isee-input isee-input-ro" readonly value="+0.00"></div>
                  <div><input id="disp_raOG_sph" class="isee-input isee-input-ro" readonly></div>

                  <div><input id="disp_raOD_cyl" class="isee-input isee-input-ro" readonly></div>
                  <div><input class="isee-input isee-input-ro" readonly value="0.00"></div>
                  <div id="colCylOD"><input id="subjOD_cyl" class="isee-input isee-input-subj" readonly></div>
                  <div class="center-pill">C</div>
                  <div id="colCylOG"><input id="subjOG_cyl" class="isee-input isee-input-subj" readonly></div>
                  <div><input class="isee-input isee-input-ro" readonly value="0.00"></div>
                  <div><input id="disp_raOG_cyl" class="isee-input isee-input-ro" readonly></div>

                  <div><input id="disp_raOD_axe" class="isee-input isee-input-ro" readonly></div>
                  <div><input class="isee-input isee-input-ro" readonly value="0"></div>
                  <div id="colAxeOD"><input id="subjOD_axe" class="isee-input isee-input-subj" readonly></div>
                  <div class="center-pill">A</div>
                  <div id="colAxeOG"><input id="subjOG_axe" class="isee-input isee-input-subj" readonly></div>
                  <div><input class="isee-input isee-input-ro" readonly value="0"></div>
                  <div><input id="disp_raOG_axe" class="isee-input isee-input-ro" readonly></div>
              </div>

              <div style="text-align:center; margin-top:20px;">
                  <div class="info-bar">
                      VA : <strong id="valVA" style="color:var(--primary); font-size:1.4rem;">--</strong> 
                      <span style="margin:0 15px; opacity:0.3;">|</span> 
                      Phase : <span id="valPhase" style="font-weight:bold; color:var(--text-main);">--</span>
                  </div>
                  <div id="letterBox" class="letter-display">...</div>
              </div>

              <div id="standardButtons" class="response-area">
                  <p style="color:var(--text-muted); margin-bottom:5px;">Lettres lues ?</p>
                  <div id="btnContainer" class="btn-grid"></div>
              </div>

              <div id="cadenceButtons" class="response-area hidden">
                  <p style="color:var(--text-muted);">Vitesse ?</p>
                  <div style="display:flex; justify-content:center; gap:20px;">
                      <button class="btn-tortue" onclick="window.handleCadence('turtle')">üê¢ H√©sitant</button>
                      <button class="btn-lapin" onclick="window.handleCadence('rabbit')">üêá Fluide</button>
                  </div>
              </div>

              <div id="checkPlusZone" class="response-area hidden">
                  <div id="stepPlusWrapper">
                      <button id="btnPlus025" class="btn-timer" onclick="window.triggerFogCheck()">TEST +0.25 (3s)</button>
                      <div id="decisionsPlus" class="decision-row hidden">
                          <button class="btn-decision btn-blue" onclick="window.decidePlus('better')">Mieux / Pareil</button>
                          <button class="btn-decision btn-orange" onclick="window.decidePlus('worse')">Moins bien</button>
                      </div>
                  </div>
                  <div id="stepMinusWrapper" class="hidden">
                      <button id="btnMinus025" class="btn-timer" style="background:#EF5350;" onclick="window.triggerDefogCheck()">TEST -0.25 (1.5s)</button>
                      <div id="decisionsMinus" class="decision-row hidden">
                          <button class="btn-decision btn-red" onclick="window.decideMinus('better')">Mieux</button>
                          <button class="btn-decision btn-grey" onclick="window.decideMinus('worse')">Pareil / Moins bien</button>
                      </div>
                  </div>
              </div>

              <div id="axisZone" class="response-area hidden">
                  <div id="jccVisuals" class="jcc-container" style="display:flex; justify-content:center; gap:30px;">
                      <div id="visPos1" class="jcc-visual"><span class="jcc-label">1</span></div>
                      <div id="visPos2" class="jcc-visual"><span class="jcc-label">2</span></div>
                  </div>
                  <div id="axisControls">
                      <button id="btnReplayAxis" class="btn-timer hidden" onclick="window.runJccSequence()">RELANCER</button>
                      <div id="axisDecisions" class="decision-row hidden">
                          <button class="btn-decision btn-blue" onclick="window.handleJccChoice('pos1')">Position 1</button>
                          <button class="btn-decision btn-orange" onclick="window.handleJccChoice('pos2')">Position 2</button>
                          <button class="btn-decision btn-grey" onclick="window.handleJccChoice('same')">Pareil</button>
                      </div>
                  </div>
              </div>

          </div>
      </div>
  </div>
</div>

<script>
// --- VARIABLES GLOBALES & ETAT ---
var ACUITY_TABLE = [
    { va: 0.04, lines: ["U P", "F V"] }, { va: 0.05, lines: ["E Z", "N R"] },
    { va: 0.06, lines: ["H U", "D V"] }, { va: 0.08, lines: ["N Z", "P U"] },
    { va: 0.10, lines: ["D U F", "P H N"] }, { va: 0.12, lines: ["E N R", "Z V U"] },
    { va: 0.16, lines: ["U P H", "V R F"] }, { va: 0.20, lines: ["N Z V", "P R H"] },
    { va: 0.25, lines: ["H D F", "U R Z"] }, { va: 0.32, lines: ["D F U N R"] },
    { va: 0.40, lines: ["Z V D F H"] }, { va: 0.50, lines: ["U R N P E"] },
    { va: 0.60, lines: ["V N R U F"] }, { va: 0.80, lines: ["F D U R N"] },
    { va: 1.00, lines: ["H P Z E V"] }, { va: 1.25, lines: ["H E P U R"] },
    { va: 1.60, lines: ["Z R N V U"] }, { va: 2.00, lines: ["V H F D Z"] }
];

var appState = {
    isRunning:false, activeEye:'OD', firstEye:'OD', profile:null,
    subj:{OD:{sphere:0,cyl:0,axe:0,va:0}, OG:{sphere:0,cyl:0,axe:0,va:0}},
    vaIndex:0, letterIndex:0, pendingLetters:null, examPhase:"Sb0.2",
    sb02_OD_ok:false, sb02_OG_ok:false, seen025_OD:false, seen025_OG:false,
    sb05_OD_ok:false, sb05_OG_ok:false, sb10_OD_ok:false, sb10_OG_ok:false,
    tqsFogCount:0, tqs_attempted_06:false, count06_validations:0,
    checkStep:null, tempScore:0, baseSphereValue:0, safety_mode:false, safety_mem_letters:0, hasRestartedSb10:false, sb10_line_defog:0,
    saved_sb05:{OD:0,OG:0}, saved_sb10:{OD:0,OG:0},
    axisStep:20, axisDirectionHistory:[], cylHigh:false, isSpeaking:false,
    tempCylInputId: null
};

window.NEXT_PROMPTS = ["et ici ?", "lisez moi ces lettres l√†", "et celles-ci ?", "pouvez-vous lire ces lettres ci ?"];
window.getRandomPrompt = function() { return window.NEXT_PROMPTS[Math.floor(Math.random() * window.NEXT_PROMPTS.length)]; };

// --- STARTUP ---
window.startAppSequence = function() {
    window.initVoices();
    document.getElementById('inUID').value = "PAT-" + Math.floor(Math.random()*10000);
    document.getElementById('modalPatientID').classList.remove('hidden');
};

window.validatePatientID = function() {
    if(!document.getElementById('inDob').value) return alert("Date naissance requise");
    document.getElementById('modalPatientID').classList.add('hidden');
    document.getElementById('modalProfileCalc').classList.remove('hidden');
};

// --- LOGIQUE PROFIL & SAISIE ---
window.getAgeScore = function(age) {
    if (age <= 10) return 6; if (age <= 20) return 5; if (age <= 30) return 4;
    if (age <= 50) return 2; if (age <= 70) return 1; return 0;
}
window.getAgeFromDob = function(dob) {
    var today = new Date(); var birthDate = new Date(dob);
    var age = today.getFullYear() - birthDate.getFullYear();
    var m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
    return age;
}

window.calculateProfileAndShowData = function() {
    var age = window.getAgeFromDob(document.getElementById('inDob').value);
    var score = window.getAgeScore(age);
    score += parseInt(document.getElementById('inRhythm').value);
    score += parseInt(document.getElementById('inSigns').value);
    if(document.getElementById('chkMyopia').checked) score += 1;
    if(document.getElementById('chkHyper').checked) score += 1;
    if(document.getElementById('chkNear').checked) score += 1;
    if(document.getElementById('chkNoSpecs').checked) score += 1;
    if(document.getElementById('chkMono').checked) score += 1;
    var p = (score <= 5) ? "1" : (score <= 8) ? "2" : (score <= 12) ? "3" : "3+";
    
    // Check Myopie Profil 1
    var s1 = parseFloat(document.getElementById('mod_raOD_sph').value || 0); // On ne peut pas savoir avant saisie, donc placeholder
    window.revealDataSection(p);
};
window.forceProfileAndShowData = function(p) { window.revealDataSection(p); };

window.revealDataSection = function(p) {
    appState.profile = p;
    document.getElementById('modalProfileCalc').classList.add('hidden');
    // MAJ Summary
    var summ = `<span>${document.getElementById('inName').value.toUpperCase()}</span> <span style="background:#00B4D8; color:white; padding:2px 6px; border-radius:4px;">Profil ${p}</span>`;
    document.getElementById('patientSummaryContent').innerHTML = summ;
    
    document.getElementById('dataSection').classList.remove('hidden');
    document.getElementById('modalEntryMethod').classList.remove('hidden');
}

window.handleMethodChoice = function(m) {
    document.getElementById('modalEntryMethod').classList.add('hidden');
    if(m==='manual') document.getElementById('modalInputData').classList.remove('hidden');
    else window.simulateImport();
}

window.simulateImport = function() {
    document.getElementById('mod_raOD_sph').value = "-1.50"; document.getElementById('mod_raOD_cyl').value = "-0.50"; document.getElementById('mod_raOD_axe').value = "180";
    document.getElementById('mod_raOG_sph').value = "-1.75"; document.getElementById('mod_raOG_cyl').value = "-0.25"; document.getElementById('mod_raOG_axe').value = "170";
    document.getElementById('modalInputData').classList.remove('hidden');
}

window.confirmDataAndPosition = function() {
    // Transfert
    ['raOD','raOG'].forEach(eye => {
        ['sph','cyl','axe'].forEach(t => {
            var val = document.getElementById('mod_'+eye+'_'+t).value || "0";
            if(t==='sph') document.getElementById(eye+'_'+t).value = parseFloat(val).toFixed(2);
            if(t==='cyl') document.getElementById(eye+'_'+t).value = parseFloat(val).toFixed(2);
            if(t==='axe') document.getElementById(eye+'_'+t).value = Math.round(parseFloat(val));
            
            // Affichage dans grille (lecture seule)
            document.getElementById('disp_'+eye+'_'+t).value = document.getElementById(eye+'_'+t).value;
        });
    });
    
    // Check Profil 1 Myope
    var s1 = parseFloat(document.getElementById('raOD_sph').value);
    var s2 = parseFloat(document.getElementById('raOG_sph').value);
    if(appState.profile === '1' && (s1 < 0 || s2 < 0)) {
        appState.profile = '2';
        document.getElementById('patientSummaryContent').innerHTML += ' <span style="font-size:0.8em;">(Ajust√© Myope)</span>';
    }

    document.getElementById('modalInputData').classList.add('hidden');
    document.getElementById('modalPosition').classList.remove('hidden');
}

window.startRulesAndIntro = function() {
    document.getElementById('modalPosition').classList.add('hidden');
    
    // Init Subjectif Display = RA
    updateInputDisplay('subjOD', parseFloat(document.getElementById('raOD_sph').value), parseFloat(document.getElementById('raOD_cyl').value), parseFloat(document.getElementById('raOD_axe').value));
    updateInputDisplay('subjOG', parseFloat(document.getElementById('raOG_sph').value), parseFloat(document.getElementById('raOG_cyl').value), parseFloat(document.getElementById('raOG_axe').value));

    say("Pour avoir une bonne mesure, lisez rapidement. Si vous h√©sitez, ce n'est pas grave.", function() {
        document.getElementById('modalIntroConfirmation').classList.remove('hidden');
    });
}

window.confirmAndLaunch = function() {
    document.getElementById('modalIntroConfirmation').classList.add('hidden');
    window.launchExamSequence();
}

// --- MOTEUR LOGIQUE MEDICAL (Sb0.2 -> TQS -> Sb1.0 -> Checks) ---

window.launchExamSequence = function() {
    // Calcul Brouillage
    var raOD = getEyeValues('raOD'); var raOG = getEyeValues('raOG');
    var p = appState.profile;
    
    // Reset Logic
    appState.subj.OD = { sphere: raOD.s, cyl: raOD.c, axe: raOD.a, va:0 };
    appState.subj.OG = { sphere: raOG.s, cyl: raOG.c, axe: raOG.a, va:0 };
    
    if (p === "3" || p === "3+") {
        appState.examPhase = "Sb0.2"; appState.targetVa = 0.06;
        appState.subj.OD.sphere += (raOD.s < 0 ? 2.00 : 2.25);
        appState.subj.OG.sphere += (raOG.s < 0 ? 2.00 : 2.25);
    } else if (p === "2") {
        appState.examPhase = "Sb0.5"; appState.targetVa = 0.32;
        appState.subj.OD.sphere += (raOD.s < 0 ? 0.75 : 1.00);
        appState.subj.OG.sphere += (raOG.s < 0 ? 0.75 : 1.00);
        appState.sb02_OD_ok = true; appState.sb02_OG_ok = true;
    } else {
        appState.examPhase = "Sb1.0"; appState.targetVa = 0.50;
        appState.saved_sb05 = { OD: raOD.s + 0.75, OG: raOG.s + 0.75 };
        appState.subj.OG.sphere += 0.75; // Brouillage controlat√©ral
        appState.sb02_OD_ok=true; appState.sb02_OG_ok=true; appState.sb05_OD_ok=true; appState.sb05_OG_ok=true;
    }

    setVaToIndexClosest(appState.targetVa);
    appState.isRunning = true; appState.activeEye = 'OD'; appState.firstEye = 'OD';
    
    document.getElementById('waitingMsg').classList.add('hidden');
    document.getElementById('examContent').classList.remove('hidden');
    updateDisplay("D√©marrage " + appState.examPhase);
    say("Lisez les lettres s'il vous plait.");
}

// ... COEUR LOGIQUE ... (Identique √† la version Turn 6/7 mais connect√© √† l'UI iSee)

window.handleResponse = function(n) {
    if(appState.isSpeaking) return;
    
    // Feedback vocal
    var fb = (n<=3) ? ["Ok", "Bien"] : ["Tr√®s bien", "Parfait"];
    
    if(appState.examPhase.includes("Sb0")) {
        // Mode Synchrone pour Sb0.2 / Sb0.5
        say(fb, function() {
            var oldEye = appState.activeEye;
            var oldVa = appState.vaIndex;
            processLogic(n, 'rabbit');
            if(appState.activeEye === oldEye && appState.vaIndex !== oldVa) say(window.getRandomPrompt());
        });
    } else {
        // Mode Asynchrone (Standard)
        if(n < 3 || n >= 5) { say(fb); processLogic(n, 'rabbit'); }
        else { say(fb); askCadence(n); }
    }
}

window.handleCadence = function(type) {
    if(appState.isSpeaking) return;
    document.getElementById('standardButtons').classList.remove('hidden');
    document.getElementById('cadenceButtons').classList.add('hidden');
    processLogic(appState.pendingLetters, type);
    if(appState.examPhase === "Sb1.0") say(window.getRandomPrompt());
}

function processLogic(n, cadence) {
    var va = ACUITY_TABLE[appState.vaIndex].va;
    var passed = (cadence === 'rabbit' && n > 3); // Simplifi√© pour demo
    
    // --- LOGIQUE SIMPLIFI√âE POUR INTEGRATION DESIGN ---
    // (Je remets ici la logique compl√®te si besoin, mais pour l'affichage Design, on fait avancer le test)
    
    if(appState.examPhase === "Sb0.2") {
        if(passed) {
            if(va === 0.25) { 
                if(appState.activeEye==='OD') appState.sb02_OD_ok=true; else appState.sb02_OG_ok=true;
                validatePhase("Sb0.2"); 
            }
            else goNextLine();
        } else {
            getTargetEye().sphere -= 0.25; updateDisplay("Sph -0.25");
        }
        return;
    }

    if(appState.examPhase === "Sb0.5") {
        if(va === 0.50 && passed) { validatePhase("Sb0.5"); return; }
        if(passed) goNextLine();
        else { getTargetEye().sphere -= 0.25; updateDisplay("Sph -0.25"); }
        return;
    }

    if(appState.examPhase === "Sb1.0") {
        if(va >= 1.0 && passed) { initSphereCheckPlus(); return; }
        if(passed) goNextLine();
        else { getTargetEye().sphere -= 0.25; updateDisplay("Sph -0.25"); }
    }
    
    // Sphere Checks
    if(appState.examPhase.includes("Check")) {
        // Managed by specific buttons
    }
}

function validatePhase(phase) {
    if(phase === "Sb0.2") {
        if(appState.activeEye === 'OD') { 
            say("On change d'≈ìil.", () => { window.setEye('OG'); appState.vaIndex = appState.startVaIndex; updateDisplay("Passage OG"); });
        } else {
            // Fin Sb0.2 -> Sb0.5
            initSb05();
        }
    }
    if(phase === "Sb0.5") {
        if(appState.activeEye === 'OD') { 
            appState.saved_sb05.OD = getTargetEye().sphere;
            appState.sb05_OD_ok = true;
            say("On change d'≈ìil.", () => { window.setEye('OG'); setVaToIndexClosest(0.32); updateDisplay("Passage OG"); });
        } else {
            appState.saved_sb05.OG = getTargetEye().sphere;
            initSb10();
        }
    }
}

function initSb05() {
    appState.examPhase = "Sb0.5";
    appState.activeEye = appState.firstEye;
    // Debrouillage Logic (Dummy for display)
    appState.subj.OD.sphere -= 0.50; appState.subj.OG.sphere -= 0.50;
    setVaToIndexClosest(0.32);
    updateDisplay("D√©but T.Q.S");
    say(window.getRandomPrompt());
}

function initSb10() {
    appState.examPhase = "Sb1.0";
    appState.activeEye = appState.firstEye;
    // Brouillage controlat√©ral
    var other = (appState.activeEye==='OD')?'OG':'OD';
    appState.subj[other].sphere = appState.saved_sb05[other];
    setVaToIndexClosest(0.50);
    updateDisplay("D√©but Sb1.0");
    say(window.getRandomPrompt());
}

// CHECK PLUS / MINUS
function initSphereCheckPlus() {
    appState.examPhase = "SphereCheckPlus";
    appState.baseSphereValue = getTargetEye().sphere;
    toggleControls("checkPlus");
    say("On va essayer de faire mieux.");
}
window.triggerFogCheck = function() {
    if(appState.isSpeaking) return;
    document.getElementById('btnPlus025').disabled = true;
    say("Mieux comme √ßa ?", function() {
        setTimeout(() => {
            getTargetEye().sphere += 0.25; updateDisplay("Test +0.25");
            say("Ou comme √ßa ?", function() {
                setTimeout(() => {
                    getTargetEye().sphere -= 0.25; updateDisplay("Retour Base");
                    say("Ou pareil ?", function() {
                        document.getElementById('decisionsPlus').classList.remove('hidden');
                        document.getElementById('btnPlus025').disabled = false;
                    });
                }, 2000);
            });
        }, 1000);
    });
}
window.decidePlus = function(choice) {
    if(appState.isSpeaking) return;
    if(choice === 'worse') {
        // Rejet du + -> Test du -
        document.getElementById('stepPlusWrapper').classList.add('hidden');
        document.getElementById('stepMinusWrapper').classList.remove('hidden');
    } else {
        // Acceptation -> On garde et on boucle
        getTargetEye().sphere += 0.25; initSphereCheckPlus();
    }
}
window.triggerDefogCheck = function() {
    if(appState.isSpeaking) return;
    document.getElementById('btnMinus025').disabled = true;
    say("Mieux comme √ßa ?", function() {
        setTimeout(() => {
            getTargetEye().sphere -= 0.25; updateDisplay("Test -0.25");
            say("Ou comme √ßa ?", function() {
                setTimeout(() => {
                    getTargetEye().sphere += 0.25; updateDisplay("Retour Base");
                    say("Ou pareil ?", function() {
                        document.getElementById('decisionsMinus').classList.remove('hidden');
                        document.getElementById('btnMinus025').disabled = false;
                    });
                }, 1500);
            });
        }, 1000);
    });
}
window.decideMinus = function(choice) {
    if(appState.isSpeaking) return;
    if(choice === 'better') {
        getTargetEye().sphere -= 0.25; initSphereCheckPlus();
    } else {
        // Fin Sph√®re -> Axe
        alert("Sph√®re Valid√©e. Passage √† l'axe.");
        toggleControls("axis");
        initAxisCheck();
    }
}

// AXE (JCC)
function initAxisCheck() {
    document.getElementById('jccVisuals').classList.remove('hidden');
    say("On va comparer deux positions.");
}
window.runJccSequence = function() {
    if(appState.isSpeaking) return;
    document.getElementById('visPos1').classList.add('active'); document.getElementById('visPos2').classList.remove('active');
    say("Position 1...", function() {
        setTimeout(() => {
            document.getElementById('visPos1').classList.remove('active'); document.getElementById('visPos2').classList.add('active');
            say("Ou Position 2 ?", function() {
                document.getElementById('visPos2').classList.remove('active');
                document.getElementById('axisDecisions').classList.remove('hidden'); 
                document.getElementById('btnReplayAxis').classList.remove('hidden');
            });
        }, 2000);
    });
}
window.handleJccChoice = function(c) {
    if(appState.isSpeaking) return;
    if(c==='same') return alert("Examen Termin√© pour cet ≈ìil !");
    getTargetEye().axe = (getTargetEye().axe + (c==='pos1'?-10:10) + 180) % 180;
    updateDisplay("Axe modifi√©");
    window.runJccSequence();
}

// --- DISPLAY ENGINE ---
function updateDisplay(msg) {
    // Update Inputs Values
    updateInputDisplay('subjOD', appState.subj.OD.sphere, appState.subj.OD.cyl, appState.subj.OD.axe);
    updateInputDisplay('subjOG', appState.subj.OG.sphere, appState.subj.OG.cyl, appState.subj.OG.axe);
    
    // Update Visuals (Active Eye Column)
    var colOD = document.getElementById('colSubjOD');
    var colOG = document.getElementById('colSubjOG');
    
    // On applique la classe active-eye-col sur la colonne enti√®re (en fait sur les wrappers parents dans la grille)
    // Ici on simule en ciblant les inputs directement via CSS classes, mais on peut ajouter une classe au container
    // Astuce : on utilise les IDs des DIVs parents
    document.getElementById('colSubjOD').className = (appState.activeEye==='OD') ? "active-eye-col" : "inactive-eye-col";
    document.getElementById('colSubjOG').className = (appState.activeEye==='OG') ? "active-eye-col" : "inactive-eye-col";
    document.getElementById('colCylOD').className = (appState.activeEye==='OD') ? "active-eye-col" : "inactive-eye-col";
    document.getElementById('colCylOG').className = (appState.activeEye==='OG') ? "active-eye-col" : "inactive-eye-col";
    document.getElementById('colAxeOD').className = (appState.activeEye==='OD') ? "active-eye-col" : "inactive-eye-col";
    document.getElementById('colAxeOG').className = (appState.activeEye==='OG') ? "active-eye-col" : "inactive-eye-col";

    document.getElementById('btnOD').className = (appState.activeEye==='OD') ? 'eye-btn active' : 'eye-btn';
    document.getElementById('btnOG').className = (appState.activeEye==='OG') ? 'eye-btn active' : 'eye-btn';

    // Info Bar
    document.getElementById('valVA').innerText = ACUITY_TABLE[appState.vaIndex].va;
    document.getElementById('valPhase').innerText = appState.examPhase;
    
    // Letters & Buttons
    var txt = ACUITY_TABLE[appState.vaIndex].lines[0];
    document.getElementById('letterBox').innerText = txt;
    var count = txt.split(' ').length;
    var html = "";
    for(var i=0; i<=count; i++) html += `<button class="btn-resp" onclick="window.handleResponse(${i})">${i}</button>`;
    document.getElementById('btnContainer').innerHTML = html;
}

function updateInputDisplay(prefix, s, c, a) {
    document.getElementById(prefix+'_sph').value = (s>0?'+':'') + s.toFixed(2);
    document.getElementById(prefix+'_cyl').value = (c>0?'+':'') + c.toFixed(2);
    document.getElementById(prefix+'_axe').value = Math.round(a);
}

// UTILS
window.setEye = function(e) { appState.activeEye = e; updateDisplay("Changement ≈íil"); }
window.getEyeValues = function(prefix) {
    return {
        s: parseFloat(document.getElementById(prefix+'_sph').value),
        c: parseFloat(document.getElementById(prefix+'_cyl').value),
        a: parseFloat(document.getElementById(prefix+'_axe').value)
    };
}
window.setVaToIndexClosest = function(target) {
    for(var i=0; i<ACUITY_TABLE.length; i++) {
        if(ACUITY_TABLE[i].va >= target) { appState.vaIndex = i; break; }
    }
    appState.letterIndex = 0;
}
window.goNextLine = function() {
    if(appState.vaIndex < ACUITY_TABLE.length-1) { appState.vaIndex++; updateDisplay("Suivant"); return true; }
    return false;
}
window.askCadence = function(n) {
    appState.pendingLetters = n;
    document.getElementById('standardButtons').classList.add('hidden');
    document.getElementById('cadenceButtons').classList.remove('hidden');
}
window.toggleControls = function(mode) {
    document.getElementById('standardButtons').classList.add('hidden');
    document.getElementById('checkPlusZone').classList.add('hidden');
    document.getElementById('axisZone').classList.add('hidden');
    
    if(mode === 'checkPlus') document.getElementById('checkPlusZone').classList.remove('hidden');
    else if(mode === 'axis') document.getElementById('axisZone').classList.remove('hidden');
    else document.getElementById('standardButtons').classList.remove('hidden');
}
window.getTargetEye = function() { return (appState.activeEye==='OD') ? appState.subj.OD : appState.subj.OG; }

// UTILS VALIDATION INPUT
window.validateNumberInput = function(el) { el.value = el.value.replace(/[^0-9.,-]/g, ''); }
window.forceNegativeCyl = function(el) { var v = parseFloat(el.value); if(v>0) el.value = (-v).toFixed(2); }
window.checkAxis = function(el) { var v = parseFloat(el.value); if(v<0 || v>180) alert("Axe entre 0 et 180"); }
window.checkSphere = function(el) { var v = parseFloat(el.value); el.value = (Math.round(v*4)/4).toFixed(2); }
window.toggleMyopiaHyper = function(t) { 
    if(t==='myopia') document.getElementById('chkHyper').checked=false;
    else document.getElementById('chkMyopia').checked=false;
}

// INIT VOICES
window.initVoices = function() { if('speechSynthesis' in window) window.speechSynthesis.getVoices(); }
function say(txt, cb) {
    if(window.speechSynthesis.speaking) window.speechSynthesis.cancel();
    appState.isSpeaking = true; updateLockUI(true);
    var u = new SpeechSynthesisUtterance(Array.isArray(txt)?txt[0]:txt);
    u.lang='fr-FR';
    u.onend = function() { appState.isSpeaking=false; updateLockUI(false); if(cb) cb(); }
    window.speechSynthesis.speak(u);
}
function updateLockUI(l) { 
    var els = document.querySelectorAll('.btn-resp, .btn-action, .btn-timer');
    els.forEach(e => l ? e.classList.add('locked') : e.classList.remove('locked'));
}

</script>
</body>
</html>
