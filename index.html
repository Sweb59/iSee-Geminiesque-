<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>iSee Dashboard - Assistant R√©fraction</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<svg style="display: none;">
  <symbol id="icon-restart" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></symbol>
  <symbol id="icon-settings" viewBox="0 0 24 24"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></symbol>
  <symbol id="icon-console" viewBox="0 0 24 24"><path fill="currentColor" d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM9.5 11.5 7.5 13.5 6 12l3.5-3.5 3.5 3.5-1.5 1.5-2-2zm5 0 2 2-1.5 1.5-3.5-3.5 3.5-3.5 1.5 1.5-2 2z"/></symbol>
  <symbol id="icon-map" viewBox="0 0 24 24"><path fill="currentColor" d="m20.5 3-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></symbol>
  <symbol id="icon-profile" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
  <symbol id="icon-phrase" viewBox="0 0 24 24"><path fill="currentColor" d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></symbol>
  <symbol id="icon-eye" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></symbol>
</svg>

<style>
  /* --- RESET & VARIABLES --- */
  :root { 
      --bg-app: #E0E5EC;
      --panel-grey: #F0F2F5;
      --cyan: #00BCD4;
      --cyan-light: #B2EBF2;
      --cyan-dark: #00838F;
      --text-dark: #37474F;
      --text-light: #78909C;
      --white: #FFFFFF;
      --border-color: #CFD8DC;
      --active-shadow: inset 2px 2px 5px #c8d0e7, inset -2px -2px 5px #ffffff;
      --neumorphic-shadow: 5px 5px 10px #c8d0e7, -5px -5px 10px #ffffff;
  }

  * { box-sizing: border-box; }
  body { 
      font-family: 'Roboto', 'Montserrat', sans-serif;
      background-color: var(--bg-app); 
      color: var(--text-dark); 
      margin: 0; padding: 0;
      height: 100vh; 
      overflow: hidden; 
      display: flex;
      flex-direction: column;
  }

  /* --- HEADER / TOOLBAR --- */
  header {
      height: 90px;
      background: var(--panel-grey);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 60px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      position: relative;
      z-index: 100;
  }

  .tool-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      color: var(--text-dark);
      transition: all 0.2s;
      position: relative;
      width: 80px;
  }
  .tool-item:hover { color: var(--cyan); transform: translateY(-2px); }
  
  .tool-icon {
      width: 40px; height: 40px;
      background: #E0E5EC;
      border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      box-shadow: var(--neumorphic-shadow);
      margin-bottom: 8px;
      color: #546E7A;
  }
  .tool-item:hover .tool-icon { color: var(--cyan); }
  .tool-label { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }

  /* SUB-MENUS (RESTART & PROFILE) */
  .sub-menu {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 10px;
      display: none;
      flex-direction: column;
      gap: 5px;
      width: 140px;
      z-index: 200;
  }
  .sub-menu.visible { display: flex; }
  .tool-item:hover .sub-menu-hover { display: flex; } /* For Profile Hover */

  .menu-btn {
      padding: 8px 12px;
      border: 1px solid #eee;
      background: #fff;
      cursor: pointer;
      font-size: 0.8rem;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
      color: var(--text-dark);
  }
  .menu-btn:hover { background: var(--cyan-light); color: var(--cyan-dark); }

  /* --- MAIN DASHBOARD LAYOUT --- */
  .main-dashboard {
      flex: 1;
      display: flex;
      padding: 20px;
      gap: 30px;
      align-items: flex-start;
      justify-content: center;
  }

  /* LEFT SIDE: DATA GRID */
  .data-container {
      flex: 0 0 60%;
      display: flex;
      flex-direction: column;
      gap: 15px;
  }

  .phase-bar {
      background: var(--cyan);
      color: white;
      font-weight: bold;
      text-transform: uppercase;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 1.1rem;
      letter-spacing: 1px;
      box-shadow: 0 4px 8px rgba(0, 188, 212, 0.3);
  }

  /* COMPLEX GRID LAYOUT (The Heart of the visual) */
  .data-grid {
      display: grid;
      grid-template-columns: 60px 60px 1fr 50px 1fr 60px 60px; /* AR LM OD [Labels] OG LM AR */
      grid-template-rows: 40px 60px 60px 60px; /* Header, S, A, C */
      gap: 8px;
      align-items: center;
  }

  /* Headers */
  .grid-header {
      font-weight: 700;
      color: var(--cyan);
      text-align: center;
      font-size: 0.9rem;
  }
  .header-od { grid-column: 3; background: var(--cyan-dark); color: white; padding: 8px; border-radius: 4px 4px 0 0; }
  .header-og { grid-column: 5; background: #37474F; color: white; padding: 8px; border-radius: 4px 4px 0 0; }
  .header-mono { grid-column: 4; text-align: center; font-size: 0.7rem; color: #90A4AE; font-weight: bold; text-transform: uppercase; }

  /* Center Labels (S, A, C) - Circles */
  .center-label {
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 2px solid var(--cyan);
      color: var(--cyan-dark);
      background: white;
      display: flex; justify-content: center; align-items: center;
      font-weight: bold;
      font-size: 1.2rem;
      margin: 0 auto;
      grid-column: 4;
  }

  /* Data Cells */
  .data-cell {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: #90A4AE; /* Default Passive Color */
  }
  
  /* Inputs specific styling to look like display */
  .data-cell input {
      width: 100%; height: 100%;
      border: none;
      background: transparent;
      text-align: center;
      font-family: inherit;
      font-weight: inherit;
      font-size: inherit;
      color: inherit;
  }

  /* Active/Subjective Columns (Big ones) */
  .cell-active {
      background: var(--cyan);
      border-color: var(--cyan);
      color: white;
      font-size: 1.8rem;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
  }
  .cell-active input { color: white; }

  .cell-passive {
      background: #ECEFF1;
      border-color: transparent;
  }

  /* Row assignments (Inverted S-A-C order) */
  .row-s { grid-row: 2; }
  .row-a { grid-row: 3; }
  .row-c { grid-row: 4; }

  /* RIGHT SIDE: SCREEN & CONTROLS */
  .screen-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
  }

  /* Eye Indicators */
  .eye-indicators {
      display: flex;
      gap: 20px;
      margin-bottom: 10px;
  }
  .eye-icon {
      width: 80px; height: 50px;
      border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      background: #546E7A; /* Default Grey/Occluded */
      color: white;
      font-weight: bold;
      font-size: 1.1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      border: 3px solid white;
      transition: background 0.3s;
      position: relative;
  }
  .eye-icon.active { background: var(--cyan); transform: scale(1.1); }
  .eye-icon::after {
      content: attr(data-label);
      position: absolute;
      top: -20px;
      font-size: 0.8rem;
      color: #90A4AE;
      font-weight: bold;
  }

  /* Visual Acuity Screen */
  .va-screen {
      background: white;
      border: 10px solid #37474F;
      border-radius: 12px;
      width: 100%;
      height: 250px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  .va-value-tag {
      position: absolute;
      right: -20px;
      background: var(--cyan);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  .letter-display { 
      font-family: 'Segoe UI', sans-serif;
      font-size: 4rem;
      font-weight: 800; 
      color: #263238; 
      letter-spacing: 5px;
  }

  /* Bottom Controls (Input Buttons) */
  .controls-area {
      width: 100%;
      text-align: center;
  }
  .input-hint { font-size: 0.9rem; color: #78909C; margin-bottom: 10px; font-weight: 600; text-transform: uppercase; }
  
  .btn-grid { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
  .btn-input {
      width: 60px; height: 60px;
      border-radius: 12px;
      border: none;
      background: white;
      color: var(--cyan-dark);
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: all 0.2s;
      border: 1px solid var(--border-color);
  }
  .btn-input:hover { background: var(--cyan); color: white; transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0, 188, 212, 0.3); }
  .btn-input.locked { opacity: 0.5; cursor: wait; }

  /* MODALS (UNCHANGED LOGIC, JUST Z-INDEX) */
  .modal-overlay { z-index: 1000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(55, 71, 79, 0.95); display: flex; justify-content: center; align-items: center; }
  .modal-content { background: white; padding: 30px; border-radius: 12px; width: 600px; text-align: center; }
  .hidden { display: none !important; }
  .btn-action { padding: 10px 20px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; margin: 5px; background: var(--cyan); color: white; }
  
  /* SCHOBER SPECIFIC CSS */
  .schober-container { display: flex; flex-direction: column; gap: 10px; width: 100%; align-items: center; }
  .schober-row { display: flex; gap: 15px; justify-content: center; }
  .btn-schober { width: 80px; height: 80px; background: #263238; border: 2px solid #546E7A; border-radius: 8px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
  .btn-schober:hover { border-color: var(--cyan); transform: scale(1.05); }
  .sch-cross { stroke: #FF0000; stroke-width: 4; }
  .sch-circle { stroke: #00FF00; stroke-width: 4; fill: none; }
  .sch-faint { opacity: 0.3; stroke-dasharray: 4; }

  /* Input helpers for modal */
  .modal-input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; }
  .modal-input-group input { width: 100%; padding: 8px; font-size: 1.1rem; border: 1px solid #ccc; border-radius: 4px; }

</style>
</head>
<body onload="window.startAppSequence()">

<div id="modalPatientID" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--cyan-dark);">Identification</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:left; margin:20px 0;">
            <label>Nom <input type="text" id="inName"></label>
            <label>Pr√©nom <input type="text" id="inForename"></label>
            <label>Date Naiss. <input type="date" id="inDob"></label>
            <label>UID <input type="text" id="inUID" readonly style="background:#eee;"></label>
        </div>
        <button class="btn-action" onclick="window.validatePatientID()">VALIDER</button>
    </div>
</div>

<div id="modalEntryMethod" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Import Donn√©es</h2>
        <button class="btn-action" onclick="window.handleMethodChoice('manual')">Saisie Manuelle</button>
        <button class="btn-action" style="background:#00838F;" onclick="window.handleMethodChoice('import')">Import Appareils</button>
    </div>
</div>

<div id="modalInputData" class="modal-overlay hidden">
    <div class="modal-content" style="width:800px;">
        <h2>Saisie R√©fraction</h2>
        <div class="modal-input-grid">
            <div>
                <h3>Frontofocom√®tre</h3>
                OD: <input id="mod_frontoOD_sph" placeholder="S"> <input id="mod_frontoOD_cyl" placeholder="C"> <input id="mod_frontoOD_axe" placeholder="A"><br>
                OG: <input id="mod_frontoOG_sph" placeholder="S"> <input id="mod_frontoOG_cyl" placeholder="C"> <input id="mod_frontoOG_axe" placeholder="A">
            </div>
            <div>
                <h3>Auto-R√©fractom√®tre</h3>
                OD: <input id="mod_raOD_sph" placeholder="S"> <input id="mod_raOD_cyl" placeholder="C"> <input id="mod_raOD_axe" placeholder="A"><br>
                OG: <input id="mod_raOG_sph" placeholder="S"> <input id="mod_raOG_cyl" placeholder="C"> <input id="mod_raOG_axe" placeholder="A">
            </div>
        </div>
        <br>
        <button class="btn-action" onclick="window.confirmDataAndPosition()">VALIDER</button>
    </div>
</div>

<div id="modalHandedness" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Lat√©ralit√©</h2>
        <button class="btn-action" onclick="window.setHandedness('OD')">DROITIER</button>
        <button class="btn-action" onclick="window.setHandedness('OG')">GAUCHER</button>
    </div>
</div>

<div id="modalSchoberConfirm" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Confirmation Schober</h2>
        <p id="schoberConfirmText" style="font-size:1.1rem; margin:20px 0;"></p>
        <button class="btn-action" style="background:#78909C;" onclick="window.cancelSchober()">ANNULER</button>
        <button class="btn-action" onclick="window.validateSchober()">VALIDER</button>
    </div>
</div>

<div id="modalProfileCalc" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Profil Accommodatif</h2>
        <div style="text-align:left; margin:10px;">
            <label>Rythme <select id="inRhythm"><option value="1">1x/an</option><option value="2">Moyen</option><option value="3">Rare</option></select></label><br>
            <label>Signes <select id="inSigns"><option value="0">Aucun</option><option value="2">Moyen</option><option value="3">Fr√©quents</option></select></label>
        </div>
        <div style="text-align:left; display:grid; grid-template-columns:1fr 1fr;">
            <label><input type="checkbox" id="chkMyopia" onchange="window.toggleMyopiaHyper('myopia')"> Myopie > 3</label>
            <label><input type="checkbox" id="chkHyper" onchange="window.toggleMyopiaHyper('hyper')"> Hyper < 1</label>
            <label><input type="checkbox" id="chkNear"> Pr√®s</label>
            <label><input type="checkbox" id="chkNoSpecs"> Sans Lunettes</label>
            <label><input type="checkbox" id="chkMono"> Monophtalme</label>
        </div>
        <br>
        <button class="btn-action" onclick="window.calculateProfileAndShowData()">CALCULER</button>
        <hr>
        <p>Ou Forcer :</p>
        <button id="btnProfile1" class="btn-action" style="background:#4CAF50;" onclick="window.forceProfileAndShowData('1')">1</button>
        <button class="btn-action" style="background:#2196F3;" onclick="window.forceProfileAndShowData('2')">2</button>
        <button class="btn-action" style="background:#FF9800;" onclick="window.forceProfileAndShowData('3')">3</button>
        <button class="btn-action" style="background:#F44336;" onclick="window.forceProfileAndShowData('3+')">3+</button>
    </div>
</div>

<div id="modalPosition" class="modal-overlay hidden">
    <div class="modal-content"><h2>Installation</h2><p>Installez le patient.</p><button class="btn-action" onclick="window.startRulesAndIntro()">R√àGLES</button></div>
</div>
<div id="modalIntroConfirmation" class="modal-overlay hidden">
    <div class="modal-content"><h2>Pr√™t ?</h2><button class="btn-action" onclick="window.confirmAndLaunch()">LANCER EXAMEN</button></div>
</div>
<div id="modalWarning" class="modal-overlay hidden"><div class="modal-content"><h2>Hors Limites</h2><button class="btn-action" onclick="window.closeWarningModal()">CORRIGER</button></div></div>
<div id="modalDefogLimit" class="modal-overlay hidden"><div class="modal-content"><h2 style="color:red">Limite D√©brouillage</h2><button class="btn-action" onclick="window.restartExam()">Recommencer</button></div></div>
<div id="modalTqsLimit" class="modal-overlay hidden"><div class="modal-content"><h2 style="color:red">Echec TQS</h2><button class="btn-action" onclick="window.restartExam()">Recommencer</button></div></div>
<div id="modalIncoherent" class="modal-overlay hidden"><div class="modal-content"><h2>Incoh√©rent</h2><button class="btn-action" onclick="window.restartSb10()">Recommencer √©tape</button></div></div>


<div class="app-container">
    
    <header>
        <div class="tool-item" onclick="toggleMenu('restartMenu')">
            <div class="tool-icon"><svg width="24" height="24"><use href="#icon-restart"></use></svg></div>
            <div class="tool-label">Repartir</div>
            <div id="restartMenu" class="sub-menu">
                <div class="menu-btn" onclick="window.restartSb10()">√âtape en cours</div>
                <div class="menu-btn" onclick="window.restartExam()">Tout l'examen</div>
            </div>
        </div>

        <div class="tool-item">
            <div class="tool-icon"><svg width="24" height="24"><use href="#icon-settings"></use></svg></div>
            <div class="tool-label">Param√®tres</div>
        </div>

        <div class="tool-item">
            <div class="tool-icon"><svg width="24" height="24"><use href="#icon-console"></use></svg></div>
            <div class="tool-label">Console</div>
        </div>

        <div class="tool-item">
            <div class="tool-icon"><svg width="24" height="24"><use href="#icon-map"></use></svg></div>
            <div class="tool-label">Carte</div>
        </div>

        <div class="tool-item hover-trigger">
            <div class="tool-icon" style="background:var(--cyan); color:white;">
                <span id="headerProfileVal" style="font-size:1.2rem; font-weight:bold;">-</span>
            </div>
            <div class="tool-label">Profil</div>
            <div class="sub-menu sub-menu-hover">
                <div class="menu-btn" onclick="window.forceProfileAndShowData('1')">Profil 1</div>
                <div class="menu-btn" onclick="window.forceProfileAndShowData('2')">Profil 2</div>
                <div class="menu-btn" onclick="window.forceProfileAndShowData('3')">Profil 3</div>
            </div>
        </div>

        <div class="tool-item">
            <div class="tool-icon"><svg width="24" height="24"><use href="#icon-phrase"></use></svg></div>
            <div class="tool-label">Phras√©ologie</div>
        </div>
    </header>

    <div class="main-dashboard">
        
        <div class="data-container">
            <div id="phaseTitleBar" class="phase-bar">EN ATTENTE...</div>

            <div class="data-grid">
                <div class="grid-header">AR</div>
                <div class="grid-header">LM</div>
                <div class="grid-header header-od">OD</div>
                <div class="header-mono">MONOCULAIRE</div>
                <div class="grid-header header-og">OG</div>
                <div class="grid-header">LM</div>
                <div class="grid-header">AR</div>

                <div class="center-label row-s">S</div>
                <div class="data-cell row-s" style="grid-column:1"><input id="raOD_sph" readonly></div>
                <div class="data-cell row-s" style="grid-column:2"><input id="frontoOD_sph" readonly></div>
                <div class="data-cell row-s cell-active" style="grid-column:3"><input id="subjOD_sph" readonly></div>
                <div class="data-cell row-s cell-active" style="grid-column:5"><input id="subjOG_sph" readonly></div>
                <div class="data-cell row-s" style="grid-column:6"><input id="frontoOG_sph" readonly></div>
                <div class="data-cell row-s" style="grid-column:7"><input id="raOG_sph" readonly></div>

                <div class="center-label row-a">A</div>
                <div class="data-cell row-a" style="grid-column:1"><input id="raOD_axe" readonly></div>
                <div class="data-cell row-a" style="grid-column:2"><input id="frontoOD_axe" readonly></div>
                <div class="data-cell row-a cell-active" style="grid-column:3"><input id="subjOD_axe" readonly></div>
                <div class="data-cell row-a cell-active" style="grid-column:5"><input id="subjOG_axe" readonly></div>
                <div class="data-cell row-a" style="grid-column:6"><input id="frontoOG_axe" readonly></div>
                <div class="data-cell row-a" style="grid-column:7"><input id="raOG_axe" readonly></div>

                <div class="center-label row-c">C</div>
                <div class="data-cell row-c" style="grid-column:1"><input id="raOD_cyl" readonly></div>
                <div class="data-cell row-c" style="grid-column:2"><input id="frontoOD_cyl" readonly></div>
                <div class="data-cell row-c cell-active" style="grid-column:3"><input id="subjOD_cyl" readonly></div>
                <div class="data-cell row-c cell-active" style="grid-column:5"><input id="subjOG_cyl" readonly></div>
                <div class="data-cell row-c" style="grid-column:6"><input id="frontoOG_cyl" readonly></div>
                <div class="data-cell row-c" style="grid-column:7"><input id="raOG_cyl" readonly></div>
            </div>
        </div>

        <div class="screen-container">
            
            <div class="eye-indicators">
                <div id="eyeOD" class="eye-icon" data-label="OD">
                    <svg width="24" height="24"><use href="#icon-eye"></use></svg>
                    <span id="vaValOD" style="margin-left:5px; font-size:0.8rem;">-</span>
                </div>
                <div style="width:40px; height:40px; border-radius:50%; border:1px solid #999; display:flex; justify-content:center; align-items:center; color:#666; font-weight:bold;">A</div>
                <div id="eyeOG" class="eye-icon" data-label="OG">
                    <svg width="24" height="24"><use href="#icon-eye"></use></svg>
                    <span id="vaValOG" style="margin-left:5px; font-size:0.8rem;">-</span>
                </div>
            </div>

            <div id="schoberWrapper" class="hidden" style="width:100%;">
                </div>

            <div id="visualScreen" class="va-screen">
                <div id="letterBox" class="letter-display">...</div>
                <div class="va-value-tag" id="currentVA">0.05</div>
            </div>

            <div class="controls-area">
                <div class="input-hint">Cliquez sur le chiffre de lettres lues</div>
                <div id="btnContainer" class="btn-grid"></div>
                
                <div id="cadenceButtons" class="hidden" style="margin-top:10px;">
                    <button class="btn-action btn-tortue" onclick="window.handleCadence('turtle')">üê¢ H√©sitant</button>
                    <button class="btn-action btn-lapin" onclick="window.handleCadence('rabbit')">üêá Fluide</button>
                </div>

                <div id="checkPlusZone" class="hidden" style="margin-top:10px;">
                    <div id="stepPlusWrapper">
                        <button id="btnPlus025" class="btn-action" onclick="window.triggerFogCheck()">TESTER +0.25</button>
                        <div id="decisionsPlus" class="hidden">
                            <button class="btn-action" onclick="window.decidePlus('better')">Mieux</button>
                            <button class="btn-action" onclick="window.decidePlus('same')">Pareil</button>
                            <button class="btn-action" style="background:#ff9800;" onclick="window.decidePlus('worse')">Moins bien</button>
                        </div>
                    </div>
                    <div id="stepMinusWrapper" class="hidden">
                        <button id="btnMinus025" class="btn-action" onclick="window.triggerDefogCheck()">TESTER -0.25</button>
                        <div id="decisionsMinus" class="hidden">
                            <button class="btn-action" onclick="window.decideMinus('better')">Mieux</button>
                            <button class="btn-action" onclick="window.decideMinus('same')">Pareil</button>
                            <button class="btn-action" style="background:#ff9800;" onclick="window.decideMinus('worse')">Moins bien</button>
                        </div>
                    </div>
                </div>

                <div id="axisZone" class="hidden">
                    <div style="font-weight:bold; margin-bottom:5px;">Test d'Axe</div>
                    <div id="jccVisuals" class="jcc-container" style="transform:scale(0.5); margin:0;">
                        <div id="visPos1" class="jcc-visual"><span class="jcc-label">1</span></div>
                        <div id="visPos2" class="jcc-visual"><span class="jcc-label">2</span></div>
                    </div>
                    <div id="axisDecisions" class="hidden" style="margin-top:10px;">
                        <button class="btn-action" onclick="window.handleJccChoice('pos1')">Choix 1</button>
                        <button class="btn-action" onclick="window.handleJccChoice('pos2')">Choix 2</button>
                        <button class="btn-action" style="background:#4CAF50;" onclick="window.handleJccChoice('same')">Pareil</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
/* ================== CORE JAVASCRIPT LOGIC ================== */

// MENU TOGGLE
window.toggleMenu = function(id) {
    var menu = document.getElementById(id);
    if(menu.classList.contains('visible')) menu.classList.remove('visible');
    else menu.classList.add('visible');
};

// --- GLOBAL STATE ---
var ACUITY_TABLE = [
    { va: 0.04, lines: ["U", "P", "F", "V"] },
    { va: 0.05, lines: ["E", "Z", "N", "R"] },
    { va: 0.06, lines: ["H", "U", "D", "V"] },
    { va: 0.08, lines: ["N Z", "P U", "V H"] },
    { va: 0.10, lines: ["D U F", "P H N"] },
    { va: 0.12, lines: ["E N R", "R H P"] },
    { va: 0.16, lines: ["U P H", "V R F"] },
    { va: 0.20, lines: ["N Z V", "P R H"] },
    { va: 0.25, lines: ["H D F", "U R Z"] },
    { va: 0.32, lines: ["D F U N R", "R U P E H"] },
    { va: 0.40, lines: ["Z V D F H", "U V N R Z"] },
    { va: 0.50, lines: ["U R N P E", "R U P E H"] },
    { va: 0.60, lines: ["V N R U F", "R H U E P"] },
    { va: 0.80, lines: ["F D U R N", "P R H U E"] },
    { va: 1.00, lines: ["H P Z E V", "H D E P N"] },
    { va: 1.25, lines: ["H E P U R", "E P N R U"] },
    { va: 1.60, lines: ["Z R N V U", "U R N P E"] },
    { va: 2.00, lines: ["V H F D Z", "R N U F D"] }
];

var appState = {
    isRunning: false, activeEye: 'OD', firstEye: 'OD', profile: null, initProfile: null, 
    baseProfile: null, 
    isSpeaking: false,
    subj: { OD: { sphere: 0, cyl: 0, axe: 0, va: "-" }, OG: { sphere: 0, cyl: 0, axe: 0, va: "-" } },
    memCyl: { OD: null, OG: null }, 
    vaIndex: 0, startVaIndex: 0, letterIndex: 0, pendingLetters: null, defoggedInZone: false,
    examPhase: "Sb0.2", patientInfo: { name: "", forename: "", dob: "", age: 0, uid: "" },
    sb02_OD_ok: false, sb02_OG_ok: false, seen025_OD: false, seen025_OG: false,
    sb05_OD_ok: false, sb05_OG_ok: false, sb10_OD_ok: false, sb10_OG_ok: false,
    tqs_attempted_06: false, count06_validations: 0, tqsFogCount: 0, checkStep: null, tempScore: 0, baseSphereValue: 0,
    sb10_line_defog: 0, safety_mode: false, safety_mem_letters: 0, hasRestartedSb10: false,
    handednessEye: 'OD', pendingSchober: null,
    saved_sb05: { OD: 0, OG: 0 }, saved_sb10: { OD: 0, OG: 0 },
    axisStep: 20, axisDirectionHistory: [], cylHigh: false, lastInvalidInputId: null 
};

window.NEXT_PROMPTS = ["et ici ?", "lisez moi ces lettres l√†", "et celles-ci ?"];
window.getRandomPrompt = function() { return window.NEXT_PROMPTS[Math.floor(Math.random() * window.NEXT_PROMPTS.length)]; };

// --- UTILS ---
window.getVal = function(id) { var el = document.getElementById(id); return (el && el.value) ? parseFloat(el.value.replace(',', '.')) || 0 : 0; };
window.setHTML = function(id, val) { var el = document.getElementById(id); if(el) { if(el.tagName==='INPUT') el.value = val; else el.innerText = val; } };
function getAgeFromDob(dobString) { var t = new Date(); var b = new Date(dobString); var a = t.getFullYear() - b.getFullYear(); if (t.getMonth() < b.getMonth()) a--; return a; }
function getAgeScore(age) { if (age <= 10) return 6; if (age <= 20) return 5; if (age <= 30) return 4; if (age <= 50) return 2; if (age <= 70) return 1; return 0; }
function normalizeAxis(val) { val = Math.round(val / 5) * 5; return (val % 180 + 180) % 180; }
window.generateShortUID = function() { return Math.random().toString(36).substr(2, 6).toUpperCase(); };

// --- INIT ---
window.startAppSequence = function() {
    window.initVoices();
    document.getElementById('inUID').value = window.generateShortUID();
    document.getElementById('modalPatientID').classList.remove('hidden');
};

// --- TTS ---
window.initVoices = function() { window.speechSynthesis.getVoices(); };
function say(text, callback) {
    if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();
    appState.isSpeaking = true; updateLockUI(true);
    var u = new SpeechSynthesisUtterance(text); u.lang = 'fr-FR'; u.rate = 1.0;
    u.onend = function() { appState.isSpeaking = false; updateLockUI(false); if (callback) callback(); };
    u.onerror = function() { appState.isSpeaking = false; updateLockUI(false); };
    window.speechSynthesis.speak(u);
}
function updateLockUI(locked) {
    var btns = document.querySelectorAll('.btn-input, .btn-action');
    btns.forEach(function(b) { if(locked) b.classList.add('locked'); else b.classList.remove('locked'); });
}

// --- WORKFLOW STEPS ---

window.validatePatientID = function() {
    if(!document.getElementById('inDob').value) { alert("Date naissance requise"); return; }
    document.getElementById('modalPatientID').classList.add('hidden');
    document.getElementById('modalEntryMethod').classList.remove('hidden');
};

window.handleMethodChoice = function(method) {
    document.getElementById('modalEntryMethod').classList.add('hidden');
    if(method==='import') simulateImport();
    document.getElementById('modalInputData').classList.remove('hidden');
};

function simulateImport() {
    document.getElementById('mod_raOD_sph').value = "-1.50"; document.getElementById('mod_raOD_cyl').value = "-0.50"; document.getElementById('mod_raOD_axe').value = "180";
    document.getElementById('mod_raOG_sph').value = "-1.75"; document.getElementById('mod_raOG_cyl').value = "-0.25"; document.getElementById('mod_raOG_axe').value = "170";
}

window.confirmDataAndPosition = function() {
    // Mapping Modal Inputs -> Dashboard Inputs
    var fields = ['raOD_sph','raOD_cyl','raOD_axe','raOG_sph','raOG_cyl','raOG_axe','frontoOD_sph','frontoOD_cyl','frontoOD_axe','frontoOG_sph','frontoOG_cyl','frontoOG_axe'];
    fields.forEach(f => {
        var val = document.getElementById('mod_' + f).value || "0";
        document.getElementById(f).value = val;
    });
    
    // Auto fill empty
    if(window.onRaChanged) window.onRaChanged(); // Calc profile base

    // Close Modal
    document.getElementById('modalInputData').classList.add('hidden');
    // Open Handedness
    document.getElementById('modalHandedness').classList.remove('hidden');
};

window.setHandedness = function(h) {
    appState.handednessEye = h;
    document.getElementById('modalHandedness').classList.add('hidden');
    // Inject Schober
    injectSchoberIntoScreen();
    // Hide standard screen, show Schober
    document.getElementById('visualScreen').classList.add('hidden');
    document.getElementById('schoberWrapper').classList.remove('hidden');
    document.getElementById('phaseTitleBar').innerText = "TEST DE SCHOBER";
};

// --- SCHOBER LOGIC & HTML INJECTION ---
const SCHOBER_PHRASES = {
    1: "Le patient voit la croix et le cercle, en m√™me temps.",
    2: "Le patient voit la croix en permanence, mais le cercle s'efface.",
    3: "Le patient voit le cercle en permanence, mais la croix s'efface.",
    4: "Alternance (D√©part OD).", 5: "Alternance (D√©part OG).",
    6: "Neutra Gauche.", 7: "Neutra Droite.", 8: "Mono OD.", 9: "Mono OG."
};

function injectSchoberIntoScreen() {
    var html = `
    <div class="schober-container">
        <div style="display:flex; gap:10px;">
            <button class="btn-schober" onclick="window.confirmSchoberSelection(1, 'bino', 'AUTO')"><svg width="60" height="60" viewBox="0 0 100 100"><line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross"/><line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross"/><circle cx="50" cy="50" r="35" class="sch-circle"/></svg></button>
            <button class="btn-schober" onclick="window.confirmSchoberSelection(2, 'bino', 'OD')"><div style="color:white;position:absolute;top:2px;left:2px;font-size:0.6rem;">OD+</div><svg width="60" height="60" viewBox="0 0 100 100"><line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross"/><line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross"/><circle cx="50" cy="50" r="35" class="sch-circle sch-faint"/></svg></button>
            <button class="btn-schober" onclick="window.confirmSchoberSelection(3, 'bino', 'OG')"><div style="color:white;position:absolute;top:2px;left:2px;font-size:0.6rem;">OG+</div><svg width="60" height="60" viewBox="0 0 100 100"><line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross sch-faint"/><line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross sch-faint"/><circle cx="50" cy="50" r="35" class="sch-circle"/></svg></button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-schober" onclick="window.confirmSchoberSelection(4, 'mono', 'OD')"><div style="color:white;position:absolute;top:2px;left:2px;font-size:0.6rem;">ALT OD</div><svg width="60" height="60" viewBox="0 0 100 100"><path d="M20 20 L40 20 L30 10 Z" fill="#fff"/><line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross"/><line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross"/></svg></button>
            <button class="btn-schober" onclick="window.confirmSchoberSelection(5, 'mono', 'OG')"><div style="color:white;position:absolute;top:2px;left:2px;font-size:0.6rem;">ALT OG</div><svg width="60" height="60" viewBox="0 0 100 100"><path d="M60 20 L80 20 L70 10 Z" fill="#fff"/><circle cx="50" cy="50" r="35" class="sch-circle"/></svg></button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-schober" onclick="window.confirmSchoberSelection(6, 'mono', 'OD')"><div style="color:white;position:absolute;top:2px;left:2px;font-size:0.6rem;">NG</div><svg width="60" height="60" viewBox="0 0 100 100"><line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross"/><line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross"/></svg></button>
            <button class="btn-schober" onclick="window.confirmSchoberSelection(7, 'mono', 'OG')"><div style="color:white;position:absolute;top:2px;left:2px;font-size:0.6rem;">ND</div><svg width="60" height="60" viewBox="0 0 100 100"><circle cx="50" cy="50" r="35" class="sch-circle"/></svg></button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-schober" style="border-style:dashed;" onclick="window.confirmSchoberSelection(8, 'mono', 'OD')">MONO OD</button>
            <button class="btn-schober" style="border-style:dashed;" onclick="window.confirmSchoberSelection(9, 'mono', 'OG')">MONO OG</button>
        </div>
    </div>`;
    document.getElementById('schoberWrapper').innerHTML = html;
}

window.confirmSchoberSelection = function(id, mode, eye) {
    appState.pendingSchober = { mode: mode, eye: eye };
    document.getElementById('schoberConfirmText').innerText = SCHOBER_PHRASES[id];
    document.getElementById('modalSchoberConfirm').classList.remove('hidden');
};

window.cancelSchober = function() { document.getElementById('modalSchoberConfirm').classList.add('hidden'); };

window.validateSchober = function() {
    document.getElementById('modalSchoberConfirm').classList.add('hidden');
    var p = appState.pendingSchober;
    // HANDLE LOGIC
    if(p.eye === 'AUTO') p.eye = appState.handednessEye || 'OD';
    
    appState.firstEye = p.eye; // Store start eye
    appState.isMonocularExam = (p.mode === 'mono');

    // Remove Schober, Show Profile Calc
    document.getElementById('schoberWrapper').classList.add('hidden');
    document.getElementById('visualScreen').classList.remove('hidden'); // Prep visual screen for later
    document.getElementById('modalProfileCalc').classList.remove('hidden');
};

window.calculateProfileAndShowData = function() {
    // Logic for calc... simplifying for dashboard version
    var score = 5; // Default logic place holder
    if(document.getElementById('chkMyopia').checked) score += 2;
    var p = (score <= 5) ? "1" : "2";
    window.forceProfileAndShowData(p);
};

window.forceProfileAndShowData = function(p) {
    appState.initProfile = p;
    document.getElementById('headerProfileVal').innerText = p;
    document.getElementById('modalProfileCalc').classList.add('hidden');
    window.openPositioningModal();
};

window.openPositioningModal = function() { document.getElementById('modalPosition').classList.remove('hidden'); };
window.startRulesAndIntro = function() {
    document.getElementById('modalPosition').classList.add('hidden');
    // Pre-fill Subjective Data with RA data for start
    document.getElementById('subjOD_sph').value = document.getElementById('raOD_sph').value;
    document.getElementById('subjOD_cyl').value = document.getElementById('raOD_cyl').value;
    document.getElementById('subjOD_axe').value = document.getElementById('raOD_axe').value;
    document.getElementById('subjOG_sph').value = document.getElementById('raOG_sph').value;
    document.getElementById('subjOG_cyl').value = document.getElementById('raOG_cyl').value;
    document.getElementById('subjOG_axe').value = document.getElementById('raOG_axe').value;
    
    appState.subj.OD.sphere = parseFloat(document.getElementById('raOD_sph').value);
    appState.subj.OG.sphere = parseFloat(document.getElementById('raOG_sph').value);

    say("Pour avoir une bonne mesure...", function() {
        document.getElementById('modalIntroConfirmation').classList.remove('hidden');
    });
};

window.confirmAndLaunch = function() {
    document.getElementById('modalIntroConfirmation').classList.add('hidden');
    window.launchExamSequence();
};

window.launchExamSequence = function() {
    appState.isRunning = true;
    appState.activeEye = appState.firstEye; // USE SELECTED EYE
    appState.examPhase = "Sb0.2"; // Or calc based on profile
    appState.targetVa = 0.06;
    setVaToIndexClosest(0.06);
    
    // Generate Input Buttons (0 to 5)
    var btnHTML = "";
    for(var i=0; i<=5; i++) { btnHTML += `<button class="btn-input" onclick="window.handleResponse(${i})">${i}</button>`; }
    document.getElementById('btnContainer').innerHTML = btnHTML;

    updateDisplay("Profil " + appState.initProfile + " - Phase " + appState.examPhase);
};

// --- CORE EXAM LOGIC UPDATES ---

function updateDisplay(msg) {
    // Update Blue Bar
    document.getElementById('phaseTitleBar').innerText = msg || appState.examPhase.toUpperCase();
    
    // Update Active Eye Indicators
    var eyeOD = document.getElementById('eyeOD');
    var eyeOG = document.getElementById('eyeOG');
    
    eyeOD.classList.remove('active'); eyeOG.classList.remove('active');
    eyeOD.style.background = "#546E7A"; eyeOG.style.background = "#546E7A"; // Grey default

    if(appState.activeEye === 'OD') {
        eyeOD.classList.add('active'); eyeOD.style.background = "#00BCD4";
    } else {
        eyeOG.classList.add('active'); eyeOG.style.background = "#00BCD4";
    }

    // Update Values in Grid
    setHTML('subjOD_sph', appState.subj.OD.sphere.toFixed(2));
    setHTML('subjOG_sph', appState.subj.OG.sphere.toFixed(2));
    
    // Update VA in eyes
    setHTML('vaValOD', appState.subj.OD.va);
    setHTML('vaValOG', appState.subj.OG.va);

    // Update Screen Letter
    var currentData = ACUITY_TABLE[appState.vaIndex];
    document.getElementById('currentVA').innerText = currentData.va;
    var txt = currentData.lines[appState.letterIndex % currentData.lines.length];
    document.getElementById('letterBox').innerText = txt;
}

// Stub functions for logic flow (reusing your existing logic structure)
window.handleResponse = function(n) {
    // Logic placeholder - Increment VA for demo
    if(n >= 3 && appState.vaIndex < ACUITY_TABLE.length-1) {
        appState.vaIndex++;
        appState.subj[appState.activeEye].va = ACUITY_TABLE[appState.vaIndex].va;
        say("Bien.");
    } else if (n < 3) {
        say("On va essayer d'am√©liorer.");
        // Switch eye logic demo
        if(appState.activeEye === appState.firstEye) {
            appState.activeEye = (appState.firstEye === 'OD') ? 'OG' : 'OD';
            appState.vaIndex = 0; // Reset for new eye
        }
    }
    updateDisplay("Examen en cours...");
};

// --- UTILITIES FOR LOGIC ---
function setVaToIndexClosest(target) { for(var i=0; i<ACUITY_TABLE.length; i++) { if(ACUITY_TABLE[i].va >= target) { appState.vaIndex = i; break; } } appState.letterIndex = 0; }

// --- RESTART FUNCTIONS ---
window.restartExam = function() { location.reload(); };
window.restartSb10 = function() { alert("Red√©marrage √©tape..."); };

// On Load
window.onRaChanged = function() {}; // Stub
window.toggleMyopiaHyper = function() {}; // Stub

</script>
</body>
</html>
