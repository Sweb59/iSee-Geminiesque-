<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Assistant R√©fraction - Dashboard Final</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

<style>
  /* --- CHARTE GRAPHIQUE --- */
  :root { 
      --bg-main: #FCF9F2;       
      --primary: #04ABC6;            
      --primary-dark: #03889E;    
      --primary-deep: #026070;    
      --primary-light: #E0F6F8;   
      --primary-border: #8CD6E2;
      --panel: #FFFFFF;            
      --text-main: #37474F;        
      --text-muted: #78909C;        
      --border: #CFD8DC;
  }

  /* RESET & BASE */
  * { box-sizing: border-box; }
  body { 
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
      background-color: var(--bg-main); 
      color: var(--text-main); 
      margin: 0; padding: 0;
      height: 100vh; 
      overflow: hidden; 
      font-size: 13px;
  }

  /* LAYOUT PRINCIPAL */
  .app-container { 
      display: flex; 
      flex-direction: column; 
      height: 100%; 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 10px;
  }

  header { 
      flex: 0 0 auto; 
      margin-bottom: 5px; 
      border-bottom: 2px solid var(--primary);
      padding-bottom: 5px;
  }
  h1 { margin: 0; color: var(--primary-dark); font-size: 1.2rem; }

  .dashboard-wrapper {
      display: flex;
      flex: 1; 
      gap: 15px;
      overflow: hidden; 
  }

  /* --- COLONNE GAUCHE --- */
  .left-panel {
      flex: 0 0 380px; 
      display: flex; 
      flex-direction: column;
      gap: 10px;
      overflow-y: auto; 
      padding-right: 5px;
  }

  /* --- COLONNE DROITE --- */
  .right-panel {
      flex: 1; 
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 15px; 
      display: flex;
      flex-direction: column;
      justify-content: center; 
      align-items: center;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 4, 198, 0.05);
      font-size: 1.1rem; 
  }

  /* STYLE DES PANNEAUX */
  .section { 
      background: var(--panel); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 10px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
    
  h2 { 
      margin-top: 0; margin-bottom: 8px; 
      color: var(--primary-dark); 
      font-size: 1rem; 
      border-bottom: 1px solid var(--primary-border); 
      padding-bottom: 2px; 
  }

  .hidden { display: none !important; }

  /* INPUTS & RESUME */
  .summary-grid { display: grid; grid-template-columns: 1fr; gap: 5px; font-size: 0.95rem; }
  .summary-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
  .summary-lbl { color: var(--text-muted); font-weight: 600; }
  .summary-val { color: var(--primary-dark); font-weight: bold; }

  .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
   
  /* Grille compacte pour la section 2 */
  .mini-data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3px; text-align: center; }
    
  label { display: block; font-weight: 600; margin-bottom: 1px; font-size: 0.75rem; color: var(--text-muted); }
  input, select { 
      width: 100%; padding: 4px; 
      border: 1px solid #ccc; border-radius: 4px; 
      font-size: 0.9rem; background: #fff;
  }
  input:disabled, select:disabled { background-color: #F5F5F5; color: #888; border-color: #E0E0E0; }

  /* CHECKBOX ALIGNMENT */
  .check-grid { display:grid; grid-template-columns: 1fr 1fr; gap:5px; text-align: left; }
  .check-lbl { 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      font-weight: normal; 
      color: var(--text-main); 
      font-size: 0.9rem;
      cursor: pointer;
      padding: 5px;
      border: 1px solid #eee;
      border-radius: 4px;
  }
  .check-lbl:hover { background: #f9f9f9; }
  .check-lbl input { width: auto; margin: 0; cursor: pointer; }

  /* --- COULEURS PERSONNALIS√âES DES DONN√âES --- */
  
  /* 1. Autor√©fractom√®tre (RA) */
  input[id^="ra"] {
      color: var(--primary);              /* Texte : Primary (Cyan) */
      background-color: var(--primary-light); /* Fond : Primary Light (Cyan tr√®s p√¢le) */
      font-family: 'Montserrat', sans-serif;  /* Police moderne */
      font-weight: 700;
      border: 1px solid var(--primary-border);
  }

  /* 2. Frontofocom√®tre */
  input[id^="fronto"] {
      color: var(--primary-border);       /* Texte : Plus clair que primary */
      background-color: #ffffff;          /* Fond : Blanc (Plus clair que primary-light) */
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
  }
    /* GRILLE VALEURS */
  .col-head { background: #ECEFF1; font-weight: bold; font-size: 0.7rem; padding: 4px 0; border-radius: 3px; }
  .col-input { padding: 3px; text-align: center; font-weight: 600; }
  .val-box { 
      background: var(--primary-light); color: var(--primary-dark);
      border: 1px solid var(--primary-border);
      font-weight: bold; font-size: 0.95rem; 
      display: flex; align-items: center; justify-content: center; 
      border-radius: 4px; min-height: 24px;
  }
  .col-max-va { background: #E8F5E9; color: #2E7D32; font-size: 0.8rem; border-color: #C8E6C9; }

  /* TITRES BLOCS DONNEES */
  .data-block-title {
      font-size: 0.75rem; font-weight:bold; color:var(--primary); text-align:center; 
      margin-bottom:3px; text-transform:uppercase; border-bottom:1px solid var(--primary-light);
  }

  /* ZONE EXAMEN */
  .exam-controls { display: flex; gap: 20px; margin-bottom: 20px; width: 100%; justify-content: center; }
   
  .eye-btn { 
      padding: 12px 40px; 
      background: var(--primary-light); 
      color: var(--primary-dark); 
      border: 1px solid transparent; 
      font-weight: bold; cursor: pointer; flex: 1; max-width: 200px; 
      border-radius: 10px; 
      transition: all 0.3s ease;
      opacity: 0.8;
      font-size: 1.2rem; 
  }
   
  .eye-btn.active { 
      background: var(--bg-main); 
      color: var(--primary-dark); 
      border: 3px solid var(--primary); 
      opacity: 1;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .eye-btn.occluded-mode {
      background-color: var(--primary-deep) !important;
      color: var(--primary-deep) !important;
      border-color: var(--primary-deep) !important;
      cursor: not-allowed;
      opacity: 0.5;
  }

  /* STYLE COLONNES SUBJECTIF */
  .subj-display-container {
      display: flex; 
      gap: 40px; 
      width: 100%; 
      margin-bottom: 20px; 
      justify-content: center;
  }

  .subj-col {
      display: flex; 
      flex-direction: column; 
      width: 220px;
      border-radius: 12px;
      padding: 15px;
      transition: all 0.3s ease;
      background: var(--primary-light); 
      border: 2px solid transparent; 
      opacity: 0.9;
  }

  .subj-col .eye-header {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      padding-bottom: 5px;
      font-size: 1.6rem;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      color: var(--primary-dark); 
  }

  /* --- MODIFICATION POLICE ICI --- */
  .subj-col .val-data { 
      font-family: 'Montserrat', sans-serif; /* Police Moderne */
      font-weight: 700; 
      font-size: 2.4rem;
      color: #90A4AE; 
      font-variant-numeric: tabular-nums; /* Alignement des chiffres */
      letter-spacing: -1px;
  }

  .subj-col.active {
      background: var(--bg-main); 
      border: 3px solid var(--primary);
      box-shadow: 0 6px 15px rgba(4, 171, 198, 0.2);
      transform: scale(1.05);
      opacity: 1;
  }

  .subj-col.active .eye-header { color: var(--primary-dark); }
  .subj-col.active .val-data { color: var(--primary); }

  .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
  .lbl-mini { font-size: 1rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }
   
  .info-bar { font-size: 1.2rem; color: var(--text-muted); margin-bottom: 10px; margin-top: 10px; }
    
  /* LETTRES */
  .letter-display { 
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      font-size: 3.5rem;
      font-weight: bold; 
      text-align: center; 
      margin: 15px 0 25px 0; 
      min-height: 80px; 
      color: #263238; 
      line-height: 1;
      letter-spacing: 5px;
  }

  /* MESSAGE BOX (CACH√âE) */
  .message-box { display: none !important; }
  .success-msg { background: #E0F2F1; color: #00695C; border-color: #B2DFDB; }

  /* BOUTONS REPONSE */
  .response-area { width: 100%; text-align: center; }
   
  .btn-grid { 
      display: flex; 
      justify-content: center; 
      gap: 40px; 
      flex-wrap: wrap; 
  }
   
  .btn-resp { 
      width: 80px; height: 80px;
      border-radius: 50%; border: none; 
      background: var(--primary-light); color: var(--primary-dark); 
      font-size: 2rem; 
      font-weight: bold; 
      cursor: pointer; transition: 0.2s; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  .btn-resp:hover { background: var(--primary); color: white; transform: scale(1.15); }
   
  .btn-resp.locked, .btn-action.locked, .btn-timer.locked, .btn-decision.locked {
      opacity: 0.5; cursor: wait; pointer-events: none;
  }

  /* ACTION BUTTONS */
  .btn-action { 
      padding: 15px 25px; border-radius: 8px; border: none; 
      color: white; font-weight: bold; cursor: pointer; 
      font-size: 1.1rem; margin-top: 10px; width: 100%;
      box-shadow: 0 3px 5px rgba(0,0,0,0.1);
      transition: background 0.2s;
  }
    
  .btn-start, .btn-validate, .btn-manual, .btn-rules { background: var(--primary); }
  .btn-start:hover, .btn-validate:hover { background: var(--primary-dark); }
  .btn-import { background: var(--primary-dark); }
  .btn-import:hover { background: var(--primary-deep); }
   
  .btn-tortue, .btn-lapin { 
      background: var(--primary-light); color: var(--primary-dark); border: 2px solid var(--primary-border); 
      font-size: 1.3rem; padding: 15px 40px; 
  }
  .btn-tortue:hover, .btn-lapin:hover { background: var(--primary); color: white; }

  /* PROFIL */
  .force-profile-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 15px; }
  .btn-profile { padding: 8px; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .p-green { background: #26A69A; } .p-blue { background: #42A5F5; }
  .p-orange { background: #FFA726; } .p-red { background: #EF5350; }

  /* BOUTONS EXAMEN */
  .btn-timer { 
      background: var(--primary); color: white; padding: 15px 35px; font-size: 1.2rem; 
      border-radius: 40px; border:none; cursor: pointer; margin-bottom: 15px;
  }
  .btn-timer:hover { background: var(--primary-dark); }
  .decision-row { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
  .btn-decision { padding: 12px 25px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
  .btn-blue { background: var(--primary); } 
  .btn-orange { background: var(--primary-dark); } 
  .btn-red { background: var(--primary-deep); } 
  .btn-green { background: var(--primary); } 
  .btn-grey { background: var(--primary-light); color: var(--primary-dark); border: 1px solid var(--primary-border); }
  .btn-grey:hover { background: var(--primary-border); }

  /* RESPONSIVE */
  @media (max-width: 900px) {
      body { overflow: auto; height: auto; } 
      .app-container { height: auto; display: block; }
      .dashboard-wrapper { display: block; } 
      .left-panel { width: 100%; margin-bottom: 15px; }
      .right-panel { min-height: 400px; }
  }

  /* MODAL */
  .modal-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(55, 71, 79, 0.9); z-index: 9999; 
      display: flex; justify-content: center; align-items: center; 
  }
  .modal-content { background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; text-align: center; }
  .modal-text { font-size: 1.2rem; line-height: 1.5; margin-bottom: 25px; color: var(--text-main); }
    
  /* Visual JCC */
  .jcc-container { display: flex; justify-content: center; gap: 50px; margin-bottom: 30px; }
  .jcc-visual { width: 100px; height: 100px; border-radius: 50%; border: 6px solid #CFD8DC; display: flex; align-items: center; justify-content: center; opacity: 0.3; }
  .jcc-visual.active { opacity: 1; border-color: var(--primary); transform: scale(1.1); box-shadow: 0 0 20px var(--primary-border); }
  .jcc-label { position: absolute; font-weight: bold; font-size: 1.8rem; color: var(--text-main); }
  .arrow-svg { width: 70px; height: 70px; }
   
  /* INPUTS MODAL */
  .modal-input-grid {
      display: flex;
      flex-direction: column; 
      gap: 10px;
      text-align: left;
      margin-bottom: 20px;
  }
  .modal-input-group label {
      display: block;
      margin-bottom: 3px;
      color: var(--text-muted);
      font-size: 0.85rem;
  }
  .modal-input-group input {
      font-size: 1.1rem;
      padding: 6px;
      text-align: center;
      border: 1px solid var(--primary-border);
      width: 100%;
  }
  .modal-eye-title {
      text-align: center;
      font-weight: bold;
      color: var(--primary-dark);
      margin-bottom: 10px;
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 5px;
      font-size: 1.1rem;
  }
  .device-header {
      font-weight: 700; color: var(--primary); margin-bottom: 15px; text-transform: uppercase; font-size: 1.1rem; text-align: center;
  }
  .data-source-lbl {
      font-weight: 600; color: var(--primary-dark); margin-bottom: 5px; margin-top: 15px; display: block;
  }
</style>
</head>
<body onload="window.startAppSequence()">

<div id="modalPatientID" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Identification du Patient</h2>
        <div class="config-grid" style="text-align:left; margin: 20px 0;">
            <div><label>Nom</label><input type="text" id="inName"></div>
            <div><label>Pr√©nom</label><input type="text" id="inForename"></div>
            <div><label>Date Naiss.</label><input type="date" id="inDob"></div>
            <div><label>UID</label><input type="text" id="inUID" readonly style="background:#ECEFF1; color:var(--primary-dark); font-weight:bold; cursor:not-allowed;"></div>
        </div>
        <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; font-size:1.1rem; border-radius:50px;" onclick="window.validatePatientID()">VALIDER</button>
    </div>
</div>

<div id="modalProfileCalc" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 700px;">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Profil Accommodatif</h2>
         
        <div class="config-grid" style="text-align:left; margin-bottom:15px;">
            <div>
                <label>Rythme des consultations par ann√©e</label>
                <select id="inRhythm"><option value="0">...</option><option value="1">1x/an</option><option value="2">1x/2ans</option><option value="3">< 1x/2ans</option></select>
            </div>
            <div>
                <label>Signes de troubles subjectifs par mois</label>
                <select id="inSigns"><option value="0">0</option><option value="2">3-4</option><option value="3">> 4</option></select>
            </div>
        </div>

        <div class="check-grid" style="margin-bottom:20px;">
            <label class="check-lbl"><input type="checkbox" id="chkMyopia" onchange="window.toggleMyopiaHyper('myopia')"> Myopie > 3 dioptries</label>
            <label class="check-lbl"><input type="checkbox" id="chkHyper" onchange="window.toggleMyopiaHyper('hyper')"> Hyperm√©tropie < 1 dioptrie</label>
            <label class="check-lbl"><input type="checkbox" id="chkNear"> Habitudes de pr√®s</label>
            <label class="check-lbl"><input type="checkbox" id="chkNoSpecs"> Lunettes Mal ou non port√©es</label>
            <label class="check-lbl"><input type="checkbox" id="chkMono"> Monophtalme</label>
        </div>

        <button class="btn-action btn-start" style="padding:15px; font-size:1.1rem;" onclick="window.calculateProfileAndShowData()">CALCUL DU PROFIL ACCOMMODATIF</button>
         
        <div style="text-align:center; margin:15px 0 5px 0; color:var(--text-muted); font-size:0.9rem;">Ou forcer le profil :</div>
        <div class="force-profile-row">
            <button class="btn-profile p-green" onclick="window.forceProfileAndShowData('1')">Bon (1)</button>
            <button class="btn-profile p-blue" onclick="window.forceProfileAndShowData('2')">Moyen</button>
            <button class="btn-profile p-orange" onclick="window.forceProfileAndShowData('3')">Difficile</button>
            <button class="btn-profile p-red" onclick="window.forceProfileAndShowData('3+')">Tr√®s Diff.</button>
        </div>
    </div>
</div>

<div id="modalEntryMethod" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Donn√©es</h2>
        <div class="modal-text">
            Saisie des donn√©es de l'autor√©fractom√®tre et du frontofocom√®tre
        </div>
        <div style="display:flex; flex-direction:column; gap:15px; justify-content:center;">
            <button class="btn-action btn-manual" style="width:100%; padding:15px 30px; font-size:1.1rem;" onclick="window.handleMethodChoice('manual')">Saisie manuelle</button>
            <button class="btn-action btn-import" style="width:100%; padding:15px 30px; font-size:1.1rem;" onclick="window.handleMethodChoice('import')">Importer les donn√©es depuis les appareils</button>
        </div>
    </div>
</div>

<div id="modalInputData" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 1100px;">
        <h2 style="color:var(--primary); border:none; font-size:1.4rem;">Saisie des Donn√©es</h2>
         
        <div style="display:flex; gap:30px; justify-content: space-between;">
             
            <div style="flex:1; border-right:2px solid #eee; padding-right:20px;">
                <div class="device-header">FRONTOFOCOM√àTRE</div>
                <div style="display:flex; gap:20px;">
                    <div style="flex:1;">
                        <div class="modal-eye-title">≈íIL DROIT</div>
                        <div class="modal-input-grid">
                            <div class="modal-input-group"><label>Sph√®re</label><input type="text" id="mod_frontoOD_sph" placeholder="Sph" inputmode="decimal" onchange="window.checkSphere(this)"></div>
                            <div class="modal-input-group"><label>Cylindre</label><input type="text" id="mod_frontoOD_cyl" placeholder="Cyl" inputmode="decimal" onchange="window.forceNegativeCyl(this)"></div>
                            <div class="modal-input-group"><label>Axe</label><input type="text" id="mod_frontoOD_axe" placeholder="Axe" inputmode="decimal" onchange="window.checkAxis(this)"></div>
                        </div>
                    </div>
                    <div style="flex:1;">
                        <div class="modal-eye-title">≈íIL GAUCHE</div>
                        <div class="modal-input-grid">
                            <div class="modal-input-group"><label>Sph√®re</label><input type="text" id="mod_frontoOG_sph" placeholder="Sph" inputmode="decimal" onchange="window.checkSphere(this)"></div>
                            <div class="modal-input-group"><label>Cylindre</label><input type="text" id="mod_frontoOG_cyl" placeholder="Cyl" inputmode="decimal" onchange="window.forceNegativeCyl(this)"></div>
                            <div class="modal-input-group"><label>Axe</label><input type="text" id="mod_frontoOG_axe" placeholder="Axe" inputmode="decimal" onchange="window.checkAxis(this)"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="flex:1; padding-left:10px;">
                <div class="device-header">AUTO-R√âFRACTOM√àTRE (RA)</div>
                <div style="display:flex; gap:20px;">
                    <div style="flex:1;">
                        <div class="modal-eye-title">≈íIL DROIT</div>
                        <div class="modal-input-grid">
                            <div class="modal-input-group"><label>Sph√®re</label><input type="text" id="mod_raOD_sph" placeholder="Sph" inputmode="decimal" onchange="window.checkSphere(this)"></div>
                            <div class="modal-input-group"><label>Cylindre</label><input type="text" id="mod_raOD_cyl" placeholder="Cyl" inputmode="decimal" onchange="window.forceNegativeCyl(this)"></div>
                            <div class="modal-input-group"><label>Axe</label><input type="text" id="mod_raOD_axe" placeholder="Axe" inputmode="decimal" onchange="window.checkAxis(this)"></div>
                        </div>
                    </div>
                    <div style="flex:1;">
                        <div class="modal-eye-title">≈íIL GAUCHE</div>
                        <div class="modal-input-grid">
                            <div class="modal-input-group"><label>Sph√®re</label><input type="text" id="mod_raOG_sph" placeholder="Sph" inputmode="decimal" onchange="window.checkSphere(this)"></div>
                            <div class="modal-input-group"><label>Cylindre</label><input type="text" id="mod_raOG_cyl" placeholder="Cyl" inputmode="decimal" onchange="window.forceNegativeCyl(this)"></div>
                            <div class="modal-input-group"><label>Axe</label><input type="text" id="mod_raOG_axe" placeholder="Axe" inputmode="decimal" onchange="window.checkAxis(this)"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <button class="btn-action btn-validate" style="width:100%; padding:15px; border-radius:8px; font-size:1.1rem; margin-top:20px;" onclick="window.confirmDataAndPosition()">VALIDER</button>
    </div>
</div>

<div id="modalPosition" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Installation</h2>
        <div class="modal-text">
            Placez le patient derri√®re la t√™te du r√©fracteur en veillant √† ce qu‚Äôil soit confortablement install√© : son front doit √™tre bien appos√© contre l‚Äôappui-front, et ses yeux parfaitement centr√©s dans les oculaires.
            <br><br>
            Assurez-vous √©galement que ses joues ne soient pas en contact avec l‚Äôappareil ‚Äî il doit √™tre possible de glisser un doigt entre ses joues et le r√©fracteur.
        </div>
        <button class="btn-action btn-rules" style="width:auto; padding:15px 40px; font-size:1.1rem; border-radius:50px;" onclick="window.startRulesAndIntro()">R√àGLES DE LECTURE</button>
    </div>
</div>

<div id="modalIntroConfirmation" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Pr√™t √† commencer ?</h2>
        <div class="modal-text">
            Assurez-vous que le patient a bien compris les r√®gles de lecture que vous venez de lui expliquer.
            <br><br>
            Si c'est le cas, vous pouvez commencer l'examen.
        </div>
        <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; border-radius:50px; font-size:1.1rem;" onclick="window.confirmAndLaunch()">LANCER L'EXAMEN</button>
    </div>
</div>

<div id="modalWarning" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary-deep); border:none; font-size:1.6rem;">Hors Limites</h2>
        <div class="modal-text">La valeur saisie est hors des limites de l‚Äôappareil. Merci de la corriger.</div>
        <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; border-radius:50px;" onclick="window.closeWarningModal()">CORRIGER</button>
    </div>
</div>

<div id="modalDefogLimit" class="modal-overlay hidden">
    <div class="modal-content" style="max-width:700px;">
        <h2 style="color:#D32F2F; border:none; font-size:1.6rem;">‚ö†Ô∏è Votre attention, s'il vous pla√Æt !</h2>
        <div class="modal-text" style="text-align:left; font-size:1rem;">
            <strong>Absence d'am√©lioration de l'acuit√© visuelle apr√®s plusieurs d√©brouillages.</strong><br><br>
            Vous avez effectu√© plusieurs √©tapes de d√©brouillage sans gain significatif d'acuit√© visuelle.<br><br>
            Rappel : R√©p√©tez vos directives au patient, v√©rifiez sa position, nettoyez les lentilles et confirmez les donn√©es de l'AR.<br><br>
            Nous vous recommandons de recommencer l'examen selon l'une des options suivantes :
        </div>
        <div id="defogButtons" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button class="btn-action btn-grey" style="white-space:normal; height:auto; padding:10px; text-align:left;" onclick="window.restartExam()">Le patient n'avait pas bien compris...</button>
            <button class="btn-action btn-validate" style="background:#D32F2F; white-space:normal; height:auto; padding:10px; text-align:left;" onclick="window.prepareCycloStop()">Le patient avait bien compris...</button>
        </div>
        <div id="saveCycloContainer" class="hidden" style="margin-top:20px;"><button class="btn-action btn-validate" style="padding:15px 30px;" onclick="window.savePatientData()">Sauvegarder les donn√©es</button></div>
    </div>
</div>

<div id="modalTqsLimit" class="modal-overlay hidden">
    <div class="modal-content" style="max-width:700px;">
        <h2 style="color:#D32F2F; border:none; font-size:1.6rem;">‚ö†Ô∏è Votre attention, s'il vous pla√Æt !</h2>
        <div class="modal-text" style="text-align:left; font-size:1rem;">
            <strong>Vous venez de brouiller de plus de 1.00 D sur la ligne de 6/10.</strong><br><br>
            Vous avez effectu√© plusieurs √©tapes de brouillage sans pouvoir bloquer l'accommodation du patient.<br><br>
            Rappel : R√©p√©tez vos directives au patient. Il est possible qu'il n'ai pas relu les lettres mais qu'il vous les a r√©p√©t√© de m√©moire. V√©rifiez √©galement sa position, il regarde peut-√™tre en dehors des oculaires.<br><br>
            Nous vous recommandons de recommencer l'examen selon l'une des options suivantes :
        </div>
        <div id="tqsButtons" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button class="btn-action btn-grey" style="white-space:normal; height:auto; padding:10px; text-align:left;" onclick="window.restartExam()">Le patient n'avait pas bien compris...</button>
            <button class="btn-action btn-validate" style="background:#D32F2F; white-space:normal; height:auto; padding:10px; text-align:left;" onclick="window.prepareCycloStopTqs()">Le patient avait bien compris...</button>
        </div>
        <div id="saveCycloContainerTqs" class="hidden" style="margin-top:20px;"><button class="btn-action btn-validate" style="padding:15px 30px;" onclick="window.savePatientData()">Sauvegarder les donn√©es</button></div>
    </div>
</div>

<div id="modalIncoherent" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary-deep); border:none; font-size:1.6rem;">R√©ponse Incoh√©rente</h2>
        <div class="modal-text">Le patient vient de vous donner une r√©ponse incoh√©rente. Il faut refaire cette partie de l'examen.</div>
        <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; border-radius:50px;" onclick="window.restartSb10()">RECOMMENCER CETTE PARTIE DE L'EXAMEN</button>
    </div>
</div>

<div class="app-container">
  <header>
      <h1>Assistant R√©fraction</h1>
  </header>

  <div class="dashboard-wrapper">
        
      <div class="left-panel">
            
          <div id="summarySection" class="section">
              <h2>1. Patient</h2>
              <div id="patientSummaryContent" style="color:#78909C; font-style:italic;">En attente d'identification...</div>
          </div>

          <div id="dataSection" class="section hidden">
              <h2 style="display:flex; justify-content:space-between;">2. Donn√©es <span id="displayProfileName" style="color:var(--primary); background:var(--primary-light); padding:2px 8px; border-radius:4px;">--</span></h2>
                
              <div style="display:flex; gap:10px; font-size:0.85rem;">
                  <div style="flex:1;">
                        <div class="data-block-title">FRONTO</div>
                        <div class="mini-data-grid">
                            <div class="col-head">OD</div> <div class="col-head">OG</div>
                            
                            <input type="text" id="frontoOD_sph" class="col-input" placeholder="Sph" tabindex="7" autocomplete="off" inputmode="decimal" oninput="window.validateNumberInput(this)" onchange="window.checkSphere(this)">
                            <input type="text" id="frontoOG_sph" class="col-input" placeholder="Sph" tabindex="10" autocomplete="off" inputmode="decimal" oninput="window.validateNumberInput(this)" onchange="window.checkSphere(this)">
                            
                            <input type="text" id="frontoOD_cyl" class="col-input" placeholder="Cyl" tabindex="9" autocomplete="off" inputmode="decimal" oninput="window.validateNumberInput(this)" onchange="window.forceNegativeCyl(this)">
                            <input type="text" id="frontoOG_cyl" class="col-input" placeholder="Cyl" tabindex="12" autocomplete="off" inputmode="decimal" oninput="window.validateNumberInput(this)" onchange="window.forceNegativeCyl(this)">
                            
                            <input type="text" id="frontoOD_axe" class="col-input" placeholder="Axe" tabindex="8" autocomplete="off" inputmode="decimal" oninput="window.validateNumberInput(this)" onchange="window.checkAxis(this)">
                            <input type="text" id="frontoOG_axe" class="col-input" placeholder="Axe" tabindex="11" autocomplete="off" inputmode="decimal" oninput="window.validateNumberInput(this)" onchange="window.checkAxis(this)">
                        </div>
                  </div>

                  <div style="flex:1;">
                        <div class="data-block-title">AUTOREF</div>
                        <div class="mini-data-grid">
                            <div class="col-head">OD</div> <div class="col-head">OG</div>
                            
                            <input type="text" id="raOD_sph" class="col-input" placeholder="Sph" tabindex="1" autocomplete="off" inputmode="decimal" oninput="window.validateNumberInput(this); window.onRaChanged()" onchange="window.checkSphere(this); window.onRaChanged()">
                            <input type="text" id="raOG_sph" class="col-input" placeholder="Sph" tabindex="4" autocomplete="off" inputmode="decimal" oninput="window.validateNumberInput(this); window.onRaChanged()" onchange="window.checkSphere(this); window.onRaChanged()">
                            
                            <input type="text" id="raOD_cyl" class="col-input" placeholder="Cyl" tabindex="3" autocomplete="off" inputmode="decimal" oninput="window.validateNumberInput(this)" onchange="window.forceNegativeCyl(this); window.onRaChanged();">
                            <input type="text" id="raOG_cyl" class="col-input" placeholder="Cyl" tabindex="6" autocomplete="off" inputmode="decimal" oninput="window.validateNumberInput(this)" onchange="window.forceNegativeCyl(this); window.onRaChanged();">
                            
                            <input type="text" id="raOD_axe" class="col-input" placeholder="Axe" tabindex="2" autocomplete="off" inputmode="decimal" oninput="window.validateNumberInput(this)" onchange="window.checkAxis(this); window.onRaChanged();">
                            <input type="text" id="raOG_axe" class="col-input" placeholder="Axe" tabindex="5" autocomplete="off" inputmode="decimal" oninput="window.validateNumberInput(this)" onchange="window.checkAxis(this); window.onRaChanged();">
                        </div>
                  </div>
              </div>
          </div>

          <div id="timeSection" class="section" style="text-align:center; margin-top:0;">
              <div id="displayDate" style="font-size:1.1rem; font-weight:bold; color:var(--primary-dark); text-transform:capitalize;">--</div>
              <div id="displayTime" style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px;">--:--</div>
              <div style="border-top:1px solid #eee; padding-top:10px;">
                  <div style="font-size:0.8rem; text-transform:uppercase; color:var(--text-muted);">Dur√©e Examen</div>
                  <div id="displayChrono" style="font-size:2rem; font-weight:bold; font-family:monospace; color:var(--primary);">00:00</div>
              </div>
          </div>

      </div>

      <div class="right-panel">
            
          <div id="waitingMsg" style="text-align:center; color:#B0BEC5;">
              <svg style="width:60px; height:60px; margin-bottom:10px;" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
              <p>L'examen commencera ici.</p>
          </div>

          <div id="examContent" class="hidden" style="width:100%;">
                
              <div class="exam-controls">
                  <button id="btnOD" class="eye-btn active" onclick="window.setEye('OD')">≈íIL DROIT</button>
                  <button id="btnOG" class="eye-btn" onclick="window.setEye('OG')">≈íIL GAUCHE</button>
              </div>

              <div class="subj-display-container">
                  <div id="subjDispOD" class="subj-col">
                      <div class="eye-header">OD</div>
                      <div class="data-row"><span class="lbl-mini">SPH</span><span id="disp_subjOD_sph" class="val-data">--</span></div>
                      <div class="data-row"><span class="lbl-mini">CYL</span><span id="disp_subjOD_cyl" class="val-data">--</span></div>
                      <div class="data-row"><span class="lbl-mini">AXE</span><span id="disp_subjOD_axe" class="val-data">--¬∞</span></div>
                      <div class="data-row"><span class="lbl-mini">VA</span><span id="disp_subjOD_va" class="val-data">--</span></div>
                  </div>
                  <div id="subjDispOG" class="subj-col">
                      <div class="eye-header">OG</div>
                      <div class="data-row"><span class="lbl-mini">SPH</span><span id="disp_subjOG_sph" class="val-data">--</span></div>
                      <div class="data-row"><span class="lbl-mini">CYL</span><span id="disp_subjOG_cyl" class="val-data">--</span></div>
                      <div class="data-row"><span class="lbl-mini">AXE</span><span id="disp_subjOG_axe" class="val-data">--¬∞</span></div>
                      <div class="data-row"><span class="lbl-mini">VA</span><span id="disp_subjOG_va" class="val-data">--</span></div>
                  </div>
              </div>

              <div class="info-bar">
                  ACUIT√â VISUELLE : <strong id="valVA" style="font-size:1.8rem !important; color:var(--primary-dark);">--</strong>
              </div>

              <div id="letterBox" class="letter-display">...</div>
                
              <div id="systemMsg" class="message-box">En attente...</div>

              <div id="standardButtons" class="response-area">
                  <p style="margin-bottom:10px; font-weight:600; color:var(--text-muted);">Combien de lettres lues ?</p>
                  <div id="btnContainer" class="btn-grid"></div>
              </div>

              <div id="cadenceButtons" class="response-area hidden">
                  <p style="margin-bottom:10px; font-weight:600;">Vitesse de lecture ?</p>
                  <div style="display:flex; justify-content:center; gap:15px;">
                      <button class="btn-action btn-tortue" onclick="window.handleCadence('turtle')">üê¢ H√©sitant</button>
                      <button class="btn-action btn-lapin" onclick="window.handleCadence('rabbit')">üêá Fluide</button>
                  </div>
              </div>

              <div id="checkPlusZone" class="response-area hidden">
                  <div id="stepPlusWrapper">
                      <button id="btnPlus025" class="btn-timer hidden" onclick="window.triggerFogCheck()">TESTER +0.25 (3s)</button>
                      
                      <div id="decisionsPlus" class="decision-row hidden">
                          <button class="btn-decision btn-blue" onclick="window.decidePlus('better')">Mieux avec le verre</button>
                          <button class="btn-decision btn-blue" onclick="window.decidePlus('same')">Pareil</button>
                          <button class="btn-decision btn-orange" onclick="window.decidePlus('worse')">Mieux sans le verre</button>
                          <div class="spacer-btn"></div>
                          <button class="btn-decision btn-grey" onclick="window.relaunchPlus()">Relancer</button>
                      </div>
                  </div>
                    
                  <div id="stepMinusWrapper" class="hidden">
                      <button id="btnMinus025" class="btn-timer hidden" onclick="window.triggerDefogCheck()">TESTER -0.25 (1.5s)</button>
                      
                      <div id="decisionsMinus" class="decision-row hidden">
                          <button class="btn-decision btn-red" onclick="window.decideMinus('better')">Mieux avec le verre</button>
                          <button class="btn-decision btn-orange" onclick="window.decideMinus('same')">Pareil</button>
                          <button class="btn-decision btn-orange" onclick="window.decideMinus('worse')">Mieux sans le verre</button>
                          <div class="spacer-btn"></div>
                          <button class="btn-decision btn-grey" onclick="window.relaunchFullCheck()">Relancer</button>
                      </div>
                  </div>
              </div>

              <div id="axisZone" class="response-area hidden">
                  <div id="jccVisuals" class="jcc-container hidden">
                      <div id="visPos1" class="jcc-visual">
                          <span class="jcc-label">1</span>
                          <svg class="arrow-svg" viewBox="0 0 100 100">
                              <path d="M50 10 A40 40 0 0 1 90 50" fill="none" stroke="#116dff" stroke-width="6" marker-end="url(#arrowhead)" />
                          </svg>
                      </div>
                      <div id="visPos2" class="jcc-visual">
                          <span class="jcc-label">2</span>
                          <svg class="arrow-svg" viewBox="0 0 100 100">
                              <path d="M50 10 A40 40 0 0 0 10 50" fill="none" stroke="#fd7e14" stroke-width="6" marker-end="url(#arrowhead2)" />
                          </svg>
                      </div>
                  </div>
                  <div id="axisControls">
                      <button id="btnReplayAxis" class="btn-timer hidden" onclick="window.runJccSequence()">R√âP√âTER LA COMPARAISON</button>
                      <div id="axisDecisions" class="decision-row hidden">
                          <button class="btn-decision btn-blue" onclick="window.handleJccChoice('pos1')">Mieux 1</button>
                          <button class="btn-decision btn-orange" onclick="window.handleJccChoice('pos2')">Mieux 2</button>
                          <button class="btn-decision btn-green" onclick="window.handleJccChoice('same')">Pareil</button>
                      </div>
                  </div>
              </div>

          </div>
      </div>
  </div>
   
  <svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
    <defs>
      <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#116dff" /></marker>
      <marker id="arrowhead2" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#fd7e14" /></marker>
    </defs>
  </svg>
</div>

<script>
// --- STARTUP LOGIC ---
window.startAppSequence = function() {
    window.initVoices();
    window.initClock(); // D√©marrage Horloge
    // G√©n√©ration UID imm√©diate
    var uid = window.generateShortUID();
    document.getElementById('inUID').value = uid;
    
    // Ouverture Fen√™tre 1 (Identification)
    document.getElementById('modalPatientID').classList.remove('hidden');
};

// Transition Fen√™tre 1 -> Fen√™tre 2
window.validatePatientID = function() {
    var dob = document.getElementById('inDob').value;
    if(!dob) { alert("La date de naissance est obligatoire."); return; }
    
    document.getElementById('modalPatientID').classList.add('hidden');
    document.getElementById('modalProfileCalc').classList.remove('hidden');
};

// --- CLOCK & CHRONO ---
window.initClock = function() {
    setInterval(function() {
        var now = new Date();
        // Date format: "Dimanche 14 D√©cembre"
        var options = { weekday: 'long', day: 'numeric', month: 'long' };
        var dateStr = now.toLocaleDateString('fr-FR', options);
        document.getElementById('displayDate').innerText = dateStr;
        
        // Time format: "14:30"
        var timeStr = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
        document.getElementById('displayTime').innerText = timeStr;
    }, 1000);
};

var chronoInterval = null;
var startTime = null;
window.startChrono = function() {
    if(chronoInterval) return; // D√©j√† d√©marr√©
    startTime = Date.now();
    chronoInterval = setInterval(function() {
        var delta = Date.now() - startTime;
        var totalSeconds = Math.floor(delta / 1000);
        var m = Math.floor(totalSeconds / 60);
        var s = totalSeconds % 60;
        // Format MM:SS
        var mStr = m < 10 ? "0" + m : m;
        var sStr = s < 10 ? "0" + s : s;
        document.getElementById('displayChrono').innerText = mStr + ":" + sStr;
    }, 1000);
};

// --- GLOBALS PROMPTS ---
window.NEXT_PROMPTS = ["et ici ?", "lisez moi ces lettres l√†", "et celles-ci ?", "pouvez-vous lire ces lettres ci ?"];
window.getRandomPrompt = function() {
    return window.NEXT_PROMPTS[Math.floor(Math.random() * window.NEXT_PROMPTS.length)];
};

// --- FONCTIONS UTILITAIRES ---
window.getVal = function(id) { 
    var el = document.getElementById(id);
    if(!el || !el.value) return 0;
    return parseFloat(el.value.replace(',', '.')) || 0; 
};
window.setHTML = function(id, val) { 
    var el = document.getElementById(id); if(el) el.innerHTML = val;
};
window.generateShortUID = function() {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let part1 = "", part2 = "";
    for(let i=0; i<3; i++) part1 += chars.charAt(Math.floor(Math.random() * chars.length));
    for(let i=0; i<3; i++) part2 += chars.charAt(Math.floor(Math.random() * chars.length));
    return part1 + "-" + part2;
};

// --- VALIDATION SAISIE NUMERIQUE & FORMATAGE ---
window.validateNumberInput = function(el) {
    el.value = el.value.replace(/[^0-9.,-]/g, '');
};

// --- MODALE WARNING ---
window.closeWarningModal = function() {
    document.getElementById('modalWarning').classList.add('hidden');
    if(appState.lastInvalidInputId) {
        var el = document.getElementById(appState.lastInvalidInputId);
        if(el) {
            el.value = ""; // Vide le champ en erreur
            el.focus();    // Redonne le focus
        }
        appState.lastInvalidInputId = null;
    }
};

window.checkSphere = function(el) {
    if(!el.value) return;
    var val = parseFloat(el.value.replace(',', '.'));
    if(isNaN(val)) return;

    // CHECK LIMITES AVANT CORRECTION
    if (val < -29.00 || val > 26.75) {
        appState.lastInvalidInputId = el.id;
        document.getElementById('modalWarning').classList.remove('hidden');
        return;
    }

    val = Math.round(val * 4) / 4; // Step 0.25
    el.value = val.toFixed(2);
};

window.forceNegativeCyl = function(el) {
    if(!el.value) return;
    var val = parseFloat(el.value.replace(',', '.'));
    if(isNaN(val)) return;
    
    // Auto-conversion positif -> n√©gatif (Logique Opto Standard)
    if(val > 0) val = -val;

    // CHECK LIMITES (-10.00 √† 0)
    if (val < -10.00 || val > 0) {
        appState.lastInvalidInputId = el.id;
        document.getElementById('modalWarning').classList.remove('hidden');
        return;
    }

    val = Math.round(val * 4) / 4; // Step 0.25
    el.value = val.toFixed(2);
};

// Fonction normalisation axe (0-175 avec modulo 180)
function normalizeAxis(val) {
    // Arrondi au pas de 5
    val = Math.round(val / 5) * 5;
    // Modulo 180 qui g√®re les n√©gatifs (ex: -5 => 175)
    val = (val % 180 + 180) % 180;
    return val;
}

window.checkAxis = function(el) {
    if(!el.value) return;
    var val = parseFloat(el.value);
    if(isNaN(val)) return;

    // NOUVELLE VALIDATION: Limites strictes pour √©viter les fautes de frappe (ex: 1400)
    if (val < 0 || val > 180) {
        appState.lastInvalidInputId = el.id;
        document.getElementById('modalWarning').classList.remove('hidden');
        return;
    }

    val = normalizeAxis(val);
    el.value = val;
};

// --- LOGIQUE CHECKBOX ---
window.toggleMyopiaHyper = function(source) {
    var chkMyopia = document.getElementById('chkMyopia');
    var chkHyper = document.getElementById('chkHyper');
    if(source === 'myopia' && chkMyopia.checked) {
        chkHyper.checked = false;
    } else if(source === 'hyper' && chkHyper.checked) {
        chkMyopia.checked = false;
    }
};

// --- TTS & LOCK ---
window.initVoices = function() {
    window.checkMyopia();
    window.speechSynthesis.getVoices();
}
function say(textOrArray, callback) {
    if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();
    
    // LOCK
    appState.isSpeaking = true;
    updateLockUI(true);

    var text = Array.isArray(textOrArray) ? textOrArray[Math.floor(Math.random() * textOrArray.length)] : textOrArray;
    var u = new SpeechSynthesisUtterance(text);
    u.lang = 'fr-FR'; u.rate = 1.0; 
    var voices = window.speechSynthesis.getVoices();
    var bestVoice = voices.find(function(v) { return v.lang.includes('fr') && (v.name.includes('Google') || v.name.includes('Thomas')); });
    if (!bestVoice) bestVoice = voices.find(function(v) { return v.lang.includes('fr'); });
    if (bestVoice) u.voice = bestVoice;
    
    u.onend = function() {
        // UNLOCK
        appState.isSpeaking = false;
        updateLockUI(false);
        if (callback) callback();
    };
    u.onerror = function() {
        appState.isSpeaking = false;
        updateLockUI(false);
    };

    window.speechSynthesis.speak(u);
}

function updateLockUI(locked) {
    // Applique une classe visuelle aux boutons pour indiquer qu'ils sont bloqu√©s
    var btns = document.querySelectorAll('.btn-resp, .btn-action, .btn-timer, .btn-decision');
    btns.forEach(function(b) {
        if(locked) b.classList.add('locked');
        else b.classList.remove('locked');
    });
}

// --- LOGIQUE AGE ---
function getAgeFromDob(dobString) {
    var today = new Date(); var birthDate = new Date(dobString);
    var age = today.getFullYear() - birthDate.getFullYear();
    var m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
    return age;
}
function getAgeScore(age) {
    if (age <= 10) return 6; if (age <= 20) return 5; 
    if (age <= 30) return 4; if (age <= 50) return 2; 
    if (age <= 70) return 1; return 0; 
}
window.checkMyopia = function() {
    var s1 = window.getVal('raOD_sph'); var s2 = window.getVal('raOG_sph');
    var btn = document.getElementById('btnProfile1');
    if (btn) { if (s1 < 0 || s2 < 0) { btn.style.display = 'none'; } else { btn.style.display = 'inline-block'; } }
};

// --- DATA ---
var ACUITY_TABLE = [
    { va: 0.04, lines: ["U", "P", "F", "V"] },
    { va: 0.05, lines: ["E", "Z", "N", "R"] },
    { va: 0.06, lines: ["H", "U", "D", "V"] },
    { va: 0.08, lines: ["N Z", "P U", "V H"] },
    { va: 0.10, lines: ["D U F", "P H N"] },
    { va: 0.12, lines: ["E N R", "R H P"] },
    { va: 0.16, lines: ["U P H", "V R F"] },
    { va: 0.20, lines: ["N Z V", "P R H"] },
    { va: 0.25, lines: ["H D F", "U R Z"] },
    { va: 0.32, lines: ["D F U N R", "R U P E H"] },
    { va: 0.40, lines: ["Z V D F H", "U V N R Z"] },
    { va: 0.50, lines: ["U R N P E", "R U P E H"] },
    { va: 0.60, lines: ["V N R U F", "R H U E P"] },
    { va: 0.80, lines: ["F D U R N", "P R H U E"] },
    { va: 1.00, lines: ["H P Z E V", "H D E P N"] },
    { va: 1.25, lines: ["H E P U R", "E P N R U"] },
    { va: 1.60, lines: ["Z R N V U", "U R N P E"] },
    { va: 2.00, lines: ["V H F D Z", "R N U F D"] }
];

var appState = {
    isRunning: false, activeEye: 'OD', firstEye: 'OD', profile: null, initProfile: null, 
    baseProfile: null, 
    isSpeaking: false, // Variable de lock
    subj: { OD: { sphere: 0, cyl: 0, axe: 0, va: "--" }, OG: { sphere: 0, cyl: 0, axe: 0, va: "--" } },
    memCyl: { OD: null, OG: null }, 
    vaIndex: 0, startVaIndex: 0, letterIndex: 0, pendingLetters: null, defoggedInZone: false,
    examPhase: "Sb0.2", patientInfo: { name: "", forename: "", dob: "", age: 0, uid: "" },
    sb02_OD_ok: false, sb02_OG_ok: false, seen025_OD: false, seen025_OG: false,
    sb05_OD_ok: false, sb05_OG_ok: false, sb10_OD_ok: false, sb10_OG_ok: false,
    tqs_attempted_06: false, count06_validations: 0, tqsFogCount: 0, checkStep: null, tempScore: 0, baseSphereValue: 0,
    
    // --- NOUVEAUX √âTATS DE S√âCURIT√â ---
    sb10_line_defog: 0, 
    safety_mode: false,
    safety_mem_letters: 0,
    hasRestartedSb10: false, // Flag anti-boucle
    // ----------------------------------

    saved_sb05: { OD: 0, OG: 0 }, saved_sb10: { OD: 0, OG: 0 },
    axisStep: 20, axisDirectionHistory: [], cylHigh: false,
    lastInvalidInputId: null 
};

// --- LOGIQUE WORKFLOW ---

// 1. CALCUL PROFIL
window.calculateProfileAndShowData = function() {
    var age = getAgeFromDob(document.getElementById('inDob').value);
    var score = getAgeScore(age);
    score += parseInt(document.getElementById('inRhythm').value);
    score += parseInt(document.getElementById('inSigns').value);
    if(document.getElementById('chkMyopia').checked) score += 1;
    if(document.getElementById('chkHyper').checked) score += 1;
    if(document.getElementById('chkNear').checked) score += 1;
    if(document.getElementById('chkNoSpecs').checked) score += 1;
    if(document.getElementById('chkMono').checked) score += 1;

    var p = (score <= 5) ? "1" : (score <= 8) ? "2" : (score <= 12) ? "3" : "3+";
    appState.baseProfile = p;
    var finalProfile = p;
    var s1 = window.getVal('raOD_sph');
    var s2 = window.getVal('raOG_sph');
    if (p === "1" && (s1 < 0 || s2 < 0)) { finalProfile = "2"; }
    revealDataSection(finalProfile, false);
};

window.forceProfileAndShowData = function(forcedProfile) {
    appState.baseProfile = forcedProfile;
    var finalProfile = forcedProfile;
    if (forcedProfile === '1') {
        var s1 = window.getVal('raOD_sph');
        var s2 = window.getVal('raOG_sph');
        if (s1 < 0 || s2 < 0) { finalProfile = '2'; }
    }
    revealDataSection(finalProfile, false);
};

function revealDataSection(profile, inputsEnabled) {
    appState.initProfile = profile; 
    setHTML('displayProfileName', profile);
    
    // Fermeture Fen√™tre 2
    document.getElementById('modalProfileCalc').classList.add('hidden');
    
    // Remplissage du R√©sum√© Patient dans la colonne gauche
    var nom = document.getElementById('inName').value || "-";
    var prenom = document.getElementById('inForename').value || "-";
    var dob = document.getElementById('inDob').value;
    var age = dob ? getAgeFromDob(dob) + " ans" : "-";
    var uid = document.getElementById('inUID').value;
    
    var summaryHTML = `
        <div class="summary-grid">
            <div class="summary-row"><span class="summary-lbl">Nom</span><span class="summary-val">${nom.toUpperCase()} ${prenom}</span></div>
            <div class="summary-row"><span class="summary-lbl">Age</span><span class="summary-val">${age}</span></div>
            <div class="summary-row"><span class="summary-lbl">UID</span><span class="summary-val" style="font-family:monospace;">${uid}</span></div>
            <div class="summary-row"><span class="summary-lbl">Profil</span><span class="summary-val" style="background:${getProfileColor(profile)}; color:white; padding:0 5px; border-radius:3px;">${profile}</span></div>
        </div>
    `;
    document.getElementById('patientSummaryContent').innerHTML = summaryHTML;

    // Affichage des donn√©es (qui sont vides pour l'instant)
    document.getElementById('dataSection').classList.remove('hidden');
    toggleInputs('dataSection', inputsEnabled);
    
    // Ouverture Fen√™tre 3 (Choix M√©thode)
    document.getElementById('modalEntryMethod').classList.remove('hidden');
}

function getProfileColor(p) {
    if(p==='1') return '#26A69A'; if(p==='2') return '#42A5F5'; if(p==='3') return '#FFA726'; return '#EF5350';
}

// 2. MODES SAISIE ET IMPORT (GESTION DE LA NOUVELLE MODALE DE CHOIX)

// Fonction appel√©e par les boutons de la modale "Importation des donn√©es"
window.handleMethodChoice = function(method) {
    // 1. Fermer la modale de choix
    document.getElementById('modalEntryMethod').classList.add('hidden');

    // 2. Rediriger selon le choix
    if (method === 'manual') {
        window.openDataEntryModal();
    } else {
        window.simulateImport();
    }
};

// Ouvre la modale de saisie manuelle (vide ou pr√©-remplie)
window.openDataEntryModal = function() {
    syncModalWithMain();
    document.getElementById('modalInputData').classList.remove('hidden');
};

// Simule un import, remplit les champs de la modale et l'ouvre
window.simulateImport = function() {
    document.getElementById('mod_raOD_sph').value = "-1.50";
    document.getElementById('mod_raOD_cyl').value = "-0.50";
    document.getElementById('mod_raOD_axe').value = "180";
    
    document.getElementById('mod_raOG_sph').value = "-1.75";
    document.getElementById('mod_raOG_cyl').value = "-0.25";
    document.getElementById('mod_raOG_axe').value = "170";

    document.getElementById('modalInputData').classList.remove('hidden');
};

// Fonction interne pour pr√©-remplir la modale si des donn√©es existent d√©j√†
function syncModalWithMain() {
    // Sync RA
    document.getElementById('mod_raOD_sph').value = document.getElementById('raOD_sph').value;
    document.getElementById('mod_raOD_cyl').value = document.getElementById('raOD_cyl').value;
    document.getElementById('mod_raOD_axe').value = document.getElementById('raOD_axe').value;
    
    document.getElementById('mod_raOG_sph').value = document.getElementById('raOG_sph').value;
    document.getElementById('mod_raOG_cyl').value = document.getElementById('raOG_cyl').value;
    document.getElementById('mod_raOG_axe').value = document.getElementById('raOG_axe').value;

    // Sync Fronto
    document.getElementById('mod_frontoOD_sph').value = document.getElementById('frontoOD_sph').value;
    document.getElementById('mod_frontoOD_cyl').value = document.getElementById('frontoOD_cyl').value;
    document.getElementById('mod_frontoOD_axe').value = document.getElementById('frontoOD_axe').value;
    
    document.getElementById('mod_frontoOG_sph').value = document.getElementById('frontoOG_sph').value;
    document.getElementById('mod_frontoOG_cyl').value = document.getElementById('frontoOG_cyl').value;
    document.getElementById('mod_frontoOG_axe').value = document.getElementById('frontoOG_axe').value;
}

// Validation de la Modale de Saisie -> Transfert vers le code -> Ouverture Modale Position
window.confirmDataAndPosition = function() {
    // 1. Transfert des valeurs de la modale vers les inputs principaux
    // RA
    document.getElementById('raOD_sph').value = document.getElementById('mod_raOD_sph').value;
    document.getElementById('raOD_cyl').value = document.getElementById('mod_raOD_cyl').value;
    document.getElementById('raOD_axe').value = document.getElementById('mod_raOD_axe').value;
    
    document.getElementById('raOG_sph').value = document.getElementById('mod_raOG_sph').value;
    document.getElementById('raOG_cyl').value = document.getElementById('mod_raOG_cyl').value;
    document.getElementById('raOG_axe').value = document.getElementById('mod_raOG_axe').value;

    // Fronto
    document.getElementById('frontoOD_sph').value = document.getElementById('mod_frontoOD_sph').value;
    document.getElementById('frontoOD_cyl').value = document.getElementById('mod_frontoOD_cyl').value;
    document.getElementById('frontoOD_axe').value = document.getElementById('mod_frontoOD_axe').value;
    
    document.getElementById('frontoOG_sph').value = document.getElementById('mod_frontoOG_sph').value;
    document.getElementById('frontoOG_cyl').value = document.getElementById('mod_frontoOG_cyl').value;
    document.getElementById('frontoOG_axe').value = document.getElementById('mod_frontoOG_axe').value;

    // --- AJOUT : REMPLISSAGE AUTOMATIQUE DES VALEURS VIDES (0.00 et 0¬∞) ---
    var prefixes = ['raOD', 'raOG', 'frontoOD', 'frontoOG'];
    prefixes.forEach(function(p) {
        // Sph√®re
        var s = document.getElementById(p + '_sph');
        if (!s.value || s.value.trim() === '') s.value = "0.00";
        
        // Cylindre
        var c = document.getElementById(p + '_cyl');
        if (!c.value || c.value.trim() === '') c.value = "0.00";
        
        // Axe
        var a = document.getElementById(p + '_axe');
        if (!a.value || a.value.trim() === '') a.value = "0¬∞";
    });
    // -----------------------------------------------------------------------

    // 2. D√©clenche les calculs li√©s au changement de valeurs (pour le profil)
    window.onRaChanged();

    // 3. Ferme la modale de saisie
    document.getElementById('modalInputData').classList.add('hidden');

    // 4. Ouvre la modale suivante (Positionnement)
    window.openPositioningModal();
};
function toggleInputs(sectionId, enable) {
    var sec = document.getElementById(sectionId);
    if(sec) {
        var inputs = sec.querySelectorAll('input:not([readonly]), select');
        inputs.forEach(function(el) { el.disabled = !enable; });
    }
}

// MISE A JOUR DYNAMIQUE DU PROFIL (Reversible)
window.onRaChanged = function() { 
    window.checkMyopia();
    if (appState.baseProfile === "1") {
        var s1 = window.getVal('raOD_sph');
        var s2 = window.getVal('raOG_sph');
        if (s1 < 0 || s2 < 0) { appState.initProfile = "2"; setHTML('displayProfileName', "2"); } 
        else { appState.initProfile = "1"; setHTML('displayProfileName', "1"); }
        
        // Mise √† jour visuelle du r√©sum√©
        var p = appState.initProfile;
        // On ne met √† jour que si le r√©sum√© est d√©j√† affich√©
        var el = document.querySelector('.summary-val[style*="background"]');
        if(el) {
            el.innerText = p;
            el.style.background = getProfileColor(p);
        }
    }
};

// 3. INSTALLATION & REGLES
window.openPositioningModal = function() {
    toggleInputs('dataSection', false);
    // CORRECTION : PLUS DE MANIPULATION DE btnPosition QUI N'EXISTE PLUS
    // document.getElementById('btnPosition').classList.add('hidden'); 
    document.getElementById('modalPosition').classList.remove('hidden');
};

window.startRulesAndIntro = function() {
    document.getElementById('modalPosition').classList.add('hidden');
    
    // Copie RA -> Subj (Affichage sans brouillage)
    var raOD = { s: getVal('raOD_sph'), c: getVal('raOD_cyl'), a: getVal('raOD_axe') };
    var raOG = { s: getVal('raOG_sph'), c: getVal('raOG_cyl'), a: getVal('raOG_axe') };
      
    // MAJ: Utilisation des nouveaux IDs d'affichage
    setHTML('disp_subjOD_sph', raOD.s.toFixed(2)); setHTML('disp_subjOG_sph', raOG.s.toFixed(2));
    setHTML('disp_subjOD_cyl', raOD.c.toFixed(2)); setHTML('disp_subjOG_cyl', raOG.c.toFixed(2));
    setHTML('disp_subjOD_axe', normalizeAxis(raOD.a) + "¬∞"); setHTML('disp_subjOG_axe', normalizeAxis(raOG.a) + "¬∞");
    setHTML('disp_subjOD_va', "--"); setHTML('disp_subjOG_va', "--");

    var introText = "Pour avoir une bonne mesure de votre vision de loin, il faut lire d‚Äôune mani√®re naturelle, c‚Äôest √† dire rapide et spontan√©e. Si vous ne pouvez pas lire vous le dites tout de suite, et si vous faites une erreur, comme vous avez lu naturellement, elle sera plus facile √† corriger ! Mais si vous lisez d‚Äôune mani√®re lente et r√©fl√©chie, le risque est de masquer vos erreurs et on ne peut pas am√©liorer une personne qui ne veut pas se tromper ! Donc il faut lire vite, si vous ne pouvez pas vous le dites tout de suite et si vous vous trompez aucune importance !";
    
    say(introText, function() {
        document.getElementById('modalIntroConfirmation').classList.remove('hidden');
    });
};

window.confirmAndLaunch = function() {
    document.getElementById('modalIntroConfirmation').classList.add('hidden');
    window.startChrono(); // DEMARRAGE CHRONO ICI
    window.triggerFinalStart();
};

window.triggerFinalStart = function() {
    // PRE-CALCUL DEBROUILLAGE Sb0.5 (Pour que le 2eme oeil soit pret)
    var raOD_sph = getVal('raOD_sph');
    var raOG_sph = getVal('raOG_sph');
    
    // On calcule le delta potentiel d√®s maintenant (pour l'utiliser plus tard)
    appState.deltaSb05_OD = (raOD_sph < 0) ? -0.75 : -0.50;
    appState.deltaSb05_OG = (raOG_sph < 0) ? -0.75 : -0.50;

    window.launchExamSequence();
};

// 4. LANCEMENT TECHNIQUE
window.launchExamSequence = function() {
    try {
        var raOD = { s: getVal('raOD_sph'), c: getVal('raOD_cyl'), a: getVal('raOD_axe') };
        var raOG = { s: getVal('raOG_sph'), c: getVal('raOG_cyl'), a: getVal('raOG_axe') };
        
        // Normalisation des axes RA
        raOD.a = normalizeAxis(raOD.a);
        raOG.a = normalizeAxis(raOG.a);

        var p = appState.initProfile;

        // Check Myopie force profil (Redondance de s√©curit√©)
        if (p === '1' && (raOD.s < 0 || raOG.s < 0)) { p = '2'; setHTML('displayProfileName', '2'); }
        appState.profile = p;

        // Calcul Brouillage
        if (p === "3" || p === "3+") {
            var fogOD = (raOD.s < 0) ? 2.00 : 2.25; var fogOG = (raOG.s < 0) ? 2.00 : 2.25;
            appState.subj.OD = { sphere: raOD.s + fogOD, cyl: raOD.c, axe: raOD.a, va: "--" };
            appState.subj.OG = { sphere: raOG.s + fogOG, cyl: raOG.c, axe: raOG.a, va: "--" };
            appState.examPhase = "Sb0.2"; appState.targetVa = 0.06;
            
            // LOGIQUE SPECIALE CYLINDRE -0.25 en Profil 3/3+
            if (appState.subj.OD.cyl === -0.25) {
                appState.memCyl.OD = { cyl: -0.25, axe: appState.subj.OD.axe };
                appState.subj.OD.cyl = 0; appState.subj.OD.axe = 0;
            }
            if (appState.subj.OG.cyl === -0.25) {
                appState.memCyl.OG = { cyl: -0.25, axe: appState.subj.OG.axe };
                appState.subj.OG.cyl = 0; appState.subj.OG.axe = 0;
            }
        } else if (p === "2") {
            var fogOD = (raOD.s < 0) ? 0.75 : 1.00; var fogOG = (raOG.s < 0) ? 0.75 : 1.00;
            appState.subj.OD = { sphere: raOD.s + fogOD, cyl: raOD.c, axe: raOD.a, va: "--" };
            appState.subj.OG = { sphere: raOG.s + fogOG, cyl: raOG.c, axe: raOG.a, va: "--" };
            appState.examPhase = "Sb0.5"; appState.targetVa = 0.32;
        } else {
            appState.subj.OD = { sphere: raOD.s, cyl: raOD.c, axe: raOD.a, va: "--" };
            appState.subj.OG = { sphere: raOG.s + 0.75, cyl: raOG.c, axe: raOG.a, va: "--" };
            appState.saved_sb05 = { OD: raOD.s + 0.75, OG: raOG.s + 0.75 };
            appState.examPhase = "Sb1.0"; appState.targetVa = 0.50;
        }

        // Init Exam
        appState.isRunning = true; appState.activeEye = 'OD'; appState.firstEye = 'OD';
        appState.defoggedInZone = false;
        setVaToIndexClosest(appState.targetVa); appState.startVaIndex = appState.vaIndex;

        // Reset flags
        appState.sb02_OD_ok=false; appState.sb02_OG_ok=false; appState.seen025_OD=false; appState.seen025_OG=false;
        appState.sb05_OD_ok=false; appState.sb05_OG_ok=false; appState.sb10_OD_ok=false; appState.sb10_OG_ok=false;
        appState.saved_sb10 = { OD: 0, OG: 0 };

        if (appState.profile === "2") { 
             appState.tqsFogCount = 0;
             appState.sb02_OD_ok = true; appState.sb02_OG_ok = true; 
        }
        else if (appState.profile === "1") { appState.sb02_OD_ok = true; appState.sb02_OG_ok = true; appState.sb05_OD_ok = true; appState.sb05_OG_ok = true; }

        // Affichage Zone
        document.getElementById('waitingMsg').classList.add('hidden');
        document.getElementById('examContent').classList.remove('hidden');
        updateDisplay("Profil " + appState.profile + ". Phase " + appState.examPhase + " (OD)");
          
        say("Lisez moi s'il vous plait les lettres que vous voyez sur l'√©cran au fond de la pi√®ce");
    } catch(e) { alert("Erreur Lancement: " + e); }
};

// ... SUITE LOGIQUE (TargetEye, Validate, ProcessLogic...) ...
function getTargetEye() { return (appState.activeEye === 'OD') ? appState.subj.OD : appState.subj.OG; }

function validateSb02() {
    var eye = appState.activeEye;
    if (eye === 'OD') appState.sb02_OD_ok = true; else appState.sb02_OG_ok = true;
    say("On va de l'autre c√¥t√©.", function() {
        if (appState.sb02_OD_ok && appState.sb02_OG_ok) { 
            // TOUT LE MONDE A FINI SB0.2 -> PASSAGE A SB0.5
            initSb05(); 
        } 
        else {
            var nextEye = (eye === 'OD') ? 'OG' : 'OD'; appState.activeEye = nextEye;
            appState.defoggedInZone = false; appState.vaIndex = appState.startVaIndex;
            appState.letterIndex = 0; updateDisplay("Recherche Sb0.2 (" + nextEye + ")");
            
            // AJOUT: Relance vocale apr√®s changement d'≈ìil
            say(window.getRandomPrompt());
        }
    });
}

function initSb05() {
    // ALERT REMOVED FOR FLUID TRANSITION
    // alert("D√©but Recherche Sb0.5 (T.Q.S).\nRetour au premier ≈ìil (" + appState.firstEye + ").");
    appState.examPhase = "Sb0.5"; 
    appState.activeEye = appState.firstEye; // Retour premier oeil
    appState.defoggedInZone = false; 
    appState.tqs_attempted_06 = false; 
    appState.count06_validations = 0; 
    appState.tqsFogCount = 0; 
    
    // APPLICATION DU DEBROUILLAGE GLOBAL (OD + OG)
    applySb05GlobalDefog();

    // AJOUT : Annonce de relance apr√®s l'initialisation de la phase
    say(window.getRandomPrompt());
}

function applySb05GlobalDefog() {
    if(appState.profile === "2") { 
        setVaToIndexClosest(0.32); 
        updateDisplay("Profil 2: D√©marrage T.Q.S."); 
        return; 
    }

    // Calcul pour OD (Bas√© sur la sph√®re actuelle de fin de Sb0.2)
    if (appState.seen025_OD) {
        // A vu 0.25 -> Pas de d√©brouillage
    } else {
        // N'a pas vu 0.25 -> D√©brouillage
        var currentSphOD = appState.subj.OD.sphere;
        var deltaOD = (currentSphOD < 0) ? -0.75 : -0.50; // Bas√© sur sph√®re actuelle
        appState.subj.OD.sphere += deltaOD;
    }

    // Calcul pour OG (Bas√© sur la sph√®re actuelle de fin de Sb0.2)
    if (appState.seen025_OG) {
        // A vu 0.25 -> Pas de d√©brouillage
    } else {
        // N'a pas vu 0.25 -> D√©brouillage
        var currentSphOG = appState.subj.OG.sphere;
        var deltaOG = (currentSphOG < 0) ? -0.75 : -0.50; // Bas√© sur sph√®re actuelle
        appState.subj.OG.sphere += deltaOG;
    }
    
    setVaToIndexClosest(0.32); 
    updateDisplay("Sb0.5: D√©brouillage Bilat√©ral effectu√© -> D√©part 0.3");
}

function validateSb05() {
    var eye = appState.activeEye;
    if (eye === 'OD') appState.sb05_OD_ok = true; else appState.sb05_OG_ok = true;
    
    // Sauvegarde de la Sb0.5 trouv√©e
    if(eye === 'OD') appState.saved_sb05.OD = appState.subj.OD.sphere; 
    else appState.saved_sb05.OG = appState.subj.OG.sphere;

    say("On va de l'autre c√¥t√©.", function() {
        if (appState.sb05_OD_ok && appState.sb05_OG_ok) { 
            initSb10(); 
        } 
        else {
            var nextEye = (eye === 'OD') ? 'OG' : 'OD'; 
            appState.activeEye = nextEye;
            // Pas de recalcul de sph√®re ici (d√©j√† fait en global), juste reset variables TQS
            appState.count06_validations = 0; 
            appState.tqs_attempted_06 = false;
            appState.tqsFogCount = 0;
            
            setVaToIndexClosest(0.32); 
            updateDisplay("Sb0.5 (" + nextEye + ") : D√©part 0.3");
            
            // AJOUT: Relance vocale apr√®s changement d'≈ìil
            say(window.getRandomPrompt());
        }
    });
}

function initSb10() {
    // ALERT REMOVED FOR FLUID TRANSITION
    // alert("Passage √† Sb1.0 (Bio-Monoculaire).");
    appState.examPhase = "Sb1.0"; appState.activeEye = appState.firstEye; appState.defoggedInZone = false;
    applySb10Logic();
    
    // AJOUT : Annonce de relance apr√®s l'initialisation de la phase
    say(window.getRandomPrompt());
}

function applySb10Logic() {
    var sphere = getTargetEye().sphere; var eye = appState.activeEye; var otherEye = (eye === 'OD') ? 'OG' : 'OD';
    appState.subj[otherEye].sphere = appState.saved_sb05[otherEye]; 
    setVaToIndexClosest(0.50);
    if (sphere < 0) {
        if(eye==='OD') appState.subj.OD.sphere -= 0.50; else appState.subj.OG.sphere -= 0.50;
        updateDisplay("Sb1.0: N√©gatif -> D√©brouille -0.50 -> Ligne 0.5");
    } else { updateDisplay("Sb1.0: Positif -> Ligne 0.5"); }
}

function validateSb10() {
    var sphere = getTargetEye().sphere;
    if (sphere < 0) { initSphereCheckMinus(); } else { initSphereCheckPlus(); }
}

function finishSb10ForEye() {
    var eye = appState.activeEye; var maxVa = ACUITY_TABLE[appState.vaIndex].va;
    // Mise √† jour de l'affichage dans le panneau droit (disp_)
    setHTML('disp_subj'+eye+'_va', maxVa);

    if (eye === 'OD') appState.saved_sb10.OD = appState.subj.OD.sphere; else appState.saved_sb10.OG = appState.subj.OG.sphere;
    if (eye === 'OD') appState.sb10_OD_ok = true; else appState.sb10_OG_ok = true;
      
    alert("Sph√®re Valid√©e (" + eye + "). D√©but Recherche AXE.");
    document.getElementById('checkPlusZone').classList.add('hidden');
    document.getElementById('standardButtons').classList.add('hidden');
    document.getElementById('cadenceButtons').classList.add('hidden');
    document.getElementById('axisZone').classList.remove('hidden');
    initAxisCheck();
}

function initSphereCheckMinus() {
    appState.examPhase = "SphereCheckMinus"; appState.checkStep = "TEST_125_PRE";
    
    // MODIFICATION: Check si safety mode actif
    if (appState.safety_mode) {
        // En mode s√©curit√©, on reste sur la ligne actuelle
        // Mais on change les lettres pour √©viter la m√©morisation
        nextLetters();
        updateDisplay("S√©curit√© Myope: Test Quart Concave sur ligne actuelle.");
        
        // --- LOGIQUE: ON AJOUTE LE -0.25 POUR LE TEST ---
        var target = getTargetEye(); 
        target.sphere -= 0.25; 
        // ------------------------------------------------
        
        say("Lisez-moi cette ligne maintenant."); // Vocal sp√©cifique demand√©
    } else {
        // Mode standard (fin d'examen), on va √† 1.25
        setVaToIndexClosest(1.25); 
        updateDisplay("Check (-): Lecture 1.25 (Score 1)");
    }
}

function initSphereCheckPlus(skipIntro) {
    appState.examPhase = "SphereCheckPlus"; appState.baseSphereValue = getTargetEye().sphere;
    document.getElementById('standardButtons').classList.add('hidden');
    document.getElementById('cadenceButtons').classList.add('hidden');
    document.getElementById('checkPlusZone').classList.remove('hidden');
    document.getElementById('stepPlusWrapper').classList.remove('hidden');
    document.getElementById('decisionsPlus').classList.add('hidden');
    document.getElementById('stepMinusWrapper').classList.add('hidden');
    document.getElementById('decisionsMinus').classList.add('hidden');
    document.getElementById('btnMinus025').disabled = true;
    if(skipIntro) { nextLetters(); window.triggerFogCheck(); } 
    else { setTimeout(function() { say("C'est pas mal, mais on va voir si on peut faire un peu mieux", function() { nextLetters(); window.triggerFogCheck(); }); }, 500); }
}

// --------------------------------------------------------------------------
// --- LOGIQUE ASYNCHRONE ET TIMING PR√âCIS (Bas√© sur Analyse Vid√©o) ---
// --------------------------------------------------------------------------

// 1. Fonction utilitaire pour attendre (Promesse)
const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// 2. Test du +0.25 (3s d'exposition environ - Ratio 2:1)
async function triggerFogCheck() {
    // Verrouillage de l'interface
    updateLockUI(true);
    document.getElementById('btnPlus025').disabled = true; 
    
    const target = getTargetEye();
    // On s'assure qu'on part de la base
    target.sphere = appState.baseSphereValue; 
    updateDisplay("Check (+): R√©f√©rence...");

    // Etape 1 : R√©f√©rence (Sans le verre)
    say("Vous pr√©f√©rez comme √ßa ?");
    // MODIFICATION DEMAND√âE : +1s d'attente (2500ms au lieu de 1500ms)
    await wait(2500); 

    // Etape 2 : Ajout du verre +0.25 (Chevauchement Parole/Geste)
    say("Ou si je fais √ßa ?");
    await wait(400); // Petit d√©lai naturel avant l'action
    target.sphere = appState.baseSphereValue + 0.25;
    updateDisplay("Check (+): +0.25 ajout√©");
    
    // TEMPS D'EXPOSITION LONG (Pour le verre positif)
    // La vid√©o montre environ 3 secondes
    await wait(3000); 

    // Etape 3 : Retrait du verre
    say("Ou si je reviens ?");
    await wait(400); // Petit d√©lai naturel
    target.sphere = appState.baseSphereValue; // Retour base
    updateDisplay("Check (+): Retour Base");

    // Fin de la s√©quence
    updateLockUI(false);
    document.getElementById('decisionsPlus').classList.remove('hidden'); 
    document.getElementById('btnPlus025').disabled = false;
}

// 3. Test du -0.25 (1.5s d'exposition environ - Ratio 1:2)
async function triggerDefogCheck() {
    // Verrouillage
    updateLockUI(true);
    document.getElementById('btnMinus025').disabled = true; 
    
    const target = getTargetEye();
    target.sphere = appState.baseSphereValue;
    updateDisplay("Check (-): R√©f√©rence...");

    // Etape 1 : R√©f√©rence
    say("Vous pr√©f√©rez comme √ßa ?");
    // MODIFICATION DEMAND√âE : +1s d'attente (2500ms au lieu de 1500ms)
    await wait(2500);

    // Etape 2 : Ajout du verre -0.25 (Chevauchement)
    say("Ou si je fais √ßa ?");
    await wait(400);
    target.sphere = appState.baseSphereValue - 0.25;
    updateDisplay("Check (-): -0.25 ajout√©");

    // TEMPS D'EXPOSITION COURT (Pour le verre n√©gatif)
    // La vid√©o montre environ 1.5 secondes (moiti√© du temps positif)
    await wait(1500); 

    // Etape 3 : Retrait
    say("Ou si je reviens ?");
    await wait(400);
    target.sphere = appState.baseSphereValue; // Retour base
    updateDisplay("Check (-): Retour Base");

    // Fin
    updateLockUI(false);
    document.getElementById('decisionsMinus').classList.remove('hidden'); 
    document.getElementById('btnMinus025').disabled = false;
}

window.relaunchPlus = function() {
    if (appState.isSpeaking) return; // LOCK
    document.getElementById('decisionsPlus').classList.add('hidden');
    
    // CHANGEMENT DE LETTRES UNIQUEMENT ICI (Relance explicite)
    nextLetters(); 
    
    say("D'accord, je vous remontre", function() { window.triggerFogCheck(); });
};

window.decidePlus = function(choice) {
    if (appState.isSpeaking) return; // LOCK
    
    // NOTE IMPORTANTE: Pas de nextLetters() ici car on enchaine sur le test suivant
    // ou on valide. Le changement de lettres se fait APRES la d√©cision si on relance.

    // --- S√âCURIT√â SB1.0 (Mode V√©rification) ---
    if (appState.safety_mode) {
        if (choice === 'better' || choice === 'same') {
            document.getElementById('modalIncoherent').classList.remove('hidden');
            return;
        }
        // Cas 2 : Le patient pr√©f√®re la Base (Reject +0.25) -> Confirme la limite
    }
    // ------------------------------------------

    if (choice === 'better' || choice === 'same') {
        // Le patient aime le +0.25 -> On l'adopte et on recommence
        // C'est une NOUVELLE it√©ration -> Changement de lettres
        nextLetters();
        
        var target = getTargetEye(); target.sphere = appState.baseSphereValue + 0.25; 
        updateDisplay("Accept√© (+0.25) -> On recommence le test"); 
        setTimeout(function() { initSphereCheckPlus(); }, 500);
    } else {
        // Le patient n'aime pas -> On passe au test du moins
        // PAS DE CHANGEMENT DE LETTRES (M√™me test, √©tape suivante)
        document.getElementById('stepPlusWrapper').classList.add('hidden'); 
        document.getElementById('decisionsPlus').classList.add('hidden');
        updateDisplay("Rejet du (+) -> Transition imm√©diate...");
        say("Attention, je vais dans l'autre sens.", function() { window.startAutomaticMinusCheck(); });
    }
}

window.startAutomaticMinusCheck = function() {
    document.getElementById('stepMinusWrapper').classList.remove('hidden');
    document.getElementById('decisionsMinus').classList.add('hidden');
    window.triggerDefogCheck();
};

window.relaunchFullCheck = function() { 
    if (appState.isSpeaking) return; // LOCK
    
    // Relance explicite -> Changement de lettres
    nextLetters();
    
    say("D'accord, mais on refait tout", function() { window.initSphereCheckPlus(true); }); 
};

window.decideMinus = function(choice) {
    if (appState.isSpeaking) return; // LOCK
    
    // Fin du test -> Changement de lettres pour la suite (ou validation)
    nextLetters();
    
    // --- MODIFICATION S√âCURIT√â SB1.0 ---
    if (choice === 'better') {
        // Le patient veut d√©brouiller
        var target = getTargetEye(); target.sphere = appState.baseSphereValue - 0.25; 
        
        // Si on est en mode S√©curit√© (Safety Re-check)
        if (appState.safety_mode) {
            updateDisplay("S√©curit√©: D√©brouillage accept√©. Relire la ligne pr√©c√©dente.");
            appState.examPhase = "Sb1.0";
            
            // ACTION IMMEDIATE : Changement de lettres + Vocal
            // nextLetters() d√©j√† appel√© au d√©but de la fonction
            say("Tr√®s bien, essayez de me lire cette ligne maintenant."); 

            document.getElementById('checkPlusZone').classList.add('hidden'); 
            document.getElementById('standardButtons').classList.remove('hidden');
            return;
        }

        alert("On enl√®ve 0.25 et on recommence le test complet.");
        initSphereCheckPlus(); 
    } else {
        // Le patient n'aime pas le d√©brouillage (Prefer Base)
        
        // --- S√âCURIT√â : RETOUR ARRI√àRE ---
        if (appState.safety_mode) {
             var revertAmount = appState.sb10_line_defog * 0.25;
             getTargetEye().sphere += revertAmount;
             updateDisplay("Retour Sph√®re Initiale Ligne: " + getTargetEye().sphere.toFixed(2));
             alert("S√©curit√© : Les d√©brouillages pr√©c√©dents sur cette ligne n'ont pas aid√©. On annule tout et on valide.");
             document.getElementById('checkPlusZone').classList.add('hidden'); 
             document.getElementById('standardButtons').classList.remove('hidden');
             finishSb10ForEye();
             return;
        }
        // ---------------------------------

        document.getElementById('checkPlusZone').classList.add('hidden'); document.getElementById('standardButtons').classList.remove('hidden');
        alert("Sph√®re Valid√©e !"); finishSb10ForEye();
    }
}

// Fonction de restart pour la modale Incoh√©rent
window.restartSb10 = function() {
    document.getElementById('modalIncoherent').classList.add('hidden');
    document.getElementById('checkPlusZone').classList.add('hidden');
    document.getElementById('standardButtons').classList.remove('hidden');
    
    // --- CORRECTION MAJEURE : RETOUR +0.50 ---
    var target = getTargetEye();
    target.sphere += 0.50;
    updateDisplay("Relance Sb1.0 (+0.50) suite incoh√©rence");
    // ----------------------------------------

    // Reset specific Sb1.0 counters
    appState.sb10_line_defog = 0;
    appState.safety_mode = false;
    appState.hasRestartedSb10 = true; // NEW FLAG
    // Relaunch phase
    initSb10();
};

window.handleResponse = function(lettersRead) {
    if (appState.isSpeaking) return; // LOCK

    // 1. Feedback Choice
    var wordsLow = ["Ok", "D'accord", "Bien"];
    var wordsHigh = ["Ok", "Bien", "Tr√®s bien", "Parfait", "D'accord"];
    var feedback = (lettersRead <= 3) ? wordsLow[Math.floor(Math.random() * wordsLow.length)] : wordsHigh[Math.floor(Math.random() * wordsHigh.length)];

    // --- GESTION SP√âCIFIQUE Sb0.2 et Sb0.5 (S√©quence Temporelle Stricte) ---
    if (appState.examPhase === "Sb0.2" || appState.examPhase === "Sb0.5") {
        
        // 1. On parle d'abord (Feedback)
        say(feedback, function() {
            // CE CODE S'EXECUTE UNE FOIS QUE "TRES BIEN" EST FINI

            // 2. Snapshot √©tat avant logique
            var oldVa = appState.vaIndex;
            var oldLet = appState.letterIndex;
            var oldEye = appState.activeEye;

            // 3. Ex√©cution logique (MISE A JOUR VISUELLE ICI)
            processLogic(lettersRead, 'rabbit');

            // 4. Si la logique a chang√© l'≈ìil (fin de phase), on s'arr√™te l√† (la transition vocale est g√©r√©e ailleurs)
            if (appState.activeEye !== oldEye) return;

            // 5. D√©tection du changement visuel
            var changed = (appState.vaIndex !== oldVa || appState.letterIndex !== oldLet);
            
            // 6. Si changement visuel -> Relance vocale
            if (changed) {
                say(window.getRandomPrompt());
            }
        });
        return;
    }

    // --- GESTION STANDARD (Sb1.0, etc.) ---
    var currentTxt = ACUITY_TABLE[appState.vaIndex].lines[appState.letterIndex % 8]; 
    if(!currentTxt) currentTxt = ACUITY_TABLE[appState.vaIndex].lines[0];
    var totalLetters = currentTxt.split(' ').length;

    if (totalLetters < 5 || lettersRead < 3) { 
        // Pas de demande de cadence -> Logique imm√©diate
        processLogic(lettersRead, 'rabbit');
        if (!appState.isSpeaking) say(feedback);
    } else { 
        // Demande de cadence
        say(feedback); // On dit juste "Bien"
        askCadence(lettersRead); 
    }
};

window.handleCadence = function(type) {
    if (appState.isSpeaking) return; // LOCK

    // 1. Snapshot de la phase AVANT logique
    var phaseBefore = appState.examPhase;

    var n = appState.pendingLetters; 
    appState.pendingLetters = null;
    
    document.getElementById('standardButtons').classList.remove('hidden'); 
    document.getElementById('cadenceButtons').classList.add('hidden');
    
    // 2. Ex√©cution Logique
    processLogic(n, type);

    // 3. V√©rification APRES logique
    // Si on est encore en Sb1.0, c'est qu'on continue (Ligne suivante ou d√©brouillage) -> On relance.
    // Si on a chang√© de phase (vers SphereCheck, etc.), on ne dit rien.
    if (phaseBefore === "Sb1.0" && appState.examPhase === "Sb1.0") {
          say(window.getRandomPrompt());
    }
};

// --- LOGIQUE PRINCIPALE AVEC MESSAGES HARMONIS√âS ---
function processLogic(lettersRead, cadence) {
    var currentVA = ACUITY_TABLE[appState.vaIndex].va;
    var currentTxt = ACUITY_TABLE[appState.vaIndex].lines[appState.letterIndex % 8]; if(!currentTxt) currentTxt = ACUITY_TABLE[appState.vaIndex].lines[0];
    var totalLetters = currentTxt.split(' ').length; var isSmallLine = totalLetters < 5;
    var isPassed = false;
      
    // R√àGLE SP√âCIFIQUE SB0.2
    if (appState.examPhase === "Sb0.2") {
        if (cadence === 'rabbit') {
            if (isSmallLine) {
                if (lettersRead === totalLetters) isPassed = true;
            } else {
                if (lettersRead >= 3) isPassed = true;
            }
        }
        else if (cadence === 'turtle') {
            if (!isSmallLine) {
                if (lettersRead >= 4) isPassed = true;
            }
        }
        
        if (isPassed) {
            // MISE A JOUR VA LUE
            appState.subj[appState.activeEye].va = currentVA;

            if (currentVA === 0.25) {
                if (appState.activeEye === 'OD') appState.seen025_OD = true; else appState.seen025_OG = true;
                validateSb02();
                return;
            }
            if (goNextLine()) updateDisplay("Valid√© -> Suivant");
            else updateDisplay("Max Atteint");
            return;
        } else {
            if (currentVA === 0.25) {
                 updateDisplay("Palier 0.25 non franchi -> Sb0.2 valid√©e");
                 setTimeout(function() { validateSb02(); }, 1000); 
                 return;
            }

            var currentSph = getTargetEye().sphere;
            var raSph = (appState.activeEye === 'OD') ? getVal('raOD_sph') : getVal('raOG_sph');
            if (currentSph - 0.25 < raSph) {
                 document.getElementById('modalDefogLimit').classList.remove('hidden');
                 return;
            }

            if (currentVA >= 0.06 && currentVA <= 0.20) {
                appState.defoggedInZone = true;
            }

            getTargetEye().sphere -= 0.25;

            // --- CORRECTION : Changement de lettres si >= 3 OU si ligne petite et >= 1 lettre lue ---
            if (lettersRead >= 3 || (isSmallLine && lettersRead > 0)) {
                nextLetters();
            } 
            
            var msg = (cadence === 'turtle') ? "Tortue -> Sph -0.25" : "Non vu -> Sph -0.25";
            updateDisplay(msg);
            return;
        }
    }

    // R√àGLE SP√âCIFIQUE SB0.5 (T.Q.S)
    if (appState.examPhase === "Sb0.5") {
        
        // --- 1. Gestion Validation Ligne (Lapin/Tortue identique) ---
        if (lettersRead >= 3) isPassed = true;
        else isPassed = false;

        // --- 2. Logique par Ligne ---

        // CAS A : Ligne 0.3 (0.32) ou 0.4 (0.40)
        if (currentVA === 0.32 || currentVA === 0.40) {
            if (isPassed) {
                // MISE A JOUR VA LUE
                appState.subj[appState.activeEye].va = currentVA;

                if (currentVA === 0.40) {
                    if (appState.tqs_attempted_06) {
                        setVaToIndexClosest(0.50);
                        updateDisplay("0.4 Valid√© (Post-Brouillage) -> 0.5");
                    } else {
                        setVaToIndexClosest(0.60);
                        updateDisplay("0.4 Valid√© -> Saut √† 0.6 (Pi√®ge)");
                        appState.tqs_attempted_06 = true; 
                    }
                } else {
                    goNextLine(); // 0.3 -> 0.4
                    updateDisplay("0.3 Valid√© -> 0.4");
                }
            } else {
                getTargetEye().sphere -= 0.25;
                nextLetters(); // <-- Ajout pour relance vocale
                updateDisplay("√âchec " + currentVA + " -> D√©brouille -0.25");
            }
            return;
        }

        // CAS B : Ligne 0.60 (Le Pi√®ge)
        if (currentVA === 0.60) {
            if (!isPassed) {
                if (appState.tqsFogCount > 0) setVaToIndexClosest(0.40);
                else setVaToIndexClosest(0.50);
                updateDisplay("Pi√®ge 0.6 fonctionnel -> Descente");
            } else {
                // MISE A JOUR VA LUE (M√™me si c'est un pi√®ge, il l'a lue)
                appState.subj[appState.activeEye].va = currentVA;

                if (appState.tqsFogCount >= 2) {
                    document.getElementById('modalTqsLimit').classList.remove('hidden');
                    return;
                }
                getTargetEye().sphere += 0.50;
                nextLetters();
                appState.tqsFogCount++;
                updateDisplay("Pi√®ge 0.6 √©chou√© (Vu) -> Brouille +0.50");
            }
            return;
        }

        // CAS C : Ligne 0.50 (Finale)
        if (currentVA === 0.50) {
            if (isPassed) {
                appState.subj[appState.activeEye].va = currentVA;
                validateSb05();
            } else {
                getTargetEye().sphere -= 0.25;
                nextLetters(); // <-- Ajout pour relance vocale
                updateDisplay("√âchec 0.5 -> D√©brouille -0.25");
            }
            return;
        }
    }

    // R√àGLES STANDARD (AUTRES PHASES)
    if (cadence === 'rabbit') {
        if (isSmallLine && lettersRead === totalLetters) isPassed = true;
        if (!isSmallLine && lettersRead > 3) isPassed = true;
    }
      
    // LOGIQUE SPHERE CHECK
    if (appState.examPhase === "SphereCheckMinus") {
        if (appState.checkStep === "TEST_125_PRE") {
            appState.tempScore = lettersRead; var target = getTargetEye(); target.sphere -= 0.25;
            appState.checkStep = "TEST_125_POST"; nextLetters(); updateDisplay("Ajout -0.25 -> Relire 1.25");
        } else if (appState.checkStep === "TEST_125_POST") {
            var gain = lettersRead - appState.tempScore;
            
            // --- S√âCURIT√â MYOPE : R√àGLE GAIN >= 2 ---
            if (appState.safety_mode) {
                 var gainSafety = lettersRead - appState.safety_mem_letters;
                 
                 if (gainSafety >= 2) {
                      // SUCC√àS : On garde le -0.25
                      if (isPassed) {
                           appState.safety_mode = false;
                           appState.sb10_line_defog = 0;
                           appState.examPhase = "Sb1.0"; // Retour Sb1.0
                           appState.subj[appState.activeEye].va = currentVA;
                           appState.checkStep = null;
                           if (goNextLine()) updateDisplay("S√©curit√© Myope pass√©e -> Ligne Suivante");
                           else updateDisplay("Max Atteint");
                      } else {
                           // Pas lapin mais gain >= 2 -> On valide cette sph√®re
                           alert("Am√©lioration confirm√©e (+"+gainSafety+") mais plafond atteint. On valide cette sph√®re.");
                           finishSb10ForEye();
                      }
                 } else {
                      // ECHEC : Gain < 2
                      var target = getTargetEye(); target.sphere += 0.25; // Revert
                      updateDisplay("Revert...");
                      alert("Gain insuffisant (< 2). On revient √† la sph√®re pr√©c√©dente.");
                      finishSb10ForEye();
                 }
                 return;
            }
            // ----------------------------------------

            if (gain >= 3) { updateDisplay("Gain suffisant -> -0.25 conserv√©"); appState.examPhase = "Sb1.0"; appState.checkStep = null; finishSb10ForEye(); } 
            else { var target = getTargetEye(); target.sphere += 0.25; updateDisplay("Gain faible -> -0.25 rejet√©"); appState.examPhase = "Sb1.0"; appState.checkStep = null; finishSb10ForEye(); }
        }
        return;
    }

    // LOGIQUE Sb1.0
    if (appState.examPhase === "Sb1.0") {
        
        // --- S√âCURIT√â DE RETOUR (Apr√®s CheckPlus/CheckMinus) ---
        if (appState.safety_mode && getTargetEye().sphere >= 0) { // Uniquement Positif ici, Myope g√©r√© dans SphereCheckMinus block
            if (lettersRead > appState.safety_mem_letters) {
                // Filtre A: Am√©lioration confirm√©e
                
                if (isPassed) {
                    // Filtre B: Validation Standard (Lapin) -> OK
                    appState.safety_mode = false; 
                    appState.sb10_line_defog = 0; // Reset compteur
                    appState.subj[appState.activeEye].va = currentVA;
                    if (goNextLine()) updateDisplay("S√©curit√© pass√©e -> Ligne Suivante");
                    else updateDisplay("Max Atteint");
                    return;
                } else {
                    // Filtre B: Echec Validation (Am√©lioration mais pas Lapin) -> STOP
                    // C'est ici qu'on force la sortie pour √©viter la boucle
                    alert("Am√©lioration confirm√©e mais plafond atteint. On valide cette sph√®re.");
                    finishSb10ForEye();
                    return;
                }
            } else {
                // Filtre A Failed: Pas d'am√©lioration -> REVERT & STOP
                
                // 1. On annule le d√©brouillage (On remet +0.25 car le -0.25 √©tait inutile)
                var target = getTargetEye();
                target.sphere += 0.25;
                
                // --- CORRECTION : ON MET A JOUR L'AFFICHAGE AVANT DE VALIDER ---
                updateDisplay("S√©curit√© : Retour √† la sph√®re pr√©c√©dente."); 
                // ---------------------------------------------------------------

                // 2. Alert et Fin
                alert("S√©curit√© : Le d√©brouillage n'apporte rien. On revient √† la sph√®re pr√©c√©dente (" + target.sphere.toFixed(2) + ") et on valide.");
                finishSb10ForEye();
                return;
            }
        }
        // -------------------------------------------------------

        var sph = getTargetEye().sphere;
        if (currentVA === 1.0) {
            if (sph >= 0) {
                // === CAS SPH√àRE POSITIVE OU NULLE ===
                // 1. √âchec
                if (lettersRead < 3 || (lettersRead === 3 && cadence === 'turtle')) {
                    
                    // --- CORRECTION CHRONOLOGIQUE : CHECK AVANT D√âBROUILLAGE ---
                    if (appState.sb10_line_defog >= 2) {
                        // C'est le 3√®me √©chec -> STOP AVANT DE TOUCHER LA SPHERE
                        if (appState.hasRestartedSb10) {
                            alert("S√©curit√© : Seconde tentative √©chou√©e. On valide la sph√®re actuelle.");
                            finishSb10ForEye();
                            return;
                        }
                        appState.safety_mode = true;
                        appState.safety_mem_letters = lettersRead;
                        alert("S√©curit√© : D√©brouillage excessif (" + sph.toFixed(2) + "). V√©rification.");
                        initSphereCheckPlus();
                        return; // SORTIE ICI, SPH√àRE INCHANG√âE (4.00)
                    }
                    appState.sb10_line_defog++;
                    // -----------------------------------------------------------

                    changeSphereAndRetest(-0.25); updateDisplay("Echec 1.0 (+) -> D√©brouille -0.25"); 
                    return;
                }
                // 2. Succ√®s -> Check Plus
                appState.subj[appState.activeEye].va = currentVA;
                initSphereCheckPlus(); return;
            } else {
                // === CAS SPH√àRE N√âGATIVE (< 0) ===
                // 1. √âchec Franc
                if (lettersRead < 3 || (lettersRead === 3 && cadence === 'turtle')) { 
                    
                    // --- S√âCURIT√â MYOPE ---
                    if (appState.sb10_line_defog >= 2) {
                          appState.safety_mode = true;
                          appState.safety_mem_letters = lettersRead;
                          alert("S√©curit√© Myope : D√©brouillage excessif. Test du Quart Concave.");
                          
                          // --- AJOUT MAJEUR : ON AJOUTE LE -0.25 POUR LE TEST ICI ---
                          var target = getTargetEye(); target.sphere -= 0.25; 
                          // -----------------------------------------------------------
                          
                          initSphereCheckMinus(); // Lance le test sans changer la ligne
                          return;
                    }
                    appState.sb10_line_defog++;
                    // ----------------------

                    changeSphereAndRetest(-0.25); 
                    updateDisplay("Echec 1.0 (-) -> D√©brouille -0.25"); 
                    return; 
                }
                // 2. Zone Mitig√©e (3 ou 4 lettres, OU 5 lettres Tortue)
                if (lettersRead === 3 || lettersRead === 4 || (lettersRead === 5 && cadence === 'turtle')) { 
                    initSphereCheckMinus(); 
                    return; 
                }
                // 3. Succ√®s Total (5 lettres ET Lapin)
                if (lettersRead === 5 && cadence === 'rabbit') { 
                    appState.subj[appState.activeEye].va = currentVA;
                    // Validation imm√©diate, pas de Quart Concave
                    alert("Sph√®re Valid√©e (Succ√®s Total) !"); 
                    finishSb10ForEye(); 
                    return; 
                }
            }
        }
        
        // Logique de mont√©e standard avant 1.0
        if (isPassed) {
            appState.subj[appState.activeEye].va = currentVA;
            if (currentVA < 1.0) { if (goNextLine()) updateDisplay("Valid√© -> Suivant"); else updateDisplay("Max Atteint"); } return;
        } else { 
            
            // --- CORRECTION CHRONOLOGIQUE : CHECK AVANT D√âBROUILLAGE (POUR SPH >= 0) ---
            if (sph >= 0) {
                if (appState.sb10_line_defog >= 2) {
                    if (appState.hasRestartedSb10) {
                        alert("S√©curit√© : Seconde tentative √©chou√©e. On valide la sph√®re actuelle.");
                        finishSb10ForEye();
                        return;
                    }
                    appState.safety_mode = true;
                    appState.safety_mem_letters = lettersRead;
                    alert("S√©curit√© : D√©brouillage excessif (" + sph.toFixed(2) + "). V√©rification.");
                    initSphereCheckPlus();
                    return;
                }
                appState.sb10_line_defog++;
            }
            // --- S√âCURIT√â MYOPE (POUR SPH < 0) ---
            else {
                if (appState.sb10_line_defog >= 2) {
                      appState.safety_mode = true;
                      appState.safety_mem_letters = lettersRead;
                      alert("S√©curit√© Myope : D√©brouillage excessif. Test du Quart Concave.");
                      
                      // --- AJOUT MAJEUR : ON AJOUTE LE -0.25 POUR LE TEST ICI ---
                      var target = getTargetEye(); target.sphere -= 0.25; 
                      // -----------------------------------------------------------
                      
                      initSphereCheckMinus();
                      return;
                }
                appState.sb10_line_defog++;
            }
            // ---------------------------------------------------------------------------

            changeSphereAndRetest(-0.25); 
            updateDisplay("Echec " + currentVA + " -> D√©brouille -0.25"); 
            return; 
        }
    }
    
    // GENERAL - MESSAGES BAVARDS
    var msg = ""; var changeSphere = 0;
    if (isSmallLine) {
       if (lettersRead < totalLetters) { changeSphere = -0.25; nextLetters(); msg = "Non vu -> Sph -0.25"; } else { if (goNextLine()) msg = "Valid√© -> Suivant"; else msg = "Acuit√© Max"; }
    } else {
       if (lettersRead < 3) { changeSphere = -0.25; msg = "< 3 lettres -> Sph -0.25"; } 
       else if (lettersRead === 3) { changeSphere = -0.25; nextLetters(); msg = "= 3 lettres -> Sph -0.25"; } 
       else {
           if (cadence === 'turtle') { changeSphere = -0.25; nextLetters(); msg = "> 3 (Tortue) -> Sph -0.25"; } 
           else { if (currentVA === 1.0) { nextLetters(); msg = "VA 1.0 -> Test Faces"; } else { if (goNextLine()) msg = "Valid√© -> Suivant"; else msg = "Acuit√© Max"; } }
       }
    }
    applyChanges(changeSphere, msg);
}

// Fonction utilitaire pour la s√©curit√© Sb1.0
function handleSb10Safety(currentSphere, score) {
    if (currentSphere >= 0) {
        appState.sb10_line_defog++;
        // Si on a d√©brouill√© plus de 0.50 (donc 3 fois 0.25 = 0.75)
        if (appState.sb10_line_defog > 2) {
            // NEW CHECK: Prevent infinite loop
            if (appState.hasRestartedSb10) {
                alert("S√©curit√© : Seconde tentative √©chou√©e. On valide la sph√®re actuelle.");
                finishSb10ForEye();
                return;
            }

            appState.safety_mode = true;
            // On sauvegarde le vrai score de l'√©chec
            appState.safety_mem_letters = score; 
            
            alert("S√©curit√© : D√©brouillage excessif sur sph√®re positive. V√©rification.");
            initSphereCheckPlus();
        }
    }
}

function changeSphereAndRetest(delta) { var target = getTargetEye(); target.sphere += delta; nextLetters(); }
function nextLetters() { appState.letterIndex++; }
function goNextLine() {
    appState.sb10_line_defog = 0; // Reset s√©curit√© nouvelle ligne
    var currentVA = ACUITY_TABLE[appState.vaIndex].va;
    if (currentVA === 0.25 && appState.examPhase === "Sb0.2") { if (appState.activeEye === 'OD') appState.seen025_OD = true; if (appState.activeEye === 'OG') appState.seen025_OG = true; }
    if (appState.examPhase === "Sb0.2" && currentVA === 0.20 && appState.defoggedInZone) { validateSb02(); return false; }
    if (appState.examPhase === "Sb0.5" && currentVA === 0.40) { appState.tqs_attempted_06 = true; setVaToIndexClosest(0.60); return true; }
    if (appState.vaIndex < ACUITY_TABLE.length - 1) { appState.vaIndex++; appState.letterIndex = 0; return true; }
    return false;
}
function setVaToIndexClosest(target) { for(var i=0; i<ACUITY_TABLE.length; i++) { if(ACUITY_TABLE[i].va >= target) { appState.vaIndex = i; break; } } appState.letterIndex = 0; }
function askCadence(n) { appState.pendingLetters = n; document.getElementById('standardButtons').classList.add('hidden'); document.getElementById('cadenceButtons').classList.remove('hidden'); updateDisplay("> 3 lettres. Cadence ?"); }
function applyChanges(sphereDelta, message) {
    var currentVA = ACUITY_TABLE[appState.vaIndex].va;
    if (appState.examPhase === "Sb0.2" && sphereDelta < 0 && currentVA >= 0.06 && currentVA <= 0.20) { appState.defoggedInZone = true; }
    var target = getTargetEye(); target.sphere += sphereDelta; updateDisplay(message);
}

function updateDisplay(message) {
    // 1. Mise √† jour Panneau Gauche
    setHTML('subjOD_sph', appState.subj.OD.sphere.toFixed(2)); setHTML('subjOG_sph', appState.subj.OG.sphere.toFixed(2));
    setHTML('subjOD_cyl', appState.subj.OD.cyl.toFixed(2)); setHTML('subjOG_cyl', appState.subj.OG.cyl.toFixed(2));
    setHTML('subjOD_axe', appState.subj.OD.axe + "¬∞"); setHTML('subjOG_axe', appState.subj.OG.axe + "¬∞");

    // 2. Mise √† jour Panneau Droite (Nouvelle Section Verticale)
    setHTML('disp_subjOD_sph', appState.subj.OD.sphere.toFixed(2));
    setHTML('disp_subjOD_cyl', appState.subj.OD.cyl.toFixed(2));
    setHTML('disp_subjOD_axe', appState.subj.OD.axe + "¬∞");
    setHTML('disp_subjOD_va', appState.subj.OD.va); // Ajout VA OD

    setHTML('disp_subjOG_sph', appState.subj.OG.sphere.toFixed(2));
    setHTML('disp_subjOG_cyl', appState.subj.OG.cyl.toFixed(2));
    setHTML('disp_subjOG_axe', appState.subj.OG.axe + "¬∞");
    setHTML('disp_subjOG_va', appState.subj.OG.va); // Ajout VA OG

    // Gestion visuelle de l'≈ìil actif
    var boxOD = document.getElementById('subjDispOD');
    var boxOG = document.getElementById('subjDispOG');
    var btnOD = document.getElementById('btnOD');
    var btnOG = document.getElementById('btnOG');

    // Gestion des classes des colonnes de donn√©es
    if(appState.activeEye === 'OD') {
        boxOD.classList.add('active'); boxOG.classList.remove('active');
    } else {
        boxOD.classList.remove('active'); boxOG.classList.add('active');
    }

    // Gestion des classes des boutons Yeux (Nouvelle logique Occlusion)
    var isMonocularPhase = (appState.examPhase === "Sb0.2" || appState.examPhase === "Sb0.5");
    
    if(appState.activeEye === 'OD') {
        btnOD.className = 'eye-btn active';
        btnOG.className = isMonocularPhase ? 'eye-btn occluded-mode' : 'eye-btn';
    } else {
        btnOD.className = isMonocularPhase ? 'eye-btn occluded-mode' : 'eye-btn';
        btnOG.className = 'eye-btn active';
    }

    setHTML('valProfile', appState.profile);
    setHTML('systemMsg', message);
    if (message.indexOf("VALID√âE") !== -1 || message.indexOf("Valid√©") !== -1) document.getElementById('systemMsg').classList.add('success-msg'); else document.getElementById('systemMsg').classList.remove('success-msg');
      
    var currentData = ACUITY_TABLE[appState.vaIndex]; setHTML('valVA', currentData.va);
    var linesArr = currentData.lines; var txt = linesArr[appState.letterIndex % linesArr.length];
    setHTML('letterBox', txt);
    var count = txt.split(' ').length; var btnHTML = "";
    for(var i=0; i<=count; i++) { btnHTML += '<button class="btn-resp" onclick="window.handleResponse('+i+')">'+i+'</button> '; }
    setHTML('btnContainer', btnHTML);
      
    // Visuals Eye (Gauche) - Masquage des champs de saisie
    // (MODIFI√â: Suppression de applyVisuals car plus d'√©l√©ments √† masquer dans le panneau gauche)
}

// --- AXE ---
window.initAxisCheck = function() {
    appState.examPhase = "AxisCheck"; var target = getTargetEye(); var raAxis = (appState.activeEye === 'OD') ? getVal('raOD_axe') : getVal('raOG_axe');
    appState.startAxisRA = raAxis; var cyl = Math.abs(target.cyl); appState.cylHigh = (cyl >= 4.50);
    if (cyl < 2.50) appState.axisStep = 20; else appState.axisStep = 10; 
    appState.axisDirectionHistory = [];
    document.getElementById('jccVisuals').classList.remove('hidden'); document.getElementById('visPos1').classList.remove('active'); document.getElementById('visPos2').classList.remove('active');
    document.getElementById('axisDecisions').classList.add('hidden'); document.getElementById('btnReplayAxis').classList.add('hidden'); 
    updateDisplay("Axe: Init CXJ. Cyl=" + cyl.toFixed(2));
    if (appState.cylHigh) { alert("Cylindre Fort d√©tect√©. M√©thode comparative (RA vs RA+5 / RA-5)."); } 
    else { 
        say("Je vais maintenant vous montrer deux positions diff√©rentes que vous allez comparer. Vous me direz avec quelle position vous pr√©f√©rez lire les lettres. Pour cela, il faudra lire toutes les lettres dans votre t√™te. Je ferai pareil, comme cela nous serons plus au moins synchronis√©s.", function() {
            setTimeout(function() { runJccSequence(); }, 1000);
        });
    }
};

window.runJccSequence = function() {
    if (appState.isSpeaking) return; // LOCK
    var p1 = document.getElementById('visPos1'); var p2 = document.getElementById('visPos2');
    document.getElementById('axisDecisions').classList.add('hidden'); document.getElementById('btnReplayAxis').classList.add('hidden');
    say("Vous pr√©f√©rez lire les lettres dans la position une ?", function() {
        p1.classList.add('active'); p2.classList.remove('active');
        setTimeout(function() {
            say("Ou vous pr√©f√©rez lire les lettres dans la position deux, ou c'est pareil ?", function() {
                  p1.classList.remove('active'); p2.classList.add('active');
                  setTimeout(function() { p2.classList.remove('active'); document.getElementById('axisDecisions').classList.remove('hidden'); document.getElementById('btnReplayAxis').classList.remove('hidden'); }, 500);
            });
        }, 2000);
    });
};

window.handleJccChoice = function(choice) {
    if (appState.isSpeaking) return; // LOCK
    var target = getTargetEye();
    if (choice === 'same') { alert("Axe valid√© ! Passage √† la Puissance."); return; }
    var direction = (choice === 'pos1') ? 'cw' : 'ccw'; appState.axisDirectionHistory.push(direction);
    var consecutiveCount = 0; for (var i = appState.axisDirectionHistory.length - 1; i >= 0; i--) { if (appState.axisDirectionHistory[i] === direction) consecutiveCount++; else break; }
    if (consecutiveCount >= 2 && appState.axisDirectionHistory.length >= 2) {
        alert("ALERTE : D√©viation importante. Retour √† l'axe RA et lecture √† voix haute."); target.axe = appState.startAxisRA; updateDisplay("Reset Axe -> RA. Lecture √† voix haute.");
        appState.axisStep = (Math.abs(target.cyl) < 2.50) ? 20 : 10; appState.axisDirectionHistory = []; 
        say("Nous allons recommencer. Cette fois, je vais vous demander de lire les lettres √† voix haute.");
        return;
    }
    var rot = (choice === 'pos1') ? -appState.axisStep : appState.axisStep;
    if (appState.axisDirectionHistory.length > 1) {
        var lastDir = appState.axisDirectionHistory[appState.axisDirectionHistory.length - 2];
        if (lastDir !== direction) { 
            if (appState.axisStep === 20) appState.axisStep = 10; else if (appState.axisStep === 10) appState.axisStep = 5; 
            updateDisplay("Inversion -> Pas de " + appState.axisStep + "¬∞");
        }
    }
    
    // Modification ici pour utiliser la fonction de normalisation (0-175)
    target.axe = normalizeAxis(target.axe + rot);
    
    updateDisplay("Nouvel Axe : " + target.axe + "¬∞"); nextLetters(); setTimeout(function() { runJccSequence(); }, 1000);
};

// --- NOUVELLES FONCTIONS DE GESTION DE FLUX (STOP/RESTART) ---
window.restartExam = function() {
    // 1. Hide the modal
    document.getElementById('modalDefogLimit').classList.add('hidden');
    document.getElementById('modalTqsLimit').classList.add('hidden');

    // 2. Reset specific safety flags/counters that might prevent restart
    appState.defoggedInZone = false;
    appState.tqsFogCount = 0;
    // The rest are handled by launchExamSequence, but let's be safe
    appState.sb02_OD_ok = false;
    appState.sb02_OG_ok = false;

    // 3. Relaunch the sequence
    // This function re-reads RA, re-calculates fog, and sets phase to Sb0.2 (for profiles 3)
    window.launchExamSequence();
};

window.prepareCycloStop = function() {
    // Masquer les boutons de choix
    document.getElementById('defogButtons').classList.add('hidden');
    // Afficher le bouton de sauvegarde
    document.getElementById('saveCycloContainer').classList.remove('hidden');
};

window.prepareCycloStopTqs = function() {
    // Masquer les boutons de choix
    document.getElementById('tqsButtons').classList.add('hidden');
    // Afficher le bouton de sauvegarde
    document.getElementById('saveCycloContainerTqs').classList.remove('hidden');
};

window.savePatientData = function() {
    alert("Donn√©es sauvegard√©es pour l'examen sous cyclopl√©gique.");
    location.reload(); 
};
</script>
</body>
</html>
