<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Assistant Réfraction - Dashboard Final</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

<style>
  /* --- CHARTE GRAPHIQUE --- */
  :root { 
      --bg-main: #FCF9F2;       
      --primary: #04ABC6;            
      --primary-dark: #03889E;    
      --primary-deep: #026070;    
      --primary-light: #E0F6F8;   
      --primary-border: #8CD6E2;
      --panel: #FFFFFF;            
      --text-main: #37474F;        
      --text-muted: #78909C;        
      --border: #CFD8DC;
  }

  /* RESET & BASE */
  * { box-sizing: border-box; }
  body { 
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
      background-color: var(--bg-main); 
      color: var(--text-main); 
      margin: 0; padding: 0;
      height: 100vh; 
      overflow: hidden; 
      font-size: 13px;
  }

/* --- LAYOUT GRID UNIQUE (ONE SCREEN) --- */
  
  /* Conteneur Maitre : Prend tout l'écran, pas de scroll global sauf si nécessaire */
  .app-container { 
      display: grid;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #FCF9F2;
      padding: 10px;
      gap: 10px;

      /* GRILLE DE PRÉCISION : 20x20 
         Chaque cellule fait 5% de largeur et 5% de hauteur.
         Vous pouvez placer n'importe quel élément avec grid-row / grid-column.
      */
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(20, 1fr);
  }

  /* --- PLACEMENT DES ÉLÉMENTS (C'EST ICI QUE VOUS MODIFIEZ POUR BOUGER LES BLOCS) --- */

  /* 1. Zone Patient (Ligne 1, Toute largeur) */
  /* 1. Zone Patient (Barre du haut) - MODIFIÉE */
 /* 1. Zone Patient (Barre du haut) - FONDUE DANS LE DÉCOR */
  #zonePatient {
      grid-column: 1 / 21;  
      grid-row: 1 / 3;      
      
      /* FOND CRÈME (Identique au body) */
      background: #FCF9F2; 
      
      /* PLUS DE BORDURE (Pour fondre la zone) */
      border: none; 
      
      border-radius: 0; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 0 30px;
      position: relative; 
  }

  /* Style du Chrono (TAILLE RÉDUITE) */
  #displayChrono {
      font-weight: 800; 
      color: var(--primary-deep);
      
      /* Taille réduite pour être discret */
      font-size: 1.3rem; 
      
      font-family: 'Montserrat', sans-serif;
      opacity: 0.8; /* Un peu moins agressif visuellement */
  }

  /* Style du Nom/Prénom/Age */
  .patient-info-block {
      font-size: 1.8rem;
      font-weight: 700;
      color: #37474F;
      text-transform: uppercase;
      
      display: flex;       
      align-items: baseline; /* Aligne le texte sur la ligne d'écriture */
      gap: 15px;           /* Espace entre le nom et l'âge */
  }
  /* La Pastille de Profil (RONDE et CENTRÉE sur ZoneLettres) */
  .pat-profile-badge {
      position: absolute;
      
      /* POSITIONNEMENT : 
         La zone lettres est colonnes 14 à 19. Le centre est environ à 80% de la largeur totale.
      */
      left: 80%; 
      top: 50%;
      transform: translate(-50%, -50%); /* Centrage parfait sur le point 80% */
      
      width: 50px; 
      height: 50px;
      border-radius: 50%; /* ROND */
      
      display: flex;
      justify-content: center;
      align-items: center;
      
      color: white;
      font-weight: 800;
      font-size: 1.8rem; /* Juste le chiffre en gros */
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      border: 2px solid white;
  }
  /* 2. Infos / Pilotage (Juste en dessous) */

 /* 2-A. Zone Pilotage (Alignée sur les Données : Col 1-13) */
 /* 2-A. Zone Pilotage (Alignée sur les Données : Col 1-13) */
 /* 2-A. Zone Pilotage */
  #zonePilotage {
      grid-column: 1 / 13; 
      /* ON DESCEND LA ZONE : Lignes 6 à 8 */
      grid-row: 6 / 8;     
      
      display: flex; 
      flex-direction: column; 
      /* ON COLLE LE CONTENU EN BAS pour toucher les cartes */
      justify-content: flex-end; 
      align-items: center;    
      padding-bottom: 5px;
      
      /* Fond transparent pour que ça fasse "partie" du bloc du dessous */
      background: transparent; 
  }
  /* 2-B. Zone Visuels VA (Alignée sur les Lettres : Col 16-21) */
 /* 2-B. Zone Visuels VA (Alignée sur le Pilotage : Col 16-21) */
 /* 2-B. Zone Visuels VA (Les deux boutons -- / --) */
  #zoneVisuels {
      /* ALIGNEMENT HORIZONTAL : On cale sur la même largeur que #zoneLettres */
      grid-column: 14 / 19; 
      
      /* ALIGNEMENT VERTICAL : On place juste au-dessus (Lignes 5 à 7) */
      grid-row: 7 / 9;       
      
      display: flex; 
      /* On centre le contenu pour qu'il soit bien au milieu de la colonne */
      justify-content: center; 
      align-items: flex-end; /* Collé en bas de la case pour être proche des lettres */
      
      padding-bottom: 5px;
      
      background: transparent; 
      border-radius: 8px;
  }

  /* 3. Données Techniques (Gauche Verticale ?) - À vous de régler */
  /* 3. Données Techniques (HORIZONTALE : Lignes 5 à 7) */
/* 3. Données Techniques (GAUCHE : 75% Largeur) */
/* 3. Données Techniques (GAUCHE : 60% Largeur) */
/* 3. Données Techniques (GAUCHE : 60% Largeur) */
  /* 3. Données Techniques (GAUCHE : 60% Largeur) */
  #examDataStrip {
      grid-column: 1 / 13;  
      /* ON COLLE CETTE ZONE JUSTE SOUS LE PILOTAGE (Ligne 8) */
      grid-row: 8 / 18;     
      
      display: flex;
      flex-direction: row;
      justify-content: center; 
      
      /* C'EST ICI LE SECRET : ON COLLE LES CARTES TOUT EN HAUT DE LEUR ZONE */
      align-items: flex-start; 
      
      gap: 15px; 
      background: transparent;
      overflow: visible;
      padding: 5px;
  }
  
  /* --- STYLE GÉNÉRAL DES CARTES (AR / Fronto) --- */
  .exam-data-strip .data-col { 
      flex: 0 0 110px; 
      height: auto; min-height: 180px;
      
      display: flex; 
      flex-direction: column; 
      justify-content: center;
      
      background: #FCF9F2; 
      
      /* C'EST ICI LE CHANGEMENT : BORDURE PLUS LARGE (4px) */
      border: 4px solid #04ABC6; 
      
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(4, 171, 198, 0.1);
  }

  /* --- SPÉCIFIQUE : Carte Subjectif (Quand elle est INACTIVE) --- */
  /* Elle prend le style du bouton "FERMÉ" (Marron foncé) */
  .exam-data-strip .col-active {
      background: #5D4037 !important; 
      border-color: #5D4037 !important; 
  }

  /* Force la couleur du TEXTE à l'intérieur (Beige clair #D7CCC8) */
  .exam-data-strip .col-active .col-title,
  .exam-data-strip .col-active .val-input,
  .exam-data-strip .col-active .val-big,
  .exam-data-strip .col-active span {
      color: #D7CCC8 !important;
      border-bottom-color: rgba(215, 204, 200, 0.3);
  }

  /* --- SPÉCIFIQUE : Carte Subjectif (Quand elle est ACTIVE/HIGHLIGHT) --- */
  /* Elle devient Cyan (#04ABC6) avec texte Blanc */
  .exam-data-strip .col-active.highlight {
      background: #04ABC6 !important;
      border-color: #026070 !important;
      transform: scale(1.05);
  }
  
  /* Force le texte BLANC quand la carte est active */
  .exam-data-strip .col-active.highlight .col-title,
  .exam-data-strip .col-active.highlight .val-input,
  .exam-data-strip .col-active.highlight .val-big {
      color: #FFFFFF !important;
  }

  /* Suppression des bordures des inputs pour toutes les cartes */
  .exam-data-strip .data-col input, 
  .exam-data-strip .data-col .val-input {
      border: none !important;
      background: transparent !important;
      outline: none;
      box-shadow: none;
      text-align: center;
  }
/* --- COLONNE VERTÉBRALE (Style CARTE avec BORDURE) --- */
  .center-labels {
      display: flex !important;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      
      width: 70px;         
      min-height: 180px;   /* Même hauteur que les cartes voisines */
      margin: 0 5px;
      
      /* 1. FOND CRÈME */
      background: #FCF9F2;           
      
      /* 2. BORDURE CYAN ÉPAISSE (4px) */
      border: 4px solid #04ABC6;     
      border-radius: 8px;            
      
      /* 3. EFFET DE VOLUME (Ombre) */
      box-shadow: 0 4px 6px rgba(4, 171, 198, 0.1);
  }

  /* Espaceur invisible pour aligner S avec la 1ère valeur */
  .center-labels .col-title {
      height: 20px; 
      margin-bottom: 8px;
      visibility: hidden; 
  }

  /* Style des Cercles (S, C, A) à l'intérieur */
  .center-labels .label-row {
      display: flex;
      align-items: center;
      justify-content: center;
      
      width: 40px;
      height: 40px;
      
      margin: 4px 0; /* Espacement vertical */
      
      border-radius: 50%;
      background-color: #FCF9F2; 
      border: 3px solid #04ABC6; 
      color: #04ABC6;            
      
      font-weight: 800;
      font-family: 'Montserrat', sans-serif;
      font-size: 1.1rem;
  }
  /* 4. Zone Lettres (DROITE : Colonnes 16-21) */
  /* 4. Zone Lettres (DROITE : Colonnes 16-21) */
  /* 4. Zone Lettres (DROITE) */
  /* 4. Zone Lettres (DROITE) - CORRIGÉ POUR CENTRAGE */
 /* 4. Zone Lettres (DROITE) - MODIFIÉ (Taille, Position, Bordure) */
  /* 4. Zone Lettres (DROITE) - Centrée et Rétrécie */
  /* 4. Zone Lettres (DROITE) - Montée vers le haut */
  /* 4. Zone Lettres (DROITE) - Alignée sous le Pilotage */
/* 4. Zone Lettres (DROITE) - Descendue d'une ligne */
  #zoneLettres {
      grid-column: 14 / 19; 
      
      /* --- NOUVELLE POSITION (+1) --- */
      grid-row: 9 / 15;      
      
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center;
      
      padding: 5px 0;
      background: #FAFAFA;
      border-radius: 8px;
      border: 2px solid #000000;
      overflow: hidden; 
  }
  /* Style d'une ligne de lettres (le conteneur de la ligne) */
/* --- Style d'une ligne de lettres (Conteneur) --- */
  .va-line-row {
      position: relative;
      
      /* LARGEUR 75% (La barre bleue ne prendra que 3/4 de la largeur) */
      width: 75%;        
      margin: 1px auto; /* Centrage horizontal automatique */
      
      padding: 5px 0;
      
      display: flex;
      justify-content: center;
      align-items: center;
      
      border-radius: 4px;
      
      /* Bordure invisible par défaut */
      border: 2px solid transparent; 
      transition: all 0.2s ease;
  }

  /* --- La valeur de l'acuité (le chiffre à droite) --- */
  /* --- La valeur de l'acuité (le chiffre à droite) --- */
  /* --- La valeur de l'acuité (le chiffre à droite) --- */
  .va-tag-value {
      position: absolute;
      
      /* Position horizontale */
      right: -15%; 
      
      top: 50%;          
      transform: translateY(-50%);
      
      font-family: 'Montserrat', sans-serif;
      font-size: 1rem;    
      font-weight: 800;
      color: #000000;     
      
      /* --- NOUVEAU : RESSERRER LES CHIFFRES --- */
      letter-spacing: -1px; /* Valeur négative pour rapprocher les caractères */
      /* --------------------------------------- */
      
      background: transparent; 
      border: none;
      padding: 0;
      z-index: 10;
      
      width: 40px;       
      text-align: right; 
      white-space: nowrap; 
  }

  /* --- LA LIGNE SÉLECTIONNÉE (Active) --- */
  .va-line-row.line-selected {
      background-color: rgba(4, 171, 198, 0.15); /* Fond Cyan léger */
      
      /* BORDURE CYAN */
      border-color: #04ABC6; 
      
      box-shadow: none;
  }

  /* --- Style du texte des lettres --- */
  .optotype-text {
      font-family: 'Montserrat', 'Arial', sans-serif; 
      font-weight: bold;
      color: #333;
      line-height: 1;
      
      /* TAILLE DES LETTRES */
      font-size: 2.5rem !important; 
      letter-spacing: 5px;
      
      /* Centrage du texte */
      text-align: center;
      width: 100%;
  }
 /* 5. Zone Boutons (Bas de l'écran - Centrée) */
  /* 5. Zone Boutons (Bas de l'écran - Remontée) */
  /* 5. Zone Boutons (Bas de l'écran - Sans bordure) */
  #zoneBoutons {
      grid-column: 1 / 21;
      
      /* Position remontée (Ligne 17) */
      grid-row: 17 / 21;     
      
      display: flex; 
      justify-content: center; 
      align-items: flex-start; /* Collé en haut */
      padding-top: 10px;       
      
      /* COULEUR CRÈME */
      background: #FCF9F2; 
      
      /* --- MODIFICATION : PLUS DE LIGNE GRISE --- */
      border-top: none; 
      /* ---------------------------------------- */
      
      z-index: 100;
  }

/* --- STYLE DE LA QUESTION "COMBIEN DE LETTRES LUES ?" --- */
  /* --- STYLE DES QUESTIONS (Lettres lues ET Vitesse) --- */
  #standardButtons p, #cadenceButtons p {
      /* On force la même grande taille pour les deux */
      font-size: 1.6rem !important; 
      
      color: #37474F !important; 
      font-weight: 700 !important;
      margin-bottom: 15px !important;
      margin-top: 0 !important; /* Sécurité pour l'alignement */
  }
  
  /* --- LE SCHOBER (OVERLAY TOTAL) --- */
  #schoberStep {
      position: fixed;   /* Sort de la grille, se place par rapport à la fenêtre */
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: #ECEFF1; /* Fond gris clair pour masquer le reste */
      z-index: 9999;       /* Au dessus de tout */
      
      /* Centrage du contenu */
      display: flex; 
      justify-content: center; 
      align-items: center;
      padding: 20px;
  }
  
  /* IMPORTANT : Quand JS ajoute la classe .hidden, on cache l'overlay */
  #schoberStep.hidden {
      display: none !important;
  }

  /* RESPONSIVE MOBILE */
  @media (max-width: 900px) {
      .app-container {
          display: flex; /* Retour en flex simple pour mobile */
          flex-direction: column;
          height: auto;
          overflow: visible;
      }
      #zonePatient, #zoneInfos, #examDataStrip, #zoneLettres, #zoneBoutons {
          width: 100%;
          grid-column: auto; grid-row: auto; /* Reset grille */
          margin-bottom: 10px;
      }
      #examDataStrip { flex-direction: row; flex-wrap: wrap; }
      .exam-data-strip .data-col { flex: 1; min-width: 100px; }
  }

  /* --- STYLES ÉLÉMENTS SPÉCIFIQUES --- */

  /* Boutons Pilotage */
  .btn-pilot {
      width: 60px; height: 38px; border-radius: 6px; font-weight: bold; cursor: pointer; border: 2px solid transparent; font-size: 1rem;
  }
  .btn-pilot.open { background: #fff; border-color: #B0BEC5; color: #78909C; }
  .btn-pilot.closed { background: #455A64; border-color: #455A64; color: #90A4AE; opacity: 0.5; }
  .btn-pilot.active { background: var(--primary); color: white; border-color: var(--primary-dark); opacity: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .btn-pilot.open { background: #FFF; border-color: transparent; color: #78909C; box-shadow: 0 2px 5px rgba(0,0,0,0.05); } 
  .btn-pilot.closed { background: #5D4037; border-color: #5D4037; color: #D7CCC8; opacity: 0.6; }
  .btn-pilot.active { background: var(--primary); color: white; border-color: var(--primary-dark); opacity: 1; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }

  .btn-mode-display {
      padding: 5px 15px; background: #ECEFF1; color: #455A64; font-size: 0.85rem; font-weight: 700; border-radius: 12px; border: 1px solid #CFD8DC; text-transform: uppercase; min-width: 140px; text-align: center;
      padding: 5px 15px; background: #EFEBE9; color: #5D4037;
      font-size: 0.85rem; font-weight: 700; border-radius: 12px; border: none; 
      text-transform: uppercase; min-width: 140px; text-align: center;
  }

  /* Indicateurs Visuels VA */
  .va-box-display {
      width: 80px; height: 50px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem; /* Un peu plus petit */
      font-weight: bold; font-family: 'Montserrat', sans-serif;
      background: #FAFAFA; color: #CFD8DC; border: 2px solid #F0F0F0;
      font-size: 1.5rem; font-weight: bold; font-family: 'Montserrat', sans-serif;
      background: #FFF; 
      color: #BCAAA4; border: none; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .va-box-display.active-eye {
      background: #E0F7FA; color: var(--primary-dark); border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      background: #E0F7FA; color: var(--primary-dark); border: 2px solid var(--primary);
  }

 /* --- COLONNES DE DONNÉES --- */
.exam-data-strip { 
    display: flex; 
    gap: 5px;        /* Petit écart entre les cartes */
    width: 100%;     /* <--- IMPORTANT : Prend toute la largeur disponible */
    justify-content: space-between; /* Répartit les cartes équitablement */
    align-items: flex-start; 
}

 /* 1. Colonnes Passives (RA, Fronto) */
.data-col { 
    display: flex; flex-direction: column; 
    /* width: 135px;  <-- SUPPRIMER CETTE LIGNE */
    flex: 1;          /* <--- NOUVEAU : S'étire pour remplir l'espace */
    min-width: 0;     /* Permet à la colonne de rétrécir si besoin */
    
    background: var(--bg-main); 
    border: none; /* Ou votre bordure cyan si vous l'avez gardée */
    
    border-radius: 8px; 
    padding: 5px;     /* Padding interne réduit */
    text-align: center; 
    transition: all 0.3s ease; 
}

  /* ================================================================= */
  /* 2. COLONNE CENTRALE (DESIGN "VERTEBRALE") */
  /* ================================================================= */
  .center-labels {
      display: flex; 
      flex-direction: column; 
      align-items: center;
      
      /* Apparence de la colonne conteneur */
      width: 50px; /* Plus large pour accueillir les cercles */
      padding: 10px 0;
      background-color: #FAFAFA; /* Fond gris très clair */
      border-left: 2px solid #E0E0E0; /* Bordure Gauche */
      border-right: 2px solid #E0E0E0; /* Bordure Droite */
      border-radius: 30px; /* Forme de pilule */
      margin: 0 5px; /* Petit espacement latéral */
      flex-shrink: 0;
  }

  /* Le style des CERCLES (S, C, A) */
  .label-row {
      display: flex; 
      align-items: center; 
      justify-content: center;
      
      /* Dimensions du cercle */
      width: 34px; 
      height: 34px;
      border-radius: 50%; /* Forme ronde */
      border: 2px solid #B0BEC5; /* Bordure du cercle */
      background-color: #FFFFFF; /* Fond blanc pour contraste */
      
      /* Typographie */
      font-weight: 800; 
      font-size: 1.1rem; /* Texte plus grand */
      color: #546E7A; 
      font-family: 'Montserrat', sans-serif;

      /* ALIGNEMENT VERTICAL PRÉCIS */
      /* Doit correspondre à la hauteur + marge des lignes de données */
      margin-bottom: 2px; /* Ajusté pour s'aligner avec les inputs */
  }
  
  /* Cas spécifique pour VA (Cercle Bleu) */
  .va-label {
      margin-top: 5px; 
      border-color: var(--primary); /* Bordure Cyan */
      color: var(--primary); /* Texte Cyan */
      font-size: 1rem;
  }

 /* 3. Carte Subjectif - ÉTAT INACTIF */
.col-active { 
    /* width: 175px; <-- SUPPRIMER CETTE LIGNE */
    flex: 1.2;       /* <--- Un peu plus large que les AR/LM (Ratio 1.2 vs 1) */
    min-width: 0;    /* Important pour le responsive */
    
    z-index: 1; transform: scale(0.98); 
    background-color: #F5F5F5; border: 2px solid #E0E0E0; box-shadow: none; 
    border-radius: 8px; /* Ajout esthétique */
}
  .col-active .col-title { color: #B0BEC5; border-bottom-color: #E0E0E0; }
 .col-active .val-big { 
    color: #B0BEC5; 
    font-size: 1.3rem; /* <--- RÉDUIT (était 1.8rem) */
    font-weight: 800; 
    transition: color 0.2s; 
}
  .col-active #disp_subjOD_va, .col-active #disp_subjOG_va { color: #B0BEC5; font-weight: bold; transition: color 0.2s; }
  .col-active .val-input { color: #B0BEC5 !important; width: 100%; text-align: center; background: transparent; border: none; font-weight: 700; font-size: 1.2rem; }

  /* ================================================================= */
  /* 4. Carte Subjectif - ÉTAT ACTIF (Cyan/Blanc) */
  /* ================================================================= */
  .col-active.highlight {
      z-index: 10; transform: scale(1.05); 
      background-color: var(--primary) !important; border-color: var(--primary-deep) !important; 
      box-shadow: 0 10px 25px rgba(4, 171, 198, 0.3);
  }
  .col-active.highlight .col-title { color: #FFFFFF !important; border-bottom-color: rgba(255,255,255,0.3); }
  .col-active.highlight .val-big { color: #FFFFFF !important; }
  .col-active.highlight #disp_subjOD_va, .col-active.highlight #disp_subjOG_va { color: #FFFFFF !important; }
  .col-active.highlight .val-input { color: #FFFFFF !important; }

  /* ================================================================= */
  /* 5. ALIGNEMENTS */
  /* ================================================================= */
  .lbl { display: none !important; } 
  
  .col-title { 
      font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-bottom: 8px; 
      border-bottom: 1px solid #F5F5F5; padding-bottom: 4px; width: 100%; white-space: nowrap;
  }
  .title-ra { color: var(--primary); }
  .title-subj { color: var(--primary-dark); font-size: 1rem; transition: color 0.2s; }
  
  /* Ajustement de la hauteur des lignes de données pour s'aligner aux cercles */
  .data-line { 
      display: flex; justify-content: center; align-items: center; 
      height: 34px; /* Hauteur identique aux cercles */
      margin-bottom: 2px; /* Marge identique aux cercles */
  }
  .val-input { font-family: 'Montserrat', sans-serif; }
  
  /* --- LETTRES (VERSION RÉDUITE) --- */
  /* --- LETTRES --- */
  .letter-display { 
      font-family: 'Segoe UI', sans-serif; 
      font-size: 3rem; /* RÉDUIT (était 5.5rem) */
      font-weight: bold; color: #263238; letter-spacing: 8px; 
      font-size: 3rem; 
      font-weight: bold; color: #3E2723; 
      letter-spacing: 8px; 
  }

  .info-bar { font-size: 1.1rem; color: var(--text-muted); margin-bottom: 15px; }
  .info-bar { font-size: 1.1rem; color: #8D6E63; margin-bottom: 15px; }

  /* STYLE DES PANNEAUX */
  .section { 
      background: var(--panel); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 10px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  h2 { 
      margin-top: 0; margin-bottom: 8px; 
      color: var(--primary-dark); 
      font-size: 1rem; 
      border-bottom: 1px solid var(--primary-border); 
      padding-bottom: 2px; 
  }

  .hidden { display: none !important; }

  /* INPUTS & RESUME */
  .summary-grid { display: grid; grid-template-columns: 1fr; gap: 5px; font-size: 0.95rem; }
  .summary-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
  .summary-lbl { color: var(--text-muted); font-weight: 600; }
  .summary-val { color: var(--primary-dark); font-weight: bold; }

  .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

  /* Grille compacte pour la section 2 */
  .mini-data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3px; text-align: center; }

  label { display: block; font-weight: 600; margin-bottom: 1px; font-size: 0.75rem; color: var(--text-muted); }
  input, select { 
      width: 100%; padding: 4px; 
      border: 1px solid #ccc; border-radius: 4px; 
      font-size: 0.9rem; background: #fff;
  }
  input:disabled, select:disabled { background-color: #F5F5F5; color: #888; border-color: #E0E0E0; }

  /* CHECKBOX ALIGNMENT */
  .check-grid { display:grid; grid-template-columns: 1fr 1fr; gap:5px; text-align: left; }
  .check-lbl { 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      font-weight: normal; 
      color: var(--text-main); 
      font-size: 0.9rem;
      cursor: pointer;
      padding: 5px;
      border: 1px solid #eee;
      border-radius: 4px;
  }
  .check-lbl:hover { background: #f9f9f9; }
  .check-lbl input { width: auto; margin: 0; cursor: pointer; }

  /* --- COULEURS PERSONNALISÉES DES DONNÉES --- */

/* 1. Autoréfractomètre (RA) */
input[id^="ra"] {
    color: var(--primary); 
    background-color: transparent; 
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    border: none; 
    text-align: center; 
    
    width: 100%;        /* <--- IMPORTANT : Prend la largeur de la colonne */
    font-size: 0.9rem;  /* <--- TAILLE RÉDUITE (était 1.1rem ou +) */
    padding: 2px 0;     /* Ajustement vertical */
}

/* Faites pareil pour input[id^="fronto"] juste en dessous */
input[id^="fronto"] {
    /* ... (mêmes propriétés de couleur) ... */
    width: 100%;
    font-size: 0.9rem;  /* <--- TAILLE RÉDUITE */
    padding: 2px 0;
}
  
  /* GRILLE VALEURS */
  .col-head { background: #ECEFF1; font-weight: bold; font-size: 0.7rem; padding: 4px 0; border-radius: 3px; }
  .col-input { padding: 3px; text-align: center; font-weight: 600; }
  .val-box { 
      background: var(--primary-light); color: var(--primary-dark);
      border: 1px solid var(--primary-border);
      font-weight: bold; font-size: 0.95rem; 
      display: flex; align-items: center; justify-content: center; 
      border-radius: 4px; min-height: 24px;
  }
  .col-max-va { background: #E8F5E9; color: #2E7D32; font-size: 0.8rem; border-color: #C8E6C9; }

  /* TITRES BLOCS DONNEES */
  .data-block-title {
      font-size: 0.75rem; font-weight:bold; color:var(--primary); text-align:center; 
      margin-bottom:3px; text-transform:uppercase; border-bottom:1px solid var(--primary-light);
  }




  /* MESSAGE BOX (CACHÉE) */
  .message-box { display: none !important; }
  .success-msg { background: #E0F2F1; color: #00695C; border-color: #B2DFDB; }

  /* BOUTONS REPONSE */
  .response-area { width: 100%; text-align: center; }

  .btn-grid { 
      display: flex; 
      justify-content: center; 
      gap: 40px; 
      flex-wrap: wrap; 
  }

  .btn-resp { 
      width: 80px; height: 80px;
      border-radius: 50%; border: none; 
      background: var(--primary-light); color: var(--primary-dark); 
      font-size: 2rem; 
      font-weight: bold; 
      cursor: pointer; transition: 0.2s; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  .btn-resp:hover { background: var(--primary); color: white; transform: scale(1.15); }

  .btn-resp.locked, .btn-action.locked, .btn-timer.locked, .btn-decision.locked {
      opacity: 0.5; cursor: wait; pointer-events: none;
  }

  /* ACTION BUTTONS */
  .btn-action { 
      padding: 15px 25px; border-radius: 8px; border: none; 
      color: white; font-weight: bold; cursor: pointer; 
      font-size: 1.1rem; margin-top: 10px; width: 100%;
      box-shadow: 0 3px 5px rgba(0,0,0,0.1);
      transition: background 0.2s;
  }

  .btn-start, .btn-validate, .btn-manual, .btn-rules { background: var(--primary); }
  .btn-start:hover, .btn-validate:hover { background: var(--primary-dark); }
  .btn-import { background: var(--primary-dark); }
  .btn-import:hover { background: var(--primary-deep); }

  /* --- Style spécifique pour GROSSIR les émojis --- */
  .emoji-icon {
      font-size: 3rem;        /* Taille géante pour l'émoji */
      vertical-align: middle; 
      margin-right: 15px;     /* Espace entre l'animal et le texte */
      line-height: 0;         /* Empêche l'émoji de déformer la hauteur */
      margin-top: -5px;       /* Petit ajustement vertical */
  }

  /* --- Ajustement du bouton pour accueillir l'émoji --- */
  .btn-tortue, .btn-lapin {
      background: var(--primary-light); 
      color: var(--primary-dark); 
      border: 2px solid var(--primary-border);
      
      font-size: 1.3rem;      /* Taille normale pour le texte */
      padding: 0 40px;        /* Padding horizontal */
      
      /* Flexbox pour aligner l'émoji et le texte */
      display: flex !important;
      align-items: center;
      justify-content: center;
      
      height: 80px;           /* Hauteur fixe pour que ça reste propre */
  }

  .btn-tortue:hover, .btn-lapin:hover { 
      background: var(--primary); 
      color: white; 
  }
  /* PROFIL */
  .force-profile-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 15px; }
  .btn-profile { padding: 8px; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .p-green { background: #26A69A; } .p-blue { background: #42A5F5; }
  .p-orange { background: #FFA726; } .p-red { background: #EF5350; }

  /* BOUTONS EXAMEN */
  .btn-timer { 
      background: var(--primary); color: white; padding: 15px 35px; font-size: 1.2rem; 
      border-radius: 40px; border:none; cursor: pointer; margin-bottom: 15px;
  }
  .btn-timer:hover { background: var(--primary-dark); }
  .decision-row { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
  .btn-decision { padding: 12px 25px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
  .btn-blue { background: var(--primary); } 
  .btn-orange { background: var(--primary-dark); } 
  .btn-red { background: var(--primary-deep); } 
  .btn-green { background: var(--primary); } 
  .btn-grey { background: var(--primary-light); color: var(--primary-dark); border: 1px solid var(--primary-border); }
  .btn-grey:hover { background: var(--primary-border); }

  /* RESPONSIVE */
  @media (max-width: 900px) {
      body { overflow: auto; height: auto; } 
      .app-container { height: auto; display: block; }
      .dashboard-wrapper { display: block; } 
      .left-panel { width: 100%; margin-bottom: 15px; }
      .right-panel { min-height: 400px; }
  }

  /* MODAL */
  .modal-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(55, 71, 79, 0.9); z-index: 9999; 
      display: flex; justify-content: center; align-items: center; 
  }
  .modal-content { background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; text-align: center; }
  .modal-text { font-size: 1.2rem; line-height: 1.5; margin-bottom: 25px; color: var(--text-main); }

  /* Visual JCC */
  /* --- NOUVEAU STYLE AXE (JCC) ALIGNÉ SUR LES BULLES --- */

/* Conteneur pour centrer les cercles 1 et 2 dans le schéma */
#schemaContainer .jcc-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    justify-content: center;
    gap: 120px; /* Écarte les cercles pour laisser respirer le centre */
    width: 100%;
    pointer-events: none; /* L'animation ne doit pas gêner les clics */
    z-index: 300;
}

/* Style "Bulle" identique au test de sphère */
/* --- Modif JCC Visuals --- */
/* --- VISUELS JCC (CORRIGÉS) --- */
.jcc-visual {
    width: 95px;
    height: 95px;
    border-radius: 50%;
    background: #FFFFFF;
    border: 5px solid #CFD8DC;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    position: relative; /* Indispensable pour le centrage des enfants */
    opacity: 0; 
    pointer-events: none;
}

.jcc-visual.active {
    opacity: 1;
    transform: scale(1.1);
    border-color: var(--primary);
}

/* Chiffres 1 et 2 forcés au centre */
.jcc-label {
    position: absolute; /* Sort du flux pour ne pas pousser l'image */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Centrage mathématique parfait */
    font-weight: 800;
    font-size: 2.2rem; /* Taille augmentée */
    color: var(--text-main);
    z-index: 2;
    margin: 0;
    line-height: 1;
}

.arrow-svg { 
    width: 90px; 
    height: 90px; 
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    overflow: visible !important; 
    z-index: 1;
}
  /* INPUTS MODAL */
  .modal-input-grid {
      display: flex;
      flex-direction: column; 
      gap: 10px;
      text-align: left;
      margin-bottom: 20px;
  }
  .modal-input-group label {
      display: block;
      margin-bottom: 3px;
      color: var(--text-muted);
      font-size: 0.85rem;
  }
  .modal-input-group input {
      font-size: 1.1rem;
      padding: 6px;
      text-align: center;
      border: 1px solid var(--primary-border);
      width: 100%;
  }
  .modal-eye-title {
      text-align: center;
      font-weight: bold;
      color: var(--primary-dark);
      margin-bottom: 10px;
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 5px;
      font-size: 1.1rem;
  }
  .device-header {
      font-weight: 700; color: var(--primary); margin-bottom: 15px; text-transform: uppercase; font-size: 1.1rem; text-align: center;
  }
  .data-source-lbl {
      font-weight: 600; color: var(--primary-dark); margin-bottom: 5px; margin-top: 15px; display: block;
  }

  /* --- STYLE TEST DE SCHOBER --- */
  .schober-container { display: flex; flex-direction: column; gap: 15px; width: 100%; align-items: center; border: 1px solid #ECEFF1; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
  .schober-group-title { font-weight: bold; font-size: 1rem; color: var(--primary-deep); text-transform: uppercase; margin-bottom: 15px; border-bottom: 2px solid var(--primary-light); display: inline-block; padding-bottom: 5px; }

  /* Nouveaux styles pour les sous-catégories */
  .schober-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; }
  .schober-sub-group { display: flex; flex-direction: column; align-items: center; background: #FAFAFA; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
  .schober-sub-title { font-size: 0.8rem; font-weight: 700; color: #00838F; margin-bottom: 10px; text-align: center; max-width: 140px; min-height: 30px; display:flex; align-items:center; justify-content:center; }

  .schober-grid { display: flex; justify-content: center; gap: 10px; }

  .btn-schober { width: 90px; height: 90px; background-color: #000000; border: 3px solid #455A64; border-radius: 12px; cursor: pointer; position: relative; display: flex; justify-content: center; align-items: center; transition: transform 0.2s, border-color 0.2s; }
  .btn-schober:hover { transform: scale(1.05); border-color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

  /* SVG Styles */
  .sch-cross { stroke: #FF0000; stroke-width: 4; }
  .sch-circle { stroke: #00FF00; stroke-width: 4; fill: none; }
  .sch-faint { opacity: 0.3; stroke-dasharray: 4; }

  .step-instruction { font-size: 1.2rem; color: var(--text-main); margin-bottom: 25px; text-align: center; background: #E1F5FE; padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); }

/* --- CORRECTION Z-INDEX MODALES --- */
/* Force les modales à être TOUJOURS au-dessus du Schober (qui est à 9999) */
.modal-overlay {
    z-index: 20000 !important; 
}  

/* --- SÉCURITÉ AFFICHAGE COLONNE CENTRALE --- */
.center-labels {
    display: flex !important; /* Force l'affichage même si caché ailleurs */
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    width: 60px;
    margin: 0 5px;
    padding-top: 5px;
    background: transparent;
}

.center-labels .col-title {
    height: 20px;
    margin-bottom: 8px;
    visibility: hidden;
}

.center-labels .label-row {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    margin-top: 2px;
    margin-bottom: 2px;
    border-radius: 50%;
    
    /* VOS COULEURS : Fond Crème, Bordure Cyan 4px */
    background-color: #FCF9F2;
    border: 4px solid #04ABC6; 
    color: #04ABC6;
    
    font-weight: 800;
    font-family: 'Montserrat', sans-serif;
    font-size: 1.1rem;
}  

/* --- BOUTON ALÉATOIRE (SHUFFLE) --- */
#btnRandomLetters {
    /* PLACEMENT GRILLE : Juste à droite de zoneLettres (qui finit col 19) */
    grid-column: 19 / 21; 
    /* Centré verticalement par rapport à zoneLettres (lignes 9-15) */
    grid-row: 11 / 13;    
    
    /* ESTHÉTIQUE */
    background-color: #04ABC6; /* Bleu Cyan */
    border: 3px solid #026070; /* Bleu plus foncé */
    border-radius: 50%;        /* Rond parfait */
    
    width: 60px;
    height: 60px;
    
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: transform 0.2s, background 0.2s;
    
    /* S'assure qu'il est au dessus */
    z-index: 50;
    margin: auto; /* Centrage dans sa case de grille */
}

#btnRandomLetters:hover {
    transform: scale(1.1) rotate(180deg); /* Petit effet de rotation sympa */
    background-color: #03889E;
}

#btnRandomLetters:active {
    transform: scale(0.95);
}

#btnRandomLetters svg {
    width: 30px;
    height: 30px;
    fill: none;
    stroke: white;
    stroke-width: 2.5;
    stroke-linecap: round;
    stroke-linejoin: round;
}
/* ========================================================= */
/* 1. ANIMATION SCHÉMA SPHERE (VERSION FINALE)               */
/* ========================================================= */

#schemaContainer {
    grid-column: 1 / 13; 
    grid-row: 14 / 17; /* Position remontée */
    
    display: flex; justify-content: center; align-items: center;
    position: relative; background: transparent;
    z-index: 200; pointer-events: none;
}

/* Style des bulles */
.anim-bubble {
    width: 90px; height: 90px;
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center; text-align: center;
    font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 0.9rem; line-height: 1.2;
    padding: 5px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

/* CERCLE BLEU (BASE) - Fixe au centre */
.bubble-base {
    background: #E0F7FA; border: 3px solid #04ABC6; color: #006064;
    z-index: 10;
    opacity: 0; transform: scale(0.8);
    transition: opacity 0.5s, transform 0.5s;
}
.bubble-base.visible { opacity: 1; transform: scale(1); }

/* --- GAUCHE (+0.25) --- */
.arrow-connector {
    position: absolute; right: 50%; margin-right: 44px;
    height: 6px; background-color: #04ABC6; width: 0px; 
    transition: width 0.4s ease-out; z-index: 5;
}
.arrow-connector::before {
    content: ''; position: absolute; left: -8px; top: -5px; width: 0; height: 0;
    border-top: 8px solid transparent; border-bottom: 8px solid transparent; 
    border-right: 12px solid #04ABC6; opacity: 0; transition: opacity 0.2s;
}
.arrow-connector.active { width: 100px; }
.arrow-connector.active::before { opacity: 1; }

.bubble-target {
    position: absolute; background: #E8F5E9; border: 3px solid #43A047; color: #1B5E20;
    z-index: 6; right: 50%; margin-right: 45px; 
    opacity: 0; transform: scale(0.5); transition: all 0.4s ease-out;
}
.bubble-target.visible { opacity: 1; transform: translateX(-110px) scale(1); }

/* --- DROITE (-0.25) --- */
.arrow-connector-right {
    position: absolute; left: 50%; margin-left: 44px;
    height: 6px; background-color: #04ABC6; /* TIGE BLEUE */
    width: 0px; transition: width 0.4s ease-out; z-index: 5;
    top: 50%; transform: translateY(-50%);
}
.arrow-connector-right::before {
    content: ''; position: absolute; right: -8px; top: -5px; width: 0; height: 0;
    border-top: 8px solid transparent; border-bottom: 8px solid transparent; 
    border-left: 12px solid #04ABC6; /* POINTE BLEUE */
    opacity: 0; transition: opacity 0.2s;
}
.arrow-connector-right.active { width: 100px; }
.arrow-connector-right.active::before { opacity: 1; }

.bubble-target-minus {
    position: absolute; background: #FFEBEE; border: 3px solid #D32F2F; color: #B71C1C;
    z-index: 6; left: 50%; margin-left: 45px; top: 54%; 
    opacity: 0; transform: translate(-50%, -50%) scale(0.5); transition: all 0.4s ease-out;
}
.bubble-target-minus.visible { opacity: 1; transform: translate(110px, -50%) scale(1); }


/* ========================================================= */
/* 2. STYLE BIO-MONOCULAIRE (Oeil Passif)                    */
/* ========================================================= */
.exam-data-strip .col-bio-inactive {
    background: rgba(4, 171, 198, 0.1) !important; 
    border-color: rgba(4, 171, 198, 0.4) !important; 
    transform: scale(1) !important; opacity: 0.9;
}
.exam-data-strip .col-bio-inactive .val-big,
.exam-data-strip .col-bio-inactive .col-title,
.exam-data-strip .col-bio-inactive .val-input,
.exam-data-strip .col-bio-inactive span {
    color: #00838F !important; 
}

/* ========================================================= */
/* === NOUVEAUX BOUTONS & STYLE RETESTER (FINAL) ===         */
/* ========================================================= */

/* 1. Z-INDEX PARENT (CRUCIAL) */
#zoneBoutons {
    z-index: 500 !important;
    position: relative;
}

/* 2. Conteneur principal (Hauteur ajustée -85px) */
#checkPlusZone {
    position: relative;
    width: 100%;
    margin-top: -127px; 
    pointer-events: auto;
    z-index: 600 !important;
}

/* Ligne des boutons (Alignement haut) */
.decision-row-round {
    display: flex;
    justify-content: center;
    align-items: flex-start; 
    gap: 30px;
    width: 100%;
    position: relative;
    padding-top: 10px;
}

/* 3. Style des Boutons Ronds (Base 90px) */
.btn-round {
    width: 90px; height: 90px;
    border-radius: 50%;
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    font-size: 0.8rem;
    line-height: 1.1;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    transition: transform 0.2s;
    border: none;
    display: flex; justify-content: center; align-items: center; text-align: center;
    flex-shrink: 0;
}
.btn-round:hover { transform: scale(1.05); }
.btn-round:active { transform: scale(0.95); }

/* --- COULEURS --- */
.btn-round-green { background: #43A047; color: white; border: 2px solid #2E7D32; }
.btn-round-red   { background: #EF5350; color: white; border: 2px solid #C62828; }
.btn-round-blue  { background: #E0F7FA; color: #006064; border: 3px solid #04ABC6; }
.btn-round-outline { background: transparent; color: #00838F; border: 2px solid #04ABC6; }

/* 4. NOUVEAU STYLE : BOUTON RETESTER (Rond et Gris) */
.btn-round-grey { 
    background: #ECEFF1; 
    color: #546E7A; 
    border: 2px solid #CFD8DC; 
}
.btn-round-grey:hover { background: #CFD8DC; }

/* 5. COLONNE VERTICALE (ESPACEMENT) */
.btn-col-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    
    /* Espace vertical entre le bouton bleu et Retester */
    gap: 25px; 
    
    width: 90px; 
}

/* 6. DÉCALAGES PRÉCIS */
#decisionsPlus { transform: translateX(-401px); }
#decisionsMinus { transform: translateX(-161px); }

/* --- AJOUT POUR LA VISIBILITÉ DE L'AXE --- */

/* On s'assure que les boutons de l'axe sont bien visibles */
/* --- STYLE FINAL DES BOUTONS DE RÉPONSE AXE (JCC) --- */

/* --- BOUTONS RÉPONSE AXE (JCC) REPOSITIONNÉS ET RÉDUITS --- */
#axisControls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    margin-top: 20px;
}

#axisDecisions {
    display: flex;
    gap: 20px;
    justify-content: center;
}

/* Style des 3 boutons de choix (Mieux 1, Mieux 2, Pareil) */
#axisDecisions .btn-decision {
    width: 65px !important;
    height: 65px !important;
    min-width: 65px !important;
    border-radius: 50% !important;
    background: #FFFFFF !important;
    font-family: 'Montserrat', sans-serif;
    font-weight: 800;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1.2;
    text-transform: uppercase;
    transition: all 0.2s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

/* Style spécifique du bouton RÉPÉTER (RETESTER) */
#btnReplayAxis {
    width: 65px !important;
    height: 65px !important;
    border-radius: 50% !important;
    background: #ECEFF1 !important; /* Gris clair comme les autres retester */
    color: #546E7A !important;
    border: 2px solid #CFD8DC !important;
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    font-size: 0.75rem;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

#axisDecisions .btn-blue { border: 4px solid #116dff !important; color: #116dff !important; }
#axisDecisions .btn-orange { border: 4px solid #fd7e14 !important; color: #fd7e14 !important; }
#axisDecisions .btn-green { border: 4px solid #43A047 !important; color: #43A047 !important; }

#axisDecisions .btn-decision:hover, #btnReplayAxis:hover {
    transform: scale(1.05);
}  
</style>
</head>
<body onload="window.startAppSequence()">

<div id="modalPatientID" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Identification du Patient</h2>
        <div class="config-grid" style="text-align:left; margin: 20px 0;">
            <div><label>Nom</label><input type="text" id="inName"></div>
            <div><label>Prénom</label><input type="text" id="inForename"></div>
            <div><label>Date Naiss.</label><input type="date" id="inDob"></div>
            <div><label>UID</label><input type="text" id="inUID" readonly style="background:#ECEFF1; color:var(--primary-dark); font-weight:bold; cursor:not-allowed;"></div>
        </div>
        <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; font-size:1.1rem; border-radius:50px;" onclick="window.validatePatientID()">VALIDER</button>
    </div>
</div>

<div id="modalProfileCalc" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 900px;">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Profil Accommodatif</h2>

        <div class="config-grid" style="text-align:left; margin-bottom:15px;">
            <div>
                <label>Rythme des consultations par année</label>
                <select id="inRhythm"><option value="0">...</option><option value="1">1x/an</option><option value="2">1x/2ans</option><option value="3">< 1x/2ans</option></select>
            </div>
            <div>
                <label>Nombres de signes de décompensation de phorie par mois</label>
                <select id="inSigns"><option value="0">0</option><option value="2">3-4</option><option value="3">> 4</option></select>
            </div>
        </div>

        <div class="check-grid" style="margin-bottom:20px;">
            <label class="check-lbl"><input type="checkbox" id="chkMyopia" onchange="window.toggleMyopiaHyper('myopia')"> Myopie > 3 dioptries</label>
            <label class="check-lbl"><input type="checkbox" id="chkHyper" onchange="window.toggleMyopiaHyper('hyper')"> Hypermétropie < 1 dioptrie</label>
            <label class="check-lbl"><input type="checkbox" id="chkNear"> Habitudes de près</label>
            <label class="check-lbl"><input type="checkbox" id="chkNoSpecs"> Lunettes Mal ou non portées</label>
            <label class="check-lbl"><input type="checkbox" id="chkMono"> Monophtalme</label>
        </div>

        <button class="btn-action btn-start" style="padding:15px; font-size:1.1rem;" onclick="window.calculateProfileAndShowData()">CALCUL DU PROFIL ACCOMMODATIF</button>

        <div style="text-align:center; margin:15px 0 5px 0; color:var(--text-muted); font-size:0.9rem;">Ou forcer le profil :</div>
        <div class="force-profile-row">
            <button id="btnProfile1" class="btn-profile p-green" onclick="window.forceProfileAndShowData('1')">Bon (1)</button>
            <button class="btn-profile p-blue" onclick="window.forceProfileAndShowData('2')">Moyen</button>
            <button class="btn-profile p-orange" onclick="window.forceProfileAndShowData('3')">Difficile</button>
            <button class="btn-profile p-red" onclick="window.forceProfileAndShowData('3+')">Très Diff.</button>
        </div>
    </div>
</div>

<div id="modalEntryMethod" class="modal-overlay hidden">
    <div class="modal-content" style="max-width:500px;">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Saisie des Données</h2>
        <div class="modal-text">Sélectionnez l'appareil à renseigner :</div>

        <div style="display:flex; flex-direction:column; gap:15px;">
            <button class="btn-action btn-manual" style="background:#FFF; color:var(--primary-dark); border:2px solid var(--primary-border);" onclick="window.openModal('AutoRef')">
                <strong>AUTO-RÉFRACTOMÈTRE (RA)</strong><br>
                <span style="font-size:0.8rem;">Saisie Sphère / Cyl / Axe</span>
            </button>

            <button class="btn-action btn-manual" style="background:#FFF; color:#546E7A; border:2px solid #CFD8DC;" onclick="window.openModal('Fronto')">
                <strong>FRONTOFOCOMÈTRE</strong><br>
                <span style="font-size:0.8rem;">Lunettes portées</span>
            </button>

            <div style="height:1px; background:#eee; margin:10px 0;"></div>

            <button class="btn-action btn-import" onclick="window.simulateImport()">
                Importer depuis les appareils (Simul.)
            </button>

            <button class="btn-action btn-validate" style="margin-top:10px;" onclick="window.finishDataEntry()">
                TERMINER LA SAISIE
            </button>
        </div>
    </div>
</div>
<div id="modalInputAutoRef" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 600px;">
        <h2 style="color:var(--primary); border:none;">Auto-Réfractomètre (RA)</h2>

        <div style="display:flex; gap:20px; margin-bottom:20px;">
            <div style="flex:1;">
                <div class="modal-eye-title">ŒIL DROIT</div>
                <div class="modal-input-grid">
                    <div class="modal-input-group"><label>Sphère</label><input type="text" id="mod_raOD_sph" placeholder="+/- 0.00" inputmode="decimal" onchange="window.checkSphere(this)"></div>
                    <div class="modal-input-group"><label>Cylindre</label><input type="text" id="mod_raOD_cyl" placeholder="- 0.00" inputmode="decimal" onchange="window.checkCylInput(this)"></div>
                    <div class="modal-input-group"><label>Axe</label><input type="text" id="mod_raOD_axe" placeholder="0°" inputmode="decimal" onchange="window.checkAxis(this)"></div>
                </div>
            </div>
            <div style="flex:1;">
                <div class="modal-eye-title">ŒIL GAUCHE</div>
                <div class="modal-input-grid">
                    <div class="modal-input-group"><label>Sphère</label><input type="text" id="mod_raOG_sph" placeholder="+/- 0.00" inputmode="decimal" onchange="window.checkSphere(this)"></div>
                    <div class="modal-input-group"><label>Cylindre</label><input type="text" id="mod_raOG_cyl" placeholder="- 0.00" inputmode="decimal" onchange="window.checkCylInput(this)"></div>
                    <div class="modal-input-group"><label>Axe</label><input type="text" id="mod_raOG_axe" placeholder="0°" inputmode="decimal" onchange="window.checkAxis(this)"></div>
                </div>
            </div>
        </div>

        <button class="btn-action btn-validate" onclick="window.saveAndCloseModal('AutoRef')">VALIDER RA</button>
    </div>
</div>

<div id="modalInputFronto" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 600px;">
        <h2 style="color:#546E7A; border:none;">Frontofocomètre</h2>

        <div style="display:flex; gap:20px; margin-bottom:20px;">
            <div style="flex:1;">
                <div class="modal-eye-title" style="color:#546E7A; border-color:#CFD8DC;">ŒIL DROIT</div>
                <div class="modal-input-grid">
                    <div class="modal-input-group"><label>Sphère</label><input type="text" id="mod_frontoOD_sph" placeholder="+/- 0.00" inputmode="decimal" onchange="window.checkSphere(this)"></div>
                    <div class="modal-input-group"><label>Cylindre</label><input type="text" id="mod_frontoOD_cyl" placeholder="- 0.00" inputmode="decimal" onchange="window.checkCylInput(this)"></div>
                    <div class="modal-input-group"><label>Axe</label><input type="text" id="mod_frontoOD_axe" placeholder="0°" inputmode="decimal" onchange="window.checkAxis(this)"></div>
                </div>
            </div>
            <div style="flex:1;">
                <div class="modal-eye-title" style="color:#546E7A; border-color:#CFD8DC;">ŒIL GAUCHE</div>
                <div class="modal-input-grid">
                    <div class="modal-input-group"><label>Sphère</label><input type="text" id="mod_frontoOG_sph" placeholder="+/- 0.00" inputmode="decimal" onchange="window.checkSphere(this)"></div>
                    <div class="modal-input-group"><label>Cylindre</label><input type="text" id="mod_frontoOG_cyl" placeholder="- 0.00" inputmode="decimal" onchange="window.checkCylInput(this)"></div>
                    <div class="modal-input-group"><label>Axe</label><input type="text" id="mod_frontoOG_axe" placeholder="0°" inputmode="decimal" onchange="window.checkAxis(this)"></div>
                </div>
            </div>
        </div>

        <button class="btn-action btn-validate" style="background:#546E7A;" onclick="window.saveAndCloseModal('Fronto')">VALIDER FRONTO</button>
    </div>
</div>

<div id="modalHandedness" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Latéralité</h2>
        <div class="modal-text">Le patient est-il droitier ou gaucher ?</div>
        <div style="display:flex; gap:20px; justify-content:center;">
            <button class="btn-action btn-validate" style="width:auto; padding:15px 30px;" onclick="window.setHandedness('OD')">DROITIER</button>
            <button class="btn-action btn-validate" style="width:auto; padding:15px 30px;" onclick="window.setHandedness('OG')">GAUCHER</button>
        </div>
    </div>
</div>

<div id="modalSchoberQuestion" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Réponse du patient ?</h2>
        <div class="modal-text" style="font-size:1.2rem; margin-bottom:30px;">
            A-t-il répondu <strong>OUI</strong> ?<br>
            <span style="font-size:0.9rem; color:#78909C;">(Voit-il la croix ET le cercle ?)</span>
        </div>
        <div style="display:flex; gap:20px; justify-content:center;">
            <button class="btn-action btn-grey" style="width:auto; padding:15px 40px; font-size:1.2rem;" onclick="window.handleSchoberAnswer('non')">NON</button>
            <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; font-size:1.2rem;" onclick="window.handleSchoberAnswer('oui')">OUI</button>
        </div>
    </div>
</div>
  
<div id="modalSchoberConfirm" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Confirmation Schober</h2>
        <div id="schoberConfirmText" class="modal-text" style="font-weight:500; color:#37474F; margin-bottom:25px;"></div>
        <div style="display:flex; gap:20px; justify-content:center;">
            <button class="btn-action btn-grey" style="width:auto; padding:15px 30px;" onclick="window.cancelSchober()">ANNULER</button>
            <button class="btn-action btn-validate" style="width:auto; padding:15px 30px;" onclick="window.validateSchober()">VALIDER</button>
        </div>
    </div>
</div>

<div id="modalPosition" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Installation</h2>
        <div class="modal-text">
            Placez le patient derrière la tête du réfracteur en veillant à ce qu’il soit confortablement installé : son front doit être bien apposé contre l’appui-front, et ses yeux parfaitement centrés dans les oculaires.
            <br><br>
            Assurez-vous également que ses joues ne soient pas en contact avec l’appareil — il doit être possible de glisser un doigt entre ses joues et le réfracteur.
        </div>
        <button class="btn-action btn-rules" style="width:auto; padding:15px 40px; font-size:1.1rem; border-radius:50px;" onclick="window.startRulesAndIntro()">RÈGLES DE LECTURE</button>
    </div>
</div>

<div id="modalIntroConfirmation" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Prêt à commencer ?</h2>
        <div class="modal-text">
            Assurez-vous que le patient a bien compris les règles de lecture que vous venez de lui expliquer.
            <br><br>
            Si c'est le cas, vous pouvez commencer l'examen.
        </div>
        <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; border-radius:50px; font-size:1.1rem;" onclick="window.confirmAndLaunch()">LANCER L'EXAMEN</button>
    </div>
</div>

<div id="modalWarning" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary-deep); border:none; font-size:1.6rem;">Hors Limites</h2>
        <div class="modal-text">La valeur saisie est hors des limites de l’appareil. Merci de la corriger.</div>
        <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; border-radius:50px;" onclick="window.closeWarningModal()">CORRIGER</button>
    </div>
</div>

  <div id="modalCylTranspose" class="modal-overlay hidden">
    <div class="modal-content" style="border-top: 5px solid #FFA726; max-width: 500px;">
        <h2 style="color:#EF6C00; border:none; font-size:1.4rem; margin-top:0;">Cylindre Positif Détecté</h2>
        <div class="modal-text" style="text-align:left; font-size:1rem; color:#333;">
            Vous avez saisi une valeur positive : <strong><span id="txtPosCylVal" style="color:#D84315;"></span></strong>.<br><br>
            Ce logiciel fonctionne exclusivement en <strong>cylindre négatif</strong>.<br>
            Que souhaitez-vous faire ?
        </div>
        <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button class="btn-action btn-validate" style="background:#0277BD; border-radius:6px; padding:12px;" onclick="window.applyTransposition()">
                <strong>TRANSPOSER LA FORMULE</strong><br>
                <span style="font-size:0.8rem; opacity:0.9;">(Recalcule Sphère et Axe mathématiquement)</span>
            </button>
            <button class="btn-action btn-grey" style="border-radius:6px; padding:12px;" onclick="window.invertCylSign()">
                <strong>JUSTE INVERSER LE SIGNE (+ vers -)</strong><br>
                <span style="font-size:0.8rem; color:#666;">(Si c'est une erreur de frappe)</span>
            </button>
            <button class="btn-action btn-grey" style="background:#fff; border:1px solid #ccc; color:#555; border-radius:6px; padding:10px;" onclick="window.cancelCorrection()">
    Annuler / Corriger manuellement
</button>
        </div>
    </div>
</div>
<div id="modalAskAxis" class="modal-overlay hidden">
    <div class="modal-content" style="border-top: 5px solid #FFA726; max-width: 450px;">
        <h2 style="color:#EF6C00; border:none; font-size:1.4rem;">Axe Manquant</h2>

        <div class="modal-text" style="text-align:left;">
            Pour transposer mathématiquement le cylindre positif, il faut connaître son axe d'origine.<br><br>
            <span style="color:#D84315; font-weight:bold;">👉 Entrez l'axe du cylindre POSITIF :</span>
        </div>

        <div style="margin: 20px 0;">
            <input type="number" id="inputTranspAxis" placeholder="Ex: 90" 
                   style="font-size:1.5rem; padding:10px; width:150px; text-align:center; border:2px solid #FFA726; border-radius:8px; font-weight:bold;">
            <div style="font-size:0.8rem; color:#888; margin-top:5px;">(Entre 0 et 180°)</div>
        </div>

        <div style="display:flex; gap:15px; justify-content:center;">
            <button class="btn-action btn-grey" style="width:auto;" onclick="window.closeAskAxisModal()">Annuler</button>
            <button class="btn-action btn-validate" style="width:auto; background:#EF6C00;" onclick="window.validateTranspositionAxis()">VALIDER</button>
        </div>
    </div>
</div>
  <div id="modalDefogLimit" class="modal-overlay hidden">
    <div class="modal-content" style="max-width:700px;">
        <h2 style="color:#D32F2F; border:none; font-size:1.6rem;">⚠️ Votre attention, s'il vous plaît !</h2>
        <div class="modal-text" style="text-align:left; font-size:1rem;">
            <strong>Absence d'amélioration de l'acuité visuelle après plusieurs débrouillages.</strong><br><br>
            Vous avez effectué plusieurs étapes de débrouillage sans gain significatif d'acuité visuelle.<br><br>
            Rappel : Répétez vos directives au patient, vérifiez sa position, nettoyez les lentilles et confirmez les données de l'AR.<br><br>
            Nous vous recommandons de recommencer l'examen selon l'une des options suivantes :
        </div>
        <div id="defogButtons" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button class="btn-action btn-grey" style="white-space:normal; height:auto; padding:10px; text-align:left;" onclick="window.restartExam()">Le patient n'avait pas bien compris...</button>
            <button class="btn-action btn-validate" style="background:#D32F2F; white-space:normal; height:auto; padding:10px; text-align:left;" onclick="window.prepareCycloStop()">Le patient avait bien compris...</button>
        </div>
        <div id="saveCycloContainer" class="hidden" style="margin-top:20px;"><button class="btn-action btn-validate" style="padding:15px 30px;" onclick="window.savePatientData()">Sauvegarder les données</button></div>
    </div>
</div>

<div id="modalTqsLimit" class="modal-overlay hidden">
    <div class="modal-content" style="max-width:700px;">
        <h2 style="color:#D32F2F; border:none; font-size:1.6rem;">⚠️ Votre attention, s'il vous plaît !</h2>
        <div class="modal-text" style="text-align:left; font-size:1rem;">
            <strong>Vous venez de brouiller de plus de 1.00 D sur la ligne de 6/10.</strong><br><br>
            Vous avez effectué plusieurs étapes de brouillage sans pouvoir bloquer l'accommodation du patient.<br><br>
            Rappel : Répétez vos directives au patient. Il est possible qu'il n'ai pas relu les lettres mais qu'il vous les a répété de mémoire. Vérifiez également sa position, il regarde peut-être en dehors des oculaires.<br><br>
            Nous vous recommandons de recommencer l'examen selon l'une des options suivantes :
        </div>
        <div id="tqsButtons" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button class="btn-action btn-grey" style="white-space:normal; height:auto; padding:10px; text-align:left;" onclick="window.restartExam()">Le patient n'avait pas bien compris...</button>
            <button class="btn-action btn-validate" style="background:#D32F2F; white-space:normal; height:auto; padding:10px; text-align:left;" onclick="window.prepareCycloStopTqs()">Le patient avait bien compris...</button>
        </div>
        <div id="saveCycloContainerTqs" class="hidden" style="margin-top:20px;"><button class="btn-action btn-validate" style="padding:15px 30px;" onclick="window.savePatientData()">Sauvegarder les données</button></div>
    </div>
</div>

<div id="modalIncoherent" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary-deep); border:none; font-size:1.6rem;">Réponse Incohérente</h2>
        <div class="modal-text">Le patient vient de vous donner une réponse incohérente. Il faut refaire cette partie de l'examen.</div>
        <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; border-radius:50px;" onclick="window.restartSb10()">RECOMMENCER CETTE PARTIE DE L'EXAMEN</button>
    </div>
</div>

<div class="app-container">
    <div id="zonePatient" class="grid-item">
        <div id="patientSummaryContent" style="width:100%;">
            <span style="color:#B0BEC5; font-style:italic;">En attente d'identification...</span>
        </div>
        <div id="displayChrono" style="font-weight:bold; color:var(--primary-deep);">00:00</div>
    </div>

<div id="zonePilotage" class="grid-item">
        <div class="phase-badge" style="margin-bottom: 5px;"><span id="dispPhase">INIT</span></div>
        
        <div style="display:flex; gap:10px; align-items:center;">
            <button id="btnPilotOD" class="btn-pilot" onclick="window.setEye('OD')">OD</button>
            <div id="dispMode" class="btn-mode-display">MONOCULAIRE</div>
            <button id="btnPilotOG" class="btn-pilot" onclick="window.setEye('OG')">OG</button>
        </div>
    </div>

    <div id="zoneVisuels" class="grid-item">
        <div style="display:flex; gap:10px;">
            <div id="visBoxOD" class="va-box-display" data-eye="OD">--</div>
            <div id="visBoxOG" class="va-box-display" data-eye="OG">--</div>
        </div>
    </div>

<div id="examDataStrip" class="grid-item exam-data-strip hidden">
         
         <div class="data-col col-passive">
             <div class="col-title title-ra">AR</div>
             <div class="data-line"><input type="text" id="raOD_sph" class="val-input" readonly></div>
             <div class="data-line"><input type="text" id="raOD_cyl" class="val-input" readonly></div>
             <div class="data-line"><input type="text" id="raOD_axe" class="val-input" readonly></div>
         </div>

         <div class="data-col col-passive">
             <div class="col-title">LM</div>
             <div class="data-line"><input type="text" id="frontoOD_sph" class="val-input" readonly></div>
             <div class="data-line"><input type="text" id="frontoOD_cyl" class="val-input" readonly></div>
             <div class="data-line"><input type="text" id="frontoOD_axe" class="val-input" readonly></div>
         </div>

         <div id="subjDispOD" class="data-col col-active">
             <div class="col-title title-subj">&nbsp;</div>
             <div class="data-line"><span id="disp_subjOD_sph" class="val-input val-big">--</span></div>
             <div class="data-line"><span id="disp_subjOD_cyl" class="val-input val-big">--</span></div>
             <div class="data-line"><span id="disp_subjOD_axe" class="val-input val-big">--</span></div>
         </div>

         <div class="center-labels">
            <div class="col-title" style="border:none; visibility:hidden; height:20px;">&nbsp;</div>
            <div class="label-row">S</div>
            <div class="label-row">C</div>
            <div class="label-row">A</div>
         </div>
         <div id="subjDispOG" class="data-col col-active">
             <div class="col-title title-subj">&nbsp;</div>
             <div class="data-line"><span id="disp_subjOG_sph" class="val-input val-big">--</span></div>
             <div class="data-line"><span id="disp_subjOG_cyl" class="val-input val-big">--</span></div>
             <div class="data-line"><span id="disp_subjOG_axe" class="val-input val-big">--</span></div>
         </div>

         <div class="data-col col-passive">
             <div class="col-title">LM</div>
             <div class="data-line"><input type="text" id="frontoOG_sph" class="val-input" readonly></div>
             <div class="data-line"><input type="text" id="frontoOG_cyl" class="val-input" readonly></div>
             <div class="data-line"><input type="text" id="frontoOG_axe" class="val-input" readonly></div>
         </div>

         <div class="data-col col-passive">
             <div class="col-title title-ra">AR</div>
             <div class="data-line"><input type="text" id="raOG_sph" class="val-input" readonly></div>
             <div class="data-line"><input type="text" id="raOG_cyl" class="val-input" readonly></div>
             <div class="data-line"><input type="text" id="raOG_axe" class="val-input" readonly></div>
         </div>
         
         <div id="dataSection" style="display:none;"></div> 
    </div><div id="schemaContainer">
    <div id="animTargetCircle" class="anim-bubble bubble-target">Verre<br>(+0.25)</div>
    <div id="animArrowLine" class="arrow-connector"></div>
    <div id="animBaseCircle" class="anim-bubble bubble-base">Sphère<br>testée</div>
    <div id="animArrowLineMinus" class="arrow-connector-right"></div>
    <div id="animTargetCircleMinus" class="anim-bubble bubble-target-minus">Verre<br>(-0.25)</div>

    <div id="jccVisuals" class="jcc-container hidden">
    <div id="visPos1" class="jcc-visual">
        <span class="jcc-label">1</span>
        <svg class="arrow-svg" viewBox="0 0 100 100">
            <path d="M50 10 A40 40 0 0 1 90 50" fill="none" stroke="#116dff" stroke-width="6" marker-end="url(#arrowhead)" />
        </svg>
    </div>

    <div id="visPos2" class="jcc-visual">
        <span class="jcc-label">2</span>
        <svg class="arrow-svg" viewBox="0 0 100 100">
            <path d="M50 10 A40 40 0 0 0 10 50" fill="none" stroke="#fd7e14" stroke-width="6" marker-end="url(#arrowhead2)" />
        </svg>
    </div>
</div>

    <div id="axisControls" class="response-area hidden" style="position: absolute; bottom: 0px; width: 100%; pointer-events: auto;">
        <div id="axisDecisions" class="decision-row hidden">
            <button class="btn-decision btn-blue" onclick="window.handleJccChoice('pos1')">Mieux 1</button>
            <div style="display:flex; flex-direction:column; gap:10px; align-items:center;">
                <button class="btn-decision btn-green" onclick="window.handleJccChoice('same')">Pareil</button>
                <button id="btnReplayAxis" class="hidden" onclick="window.runJccSequence()">Retester</button>
            </div>
            <button class="btn-decision btn-orange" onclick="window.handleJccChoice('pos2')">Mieux 2</button>
        </div>
    </div>
</div>

  <div id="zoneLettres" class="grid-item">
        <div id="waitingMsg" style="text-align:center; color:#B0BEC5;">
            <p style="font-size:1.5rem;">L'examen commencera ici.</p>
        </div>

        <div id="examContent" class="hidden" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <div id="letterBox" class="letter-display">...</div>
            <div id="systemMsg" class="message-box">En attente...</div>

            <div id="axisZone" class="response-area hidden">
                
            </div>
        </div>
    </div>

<button id="btnRandomLetters" onclick="window.forceChangeLetters()" title="Changer les lettres">
    <svg viewBox="0 0 24 24">
        <polyline points="16 3 21 3 21 8"></polyline>
        <line x1="4" y1="20" x2="21" y2="3"></line>
        <polyline points="21 16 21 21 16 21"></polyline>
        <line x1="15" y1="15" x2="21" y2="21"></line>
        <line x1="4" y1="4" x2="9" y2="9"></line>
    </svg>
</button>
  
    <div id="zoneBoutons" class="grid-item">
        <div id="standardButtons" class="response-area hidden">
            <p style="margin-bottom:10px; font-weight:600; color:var(--text-muted); margin-top:0;">Combien de lettres lues ?</p>
            <div id="btnContainer" class="btn-grid"></div>
        </div>

        <div id="cadenceButtons" class="response-area hidden">
            <p style="margin-bottom:10px; font-weight:600;">Vitesse de lecture ?</p>
            
            <div style="display:flex; justify-content:center; gap:15px;">
                <button class="btn-action btn-tortue" onclick="window.handleCadence('turtle')">
                    <span class="emoji-icon">🐢</span> Hésitant
                </button>

                <button class="btn-action btn-lapin" onclick="window.handleCadence('rabbit')">
                    <span class="emoji-icon">🐇</span> Fluide
                </button>
            </div>
        </div>
      <div id="checkPlusZone" class="response-area hidden">
    
    <div id="stepPlusWrapper">
        <button id="btnPlus025" class="btn-timer hidden" onclick="window.triggerFogCheck()">TESTER +0.25 (3s)</button>
        
        <div id="decisionsPlus" class="decision-row-round hidden">
            <button class="btn-round btn-round-green" onclick="window.decidePlus('better')">
                Préfère<br>(+0.25)
            </button>

            <button class="btn-round btn-round-outline" onclick="window.decidePlus('same')">
                Pareil
            </button>

            <div class="btn-col-group">
                <button class="btn-round btn-round-blue" onclick="window.decidePlus('worse')">
                    Sphère<br>testée
                </button>
                
                <button class="btn-round btn-round-grey" onclick="window.relaunchPlus()">
                    Retester
                </button>
            </div>
        </div>
    </div>

    <div id="stepMinusWrapper" class="hidden">
        <button id="btnMinus025" class="btn-timer hidden" onclick="window.triggerDefogCheck()">TESTER -0.25 (1.5s)</button>
        
        <div id="decisionsMinus" class="decision-row-round hidden">
            
            <div class="btn-col-group">
                <button class="btn-round btn-round-blue" onclick="window.decideMinus('worse')">
                    Sphère<br>testée
                </button>
                
                <button class="btn-round btn-round-grey" onclick="window.relaunchFullCheck()">
                    Retester
                </button>
            </div>

            <button class="btn-round btn-round-outline" onclick="window.decideMinus('same')">
                Pareil
            </button>

            <button class="btn-round btn-round-red" onclick="window.decideMinus('better')">
                Préfère<br>(-0.25)
            </button>
        </div>
    </div>

</div>

        
    <div id="schoberStep" class="hidden">
        <div style="max-width:800px; width:100%; background:white; padding:20px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <div class="step-instruction">
                <strong>Que voit le patient au test de Schober ?</strong><br>
                <span style="font-size:0.9rem; color:#546E7A;">Cliquez sur l'image correspondant pour déterminer le protocole.</span>
            </div>
            <div class="schober-container">
        <div class="schober-group-title">Vision Binoculaire Possible</div>

        <div class="schober-row">
            <div class="schober-sub-group">
                <div class="schober-sub-title">Vision Simultanée</div>
                <div class="schober-grid">
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(1, 'bino', 'AUTO')">
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross" />
                            <line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross" />
                            <circle cx="50" cy="50" r="35" class="sch-circle" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="schober-sub-group">
                <div class="schober-sub-title">Neutralisation Intermittente</div>
                <div class="schober-grid">
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(2, 'bino', 'OD')">
                         <div style="position:absolute; top:2px; left:2px; color:#fff; font-size:0.6rem;">OD+</div>
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross" />
                            <line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross" />
                            <circle cx="50" cy="50" r="35" class="sch-circle sch-faint" />
                        </svg>
                    </button>
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(3, 'bino', 'OG')">
                        <div style="position:absolute; top:2px; left:2px; color:#fff; font-size:0.6rem;">OG+</div>
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross sch-faint" />
                            <line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross sch-faint" />
                            <circle cx="50" cy="50" r="35" class="sch-circle" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="schober-container" style="border-color:#FFCDD2; background:#FFEBEE;">
        <div class="schober-group-title" style="color:#D32F2F; border-color:#FFCDD2;">Pas de Vision Binoculaire</div>

        <div class="schober-row">
            <div class="schober-sub-group">
                <div class="schober-sub-title">Alternance Facile</div>
                <div class="schober-grid">
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(4, 'mono', 'OD')">
                         <div style="position:absolute; top:2px; left:2px; color:#fff; font-size:0.6rem;">DÉPART OD</div>
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <path d="M20 20 L40 20 L30 10 Z" fill="#fff"/>
                            <line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross" />
                            <line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross" />
                        </svg>
                    </button>
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(5, 'mono', 'OG')">
                         <div style="position:absolute; top:2px; left:2px; color:#fff; font-size:0.6rem;">DÉPART OG</div>
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <path d="M60 20 L80 20 L70 10 Z" fill="#fff"/>
                            <circle cx="50" cy="50" r="35" class="sch-circle" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="schober-sub-group">
                <div class="schober-sub-title">Alternance difficile ou Neutra.</div>
                <div class="schober-grid">
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(6, 'mono', 'OD')">
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross" />
                            <line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross" />
                        </svg>
                    </button>
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(7, 'mono', 'OG')">
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="35" class="sch-circle" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="schober-sub-group">
                <div class="schober-sub-title">Monophtalme ou Amblyopie</div>
                <div class="schober-grid">
                      <button class="btn-schober" style="border-style:dashed;" onclick="window.confirmSchoberSelection(8, 'mono', 'OD')">
                         <div style="position:absolute; top:2px; left:2px; color:#fff; font-size:0.6rem;">MONO</div>
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross" />
                            <line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross" />
                        </svg>
                    </button>
                    <button class="btn-schober" style="border-style:dashed;" onclick="window.confirmSchoberSelection(9, 'mono', 'OG')">
                        <div style="position:absolute; top:2px; left:2px; color:#fff; font-size:0.6rem;">MONO</div>
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="35" class="sch-circle" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>

</div>
 
</div>

<script>
// --- STARTUP LOGIC ---
window.startAppSequence = function() {
    window.initVoices();
    window.initClock(); // Démarrage Horloge
    // Génération UID immédiate
    var uid = window.generateShortUID();
    document.getElementById('inUID').value = uid;

    // Ouverture Fenêtre 1 (Identification)
    document.getElementById('modalPatientID').classList.remove('hidden');
};

// Transition Fenêtre 1 -> Fenêtre 2
window.validatePatientID = function() {
    var dob = document.getElementById('inDob').value;
    if(!dob) { alert("La date de naissance est obligatoire."); return; }

    // Ferme Modal ID
    document.getElementById('modalPatientID').classList.add('hidden');

    // Remplissage partiel du résumé (Nom/Prénom)
    var nom = document.getElementById('inName').value || "-";
    var summaryHTML = `<div class="summary-grid"><div class="summary-row"><span class="summary-lbl">Patient</span><span class="summary-val">${nom.toUpperCase()}</span></div></div>`;
    document.getElementById('patientSummaryContent').innerHTML = summaryHTML;

    // Ouvre Modal Choix Méthode (STEP 2)
    document.getElementById('modalEntryMethod').classList.remove('hidden');
};
// --- CLOCK & CHRONO ---
window.initClock = function() {
    setInterval(function() {
        var now = new Date();
        // Date format: "Dimanche 14 Décembre"
        var options = { weekday: 'long', day: 'numeric', month: 'long' };
        var dateStr = now.toLocaleDateString('fr-FR', options);
        document.getElementById('displayDate').innerText = dateStr;

        // Time format: "14:30"
        var timeStr = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
        document.getElementById('displayTime').innerText = timeStr;
    }, 1000);
};

var chronoInterval = null;
var startTime = null;
window.startChrono = function() {
    if(chronoInterval) return; // Déjà démarré
    startTime = Date.now();
    chronoInterval = setInterval(function() {
        var delta = Date.now() - startTime;
        var totalSeconds = Math.floor(delta / 1000);
        var m = Math.floor(totalSeconds / 60);
        var s = totalSeconds % 60;
        // Format MM:SS
        var mStr = m < 10 ? "0" + m : m;
        var sStr = s < 10 ? "0" + s : s;
        document.getElementById('displayChrono').innerText = mStr + ":" + sStr;
    }, 1000);
};

// --- GLOBALS PROMPTS ---
window.NEXT_PROMPTS = ["et ici ?", "lisez moi ces lettres là", "et celles-ci ?", "pouvez-vous lire ces lettres ci ?"];
window.getRandomPrompt = function() {
    return window.NEXT_PROMPTS[Math.floor(Math.random() * window.NEXT_PROMPTS.length)];
};

// --- FONCTIONS UTILITAIRES ---
window.getVal = function(id) { 
    var el = document.getElementById(id);
    if(!el || !el.value) return 0;
    return parseFloat(el.value.replace(',', '.')) || 0; 
};
window.setHTML = function(id, val) { 
    var el = document.getElementById(id); if(el) el.innerHTML = val;
};
window.generateShortUID = function() {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let part1 = "", part2 = "";
    for(let i=0; i<3; i++) part1 += chars.charAt(Math.floor(Math.random() * chars.length));
    for(let i=0; i<3; i++) part2 += chars.charAt(Math.floor(Math.random() * chars.length));
    return part1 + "-" + part2;
};

// --- VALIDATION SAISIE NUMERIQUE & FORMATAGE ---
window.validateNumberInput = function(el) {
    el.value = el.value.replace(/[^0-9.,-]/g, '');
};

// --- MODALE WARNING ---
window.closeWarningModal = function() {
    document.getElementById('modalWarning').classList.add('hidden');
    if(appState.lastInvalidInputId) {
        var el = document.getElementById(appState.lastInvalidInputId);
        if(el) {
            el.value = ""; // Vide le champ en erreur
            el.focus();    // Redonne le focus
        }
        appState.lastInvalidInputId = null;
    }
};

window.checkSphere = function(el) {
    if(!el.value) return;
    var val = parseFloat(el.value.replace(',', '.'));
    if(isNaN(val)) return;

    // CHECK LIMITES AVANT CORRECTION
    if (val < -29.00 || val > 26.75) {
        appState.lastInvalidInputId = el.id;
        document.getElementById('modalWarning').classList.remove('hidden');
        return;
    }

    val = Math.round(val * 4) / 4; // Step 0.25
    el.value = val.toFixed(2);
};
// --- DEBUT LOGIQUE TRANSPOSITION (CORRIGÉ) ---
var tempCylInputId = null; 

window.checkCylInput = function(el) {
    if(!el.value) return;
    var val = parseFloat(el.value.replace(',', '.'));
    if(isNaN(val)) return;

    // DETECTION CYLINDRE POSITIF
    if(val > 0) {
        tempCylInputId = el.id; 
        document.getElementById('txtPosCylVal').innerText = "+" + val.toFixed(2);
        document.getElementById('modalCylTranspose').classList.remove('hidden');
        el.blur(); 
        return;
    }

    if (val < -10.00) {
        appState.lastInvalidInputId = el.id;
        document.getElementById('modalWarning').classList.remove('hidden');
        return;
    }

    val = Math.round(val * 4) / 4; 
    el.value = val.toFixed(2);
};
// --- LOGIQUE TRANSPOSITION & AXE ---

// 1. Déclenchement de la transposition (Ouvre la modale ou calcule direct)
window.applyTransposition = function() {
    if(!tempCylInputId) return;

    // Récupération des éléments
    var parts = tempCylInputId.split('_'); 
    var prefix = (parts.length === 3) ? parts[0] + "_" + parts[1] : parts[0];
    var elAxe = document.getElementById(prefix + '_axe');

    // Vérification si l'axe est déjà rempli
    var axeVal = elAxe.value;
    var axe = (axeVal && axeVal !== "") ? parseFloat(axeVal) : 0;

    // CAS 1 : L'axe est vide ou 0 -> On ouvre la modale de demande
    if (axe === 0) {
        // On vide le champ de la modale pour une nouvelle saisie
        document.getElementById('inputTranspAxis').value = ""; 
        // On ouvre la modale
        document.getElementById('modalAskAxis').classList.remove('hidden');
        // On met le focus dans le champ (meilleure UX)
        setTimeout(function() { document.getElementById('inputTranspAxis').focus(); }, 100);
        return; 
    }

    // CAS 2 : L'axe est déjà là -> On lance le calcul directement
    performTranspositionMath(axe);
};

// 2. Validation depuis la modale "Demande Axe" (Bouton VALIDER)
window.validateTranspositionAxis = function() {
    var input = document.getElementById('inputTranspAxis');
    var val = parseFloat(input.value);

    if (isNaN(val) || val < 0 || val > 180) {
        alert("Merci d'entrer un axe valide entre 0 et 180.");
        return;
    }

    // On ferme la modale d'axe
    document.getElementById('modalAskAxis').classList.add('hidden');

    // On lance le calcul avec la valeur saisie
    performTranspositionMath(val);
};

// 3. Fonction technique commune (Le calcul mathématique)
function performTranspositionMath(axeInitial) {
    var parts = tempCylInputId.split('_'); 
    var prefix = (parts.length === 3) ? parts[0] + "_" + parts[1] : parts[0];

    var elCyl = document.getElementById(tempCylInputId);
    var elSph = document.getElementById(prefix + '_sph');
    var elAxe = document.getElementById(prefix + '_axe');

    var cyl = parseFloat(elCyl.value.replace(',', '.'));
    var sph = elSph.value ? parseFloat(elSph.value.replace(',', '.')) : 0;

    // CALCUL
    var newSph = sph + cyl;
    var newCyl = -cyl;
    var newAxe = (axeInitial + 90) % 180;
    if (newAxe === 0) newAxe = 180; 

    // APPLICATION
    elSph.value = (Math.round(newSph * 4) / 4).toFixed(2);
    elCyl.value = (Math.round(newCyl * 4) / 4).toFixed(2);
    elAxe.value = Math.round(newAxe);

    // FERMETURE GENERALE
    window.closeTransposeModal(); // Ferme la modale orange principale
    if(window.onRaChanged) window.onRaChanged();
}

// 4. Fermeture simple de la modale d'axe (Annuler)
window.closeAskAxisModal = function() {
    document.getElementById('modalAskAxis').classList.add('hidden');
};
window.invertCylSign = function() {
    if(!tempCylInputId) return;
    var el = document.getElementById(tempCylInputId);
    var val = parseFloat(el.value.replace(',', '.'));

    // APPLICATION DE L'INVERSION
    el.value = (-val).toFixed(2); // La valeur est mise ici

    // On ferme juste la modale sans vider le champ
    window.closeTransposeModal();

    if(window.onRaChanged) window.onRaChanged();
};

// Fonction pour le bouton "Annuler / Corriger manuellement"
window.cancelCorrection = function() {
    var el = document.getElementById(tempCylInputId);
    if(el) { 
        el.value = ""; // C'EST ICI SEULEMENT QU'ON VIDE LE CHAMP
        el.focus(); 
    }
    window.closeTransposeModal();
};

window.closeTransposeModal = function() {
    document.getElementById('modalCylTranspose').classList.add('hidden');
    tempCylInputId = null;
};
// --- FIN LOGIQUE TRANSPOSITION ---
window.forceNegativeCyl = function(el) {
    if(!el.value) return;
    var val = parseFloat(el.value.replace(',', '.'));
    if(isNaN(val)) return;

    // Auto-conversion positif -> négatif (Logique Opto Standard)
    if(val > 0) val = -val;

    // CHECK LIMITES (-10.00 à 0)
    if (val < -10.00 || val > 0) {
        appState.lastInvalidInputId = el.id;
        document.getElementById('modalWarning').classList.remove('hidden');
        return;
    }

    val = Math.round(val * 4) / 4; // Step 0.25
    el.value = val.toFixed(2);
};

// Fonction normalisation axe (0-175 avec modulo 180)
function normalizeAxis(val) {
    // Arrondi au pas de 5
    val = Math.round(val / 5) * 5;
    // Modulo 180 qui gère les négatifs (ex: -5 => 175)
    val = (val % 180 + 180) % 180;
    return val;
}

window.checkAxis = function(el) {
    if(!el.value) return;
    var val = parseFloat(el.value);
    if(isNaN(val)) return;

    // NOUVELLE VALIDATION: Limites strictes pour éviter les fautes de frappe (ex: 1400)
    if (val < 0 || val > 180) {
        appState.lastInvalidInputId = el.id;
        document.getElementById('modalWarning').classList.remove('hidden');
        return;
    }

    val = normalizeAxis(val);
    el.value = val;
};

// --- LOGIQUE CHECKBOX ---
window.toggleMyopiaHyper = function(source) {
    var chkMyopia = document.getElementById('chkMyopia');
    var chkHyper = document.getElementById('chkHyper');
    if(source === 'myopia' && chkMyopia.checked) {
        chkHyper.checked = false;
    } else if(source === 'hyper' && chkHyper.checked) {
        chkMyopia.checked = false;
    }
};

// --- TTS & LOCK ---
window.initVoices = function() {
    window.checkMyopia();
    window.speechSynthesis.getVoices();
}
function say(textOrArray, callback) {
    if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();

    // LOCK
    appState.isSpeaking = true;
    updateLockUI(true);

    var text = Array.isArray(textOrArray) ? textOrArray[Math.floor(Math.random() * textOrArray.length)] : textOrArray;
    var u = new SpeechSynthesisUtterance(text);
    u.lang = 'fr-FR'; u.rate = 1.0; 
    var voices = window.speechSynthesis.getVoices();
    var bestVoice = voices.find(function(v) { return v.lang.includes('fr') && (v.name.includes('Google') || v.name.includes('Thomas')); });
    if (!bestVoice) bestVoice = voices.find(function(v) { return v.lang.includes('fr'); });
    if (bestVoice) u.voice = bestVoice;

    u.onend = function() {
        // UNLOCK
        appState.isSpeaking = false;
        updateLockUI(false);
        if (callback) callback();
    };
    u.onerror = function() {
        appState.isSpeaking = false;
        updateLockUI(false);
    };

    window.speechSynthesis.speak(u);
}

function updateLockUI(locked) {
    // Applique une classe visuelle aux boutons pour indiquer qu'ils sont bloqués
    var btns = document.querySelectorAll('.btn-resp, .btn-action, .btn-timer, .btn-decision');
    btns.forEach(function(b) {
        if(locked) b.classList.add('locked');
        else b.classList.remove('locked');
    });
}

// --- LOGIQUE AGE ---
function getAgeFromDob(dobString) {
    var today = new Date(); var birthDate = new Date(dobString);
    var age = today.getFullYear() - birthDate.getFullYear();
    var m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
    return age;
}
function getAgeScore(age) {
    if (age <= 10) return 6; if (age <= 20) return 5; 
    if (age <= 30) return 4; if (age <= 50) return 2; 
    if (age <= 70) return 1; return 0; 
}
window.checkMyopia = function() {
    var s1 = window.getVal('raOD_sph'); 
    var s2 = window.getVal('raOG_sph');
    var btn = document.getElementById('btnProfile1');
    
    if (btn) { 
        if (s1 < 0 || s2 < 0) { 
            // Myopie détectée : On cache le bouton mais ON GARDE SA PLACE
            btn.style.visibility = 'hidden'; 
        } else { 
            // Sinon : On le rend visible
            btn.style.visibility = 'visible'; 
        } 
    }
};
// --- DATA ---
var ACUITY_TABLE = [
    { va: 0.04, lines: ["U", "P", "F", "V"] },
    { va: 0.05, lines: ["E", "Z", "N", "R"] },
    { va: 0.06, lines: ["H", "U", "D", "V"] },
    { va: 0.08, lines: ["N Z", "P U", "V H"] },
    { va: 0.10, lines: ["D U F", "P H N"] },
    { va: 0.12, lines: ["E N R", "R H P"] },
    { va: 0.16, lines: ["U P H", "V R F"] },
    { va: 0.20, lines: ["N Z V", "P R H"] },
    { va: 0.25, lines: ["H D F", "U R Z"] },
    { va: 0.32, lines: ["D F U N R", "R U P E H"] },
    { va: 0.40, lines: ["Z V D F H", "U V N R Z"] },
    { va: 0.50, lines: ["U R N P E", "R U P E H"] },
    { va: 0.60, lines: ["V N R U F", "R H U E P"] },
    { va: 0.80, lines: ["F D U R N", "P R H U E"] },
    { va: 1.00, lines: ["H P Z E V", "H D E P N"] },
    { va: 1.25, lines: ["H E P U R", "E P N R U"] },
    { va: 1.60, lines: ["Z R N V U", "U R N P E"] },
    { va: 2.00, lines: ["V H F D Z", "R N U F D"] }
];

var appState = {
    isRunning: false, activeEye: 'OD', firstEye: 'OD', profile: null, initProfile: null, 
    baseProfile: null, 
    isSpeaking: false, // Variable de lock
    subj: { OD: { sphere: 0, cyl: 0, axe: 0, va: "--" }, OG: { sphere: 0, cyl: 0, axe: 0, va: "--" } },
    memCyl: { OD: null, OG: null }, 
    vaIndex: 0, startVaIndex: 0, letterIndex: 0, pendingLetters: null, defoggedInZone: false,
    examPhase: "Sb0.2", patientInfo: { name: "", forename: "", dob: "", age: 0, uid: "" },
    sb02_OD_ok: false, sb02_OG_ok: false, seen025_OD: false, seen025_OG: false,
    sb05_OD_ok: false, sb05_OG_ok: false, sb10_OD_ok: false, sb10_OG_ok: false,
    tqs_attempted_06: false, count06_validations: 0, tqsFogCount: 0, checkStep: null, tempScore: 0, baseSphereValue: 0,

    // --- NOUVEAUX ÉTATS DE SÉCURITÉ ---
    sb10_line_defog: 0, 
    safety_mode: false,
    safety_mem_letters: 0,
    hasRestartedSb10: false, // Flag anti-boucle
    
    // --- ÉTATS POUR LE TEST DE GAIN (QUART CONCAVE) ---
    scoreN_SansVerre: 0,        // Score initial sur ligne N (ex: 10/10)
    scoreNPlus1_SansVerre: 0,   // Score sur ligne N+1 sans le -0.25
    scoreNPlus1_AvecVerre: 0,   // Score sur ligne N+1 avec le -0.25
    isCheckingGain: false,      // Flag d'activation du test de gain
    
    // ----------------------------------
    handednessEye: 'OD', // Valeur par défaut
    pendingSchober: null, // Stockage temporaire du choix Schober

    saved_sb05: { OD: 0, OG: 0 }, saved_sb10: { OD: 0, OG: 0 },
    axisStep: 20, axisDirectionHistory: [], cylHigh: false,
    lastInvalidInputId: null 
};

// --- LOGIQUE WORKFLOW ---

// 1. CALCUL PROFIL
window.calculateProfileAndShowData = function() {
    var age = getAgeFromDob(document.getElementById('inDob').value);
    var score = getAgeScore(age);
    score += parseInt(document.getElementById('inRhythm').value);
    score += parseInt(document.getElementById('inSigns').value);
    if(document.getElementById('chkMyopia').checked) score += 1;
    if(document.getElementById('chkHyper').checked) score += 1;
    if(document.getElementById('chkNear').checked) score += 1;
    if(document.getElementById('chkNoSpecs').checked) score += 1;
    if(document.getElementById('chkMono').checked) score += 1;

    var p = (score <= 5) ? "1" : (score <= 8) ? "2" : (score <= 12) ? "3" : "3+";

    // Affiche la section Données (Gauche) et lance l'INSTALLATION (STEP 6)
    revealDataSection(p, false); 
};
window.forceProfileAndShowData = function(forcedProfile) {
    appState.baseProfile = forcedProfile;
    var finalProfile = forcedProfile;
    if (forcedProfile === '1') {
        var s1 = window.getVal('raOD_sph');
        var s2 = window.getVal('raOG_sph');
        if (s1 < 0 || s2 < 0) { finalProfile = '2'; }
    }
    revealDataSection(finalProfile, false);
};

function revealDataSection(profile, inputsEnabled) {
    appState.initProfile = profile; 
    setHTML('displayProfileName', profile);

    // Fermeture Fenêtre Profil
    document.getElementById('modalProfileCalc').classList.add('hidden');

    // --- CORRECTION : AFFICHAGE LIGNE UNIQUE (SANS UID) ---
    // --- BLOC MODIFIÉ : Affichage final avec Age ---
    var nom = document.getElementById('inName').value || "-";
    var prenom = document.getElementById('inForename').value || "";
    var pColor = getProfileColor(profile);
    
    // Calcul de l'âge
    var dob = document.getElementById('inDob').value;
    var ageStr = dob ? getAgeFromDob(dob) + " ans" : "";

    var summaryHTML = `
        <div class="patient-info-block">
            <span style="color:var(--primary);">${nom}</span> 
            <span style="color:var(--primary);">${prenom}</span>
            
            <span style="font-size:1.1rem; color:#90A4AE; font-weight:600; text-transform:none;">${ageStr}</span>
        </div>
        
        <div class="pat-profile-badge" style="background:${pColor}">${profile}</div>
    `;
    document.getElementById('patientSummaryContent').innerHTML = summaryHTML;
    // -------------------------------------------------------------

    document.getElementById('dataSection').classList.remove('hidden');
    toggleInputs('dataSection', inputsEnabled);

    // Passage à l'installation
    window.openPositioningModal();
}

function getProfileColor(p) {
    if(p==='1') return '#26A69A'; if(p==='2') return '#42A5F5'; if(p==='3') return '#FFA726'; return '#EF5350';
}

// 2. MODES SAISIE ET IMPORT (GESTION DE LA NOUVELLE MODALE DE CHOIX)

// Fonction appelée par les boutons de la modale "Importation des données"
// --- GESTION DES MODALES SEPAREES (RA & FRONTO) ---

// 1. Simulation d'import (Version 2.0)
window.simulateImport = function() {
    // On remplit directement les champs cachés du dashboard
    document.getElementById('raOD_sph').value = "-1.50";
    document.getElementById('raOD_cyl').value = "-0.50";
    document.getElementById('raOD_axe').value = "180";
    document.getElementById('raOG_sph').value = "-1.75";
    document.getElementById('raOG_cyl').value = "-0.25";
    document.getElementById('raOG_axe').value = "170";

    alert("Données simulées importées !");
    // On lance le calcul de profil si besoin
    if(window.onRaChanged) window.onRaChanged();
};

// 2. Ouvrir une modale spécifique
window.openModal = function(type) {
    // On charge les données actuelles dans la modale pour ne rien perdre
    syncDashboardToModal(type);

    document.getElementById('modalEntryMethod').classList.add('hidden'); // Cache le menu
    document.getElementById('modalInput' + type).classList.remove('hidden'); // Affiche la modale (AutoRef ou Fronto)
};

// 3. Valider et fermer une modale
window.saveAndCloseModal = function(type) {
    // On sauvegarde les données vers le dashboard
    syncModalToDashboard(type);

    // Si c'est RA, on met à jour le profil myopie immédiatement
    if (type === 'AutoRef' && window.onRaChanged) window.onRaChanged();

    document.getElementById('modalInput' + type).classList.add('hidden'); // Cache modale
    document.getElementById('modalEntryMethod').classList.remove('hidden'); // Retour menu
};

// 4. Terminer la saisie (Bouton Final)
window.finishDataEntry = function() {
    document.getElementById('modalEntryMethod').classList.add('hidden');

    // Remplissage sécurité
    var prefixes = ['raOD', 'raOG', 'frontoOD', 'frontoOG'];
    prefixes.forEach(function(p) {
       var s = document.getElementById(p + '_sph'); if (!s.value) s.value = "0.00";
       var c = document.getElementById(p + '_cyl'); if (!c.value) c.value = "0.00";
       var a = document.getElementById(p + '_axe'); if (!a.value) a.value = "0";
    });

    // --- NOUVEL AFFICHAGE PATIENT (LIGNE HAUTE) ---// --- NOUVEL AFFICHAGE (Barre du haut simplifiée) ---
   // --- BLOC MODIFIÉ : Récupération Nom + Calcul Age ---
    var nom = document.getElementById('inName').value || "-";
    var prenom = document.getElementById('inForename').value || "";
    
    // Calcul de l'âge
    var dob = document.getElementById('inDob').value;
    var ageStr = dob ? getAgeFromDob(dob) + " ans" : "";

    var summaryHTML = `
        <div class="patient-info-block">
            <span style="color:var(--primary);">${nom}</span> 
            <span style="color:var(--primary);">${prenom}</span>
            
            <span style="font-size:1.1rem; color:#90A4AE; font-weight:600; text-transform:none;">${ageStr}</span>
        </div>
        <div id="badgeProfilePlace"></div> 
    `;
    document.getElementById('patientSummaryContent').innerHTML = summaryHTML;
    // Mise à jour badge si déjà connu
    if(appState.initProfile) updateProfileBadge(appState.initProfile);

    // --- ICI : ON CACHE LA BARRE DE DONNÉES (FLUX DEMANDÉ) ---
    // On verrouille les inputs mais on garde la classe 'hidden'
    toggleInputs('examDataStrip', false); 
    document.getElementById('examDataStrip').classList.add('hidden');

    // Suite du flux
    document.getElementById('modalHandedness').classList.remove('hidden');
};

// Fonction utilitaire pour le badge couleur (A AJOUTER JUSTE APRES)
// Fonction utilitaire pour le badge (Juste le chiffre rond)
window.updateProfileBadge = function(p) {
    var color = getProfileColor(p);
    // On n'écrit plus "PROFIL", juste "p" (le chiffre)
    var html = `<div class="pat-profile-badge" style="background:${color}">${p}</div>`;
    
    var el = document.getElementById('badgeProfilePlace');
    if(el) el.innerHTML = html;
};
// UTILITAIRES DE SYNCHRO (MODALE <-> DASHBOARD)
function syncDashboardToModal(type) {
    var prefix = (type === 'AutoRef') ? 'ra' : 'fronto';
    ['OD', 'OG'].forEach(eye => {
        ['sph', 'cyl', 'axe'].forEach(field => {
            // Prend la valeur du dashboard
            var val = document.getElementById(prefix + eye + '_' + field).value;
            // La met dans la modale (si l'élément existe)
            var modEl = document.getElementById('mod_' + prefix + eye + '_' + field);
            if(modEl) modEl.value = val;
        });
    });
}

function syncModalToDashboard(type) {
    var prefix = (type === 'AutoRef') ? 'ra' : 'fronto';
    ['OD', 'OG'].forEach(eye => {
        ['sph', 'cyl', 'axe'].forEach(field => {
            // Prend la valeur de la modale
            var modVal = document.getElementById('mod_' + prefix + eye + '_' + field).value;
            // La met dans le dashboard
            var dashEl = document.getElementById(prefix + eye + '_' + field);
            if(dashEl) dashEl.value = modVal;
        });
    });
}

  // --- BLOC REPARE (A coller entre syncModalToDashboard et toggleInputs) ---

window.setHandedness = function(handEye) {
    // 1. Stockage & UI
    appState.handednessEye = handEye; 
    document.getElementById('modalHandedness').classList.add('hidden');
    document.getElementById('waitingMsg').classList.add('hidden'); 
    document.getElementById('schoberStep').classList.remove('hidden');

    // 2. Verrouillage VISUEL des boutons Schober
    var schoberBtns = document.querySelectorAll('.btn-schober');
    schoberBtns.forEach(function(btn) {
        btn.style.pointerEvents = 'none'; 
        btn.style.opacity = '0.4';        
        btn.style.filter = 'grayscale(100%)'; 
        btn.style.transition = 'all 0.3s';
    });

    // 3. Vocal + Ouverture Modale
    say("Sur l'écran en face de vous, voyez-vous une croix et un cercle, en même temps ?", function() {
        document.getElementById('modalSchoberQuestion').classList.remove('hidden');
    });
};

window.handleSchoberAnswer = function(reponse) {
    // 1. Fermer la modale
    document.getElementById('modalSchoberQuestion').classList.add('hidden');

    // Fonction déverrouillage
    var unlockButtons = function() {
        var schoberBtns = document.querySelectorAll('.btn-schober');
        schoberBtns.forEach(function(btn) {
            btn.style.pointerEvents = 'auto'; 
            btn.style.opacity = '1';          
            btn.style.filter = 'none';        
            btn.style.cursor = 'pointer';     
        });
    };

    if (reponse === 'oui') {
        unlockButtons();
    } else {
        var phraseNon = "Alors, que voyez-vous exactement ? La croix seule ? Le cercle seul ? Tantôt la croix, tantôt le cercle ? Dites moi.";
        say(phraseNon, function() {
            unlockButtons();
        });
    }
};

// --- FIN BLOC REPARE ---
  
function toggleInputs(sectionId, enable) {
    var sec = document.getElementById(sectionId);
    if(sec) {
        var inputs = sec.querySelectorAll('input:not([readonly]), select');
        inputs.forEach(function(el) { el.disabled = !enable; });
    }
}

// MISE A JOUR DYNAMIQUE DU PROFIL (Reversible)
// Variable globale pour le mode
appState.isMonocularExam = false; 

// --- Dictionnaire des phrases Schober ---
const SCHOBER_PHRASES = {
    1: "Le patient voit la croix et le cercle, en même temps (Vision simultanée).",
    2: "Le patient voit la croix en permanence, mais le cercle s'efface par intermittence (Neutralisation intermittente).",
    3: "Le patient voit le cercle en permanence, mais la croix s'efface par intermittence (Neutralisation intermittente).",
    4: "Le patient ne voit d'emblée que la croix, mais il peut facilement passer de la croix au cercle et inversement (Neutralisation alternante).",
    5: "Le patient ne voit d'emblée que le cercle, mais il peut facilement passer du cercle à la croix et inversement (Neutralisation alternante).",
    6: "Le patient ne voit que la croix, mais s'il ferme l'oeil droit, il voit le cercle (Neutralisation gauche).",
    7: "Le patient ne voit que le cercle, mais s'il ferme l'oeil gauche, il voit la croix (Neutralisation droite).",
    8: "Le patient ne voit que la croix, et s'il ferme l'oeil droit il ne voit plus rien (Monophtalme oeil droit ou amblyopie gauche profonde).",
    9: "Le patient ne voit que le cercle, et s'il ferme l'oeil gauche, il ne voit plus rien (Monophtalme oeil gauche ou amblyopie droite profonde)."
};

// 1. Fonction appelée par le clic bouton (Ouvre Modale)
window.confirmSchoberSelection = function(id, mode, eye) {
    // Stockage temporaire
    appState.pendingSchober = { mode: mode, eye: eye };

    // Injection du texte
    var text = SCHOBER_PHRASES[id] || "Confirmation du choix...";
    document.getElementById('schoberConfirmText').innerText = text;

    // Affichage Modale
    document.getElementById('modalSchoberConfirm').classList.remove('hidden');
};

// 2. Fonction Annuler (Ferme Modale, reste sur Schober)
window.cancelSchober = function() {
    appState.pendingSchober = null;
    document.getElementById('modalSchoberConfirm').classList.add('hidden');
};

// 3. Fonction Valider (Ferme Modale, lance la suite)
window.validateSchober = function() {
    document.getElementById('modalSchoberConfirm').classList.add('hidden');
    var p = appState.pendingSchober;
    if(p) {
        window.handleSchoberChoice(p.mode, p.eye);
    }
};

// --- LOGIQUE CHOIX OEIL DEPART (MODIFIE POUR 1-a) ---
window.handleSchoberChoice = function(mode, eye) {
    var startingEye = 'OD'; // Valeur par défaut de sécurité

    // CAS 1 : Vision Simultanée (Bouton 1 - Paramètre 'AUTO')
    if (eye === 'AUTO') {
        // On respecte la latéralité choisie à l'étape précédente
        if (appState.handednessEye === 'OG') {
            startingEye = 'OG';
        } else {
            startingEye = 'OD'; // Droitier ou par défaut
        }
    } 
    // CAS 2 : Problème Binoculaire (Boutons 2 à 9)
    else {
        // On impose l'œil défini par le bouton (l'œil fixateur/sain)
        startingEye = eye;
    }

    // Mise à jour de l'état global
    appState.firstEye = startingEye; 
    appState.activeEye = startingEye; // IMPORTANT : C'est cet œil qui commencera l'examen
    appState.isMonocularExam = (mode === 'mono');

    console.log("Schober Validé. Oeil de départ : " + startingEye);

    // Suite du flux -> Cache Schober, Affiche Profil
    document.getElementById('schoberStep').classList.add('hidden');
    document.getElementById('modalProfileCalc').classList.remove('hidden');
};
window.onRaChanged = function() { 
    window.checkMyopia();
    if (appState.baseProfile === "1") {
        var s1 = window.getVal('raOD_sph');
        var s2 = window.getVal('raOG_sph');
        if (s1 < 0 || s2 < 0) { appState.initProfile = "2"; setHTML('displayProfileName', "2"); } 
        else { appState.initProfile = "1"; setHTML('displayProfileName', "1"); }

        window.updateProfileBadge(appState.initProfile);
    }
};

// 3. INSTALLATION & REGLES
window.openPositioningModal = function() {
    toggleInputs('dataSection', false);
    // CORRECTION : PLUS DE MANIPULATION DE btnPosition QUI N'EXISTE PLUS
    // document.getElementById('btnPosition').classList.add('hidden'); 
    document.getElementById('modalPosition').classList.remove('hidden');
};

window.startRulesAndIntro = function() {
    // 1. Fermeture modale / Ouverture écran principal
    document.getElementById('modalPosition').classList.add('hidden');
    document.getElementById('examDataStrip').classList.remove('hidden');
    document.getElementById('waitingMsg').classList.add('hidden');
    document.getElementById('examContent').classList.remove('hidden');

    // 2. Récupération des valeurs RA
    var raOD = { s: getVal('raOD_sph'), c: getVal('raOD_cyl'), a: getVal('raOD_axe') };
    var raOG = { s: getVal('raOG_sph'), c: getVal('raOG_cyl'), a: getVal('raOG_axe') };

    // 3. Injection des valeurs RA dans les cartes Subjectif
    setHTML('disp_subjOD_sph', raOD.s.toFixed(2)); setHTML('disp_subjOG_sph', raOG.s.toFixed(2));
    setHTML('disp_subjOD_cyl', raOD.c.toFixed(2)); setHTML('disp_subjOG_cyl', raOG.c.toFixed(2));
    setHTML('disp_subjOD_axe', normalizeAxis(raOD.a) + "°"); setHTML('disp_subjOG_axe', normalizeAxis(raOG.a) + "°");
    setHTML('disp_subjOD_va', "--"); setHTML('disp_subjOG_va', "--");

    // 4. FORÇAGE VISUEL (YEUX OUVERTS)
    // On met les deux cartes en Cyan (Sélectionnées)
    document.getElementById('subjDispOD').classList.add('highlight');
    document.getElementById('subjDispOG').classList.add('highlight');

    // On active les deux boutons OD/OG en haut
    var btnOD = document.getElementById('btnPilotOD');
    var btnOG = document.getElementById('btnPilotOG');
    if(btnOD) { btnOD.classList.add('active'); btnOD.classList.remove('closed'); }
    if(btnOG) { btnOG.classList.add('active'); btnOG.classList.remove('closed'); }

    // 5. TEXTES INDICATEURS
    setHTML('dispPhase', "Règles de lecture");
    
    // --- AJOUT ICI : ON FORCE L'AFFICHAGE BINOCULAIRE ---
    setHTML('dispMode', "BINOCULAIRE");
    // ----------------------------------------------------

    // LA SUITE (VOIX)
    var introText = "Pour avoir une bonne mesure de votre vision de loin, il faut lire d’une manière naturelle, c’est à dire rapide et spontanée. Si vous ne pouvez pas lire vous le dites tout de suite, et si vous faites une erreur, comme vous avez lu naturellement, elle sera plus facile à corriger ! Mais si vous lisez d’une manière lente et réfléchie, le risque est de masquer vos erreurs et on ne peut pas améliorer une personne qui ne veut pas se tromper ! Donc il faut lire vite, si vous ne pouvez pas vous le dites tout de suite et si vous vous trompez aucune importance !";

    say(introText, function() {
        document.getElementById('modalIntroConfirmation').classList.remove('hidden');
    });
};
window.confirmAndLaunch = function() {
    document.getElementById('modalIntroConfirmation').classList.add('hidden');
    window.startChrono(); // DEMARRAGE CHRONO ICI
    window.triggerFinalStart();
};

window.triggerFinalStart = function() {
    // PRE-CALCUL DEBROUILLAGE Sb0.5 (Pour que le 2eme oeil soit pret)
    var raOD_sph = getVal('raOD_sph');
    var raOG_sph = getVal('raOG_sph');

    // On calcule le delta potentiel dès maintenant (pour l'utiliser plus tard)
    appState.deltaSb05_OD = (raOD_sph < 0) ? -0.75 : -0.50;
    appState.deltaSb05_OG = (raOG_sph < 0) ? -0.75 : -0.50;

    window.launchExamSequence();
};

// 4. LANCEMENT TECHNIQUE
window.launchExamSequence = function() {
    try {
        var raOD = { s: getVal('raOD_sph'), c: getVal('raOD_cyl'), a: getVal('raOD_axe') };
        var raOG = { s: getVal('raOG_sph'), c: getVal('raOG_cyl'), a: getVal('raOG_axe') };

        // Normalisation des axes RA
        raOD.a = normalizeAxis(raOD.a);
        raOG.a = normalizeAxis(raOG.a);

        var p = appState.initProfile;

        // Check Myopie force profil (Redondance de sécurité)
        if (p === '1' && (raOD.s < 0 || raOG.s < 0)) { p = '2'; setHTML('displayProfileName', '2'); }
        appState.profile = p;

        // Calcul Brouillage
        if (p === "3" || p === "3+") {
            var fogOD = (raOD.s < 0) ? 2.00 : 2.25; var fogOG = (raOG.s < 0) ? 2.00 : 2.25;
            appState.subj.OD = { sphere: raOD.s + fogOD, cyl: raOD.c, axe: raOD.a, va: "--" };
            appState.subj.OG = { sphere: raOG.s + fogOG, cyl: raOG.c, axe: raOG.a, va: "--" };
            appState.examPhase = "Sb0.2"; appState.targetVa = 0.06;

            // LOGIQUE SPECIALE CYLINDRE -0.25 en Profil 3/3+
            if (appState.subj.OD.cyl === -0.25) {
                appState.memCyl.OD = { cyl: -0.25, axe: appState.subj.OD.axe };
                appState.subj.OD.cyl = 0; appState.subj.OD.axe = 0;
            }
            if (appState.subj.OG.cyl === -0.25) {
                appState.memCyl.OG = { cyl: -0.25, axe: appState.subj.OG.axe };
                appState.subj.OG.cyl = 0; appState.subj.OG.axe = 0;
            }
        } else if (p === "2") {
            var fogOD = (raOD.s < 0) ? 0.75 : 1.00; var fogOG = (raOG.s < 0) ? 0.75 : 1.00;
            appState.subj.OD = { sphere: raOD.s + fogOD, cyl: raOD.c, axe: raOD.a, va: "--" };
            appState.subj.OG = { sphere: raOG.s + fogOG, cyl: raOG.c, axe: raOG.a, va: "--" };
            appState.examPhase = "Sb0.5"; appState.targetVa = 0.32;
        } else {
            // --- CORRECTION LOGIQUE PROFIL 1 ---
            // On identifie l'oeil de départ (celui choisi par Schober/Latéralité)
            var startEye = appState.firstEye; 
            var otherEye = (startEye === 'OD') ? 'OG' : 'OD';

            // L'oeil examiné (startEye) commence à sa valeur RA nette
            appState.subj[startEye] = { 
                sphere: (startEye === 'OD' ? raOD.s : raOG.s), 
                cyl: (startEye === 'OD' ? raOD.c : raOG.c), 
                axe: (startEye === 'OD' ? raOD.a : raOG.a), 
                va: "--" 
            };

            // L'oeil passif (otherEye) est brouillé immédiatement de +0.75
            appState.subj[otherEye] = { 
                sphere: (otherEye === 'OD' ? raOD.s : raOG.s) + 0.75, 
                cyl: (otherEye === 'OD' ? raOD.c : raOG.c), 
                axe: (otherEye === 'OD' ? raOD.a : raOG.a), 
                va: "--" 
            };

            // On initialise les mémoires de sécurité pour le Bio-Monoculaire
            appState.saved_sb05 = { 
                OD: raOD.s + 0.75, 
                OG: raOG.s + 0.75 
            };

            appState.examPhase = "Sb1.0"; 
            appState.targetVa = 0.50;
        }

        // Init Exam
        appState.isRunning = true;

        // CORRECTION : On ne remet surtout pas firstEye à 'OD'.
        // On utilise la valeur définie par le Schober (appState.firstEye).
        appState.activeEye = appState.firstEye;
        appState.defoggedInZone = false;
        setVaToIndexClosest(appState.targetVa); appState.startVaIndex = appState.vaIndex;

        // Reset flags
        appState.sb02_OD_ok=false; appState.sb02_OG_ok=false; appState.seen025_OD=false; appState.seen025_OG=false;
        appState.sb05_OD_ok=false; appState.sb05_OG_ok=false; appState.sb10_OD_ok=false; appState.sb10_OG_ok=false;
        appState.saved_sb10 = { OD: 0, OG: 0 };

        if (appState.profile === "2") { 
             appState.tqsFogCount = 0;
             appState.sb02_OD_ok = true; appState.sb02_OG_ok = true; 
        }
        else if (appState.profile === "1") { appState.sb02_OD_ok = true; appState.sb02_OG_ok = true; appState.sb05_OD_ok = true; appState.sb05_OG_ok = true; }

        // Affichage Zone
        document.getElementById('waitingMsg').classList.add('hidden');
        document.getElementById('examContent').classList.remove('hidden');
      // AFFICHER LA BARRE DE DONNÉES MAINTENANT (Début Examen)
        document.getElementById('examDataStrip').classList.remove('hidden');
        updateDisplay("Profil " + appState.profile + ". Phase " + appState.examPhase + " (OD)");

        say("Lisez moi s'il vous plait les lettres que vous voyez sur l'écran devant vous.");
    } catch(e) { alert("Erreur Lancement: " + e); }
};

// ... SUITE LOGIQUE (TargetEye, Validate, ProcessLogic...) ...
function getTargetEye() { return (appState.activeEye === 'OD') ? appState.subj.OD : appState.subj.OG; }

function validateSb02() {
    var eye = appState.activeEye;
    if (eye === 'OD') appState.sb02_OD_ok = true; else appState.sb02_OG_ok = true;
    say("On va de l'autre côté.", function() {
        if (appState.sb02_OD_ok && appState.sb02_OG_ok) { 
            // TOUT LE MONDE A FINI SB0.2 -> PASSAGE A SB0.5
            initSb05(); 
        } 
        else {
            var nextEye = (eye === 'OD') ? 'OG' : 'OD'; appState.activeEye = nextEye;
            appState.defoggedInZone = false; appState.vaIndex = appState.startVaIndex;
            appState.letterIndex = 0; updateDisplay("Recherche Sb0.2 (" + nextEye + ")");

            // AJOUT: Relance vocale après changement d'œil
            say(window.getRandomPrompt());
        }
    });
}

function initSb05() {
    // ALERT REMOVED FOR FLUID TRANSITION
    // alert("Début Recherche Sb0.5 (T.Q.S).\nRetour au premier œil (" + appState.firstEye + ").");
    appState.examPhase = "Sb0.5"; 
    appState.activeEye = appState.firstEye; // Retour premier oeil
    appState.defoggedInZone = false; 
    appState.tqs_attempted_06 = false; 
    appState.count06_validations = 0; 
    appState.tqsFogCount = 0; 

    // APPLICATION DU DEBROUILLAGE GLOBAL (OD + OG)
    applySb05GlobalDefog();

    // AJOUT : Annonce de relance après l'initialisation de la phase
    say(window.getRandomPrompt());
}

function applySb05GlobalDefog() {
    if(appState.profile === "2") { 
        setVaToIndexClosest(0.32); 
        updateDisplay("Profil 2: Démarrage T.Q.S."); 
        return; 
    }

    // Calcul pour OD (Basé sur la sphère actuelle de fin de Sb0.2)
    if (appState.seen025_OD) {
        // A vu 0.25 -> Pas de débrouillage
    } else {
        // N'a pas vu 0.25 -> Débrouillage
        var currentSphOD = appState.subj.OD.sphere;
        var deltaOD = (currentSphOD < 0) ? -0.75 : -0.50; // Basé sur sphère actuelle
        appState.subj.OD.sphere += deltaOD;
    }

    // Calcul pour OG (Basé sur la sphère actuelle de fin de Sb0.2)
    if (appState.seen025_OG) {
        // A vu 0.25 -> Pas de débrouillage
    } else {
        // N'a pas vu 0.25 -> Débrouillage
        var currentSphOG = appState.subj.OG.sphere;
        var deltaOG = (currentSphOG < 0) ? -0.75 : -0.50; // Basé sur sphère actuelle
        appState.subj.OG.sphere += deltaOG;
    }

    setVaToIndexClosest(0.32); 
    updateDisplay("Sb0.5: Débrouillage Bilatéral effectué -> Départ 0.3");
}

function validateSb05() {
    var eye = appState.activeEye;
    if (eye === 'OD') appState.sb05_OD_ok = true; else appState.sb05_OG_ok = true;

    // Sauvegarde de la Sb0.5 trouvée
    if(eye === 'OD') appState.saved_sb05.OD = appState.subj.OD.sphere; 
    else appState.saved_sb05.OG = appState.subj.OG.sphere;

    say("On va de l'autre côté.", function() {
        if (appState.sb05_OD_ok && appState.sb05_OG_ok) { 
            initSb10(); 
        } 
        else {
            var nextEye = (eye === 'OD') ? 'OG' : 'OD'; 
            appState.activeEye = nextEye;
            // Pas de recalcul de sphère ici (déjà fait en global), juste reset variables TQS
            appState.count06_validations = 0; 
            appState.tqs_attempted_06 = false;
            appState.tqsFogCount = 0;

            setVaToIndexClosest(0.32); 
            updateDisplay("Sb0.5 (" + nextEye + ") : Départ 0.3");

            // AJOUT: Relance vocale après changement d'œil
            say(window.getRandomPrompt());
        }
    });
}

function initSb10() {
    // ALERT REMOVED FOR FLUID TRANSITION
    // alert("Passage à Sb1.0 (Bio-Monoculaire).");
    appState.examPhase = "Sb1.0"; appState.activeEye = appState.firstEye; appState.defoggedInZone = false;
    applySb10Logic();

    // AJOUT : Annonce de relance après l'initialisation de la phase
    say(window.getRandomPrompt());
}

function applySb10Logic() {
    var eye = appState.activeEye; 
    var otherEye = (eye === 'OD') ? 'OG' : 'OD';
    var target = getTargetEye(); // Récupère l'œil actuellement actif

    // On s'assure que l'œil passif est bien au brouillage Sb0.5 sauvegardé
    appState.subj[otherEye].sphere = appState.saved_sb05[otherEye]; 
    
    setVaToIndexClosest(0.50);

    if (target.sphere < 0) {
        target.sphere -= 0.50;
        updateDisplay("Sb1.0: Négatif -> Débrouille -0.50 -> Ligne 0.5 (" + eye + ")");
    } else { 
        updateDisplay("Sb1.0: Positif -> Ligne 0.5 (" + eye + ")"); 
    }
}
function validateSb10() {
    var sphere = getTargetEye().sphere;
    if (sphere < 0) { initSphereCheckMinus(); } else { initSphereCheckPlus(); }
}

window.finishSb10ForEye = function() {
    window.hideBaseCircle();
    var eye = appState.activeEye;
    var target = getTargetEye();
    var maxVa = ACUITY_TABLE[appState.vaIndex].va;
    
    // Mise à jour de la VA dans l'état et l'affichage
    appState.subj[eye].va = maxVa;
    setHTML('disp_subj' + eye + '_va', maxVa);

    // Sauvegarde de la sphère finale
    if (eye === 'OD') appState.saved_sb10.OD = target.sphere; 
    else appState.saved_sb10.OG = target.sphere;
    
    // Marquer l'œil actuel comme terminé pour la phase Sb10
    if (eye === 'OD') appState.sb10_OD_ok = true; 
    else appState.sb10_OG_ok = true;

    // --- RÈGLE 1 : SÉCURITÉ CYLINDRE NUL ---
    var puissanceCyl = Math.abs(target.cyl);

    if (puissanceCyl === 0) {
        console.log("Cylindre nul détecté. Passage à l'œil suivant ou fin.");
        say("D'accord, on continue.", function() {
            // APPEL DE LA CORRECTION ICI
            window.proceedToNextStepAfterEye(eye); 
        });
    } else {
        // CAS STANDARD : Cylindre présent -> On lance l'Axe
        document.getElementById('checkPlusZone').classList.add('hidden');
        document.getElementById('standardButtons').classList.add('hidden');
        document.getElementById('cadenceButtons').classList.add('hidden');
        document.getElementById('axisZone').classList.remove('hidden');
        initAxisCheck();
    }
};

// Fonction utilitaire pour gérer la fin d'un oeil et la bascule
window.proceedToNextStepAfterEye = function(completedEye) {
    var otherEye = (completedEye === 'OD') ? 'OG' : 'OD';
    var isOtherEyeDone = (otherEye === 'OD') ? appState.sb10_OD_ok : appState.sb10_OG_ok;

    if (!appState.isMonocularExam && !isOtherEyeDone) {
        // Changement d'œil
        appState.activeEye = otherEye;
        
        // Reset des sécurités pour le second œil
        appState.sb10_line_defog = 0;
        appState.safety_mode = false;
        
        // On relance UNIQUEMENT la logique Sb1.0, pas tout l'examen
        appState.examPhase = "Sb1.0";
        applySb10Logic(); 
        
        updateDisplay("Passage au second œil : " + otherEye);
    } else {
        // Fin d'examen
        say("Ok, passons à la suite.");
        updateDisplay("Examen Terminé");
        
        document.getElementById('standardButtons').classList.add('hidden');
        document.getElementById('examContent').classList.add('hidden');
        document.getElementById('waitingMsg').classList.remove('hidden');
        setHTML('waitingMsg', '<p style="font-size:1.5rem; color:var(--primary);">Examen terminé avec succès.</p>');
    }
};function initSphereCheckMinus() {
  window.showBaseCircle(); // <--- AJOUTER CETTE LIGNE
    appState.examPhase = "SphereCheckMinus"; appState.checkStep = "TEST_125_PRE";

    // MODIFICATION: Check si safety mode actif
    if (appState.safety_mode) {
        // En mode sécurité, on reste sur la ligne actuelle
        // Mais on change les lettres pour éviter la mémorisation
        nextLetters();
        updateDisplay("Sécurité Myope: Test Quart Concave sur ligne actuelle.");

        // --- LOGIQUE: ON AJOUTE LE -0.25 POUR LE TEST ---
        var target = getTargetEye(); 
        target.sphere -= 0.25; 
        // ------------------------------------------------

        say("Lisez-moi cette ligne maintenant."); // Vocal spécifique demandé
    } else {
        // Mode standard (fin d'examen), on va à 1.25
        setVaToIndexClosest(1.25); 
        updateDisplay("Check (-): Lecture 1.25 (Score 1)");
    }
}

function initSphereCheckPlus(skipIntro) {
  window.showBaseCircle(); // <--- AJOUTER CETTE LIGNE  
  appState.examPhase = "SphereCheckPlus"; appState.baseSphereValue = getTargetEye().sphere;
    document.getElementById('standardButtons').classList.add('hidden');
    document.getElementById('cadenceButtons').classList.add('hidden');
    document.getElementById('checkPlusZone').classList.remove('hidden');
    document.getElementById('stepPlusWrapper').classList.remove('hidden');
    document.getElementById('decisionsPlus').classList.add('hidden');
    document.getElementById('stepMinusWrapper').classList.add('hidden');
    document.getElementById('decisionsMinus').classList.add('hidden');
    document.getElementById('btnMinus025').disabled = true;
    if(skipIntro) { nextLetters(); window.triggerFogCheck(); } 
    else { setTimeout(function() { say("C'est pas mal, mais on va essayer de faire un peu mieux", function() { nextLetters(); window.triggerFogCheck(); }); }, 500); }
}

// --------------------------------------------------------------------------
// --- LOGIQUE ASYNCHRONE ET TIMING PRÉCIS (Basé sur Analyse Vidéo) ---
// --------------------------------------------------------------------------

// 1. Fonction utilitaire pour attendre (Promesse)
const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// 2. Test du +0.25 (3s d'exposition environ - Ratio 2:1)
// --- FONCTION TEST +0.25 (AVEC NOUVEAU SCHÉMA BULLES) ---
// --- FONCTION TEST +0.25 (AVEC ANIMATION FLÈCHE GAUCHE) ---
async function triggerFogCheck() {
    updateLockUI(true);
    document.getElementById('btnPlus025').disabled = true; 
    
    // S'assurer que le bouton bleu est bien là au début
    window.showBaseCircle(); 
    
    const target = getTargetEye();
    target.sphere = appState.baseSphereValue; 
    updateDisplay("Check (+): Référence...");

    var arrow = document.getElementById('animArrowLine');
    var targetBubble = document.getElementById('animTargetCircle');

    say("Vous préférez comme ça ?");
    await wait(2500); 

    say("Ou si je fais ça ?");
    await wait(400); 
    
    if(arrow) arrow.classList.add('active');
    if(targetBubble) targetBubble.classList.add('visible');
    
    target.sphere = appState.baseSphereValue + 0.25;
    updateDisplay("Check (+): +0.25 ajouté");

    await wait(3000); 

    say("Ou si je reviens ?");
    await wait(400);


    target.sphere = appState.baseSphereValue; 
    updateDisplay("Check (+): Retour Base");
await wait(1000); 
   // >>> DISPARITION DU BOUTON ET DES BULLES ICI <<<
    window.hideBaseCircle(); 
  
    await wait(1000); 

    updateLockUI(false);
    document.getElementById('decisionsPlus').classList.remove('hidden'); 
    document.getElementById('btnPlus025').disabled = false;
}
  
  // 3. Test du -0.25 (1.5s d'exposition environ - Ratio 1:2)
// --- FONCTION TEST -0.25 (ANIMATION VERS LA DROITE) ---
async function triggerDefogCheck() {
    updateLockUI(true);
    document.getElementById('btnMinus025').disabled = true; 
    
    // S'assurer que le bouton bleu est bien là au début
    window.showBaseCircle();

    const target = getTargetEye();
    target.sphere = appState.baseSphereValue;
    updateDisplay("Check (-): Référence...");

    var arrowMinus = document.getElementById('animArrowLineMinus');
    var targetBubbleMinus = document.getElementById('animTargetCircleMinus');

    say("Vous préférez comme ça ?");
    await wait(2500);

    say("Ou si je fais ça ?");
    await wait(400);
    
    if(arrowMinus) arrowMinus.classList.add('active');
    if(targetBubbleMinus) targetBubbleMinus.classList.add('visible');

    target.sphere = appState.baseSphereValue - 0.25;
    updateDisplay("Check (-): -0.25 ajouté");

    await wait(1500); 

    say("Ou si je reviens ?");
    await wait(400);

    target.sphere = appState.baseSphereValue; 
    updateDisplay("Check (-): Retour Base");
await wait(1000); 
  // >>> DISPARITION DU BOUTON ET DES BULLES ICI <<<
    window.hideBaseCircle();

    await wait(1000); 

    updateLockUI(false);
    document.getElementById('decisionsMinus').classList.remove('hidden'); 
    document.getElementById('btnMinus025').disabled = false;
}
  
  window.relaunchPlus = function() {
    if (appState.isSpeaking) return; // LOCK
    document.getElementById('decisionsPlus').classList.add('hidden');

    // CHANGEMENT DE LETTRES UNIQUEMENT ICI (Relance explicite)
    nextLetters(); 

    say("D'accord, je vous remontre", function() { window.triggerFogCheck(); });
};

window.decidePlus = function(choice) {
    if (appState.isSpeaking) return;

    const target = getTargetEye();
    const currentSph = target.sphere;
    const raSph = (appState.activeEye === 'OD') ? getVal('raOD_sph') : getVal('raOG_sph');

    if (choice === 'better' || choice === 'same') {
        // LE PATIENT ACCEPTE LE PLUS : On annule toute velléité de test Swéb (-0.25)
        appState.isCheckingGain = false; 
        
        nextLetters();
        target.sphere = appState.baseSphereValue + 0.25; 
        updateDisplay("Accepté (+0.25) -> On recommence le test de brouillage"); 
        
        // On relance le test du +0.25 sur la nouvelle base
        setTimeout(function() { initSphereCheckPlus(); }, 500);
    } else {
        // --- CAS : REJET DU +0.25 ---
        const isRaPositiveAtZero = (raSph >= 0 && currentSph <= 0);

        if (isRaPositiveAtZero) {
            updateDisplay("Validation : Limite 0.00 atteinte");
            if(document.getElementById('checkPlusZone')) document.getElementById('checkPlusZone').classList.add('hidden');
            say("Ok, on continue.", function() {
                finishSb10ForEye(); 
            });
        } 
        else {
            // CORRECTIF : On prépare le terrain pour le MOINS
            document.getElementById('stepPlusWrapper').classList.add('hidden'); 
            document.getElementById('stepMinusWrapper').classList.remove('hidden');
            document.getElementById('decisionsMinus').classList.add('hidden');
            
            updateDisplay("Rejet (+) -> Présentation du Quart Concave (-0.25)");
            
            say("Attention, je vais dans l'autre sens.", function() { 
                // On lance l'animation visuelle du verre de -0.25
                window.triggerDefogCheck(); 
            });
        }
    }
}  
  window.startAutomaticMinusCheck = function() {
    document.getElementById('stepMinusWrapper').classList.remove('hidden');
    document.getElementById('decisionsMinus').classList.add('hidden');
    window.triggerDefogCheck();
};

window.relaunchFullCheck = function() { 
    if (appState.isSpeaking) return; // LOCK

    // Relance explicite -> Changement de lettres
    nextLetters();

    say("D'accord, mais on refait tout", function() { window.initSphereCheckPlus(true); }); 
};

window.decideMinus = function(choice) {
    if (appState.isSpeaking) return;

    if (choice === 'better') {
        // Initialisation de la mémoire Swéb
        appState.scoreN_SansVerre = appState.lastResponseCount || 0;
        appState.isCheckingGain = true;

        if (goNextLine()) {
            appState.examPhase = "Vérification de Swéb"; // Phase Étape 1
            nextLetters(); 
            updateDisplay("Vérification de Swéb (Mesure de base)");
            document.getElementById('checkPlusZone').classList.add('hidden');
            document.getElementById('standardButtons').classList.remove('hidden');
            say("D'accord. Sans changer le verre pour l'instant, lisez-moi cette nouvelle ligne s'il vous plaît.");
        } else {
            appState.examPhase = "Vérification de Swéb";
            nextLetters();
            document.getElementById('checkPlusZone').classList.add('hidden');
            document.getElementById('standardButtons').classList.remove('hidden');
            say("D'accord. Relisez ces lettres s'il vous plaît.");
        }
    } else {
        // --- CAS : REJET DU -0.25 (PAREIL OU MOINS BIEN) ---
        // 1. Verrouillage : On s'assure que le mode gain est désactivé
        appState.isCheckingGain = false;

        // 2. Retour à la sphère qui a validé le 10/10 initial
        var target = getTargetEye();
        target.sphere = appState.baseSphereValue; 
        
        updateDisplay("Rejet du -0.25. Validation de la base.");

        // 3. Fermeture de l'interface de test
        if(document.getElementById('checkPlusZone')) document.getElementById('checkPlusZone').classList.add('hidden');
        
        say("Très bien, on reste comme cela.", function() {
            finishSb10ForEye(); 
        });
    }
};
window.handleResponse = function(lettersRead) {
    if (appState.isSpeaking) return; // LOCK

  appState.lastResponseCount = lettersRead;
    // 1. Feedback Choice
    var wordsLow = ["Ok", "D'accord", "Bien"];
    var wordsHigh = ["Ok", "Bien", "Très bien", "Parfait", "D'accord"];
    var feedback = (lettersRead <= 3) ? wordsLow[Math.floor(Math.random() * wordsLow.length)] : wordsHigh[Math.floor(Math.random() * wordsHigh.length)];

    // --- GESTION SPÉCIFIQUE Sb0.2 et Sb0.5 (Séquence Temporelle Stricte) ---
    if (appState.examPhase === "Sb0.2" || appState.examPhase === "Sb0.5") {

        // 1. On parle d'abord (Feedback)
        say(feedback, function() {
            // CE CODE S'EXECUTE UNE FOIS QUE "TRES BIEN" EST FINI

            // 2. Snapshot état avant logique
            var oldVa = appState.vaIndex;
            var oldLet = appState.letterIndex;
            var oldEye = appState.activeEye;

            // 3. Exécution logique (MISE A JOUR VISUELLE ICI)
            processLogic(lettersRead, 'rabbit');

            // 4. Si la logique a changé l'œil (fin de phase), on s'arrête là (la transition vocale est gérée ailleurs)
            if (appState.activeEye !== oldEye) return;

            // 5. Détection du changement visuel
            var changed = (appState.vaIndex !== oldVa || appState.letterIndex !== oldLet);

            // 6. Si changement visuel -> Relance vocale
            if (changed) {
                say(window.getRandomPrompt());
            }
        });
        return;
    }

    // --- GESTION STANDARD (Sb1.0, etc.) ---
    var currentTxt = ACUITY_TABLE[appState.vaIndex].lines[appState.letterIndex % 8]; 
    if(!currentTxt) currentTxt = ACUITY_TABLE[appState.vaIndex].lines[0];
    var totalLetters = currentTxt.split(' ').length;

    if (totalLetters < 5 || lettersRead < 3) { 
        // Pas de demande de cadence -> Logique immédiate
        processLogic(lettersRead, 'rabbit');
        if (!appState.isSpeaking) say(feedback);
    } else { 
        // Demande de cadence
        say(feedback); // On dit juste "Bien"
        askCadence(lettersRead); 
    }
};

window.handleCadence = function(type) {
    if (appState.isSpeaking) return; // LOCK

  appState.lastCadenceUsed = type;
    // 1. Snapshot de la phase AVANT logique
    var phaseBefore = appState.examPhase;

    var n = appState.pendingLetters; 
    appState.pendingLetters = null;

    document.getElementById('standardButtons').classList.remove('hidden'); 
    document.getElementById('cadenceButtons').classList.add('hidden');

    // 2. Exécution Logique
    processLogic(n, type);

    // 3. Vérification APRES logique
    // Si on est encore en Sb1.0, c'est qu'on continue (Ligne suivante ou débrouillage) -> On relance.
    // Si on a changé de phase (vers SphereCheck, etc.), on ne dit rien.
    if (phaseBefore === "Sb1.0" && appState.examPhase === "Sb1.0") {
          say(window.getRandomPrompt());
    }
};

// --- LOGIQUE PRINCIPALE AVEC MESSAGES HARMONISÉS ---
function processLogic(lettersRead, cadence) {
    // --- AJOUT DE LA RÈGLE DU GAIN ---
    
    // ---------------------------------
    
    var currentVA = ACUITY_TABLE[appState.vaIndex].va;
    // ... reste de la fonction
    var currentVA = ACUITY_TABLE[appState.vaIndex].va;
    var currentTxt = ACUITY_TABLE[appState.vaIndex].lines[appState.letterIndex % 8]; if(!currentTxt) currentTxt = ACUITY_TABLE[appState.vaIndex].lines[0];
    var totalLetters = currentTxt.split(' ').length; var isSmallLine = totalLetters < 5;
    var isPassed = false;

  // =========================================================
// =========================================================
// =========================================================
// LOGIQUE EXPERTE : VÉRIFICATION DE SWÉB (SÉCURISÉE)
// =========================================================

// CAS 1 : On vient de saisir le score SANS le verre sur 12.5
if (appState.examPhase === "Vérification de Swéb") {
    appState.scoreNPlus1_SansVerre = lettersRead; 
    
    // ACTION : On applique le verre de test
    var target = getTargetEye();
    target.sphere = appState.baseSphereValue - 0.25; 
    
    // TRANSITION : On change de phase immédiatement pour le prochain clic
    appState.examPhase = "Vérification de Swéb_AVEC_VERRE";
    
    nextLetters(); 
    updateDisplay("Vérification de Swéb (Test avec -0.25)");
    say("Bien. Et maintenant avec ce nouveau verre, relisez cette ligne s'il vous plaît.");
    return; // STOP : On attend le clic suivant
}

// CAS 2 : On vient de saisir le score AVEC le verre sur 12.5
if (appState.examPhase === "Vérification de Swéb_AVEC_VERRE") {
    appState.scoreNPlus1_AvecVerre = lettersRead;
    var gainSurNPlus1 = appState.scoreNPlus1_AvecVerre - appState.scoreNPlus1_SansVerre;
    
    if (gainSurNPlus1 >= 3) {
        // SUCCÈS IMMÉDIAT
        appState.isCheckingGain = false;
        appState.examPhase = "Sb1.0";
        say("C'est parfait, on garde ce verre.");
        finishSb10ForEye();
    } 
    else if (appState.scoreN_SansVerre < 5) {
        // CAS AMBIGU : On redescend à la ligne 10/10 (N)
        setVaToIndexClosest(1.0); 
        appState.examPhase = "Vérification de Swéb_CUMUL_FINAL";
        nextLetters();
        updateDisplay("Vérification de Swéb (Gain cumulé sur 10/10)");
        say("D'accord. Regardez maintenant la ligne juste au-dessus, et lisez-moi les lettres.");
    }
    else {
        // ÉCHEC : Pas de gain et déjà au max sur la ligne précédente
        revertMinusLens();
    }
    return; // STOP : On attend le clic ou la fin
}

// CAS 3 : On vient de saisir le score de cumul sur 10/10
if (appState.examPhase === "Vérification de Swéb_CUMUL_FINAL") {
    var gainSurN = lettersRead - appState.scoreN_SansVerre;
    var gainSurNPlus1 = appState.scoreNPlus1_AvecVerre - appState.scoreNPlus1_SansVerre;
    var gainTotal = gainSurN + gainSurNPlus1;
    
    if (gainTotal >= 3) {
        // SUCCÈS CUMULÉ
        appState.isCheckingGain = false;
        appState.examPhase = "Sb1.0";
        say("Très bien, ce verre améliore globalement votre vision.");
        finishSb10ForEye();
    } else {
        // ÉCHEC CUMULÉ
        revertMinusLens();
    }
    return; // STOP
}    // RÈGLE SPÉCIFIQUE SB0.2
    if (appState.examPhase === "Sb0.2") {
        if (cadence === 'rabbit') {
            if (isSmallLine) {
                if (lettersRead === totalLetters) isPassed = true;
            } else {
                if (lettersRead >= 3) isPassed = true;
            }
        }
        else if (cadence === 'turtle') {
            if (!isSmallLine) {
                if (lettersRead >= 4) isPassed = true;
            }
        }

        if (isPassed) {
            // MISE A JOUR VA LUE
            appState.subj[appState.activeEye].va = currentVA;

            if (currentVA === 0.25) {
                if (appState.activeEye === 'OD') appState.seen025_OD = true; else appState.seen025_OG = true;
                validateSb02();
                return;
            }
            if (goNextLine()) updateDisplay("Validé -> Suivant");
            else updateDisplay("Max Atteint");
            return;
        } else {
            if (currentVA === 0.25) {
                 updateDisplay("Palier 0.25 non franchi -> Sb0.2 validée");
                 setTimeout(function() { validateSb02(); }, 1000); 
                 return;
            }

            var currentSph = getTargetEye().sphere;
            var raSph = (appState.activeEye === 'OD') ? getVal('raOD_sph') : getVal('raOG_sph');
            if (currentSph - 0.25 < raSph) {
                 document.getElementById('modalDefogLimit').classList.remove('hidden');
                 return;
            }

            if (currentVA >= 0.06 && currentVA <= 0.20) {
                appState.defoggedInZone = true;
            }

            getTargetEye().sphere -= 0.25;

            // --- CORRECTION : Changement de lettres si >= 3 OU si ligne petite et >= 1 lettre lue ---
            if (lettersRead >= 3 || (isSmallLine && lettersRead > 0)) {
                nextLetters();
            } 

            var msg = (cadence === 'turtle') ? "Tortue -> Sph -0.25" : "Non vu -> Sph -0.25";
            updateDisplay(msg);
            return;
        }
    }

    // RÈGLE SPÉCIFIQUE SB0.5 (T.Q.S)
    if (appState.examPhase === "Sb0.5") {

        // --- 1. Gestion Validation Ligne (Lapin/Tortue identique) ---
        if (lettersRead >= 3) isPassed = true;
        else isPassed = false;

        // --- 2. Logique par Ligne ---

        // CAS A : Ligne 0.3 (0.32) ou 0.4 (0.40)
        if (currentVA === 0.32 || currentVA === 0.40) {
            if (isPassed) {
                // MISE A JOUR VA LUE
                appState.subj[appState.activeEye].va = currentVA;

                if (currentVA === 0.40) {
                    if (appState.tqs_attempted_06) {
                        setVaToIndexClosest(0.50);
                        updateDisplay("0.4 Validé (Post-Brouillage) -> 0.5");
                    } else {
                        setVaToIndexClosest(0.60);
                        updateDisplay("0.4 Validé -> Saut à 0.6 (Piège)");
                        appState.tqs_attempted_06 = true; 
                    }
                } else {
                    goNextLine(); // 0.3 -> 0.4
                    updateDisplay("0.3 Validé -> 0.4");
                }
            } else {
                getTargetEye().sphere -= 0.25;
                nextLetters(); // <-- Ajout pour relance vocale
                updateDisplay("Échec " + currentVA + " -> Débrouille -0.25");
            }
            return;
        }

        // CAS B : Ligne 0.60 (Le Piège)
        if (currentVA === 0.60) {
            if (!isPassed) {
                if (appState.tqsFogCount > 0) setVaToIndexClosest(0.40);
                else setVaToIndexClosest(0.50);
                updateDisplay("Piège 0.6 fonctionnel -> Descente");
            } else {
                // MISE A JOUR VA LUE (Même si c'est un piège, il l'a lue)
                appState.subj[appState.activeEye].va = currentVA;

                if (appState.tqsFogCount >= 2) {
                    document.getElementById('modalTqsLimit').classList.remove('hidden');
                    return;
                }
                getTargetEye().sphere += 0.50;
                nextLetters();
                appState.tqsFogCount++;
                updateDisplay("Piège 0.6 échoué (Vu) -> Brouille +0.50");
            }
            return;
        }

        // CAS C : Ligne 0.50 (Finale)
        if (currentVA === 0.50) {
            if (isPassed) {
                appState.subj[appState.activeEye].va = currentVA;
                validateSb05();
            } else {
                getTargetEye().sphere -= 0.25;
                nextLetters(); // <-- Ajout pour relance vocale
                updateDisplay("Échec 0.5 -> Débrouille -0.25");
            }
            return;
        }
    }

    // RÈGLES STANDARD (AUTRES PHASES)
    if (cadence === 'rabbit') {
        if (isSmallLine && lettersRead === totalLetters) isPassed = true;
        if (!isSmallLine && lettersRead > 3) isPassed = true;
    }

    // LOGIQUE SPHERE CHECK
    if (appState.examPhase === "SphereCheckMinus") {
        if (appState.checkStep === "TEST_125_PRE") {
            appState.tempScore = lettersRead; var target = getTargetEye(); target.sphere -= 0.25;
            appState.checkStep = "TEST_125_POST"; nextLetters(); updateDisplay("Ajout -0.25 -> Relire 1.25");
        } else if (appState.checkStep === "TEST_125_POST") {
            var gain = lettersRead - appState.tempScore;

            // --- SÉCURITÉ MYOPE : RÈGLE GAIN >= 2 ---
            if (appState.safety_mode) {
                 var gainSafety = lettersRead - appState.safety_mem_letters;

                 if (gainSafety >= 2) {
                      // SUCCÈS : On garde le -0.25
                      if (isPassed) {
                           appState.safety_mode = false;
                           appState.sb10_line_defog = 0;
                           appState.examPhase = "Sb1.0"; // Retour Sb1.0
                           appState.subj[appState.activeEye].va = currentVA;
                           appState.checkStep = null;
                           if (goNextLine()) updateDisplay("Sécurité Myope passée -> Ligne Suivante");
                           else updateDisplay("Max Atteint");
                      } else {
                           // Pas lapin mais gain >= 2 -> On valide cette sphère
                           alert("Amélioration confirmée (+"+gainSafety+") mais plafond atteint. On valide cette sphère.");
                           finishSb10ForEye();
                      }
                 } else {
                      // ECHEC : Gain < 2
                      var target = getTargetEye(); target.sphere += 0.25; // Revert
                      updateDisplay("Revert...");
                      alert("Gain insuffisant (< 2). On revient à la sphère précédente.");
                      finishSb10ForEye();
                 }
                 return;
            }
            // ----------------------------------------

            if (gain >= 3) { updateDisplay("Gain suffisant -> -0.25 conservé"); appState.examPhase = "Sb1.0"; appState.checkStep = null; finishSb10ForEye(); } 
            else { var target = getTargetEye(); target.sphere += 0.25; updateDisplay("Gain faible -> -0.25 rejeté"); appState.examPhase = "Sb1.0"; appState.checkStep = null; finishSb10ForEye(); }
        }
        return;
    }

    // LOGIQUE Sb1.0
    if (appState.examPhase === "Sb1.0") {

        // --- SÉCURITÉ DE RETOUR (Après CheckPlus/CheckMinus) ---
        if (appState.safety_mode && getTargetEye().sphere >= 0) { // Uniquement Positif ici, Myope géré dans SphereCheckMinus block
            if (lettersRead > appState.safety_mem_letters) {
                // Filtre A: Amélioration confirmée

                if (isPassed) {
                    // Filtre B: Validation Standard (Lapin) -> OK
                    appState.safety_mode = false; 
                    appState.sb10_line_defog = 0; // Reset compteur
                    appState.subj[appState.activeEye].va = currentVA;
                    if (goNextLine()) updateDisplay("Sécurité passée -> Ligne Suivante");
                    else updateDisplay("Max Atteint");
                    return;
                } else {
                    // Filtre B: Echec Validation (Amélioration mais pas Lapin) -> STOP
                    // C'est ici qu'on force la sortie pour éviter la boucle
                    alert("Amélioration confirmée mais plafond atteint. On valide cette sphère.");
                    finishSb10ForEye();
                    return;
                }
            } else {
                // Filtre A Failed: Pas d'amélioration -> REVERT & STOP

                // 1. On annule le débrouillage (On remet +0.25 car le -0.25 était inutile)
                var target = getTargetEye();
                target.sphere += 0.25;

                // --- CORRECTION : ON MET A JOUR L'AFFICHAGE AVANT DE VALIDER ---
                updateDisplay("Sécurité : Retour à la sphère précédente."); 
                // ---------------------------------------------------------------

                // 2. Alert et Fin
                alert("Sécurité : Le débrouillage n'apporte rien. On revient à la sphère précédente (" + target.sphere.toFixed(2) + ") et on valide.");
                finishSb10ForEye();
                return;
            }
        }
        // -------------------------------------------------------

        var sph = getTargetEye().sphere;
        if (currentVA === 1.0) {
            if (sph >= 0) {
                // === CAS SPHÈRE POSITIVE OU NULLE ===
                // 1. Échec
                if (lettersRead < 3 || (lettersRead === 3 && cadence === 'turtle')) {

                    // --- CORRECTION CHRONOLOGIQUE : CHECK AVANT DÉBROUILLAGE ---
                    if (appState.sb10_line_defog >= 2) {
                        // C'est le 3ème échec -> STOP AVANT DE TOUCHER LA SPHERE
                        if (appState.hasRestartedSb10) {
                            alert("Sécurité : Seconde tentative échouée. On valide la sphère actuelle.");
                            finishSb10ForEye();
                            return;
                        }
                        appState.safety_mode = true;
                        appState.safety_mem_letters = lettersRead;
                        alert("Sécurité : Débrouillage excessif (" + sph.toFixed(2) + "). Vérification.");
                        initSphereCheckPlus();
                        return; // SORTIE ICI, SPHÈRE INCHANGÉE (4.00)
                    }
                    appState.sb10_line_defog++;
                    // -----------------------------------------------------------

                    changeSphereAndRetest(-0.25); updateDisplay("Echec 1.0 (+) -> Débrouille -0.25"); 
                    return;
                }
                // 2. Succès -> Check Plus
                appState.subj[appState.activeEye].va = currentVA;
                initSphereCheckPlus(); return;
            } else {
                // === CAS SPHÈRE NÉGATIVE (< 0) ===
                // 1. Échec Franc
                if (lettersRead < 3 || (lettersRead === 3 && cadence === 'turtle')) { 

                    // --- SÉCURITÉ MYOPE ---
                    if (appState.sb10_line_defog >= 2) {
                          appState.safety_mode = true;
                          appState.safety_mem_letters = lettersRead;
                          alert("Sécurité Myope : Débrouillage excessif. Test du Quart Concave.");

                          // --- AJOUT MAJEUR : ON AJOUTE LE -0.25 POUR LE TEST ICI ---
                          var target = getTargetEye(); target.sphere -= 0.25; 
                          // -----------------------------------------------------------

                          initSphereCheckMinus(); // Lance le test sans changer la ligne
                          return;
                    }
                    appState.sb10_line_defog++;
                    // ----------------------

                    changeSphereAndRetest(-0.25); 
                    updateDisplay("Echec 1.0 (-) -> Débrouille -0.25"); 
                    return; 
                }
                // 2. Zone Mitigée (3 ou 4 lettres, OU 5 lettres Tortue)
                if (lettersRead === 3 || lettersRead === 4 || (lettersRead === 5 && cadence === 'turtle')) { 
                    initSphereCheckMinus(); 
                    return; 
                }
                // 3. Succès Total (5 lettres ET Lapin)
                if (lettersRead === 5 && cadence === 'rabbit') { 
                    appState.subj[appState.activeEye].va = currentVA;
                    // Validation immédiate, pas de Quart Concave
                    alert("Sphère Validée (Succès Total) !"); 
                    finishSb10ForEye(); 
                    return; 
                }
            }
        }

        // Logique de montée standard avant 1.0
        if (isPassed) {
            appState.subj[appState.activeEye].va = currentVA;
            if (currentVA < 1.0) { if (goNextLine()) updateDisplay("Validé -> Suivant"); else updateDisplay("Max Atteint"); } return;
        } else { 

            // --- CORRECTION CHRONOLOGIQUE : CHECK AVANT DÉBROUILLAGE (POUR SPH >= 0) ---
            if (sph >= 0) {
                if (appState.sb10_line_defog >= 2) {
                    if (appState.hasRestartedSb10) {
                        alert("Sécurité : Seconde tentative échouée. On valide la sphère actuelle.");
                        finishSb10ForEye();
                        return;
                    }
                    appState.safety_mode = true;
                    appState.safety_mem_letters = lettersRead;
                    alert("Sécurité : Débrouillage excessif (" + sph.toFixed(2) + "). Vérification.");
                    initSphereCheckPlus();
                    return;
                }
                appState.sb10_line_defog++;
            }
            // --- SÉCURITÉ MYOPE (POUR SPH < 0) ---
            else {
                if (appState.sb10_line_defog >= 2) {
                      appState.safety_mode = true;
                      appState.safety_mem_letters = lettersRead;
                      alert("Sécurité Myope : Débrouillage excessif. Test du Quart Concave.");

                      // --- AJOUT MAJEUR : ON AJOUTE LE -0.25 POUR LE TEST ICI ---
                      var target = getTargetEye(); target.sphere -= 0.25; 
                      // -----------------------------------------------------------

                      initSphereCheckMinus();
                      return;
                }
                appState.sb10_line_defog++;
            }
            // ---------------------------------------------------------------------------

            changeSphereAndRetest(-0.25); 
            updateDisplay("Echec " + currentVA + " -> Débrouille -0.25"); 
            return; 
        }
    }

    // GENERAL - MESSAGES BAVARDS
    var msg = ""; var changeSphere = 0;
    if (isSmallLine) {
       if (lettersRead < totalLetters) { changeSphere = -0.25; nextLetters(); msg = "Non vu -> Sph -0.25"; } else { if (goNextLine()) msg = "Validé -> Suivant"; else msg = "Acuité Max"; }
    } else {
       if (lettersRead < 3) { changeSphere = -0.25; msg = "< 3 lettres -> Sph -0.25"; } 
       else if (lettersRead === 3) { changeSphere = -0.25; nextLetters(); msg = "= 3 lettres -> Sph -0.25"; } 
       else {
           if (cadence === 'turtle') { changeSphere = -0.25; nextLetters(); msg = "> 3 (Tortue) -> Sph -0.25"; } 
           else { if (currentVA === 1.0) { nextLetters(); msg = "VA 1.0 -> Test Faces"; } else { if (goNextLine()) msg = "Validé -> Suivant"; else msg = "Acuité Max"; } }
       }
    }
    applyChanges(changeSphere, msg);
}

// Fonction utilitaire pour la sécurité Sb1.0
function handleSb10Safety(currentSphere, score) {
    if (currentSphere >= 0) {
        appState.sb10_line_defog++;
        // Si on a débrouillé plus de 0.50 (donc 3 fois 0.25 = 0.75)
        if (appState.sb10_line_defog > 2) {
            // NEW CHECK: Prevent infinite loop
            if (appState.hasRestartedSb10) {
                alert("Sécurité : Seconde tentative échouée. On valide la sphère actuelle.");
                finishSb10ForEye();
                return;
            }

            appState.safety_mode = true;
            // On sauvegarde le vrai score de l'échec
            appState.safety_mem_letters = score; 

            alert("Sécurité : Débrouillage excessif sur sphère positive. Vérification.");
            initSphereCheckPlus();
        }
    }
}
// Fonction de secours pour annuler le verre de test en cas d'échec de gain
function revertMinusLens() {
    var target = getTargetEye();
    // On remet la sphère initiale (celle d'avant le test du -0.25)
    target.sphere = appState.baseSphereValue; 
    
    appState.isCheckingGain = false;
    appState.examPhase = "Sb1.0";
    
    // On s'assure que l'affichage revient sur la ligne de référence 10/10
    setVaToIndexClosest(1.0); 
    
    updateDisplay("Gain insuffisant : retour à la base");
    say("Ce n'est pas mieux finalement, on revient à la position précédente.");
    
    // On valide définitivement l'œil pour passer à la suite
    finishSb10ForEye();
}
function changeSphereAndRetest(delta) { var target = getTargetEye(); target.sphere += delta; nextLetters(); }
function nextLetters() { appState.letterIndex++; }
function goNextLine() {
    appState.sb10_line_defog = 0; // Reset sécurité nouvelle ligne
    var currentVA = ACUITY_TABLE[appState.vaIndex].va;
    if (currentVA === 0.25 && appState.examPhase === "Sb0.2") { if (appState.activeEye === 'OD') appState.seen025_OD = true; if (appState.activeEye === 'OG') appState.seen025_OG = true; }
    if (appState.examPhase === "Sb0.2" && currentVA === 0.20 && appState.defoggedInZone) { validateSb02(); return false; }
    if (appState.examPhase === "Sb0.5" && currentVA === 0.40) { appState.tqs_attempted_06 = true; setVaToIndexClosest(0.60); return true; }
    if (appState.vaIndex < ACUITY_TABLE.length - 1) { appState.vaIndex++; appState.letterIndex = 0; return true; }
    return false;
}
function setVaToIndexClosest(target) { for(var i=0; i<ACUITY_TABLE.length; i++) { if(ACUITY_TABLE[i].va >= target) { appState.vaIndex = i; break; } } appState.letterIndex = 0; }
function askCadence(n) { appState.pendingLetters = n; document.getElementById('standardButtons').classList.add('hidden'); document.getElementById('cadenceButtons').classList.remove('hidden'); updateDisplay("> 3 lettres. Cadence ?"); }
function applyChanges(sphereDelta, message) {
    var currentVA = ACUITY_TABLE[appState.vaIndex].va;
    if (appState.examPhase === "Sb0.2" && sphereDelta < 0 && currentVA >= 0.06 && currentVA <= 0.20) { appState.defoggedInZone = true; }
    var target = getTargetEye(); target.sphere += sphereDelta; updateDisplay(message);
}

function updateDisplay(message) {
    // 1. Mise à jour Panneau Gauche
    setHTML('subjOD_sph', appState.subj.OD.sphere.toFixed(2)); setHTML('subjOG_sph', appState.subj.OG.sphere.toFixed(2));
    setHTML('subjOD_cyl', appState.subj.OD.cyl.toFixed(2)); setHTML('subjOG_cyl', appState.subj.OG.cyl.toFixed(2));
    setHTML('subjOD_axe', appState.subj.OD.axe + "°"); setHTML('subjOG_axe', appState.subj.OG.axe + "°");

    // 2. Mise à jour Panneau Droite (Nouvelle Section Verticale)
    setHTML('disp_subjOD_sph', appState.subj.OD.sphere.toFixed(2));
    setHTML('disp_subjOD_cyl', appState.subj.OD.cyl.toFixed(2));
    setHTML('disp_subjOD_axe', appState.subj.OD.axe + "°");
    setHTML('disp_subjOD_va', appState.subj.OD.va); // Ajout VA OD

    setHTML('disp_subjOG_sph', appState.subj.OG.sphere.toFixed(2));
    setHTML('disp_subjOG_cyl', appState.subj.OG.cyl.toFixed(2));
    setHTML('disp_subjOG_axe', appState.subj.OG.axe + "°");
    setHTML('disp_subjOG_va', appState.subj.OG.va); // Ajout VA OG

    // Gestion visuelle de l'œil actif
    var boxOD = document.getElementById('subjDispOD');
    var boxOG = document.getElementById('subjDispOG');
    var btnOD = document.getElementById('btnOD');
    var btnOG = document.getElementById('btnOG');

    // Gestion des classes des colonnes de données
    if(appState.activeEye === 'OD') {
        boxOD.classList.add('active'); boxOG.classList.remove('active');
    } else {
        boxOD.classList.remove('active'); boxOG.classList.add('active');
    }

    // Gestion des classes des boutons Yeux (Nouvelle logique Occlusion)
    var isMonocularPhase = (appState.examPhase === "Sb0.2" || appState.examPhase === "Sb0.5");

    if(appState.activeEye === 'OD') {
        btnOD.className = 'eye-btn active';
        btnOG.className = isMonocularPhase ? 'eye-btn occluded-mode' : 'eye-btn';
    } else {
        btnOD.className = isMonocularPhase ? 'eye-btn occluded-mode' : 'eye-btn';
        btnOG.className = 'eye-btn active';
    }

    setHTML('valProfile', appState.profile);
    setHTML('systemMsg', message);
    if (message.indexOf("VALIDÉE") !== -1 || message.indexOf("Validé") !== -1) document.getElementById('systemMsg').classList.add('success-msg'); else document.getElementById('systemMsg').classList.remove('success-msg');

    var currentData = ACUITY_TABLE[appState.vaIndex]; setHTML('valVA', currentData.va);
    var linesArr = currentData.lines; var txt = linesArr[appState.letterIndex % linesArr.length];
    setHTML('letterBox', txt);
    var count = txt.split(' ').length; var btnHTML = "";
    for(var i=0; i<=count; i++) { btnHTML += '<button class="btn-resp" onclick="window.handleResponse('+i+')">'+i+'</button> '; }
    setHTML('btnContainer', btnHTML);

    // Visuals Eye (Gauche) - Masquage des champs de saisie
    // (MODIFIÉ: Suppression de applyVisuals car plus d'éléments à masquer dans le panneau gauche)
}

// --- AXE ---
window.initAxisCheck = function() {
    appState.examPhase = "AxisCheck"; 
    var target = getTargetEye(); 
    var raAxis = (appState.activeEye === 'OD') ? getVal('raOD_axe') : getVal('raOG_axe');
    appState.startAxisRA = raAxis; 
    var cyl = Math.abs(target.cyl); 
    appState.cylHigh = (cyl >= 4.50);

    if (cyl < 2.50) appState.axisStep = 20; else appState.axisStep = 10; 
    appState.axisDirectionHistory = [];

    // --- CORRECTION : ON ACTIVE LES ZONES D'AFFICHAGE ---
    document.getElementById('axisZone').classList.remove('hidden');     // AJOUT
    document.getElementById('axisControls').classList.remove('hidden'); // AJOUT
    document.getElementById('standardButtons').classList.add('hidden'); // AJOUT (pour cacher les chiffres 0-5)
    
    document.getElementById('jccVisuals').classList.remove('hidden'); 
    document.getElementById('visPos1').classList.remove('active'); 
    document.getElementById('visPos2').classList.remove('active');
    
    document.getElementById('axisDecisions').classList.add('hidden'); 
    document.getElementById('btnReplayAxis').classList.add('hidden'); 
    
    updateDisplay("Axe: Init CXJ. Cyl=" + cyl.toFixed(2));

    if (appState.cylHigh) { 
        alert("Cylindre Fort détecté. Méthode comparative (RA vs RA+5 / RA-5)."); 
    } else { 
        say("Je vais maintenant vous montrer deux positions différentes que vous allez comparer. Vous me direz avec quelle position vous préférez lire les lettres.", function() {
            setTimeout(function() { runJccSequence(); }, 1000);
        });
    }
};
window.runJccSequence = function() {
    if (appState.isSpeaking) return; 
    
    window.hideBaseCircle();
    var p1 = document.getElementById('visPos1'); 
    var p2 = document.getElementById('visPos2');
    var axisDecisions = document.getElementById('axisDecisions');
    var replayBtn = document.getElementById('btnReplayAxis');

    // Reset visuel
    axisDecisions.classList.add('hidden');
    replayBtn.classList.add('hidden');
    p1.classList.remove('active');
    p2.classList.remove('active');

    let startTimeP1; // Pour calculer la durée exacte d'affichage de P1

    // 1. On pose la question 1
    say("Vous préférez lire les lettres dans la position une ?", function() {
        // P1 s'allume à la fin de la phrase
        p1.classList.add('active');
        startTimeP1 = Date.now(); // On lance le chrono de visibilité

        // On laisse un temps d'observation fixe avant de lancer la suite de la phrase
        setTimeout(function() {
            
            // 2. La voix lance la transition vers le "deux"
            // Le bouton 1 est TOUJOURS ALLUMÉ ici
            say("Ou vous préférez lire les lettres dans la position deux", function() {
                
                // --- INSTANT DE LA BASCULE ---
                p1.classList.remove('active'); // Le 1 s'éteint
                p2.classList.add('active');    // Le 2 s'allume
                
                let durationP1 = Date.now() - startTimeP1; // Calcul du temps total de P1

                // On enchaîne avec la fin de la phrase
                say("ou c'est pareil ?", function() {
                    // La voix continue, le bouton 2 reste
                });

                // 3. Égalité du temps d'affichage
                setTimeout(function() {
                    p2.classList.remove('active'); // Le 2 s'éteint après la même durée que P1
                    
                    // Apparition des boutons de réponse
                    setTimeout(function() {
                        axisDecisions.classList.remove('hidden');
                        replayBtn.classList.remove('hidden');
                    }, 400);

                }, durationP1); // Utilisation de la durée calculée
            });

        }, 1500); // Délai d'observation "pur" de P1 avant que la voix ne reprenne
    });
};  
  window.handleJccChoice = function(choice) {
    if (appState.isSpeaking) return; 

    // Cache les boutons de réponse immédiatement après le clic
    document.getElementById('axisDecisions').classList.add('hidden');
    document.getElementById('btnReplayAxis').classList.add('hidden');

    var target = getTargetEye();
    if (choice === 'same') { 
        alert("Axe validé ! Passage à la Puissance."); 
        // Logique de passage à la suite ici
        return; 
    }

    // Calcul de l'axe (identique à ton code actuel)
    var direction = (choice === 'pos1') ? 'cw' : 'ccw';
    appState.axisDirectionHistory.push(direction);
    
    // ... (garde ta logique de changement d'axe et de pas de rotation) ...

    var rot = (choice === 'pos1') ? -appState.axisStep : appState.axisStep;
    target.axe = normalizeAxis(target.axe + rot);

    updateDisplay("Nouvel Axe : " + target.axe + "°");
    nextLetters();
    
    // Relance la séquence : les bulles réapparaîtront via runJccSequence
    setTimeout(function() { runJccSequence(); }, 800);
};
// --- NOUVELLES FONCTIONS DE GESTION DE FLUX (STOP/RESTART) ---
window.restartExam = function() {
    // 1. Hide the modal
    document.getElementById('modalDefogLimit').classList.add('hidden');
    document.getElementById('modalTqsLimit').classList.add('hidden');

    // 2. Reset specific safety flags/counters that might prevent restart
    appState.defoggedInZone = false;
    appState.tqsFogCount = 0;
    // The rest are handled by launchExamSequence, but let's be safe
    appState.sb02_OD_ok = false;
    appState.sb02_OG_ok = false;

    // 3. Relaunch the sequence
    // This function re-reads RA, re-calculates fog, and sets phase to Sb0.2 (for profiles 3)
    window.launchExamSequence();
};

window.prepareCycloStop = function() {
    // Masquer les boutons de choix
    document.getElementById('defogButtons').classList.add('hidden');
    // Afficher le bouton de sauvegarde
    document.getElementById('saveCycloContainer').classList.remove('hidden');
};

window.prepareCycloStopTqs = function() {
    // Masquer les boutons de choix
    document.getElementById('tqsButtons').classList.add('hidden');
    // Afficher le bouton de sauvegarde
    document.getElementById('saveCycloContainerTqs').classList.remove('hidden');
};

window.savePatientData = function() {
    alert("Données sauvegardées pour l'examen sous cycloplégique.");
    location.reload(); 
};
  // --- CORRECTION DU PILOTAGE (A COLLER A LA FIN DU SCRIPT) ---

// 1. Fonction de choix de l'œil (Mise à jour pour le nouveau design)
window.setEye = function(eye) {
    appState.activeEye = eye;
    // On force la mise à jour de l'affichage
    var currentMsg = document.getElementById('systemMsg') ? document.getElementById('systemMsg').innerText : "";
    window.updateDisplay(currentMsg);
};

// 2. Fonction d'affichage principale (Compatible Header Split)
window.updateDisplay = function(message) {
    // A. Mise à jour des colonnes de données (Gauche)
    setHTML('disp_subjOD_sph', appState.subj.OD.sphere.toFixed(2)); setHTML('disp_subjOD_cyl', appState.subj.OD.cyl.toFixed(2));
    setHTML('disp_subjOD_axe', appState.subj.OD.axe + "°"); setHTML('disp_subjOD_va', appState.subj.OD.va);
    setHTML('disp_subjOG_sph', appState.subj.OG.sphere.toFixed(2)); setHTML('disp_subjOG_cyl', appState.subj.OG.cyl.toFixed(2));
    setHTML('disp_subjOG_axe', appState.subj.OG.axe + "°"); setHTML('disp_subjOG_va', appState.subj.OG.va);

    // --- GESTION VISUELLE BIO-MONOCULAIRE & SWÉB ---
    var boxOD = document.getElementById('subjDispOD'); 
    var boxOG = document.getElementById('subjDispOG');
    
    // Détection si on est dans une phase où les deux yeux sont ouverts
    // On vérifie si la phase contient "Check", "Swéb" ou est Sb1.0/Sb0.5
    var isBioMode = (
        appState.examPhase === "Sb0.5" ||
        appState.examPhase === "Sb1.0" || 
        (appState.examPhase && appState.examPhase.includes("Check")) || 
        (appState.examPhase && appState.examPhase.includes("Swéb"))
    );

    if(boxOD && boxOG) {
        // 1. Reset des styles
        boxOD.classList.remove('highlight', 'col-bio-inactive');
        boxOG.classList.remove('highlight', 'col-bio-inactive');

        if(appState.activeEye === 'OD') {
            // Oeil examiné (Actif)
            boxOD.classList.add('highlight'); 
            
            // Oeil opposé (Passif) : Cyan transparent si Bio, sinon Marron par défaut
            if(isBioMode) boxOG.classList.add('col-bio-inactive'); 
        } 
        else {
            // Oeil examiné (Actif)
            boxOG.classList.add('highlight'); 
            
            // Oeil opposé (Passif) : Cyan transparent si Bio, sinon Marron par défaut
            if(isBioMode) boxOD.classList.add('col-bio-inactive');
        }
    }
    // B. Mise à jour EN-TÊTE GAUCHE (Pilotage)

    // --- TRADUCTION DES PHASES ---
    var affichagePhase = "Démarrage"; // 1. Par défaut (INIT)

    if (appState.examPhase) {
        switch(appState.examPhase) {
            case "Sb0.2":            
                affichagePhase = "Recherche de la Sb0.2"; // 2.
                break;

            case "Sb0.5":            
                affichagePhase = "Recherche de la Sb0.5 (T.Q.S.)"; // 3.
                break;

            case "Sb1.0":            
                affichagePhase = "Recherche de la Sb1.0"; // 4.
                break;

            case "SphereCheckPlus":  
                affichagePhase = "Verres vérificateurs"; // 5.
                break;

            case "SphereCheckMinus": 
                affichagePhase = "Verres vérificateurs"; // 6.
                break;

            case "AxisCheck":        
                affichagePhase = "Mise au point de l'axe du cylindre"; // 7.
                break;
            
            case "Vérification de Swéb":
                affichagePhase = "Vérification de Swéb"; // Le texte sera affiché tel quel
                break;
            
            // Vous pourrez ajouter vos futures phases ici (case "NomDeCode": ...)

            default:                 
                // Sécurité : affiche le code interne si pas de traduction trouvée
                affichagePhase = appState.examPhase.toUpperCase();
        }
    }
    
    setHTML('dispPhase', affichagePhase);
    // -----------------------------

    var modeText = "MONOCULAIRE";
    // On vérifie si la phase est Sb0.5, Sb1.0, contient "Check" ou contient "Swéb"
    if (appState.examPhase === "Sb0.5" || 
        appState.examPhase === "Sb1.0" || 
        (appState.examPhase && appState.examPhase.includes("Check")) || 
        (appState.examPhase && appState.examPhase.includes("Swéb"))) { // <--- Ajout Swéb ici
        
        modeText = "BIO-MONOCULAIRE";
    }
    setHTML('dispMode', modeText);

    // --- GESTION DES BOUTONS PILOTAGE (OD/OG) ---
    var btnPilotOD = document.getElementById('btnPilotOD'); 
    var btnPilotOG = document.getElementById('btnPilotOG');

    if (btnPilotOD && btnPilotOG) {
        // On définit le mode occlusion (Gris foncé) UNIQUEMENT en Sb0.2 ou Mono pur
        var isOcclusionMode = (appState.examPhase === "Sb0.2" || appState.isMonocularExam);
        
        // Reset des classes
        btnPilotOD.className = 'btn-pilot'; 
        btnPilotOG.className = 'btn-pilot';

        if (appState.activeEye === 'OD') {
            btnPilotOD.classList.add('active'); // Oeil testé en Bleu
            
            if (isOcclusionMode) {
                btnPilotOG.classList.add('closed'); // Oeil opposé en Gris (fermé)
            } else {
                btnPilotOG.classList.add('open');   // Oeil opposé en Blanc (ouvert/brouillé)
            }
        } else {
            btnPilotOG.classList.add('active'); // Oeil testé en Bleu
            
            if (isOcclusionMode) {
                btnPilotOD.classList.add('closed'); // Oeil opposé en Gris (fermé)
            } else {
                btnPilotOD.classList.add('open');   // Oeil opposé en Blanc (ouvert/brouillé)
            }
        }
    }

    // C. Mise à jour EN-TÊTE DROIT (Visuel VA)
    setHTML('visBoxOD', appState.subj.OD.va); 
    setHTML('visBoxOG', appState.subj.OG.va);
    var visOD = document.getElementById('visBoxOD'); var visOG = document.getElementById('visBoxOG');
    if(visOD && visOG) {
        if (appState.activeEye === 'OD') { visOD.classList.add('active-eye'); visOG.classList.remove('active-eye'); } 
        else { visOD.classList.remove('active-eye'); visOG.classList.add('active-eye'); }
    }

    // D. Messages
    setHTML('valProfile', appState.profile); 
    setHTML('systemMsg', message);
    var sysMsgEl = document.getElementById('systemMsg');
    if(sysMsgEl) {
        if (message.indexOf("VALIDÉE") !== -1 || message.indexOf("Validé") !== -1) sysMsgEl.classList.add('success-msg'); 
        else sysMsgEl.classList.remove('success-msg');
    }

    // E. Génération des boutons de réponse ET FORCE AFFICHAGE
    if(window.ACUITY_TABLE && appState.vaIndex < ACUITY_TABLE.length) {
        var currentData = ACUITY_TABLE[appState.vaIndex]; 
        setHTML('valVA', currentData.va);
        var linesArr = currentData.lines; 
        var txt = linesArr[appState.letterIndex % linesArr.length];
        // NOUVEAU : Appel du moteur d'affichage par blocs
        updateVisualAcuityDisplay(currentData.va, txt);

        var count = txt.split(' ').length; 
        var btnHTML = "";
        for(var i=0; i<=count; i++) { 
            btnHTML += '<button class="btn-resp" onclick="window.handleResponse('+i+')">'+i+'</button> '; 
        }
        setHTML('btnContainer', btnHTML);

        // --- CORRECTION VISIBILITÉ (Le Fix Important) ---
        var isSpecialMode = false;
        var cadBtns = document.getElementById('cadenceButtons');
        var chkPlus = document.getElementById('checkPlusZone');
        var axisCtr = document.getElementById('axisControls');

        if (cadBtns && !cadBtns.classList.contains('hidden')) isSpecialMode = true;
        if (chkPlus && !chkPlus.classList.contains('hidden')) isSpecialMode = true;
        if (axisCtr && !axisCtr.classList.contains('hidden')) isSpecialMode = true;

        var stdBtns = document.getElementById('standardButtons');
        if (stdBtns) {
            if (!isSpecialMode) {
                stdBtns.classList.remove('hidden');
            } else {
                stdBtns.classList.add('hidden');
            }
        }
    }
};

// =========================================================
// === NOUVEAU MOTEUR D'AFFICHAGE (CORRIGÉ & INTÉGRÉ) ===
// =========================================================

// Définition des groupes
const VAGroups = [
    { values: [0.06], layout: 'center' },
    { values: [0.08], layout: 'center' },
    { values: [0.10], layout: 'center' },
    { values: [0.12, 0.16], layout: 'space-between' },
    { values: [0.20, 0.25], layout: 'space-between' },
    { values: [0.32, 0.40, 0.50], layout: 'space-between' },
    { values: [0.60, 0.80, 1.00], layout: 'space-between' },
    { values: [1.25, 1.60, 2.00], layout: 'space-between' }
];

// Fonction principale attachée à window pour être accessible partout
// Fonction principale attachée à window pour être accessible partout
window.updateVisualAcuityDisplay = function(selectedValue, activeLetters) {
    const zone = document.getElementById('letterBox');
    
    // Configuration du conteneur (Centrage et Ecartement)
    zone.style.display = 'flex';
    zone.style.flexDirection = 'column';
    zone.style.height = '100%';
    zone.style.width = '100%';
    zone.style.justifyContent = 'center'; 
    zone.style.alignItems = 'center';     
    zone.style.gap = '15px';              
    
    zone.innerHTML = ''; 
    
    const valFloat = parseFloat(selectedValue);
    const group = VAGroups.find(g => g.values.includes(valFloat));
    
    // Sécurité fallback
    if (!group) {
        zone.innerHTML = `<div class="va-line-row line-selected"><span class="optotype-text">${activeLetters}</span></div>`;
        return;
    }

    group.values.forEach(va => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'va-line-row';
        
        const letterSpan = document.createElement('span');
        letterSpan.className = 'optotype-text';
        
        if (va === valFloat) {
            // --- CAS 1 : LIGNE ACTIVE ---
            rowDiv.classList.add('line-selected');
            letterSpan.innerText = activeLetters; 
            letterSpan.style.opacity = "1";
            
            // >>> C'EST ICI LE NOUVEAU CODE (L'ÉTIQUETTE) <<<
            const tag = document.createElement('div');
            tag.className = 'va-tag-value'; // Utilise le style CSS ajouté précédemment
            // --- MODIFICATION : FORCER LE "1.0" ---
            // Si le chiffre est un entier (comme 1), on rajoute ".0"
            if (Number.isInteger(va)) {
                tag.innerText = va + ".0";
            } else {
                tag.innerText = va;
            }
            // --------------------------------------

          // Affiche la valeur (ex: 0.4)
            rowDiv.appendChild(tag);        // Ajoute l'étiquette dans la ligne
            // >>> FIN DU NOUVEAU CODE <<<
            
        } else {
            // --- CAS 2 : LIGNE INACTIVE ---
            letterSpan.innerText = window.getRealLettersFromTable(va); 
            letterSpan.style.opacity = "0.4"; 
        }
        
        // On ajoute d'abord les lettres (qui seront centrées par le CSS)
        rowDiv.appendChild(letterSpan);
        
        // On ajoute la ligne à la zone
        zone.appendChild(rowDiv);
    });
};
// Fonction qui va chercher les lettres exactes dans votre base de données
window.getRealLettersFromTable = function(targetVA) {
    if (typeof ACUITY_TABLE === 'undefined') return "---";
    
    const entry = ACUITY_TABLE.find(line => line.va === targetVA);
    
    if (entry && entry.lines) {
        // Utilise l'index global pour synchroniser les lignes
        const idx = (typeof appState !== 'undefined') ? appState.letterIndex : 0;
        const lineText = entry.lines[idx % entry.lines.length];
        return lineText;
    }
    return "---";
};

// --- FONCTION BOUTON ALÉATOIRE (CORRIGÉE) ---
// --- FONCTION BOUTON ALÉATOIRE (VERSION FINALE AVEC VOIX) ---
window.forceChangeLetters = function() {
    // 1. Sécurité
    if (!appState || !appState.isRunning) return;

    // 2. Logique : changement de lettre et mise à jour affichage
    appState.letterIndex++;
    window.updateDisplay("Lettres changées manuellement");
    
    // 3. Animation du clic
    var btn = document.getElementById('btnRandomLetters');
    if(btn) {
        btn.style.transform = "scale(0.9)";
        setTimeout(function(){ 
            btn.style.transform = ""; // Reset pour le CSS :hover
        }, 150);
    }

    // 4. COMMANDE VOCALE AJOUTÉE ICI
    say("ou plutôt celles-ci.");
};
// --- GESTION AFFICHAGE CERCLE BLEU (BASE) ---
window.showBaseCircle = function() {
    var base = document.getElementById('animBaseCircle');
    if(base) base.classList.add('visible');
};

window.hideBaseCircle = function() {
    var base = document.getElementById('animBaseCircle');
    if(base) base.classList.remove('visible');
    
    // Nettoyage animation PLUS (Gauche)
    var arrow = document.getElementById('animArrowLine');
    var target = document.getElementById('animTargetCircle');
    if(arrow) arrow.classList.remove('active');
    if(target) target.classList.remove('visible');

    // Nettoyage animation MOINS (Droite - NOUVEAU)
    var arrowM = document.getElementById('animArrowLineMinus');
    var targetM = document.getElementById('animTargetCircleMinus');
    if(arrowM) arrowM.classList.remove('active');
    if(targetM) targetM.classList.remove('visible');
};
  
</script>

  
  
</body>
</html>
