<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Assistant R√©fraction - Dashboard Final</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

<style>
  /* --- CHARTE GRAPHIQUE --- */
  :root { 
      --bg-main: #FCF9F2;       
      --primary: #04ABC6;            
      --primary-dark: #03889E;    
      --primary-deep: #026070;    
      --primary-light: #E0F6F8;   
      --primary-border: #8CD6E2;
      --panel: #FFFFFF;            
      --text-main: #37474F;        
      --text-muted: #78909C;        
      --border: #CFD8DC;
  }

  /* RESET & BASE */
  * { box-sizing: border-box; }
  body { 
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
      background-color: var(--bg-main); 
      color: var(--text-main); 
      margin: 0; padding: 0;
      height: 100vh; 
      overflow: hidden; 
      font-size: 13px;
  }

  /* LAYOUT PRINCIPAL */
  /* --- LAYOUT 1-C (BANDEAU + EXAMEN) --- */
  .app-container { display: flex; flex-direction: column; height: 100vh; max-width: 100%; margin: 0; padding: 0; }
  header { display: none; } /* On cache l'ancien titre bleu */

  .dashboard-wrapper {
      display: flex;
      flex-direction: column;
      flex: 1; 
      gap: 0;
      overflow: hidden; 
      height: 100%;
      background: #FAFAFA;
  }

  /* 1. Bandeau Sup√©rieur : Patient + Chrono */
  .top-banner {
      flex: 0 0 50px; /* Hauteur fine fixe */
      background: #FFFFFF;
      border-bottom: 1px solid #CFD8DC;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      z-index: 20;
  }

  /* Style ligne patient */
  .patient-line { display: flex; align-items: center; gap: 30px; font-size: 1rem; color: var(--text-main); width: 100%; }
  .pat-name { font-weight: 700; color: var(--primary-deep); text-transform: uppercase; font-size: 1.1rem; }
  .pat-forename { font-weight: 500; font-size: 1.1rem; }
  .pat-uid { font-family: monospace; background: #ECEFF1; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem; color: #546E7A; }
  .pat-profile-badge { padding: 3px 10px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

  /* 2. Zone Examen */

  /* --- NOUVEAU LAYOUT "FLAT" (UNIFORME CR√àME & SANS BORDURES) --- */

  /* 1. Conteneur Principal */
  .right-panel {
      flex: 1; 
      width: 100%;
      background: #FCF9F2; /* FOND UNIQUE */
      display: flex;
      flex-direction: column; 
      overflow: hidden; 
      padding: 0;
  }

  /* 2. En-t√™te Divis√© */
  .exam-header-wrapper {
      display: flex;
      width: 100%;
      height: 80px;
      background: #FCF9F2; /* M√äME FOND */
      border: none; /* PLUS DE BORDURE */
      flex: 0 0 auto;
  }

  /* Partie GAUCHE (Pilotage) */
  .header-left-control {
      flex: 0 0 920px; 
      display: flex; flex-direction: column; justify-content: center;
      padding: 0 15px; 
      border: none; /* PLUS DE BORDURE */
      background: #FCF9F2; 
  }
  .phase-badge { font-size: 0.8rem; font-weight: 800; color: #546E7A; text-transform: uppercase; text-align: center; margin-bottom: 5px; }
  .control-row { display: flex; justify-content: center; gap: 15px; align-items: center; }

  /* Partie DROITE (Visuel) */
  .header-right-visual {
      flex: 1; 
      display: flex; align-items: center; justify-content: center; gap: 20px;
      background: #FCF9F2; 
  }

  /* 3. Zone de Travail (Split) */
  .work-split {
      display: flex;
      flex: 1;
      overflow: hidden;
      width: 100%;
      background: #FCF9F2; /* FOND UNIQUE PARTOUT */
  }

  /* Colonne GAUCHE (Donn√©es) */
  .side-data {
      flex: 0 0 920px; 
      background: #FCF9F2; 
      border: none; /* PLUS DE BORDURE */
      padding: 15px; 
      overflow-x: auto;
      display: flex; align-items: flex-start; justify-content: center;
  }

  /* Colonne DROITE (Lettres) */
  .side-letters {
      flex: 1; 
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: #FCF9F2; 
      position: relative;
  }

  /* 4. Barre du Bas */
  .bottom-interaction-zone {
      flex: 0 0 auto; width: 100%; min-height: 110px;
      background: #FCF9F2; 
      border: none; 
      display: flex; justify-content: center; align-items: center;
      padding: 10px; z-index: 20;
  }

  /* --- STYLES √âL√âMENTS SP√âCIFIQUES --- */
  
  /* Boutons Pilotage */
  .btn-pilot {
      width: 60px; height: 38px; border-radius: 6px; font-weight: bold; cursor: pointer; border: 2px solid transparent; font-size: 1rem;
  }
  .btn-pilot.open { background: #FFF; border-color: transparent; color: #78909C; box-shadow: 0 2px 5px rgba(0,0,0,0.05); } 
  .btn-pilot.closed { background: #5D4037; border-color: #5D4037; color: #D7CCC8; opacity: 0.6; }
  .btn-pilot.active { background: var(--primary); color: white; border-color: var(--primary-dark); opacity: 1; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }

  .btn-mode-display {
      padding: 5px 15px; background: #EFEBE9; color: #5D4037;
      font-size: 0.85rem; font-weight: 700; border-radius: 12px; border: none; 
      text-transform: uppercase; min-width: 140px; text-align: center;
  }

  /* Indicateurs Visuels VA */
  .va-box-display {
      width: 80px; height: 50px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem; font-weight: bold; font-family: 'Montserrat', sans-serif;
      background: #FFF; 
      color: #BCAAA4; border: none; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .va-box-display.active-eye {
      background: #E0F7FA; color: var(--primary-dark); border: 2px solid var(--primary);
  }

  /* --- COLONNES DE DONN√âES (Cartes Flottantes) --- */
  .exam-data-strip { display: flex; gap: 15px; width: 100%; justify-content: center; }

  .data-col { 
      display: flex; flex-direction: column; 
      width: 135px;
      background: #FFFFFF; /* On garde le blanc pour les donn√©es */
      border: none; 
      border-radius: 12px; 
      padding: 10px; 
      text-align: center; 
      box-shadow: 0 4px 15px rgba(93, 64, 55, 0.08); /* Ombre douce pour effet "Carte" */
  }
  
  .col-active { 
      width: 175px; 
      border: 2px solid var(--primary); z-index: 5; transform: scale(1.02); 
      box-shadow: 0 8px 20px rgba(4, 171, 198, 0.15);
  }

  .col-title { font-size: 0.8rem; font-weight: 800; color: #8D6E63; text-transform: uppercase; margin-bottom: 8px; border-bottom: 1px solid #F5F5F5; padding-bottom: 4px; }
  .title-ra { color: var(--primary); } 
  .title-subj { color: var(--primary-dark); font-size: 1rem; }
  
  .data-line { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 1rem; align-items: center; }
  .lbl { font-weight: bold; color: #BCAAA4; font-size: 0.8rem; }
  
  /* VALEURS */
  .val-input { 
      width: 100%; text-align: center; background: transparent; border: none; 
      font-weight: 700; color: #5D4037; font-family: 'Montserrat', sans-serif; 
      font-size: 1.2rem;
  }
  
  .val-big { font-size: 1.8rem; font-weight: 800; color: #3E2723; }

  /* --- LETTRES --- */
  .letter-display { 
      font-family: 'Segoe UI', sans-serif; 
      font-size: 3rem; 
      font-weight: bold; color: #3E2723; 
      letter-spacing: 8px; 
  }
  
  .info-bar { font-size: 1.1rem; color: #8D6E63; margin-bottom: 15px; }

  /* STYLE DES PANNEAUX */
  .section { 
      background: var(--panel); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 10px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  h2 { 
      margin-top: 0; margin-bottom: 8px; 
      color: var(--primary-dark); 
      font-size: 1rem; 
      border-bottom: 1px solid var(--primary-border); 
      padding-bottom: 2px; 
  }

  .hidden { display: none !important; }

  /* INPUTS & RESUME */
  .summary-grid { display: grid; grid-template-columns: 1fr; gap: 5px; font-size: 0.95rem; }
  .summary-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 4px 0; }
  .summary-lbl { color: var(--text-muted); font-weight: 600; }
  .summary-val { color: var(--primary-dark); font-weight: bold; }

  .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

  /* Grille compacte pour la section 2 */
  .mini-data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3px; text-align: center; }

  label { display: block; font-weight: 600; margin-bottom: 1px; font-size: 0.75rem; color: var(--text-muted); }
  input, select { 
      width: 100%; padding: 4px; 
      border: 1px solid #ccc; border-radius: 4px; 
      font-size: 0.9rem; background: #fff;
  }
  input:disabled, select:disabled { background-color: #F5F5F5; color: #888; border-color: #E0E0E0; }

  /* CHECKBOX ALIGNMENT */
  .check-grid { display:grid; grid-template-columns: 1fr 1fr; gap:5px; text-align: left; }
  .check-lbl { 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      font-weight: normal; 
      color: var(--text-main); 
      font-size: 0.9rem;
      cursor: pointer;
      padding: 5px;
      border: 1px solid #eee;
      border-radius: 4px;
  }
  .check-lbl:hover { background: #f9f9f9; }
  .check-lbl input { width: auto; margin: 0; cursor: pointer; }

  /* --- COULEURS PERSONNALIS√âES DES DONN√âES --- */

  /* 1. Autor√©fractom√®tre (RA) */
  input[id^="ra"] {
      color: var(--primary);              /* Texte : Primary (Cyan) */
      background-color: var(--primary-light); /* Fond : Primary Light (Cyan tr√®s p√¢le) */
      font-family: 'Montserrat', sans-serif;  /* Police moderne */
      font-weight: 700;
      border: 1px solid var(--primary-border);
  }

  /* 2. Frontofocom√®tre */
  input[id^="fronto"] {
      color: var(--primary-border);       /* Texte : Plus clair que primary */
      background-color: #ffffff;          /* Fond : Blanc (Plus clair que primary-light) */
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
  }
    /* GRILLE VALEURS */
  .col-head { background: #ECEFF1; font-weight: bold; font-size: 0.7rem; padding: 4px 0; border-radius: 3px; }
  .col-input { padding: 3px; text-align: center; font-weight: 600; }
  .val-box { 
      background: var(--primary-light); color: var(--primary-dark);
      border: 1px solid var(--primary-border);
      font-weight: bold; font-size: 0.95rem; 
      display: flex; align-items: center; justify-content: center; 
      border-radius: 4px; min-height: 24px;
  }
  .col-max-va { background: #E8F5E9; color: #2E7D32; font-size: 0.8rem; border-color: #C8E6C9; }

  /* TITRES BLOCS DONNEES */
  .data-block-title {
      font-size: 0.75rem; font-weight:bold; color:var(--primary); text-align:center; 
      margin-bottom:3px; text-transform:uppercase; border-bottom:1px solid var(--primary-light);
  }

  
 

  /* MESSAGE BOX (CACH√âE) */
  .message-box { display: none !important; }
  .success-msg { background: #E0F2F1; color: #00695C; border-color: #B2DFDB; }

  /* BOUTONS REPONSE */
  .response-area { width: 100%; text-align: center; }

  .btn-grid { 
      display: flex; 
      justify-content: center; 
      gap: 40px; 
      flex-wrap: wrap; 
  }

  .btn-resp { 
      width: 80px; height: 80px;
      border-radius: 50%; border: none; 
      background: var(--primary-light); color: var(--primary-dark); 
      font-size: 2rem; 
      font-weight: bold; 
      cursor: pointer; transition: 0.2s; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  .btn-resp:hover { background: var(--primary); color: white; transform: scale(1.15); }

  .btn-resp.locked, .btn-action.locked, .btn-timer.locked, .btn-decision.locked {
      opacity: 0.5; cursor: wait; pointer-events: none;
  }

  /* ACTION BUTTONS */
  .btn-action { 
      padding: 15px 25px; border-radius: 8px; border: none; 
      color: white; font-weight: bold; cursor: pointer; 
      font-size: 1.1rem; margin-top: 10px; width: 100%;
      box-shadow: 0 3px 5px rgba(0,0,0,0.1);
      transition: background 0.2s;
  }

  .btn-start, .btn-validate, .btn-manual, .btn-rules { background: var(--primary); }
  .btn-start:hover, .btn-validate:hover { background: var(--primary-dark); }
  .btn-import { background: var(--primary-dark); }
  .btn-import:hover { background: var(--primary-deep); }

  .btn-tortue, .btn-lapin { 
      background: var(--primary-light); color: var(--primary-dark); border: 2px solid var(--primary-border); 
      font-size: 1.3rem; padding: 15px 40px; 
  }
  .btn-tortue:hover, .btn-lapin:hover { background: var(--primary); color: white; }

  /* PROFIL */
  .force-profile-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 15px; }
  .btn-profile { padding: 8px; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .p-green { background: #26A69A; } .p-blue { background: #42A5F5; }
  .p-orange { background: #FFA726; } .p-red { background: #EF5350; }

  /* BOUTONS EXAMEN */
  .btn-timer { 
      background: var(--primary); color: white; padding: 15px 35px; font-size: 1.2rem; 
      border-radius: 40px; border:none; cursor: pointer; margin-bottom: 15px;
  }
  .btn-timer:hover { background: var(--primary-dark); }
  .decision-row { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
  .btn-decision { padding: 12px 25px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
  .btn-blue { background: var(--primary); } 
  .btn-orange { background: var(--primary-dark); } 
  .btn-red { background: var(--primary-deep); } 
  .btn-green { background: var(--primary); } 
  .btn-grey { background: var(--primary-light); color: var(--primary-dark); border: 1px solid var(--primary-border); }
  .btn-grey:hover { background: var(--primary-border); }

  /* RESPONSIVE */
  @media (max-width: 900px) {
      body { overflow: auto; height: auto; } 
      .app-container { height: auto; display: block; }
      .dashboard-wrapper { display: block; } 
      .left-panel { width: 100%; margin-bottom: 15px; }
      .right-panel { min-height: 400px; }
  }

  /* MODAL */
  .modal-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(55, 71, 79, 0.9); z-index: 9999; 
      display: flex; justify-content: center; align-items: center; 
  }
  .modal-content { background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; text-align: center; }
  .modal-text { font-size: 1.2rem; line-height: 1.5; margin-bottom: 25px; color: var(--text-main); }

  /* Visual JCC */
  .jcc-container { display: flex; justify-content: center; gap: 50px; margin-bottom: 30px; }
  .jcc-visual { width: 100px; height: 100px; border-radius: 50%; border: 6px solid #CFD8DC; display: flex; align-items: center; justify-content: center; opacity: 0.3; }
  .jcc-visual.active { opacity: 1; border-color: var(--primary); transform: scale(1.1); box-shadow: 0 0 20px var(--primary-border); }
  .jcc-label { position: absolute; font-weight: bold; font-size: 1.8rem; color: var(--text-main); }
  .arrow-svg { width: 70px; height: 70px; }

  /* INPUTS MODAL */
  .modal-input-grid {
      display: flex;
      flex-direction: column; 
      gap: 10px;
      text-align: left;
      margin-bottom: 20px;
  }
  .modal-input-group label {
      display: block;
      margin-bottom: 3px;
      color: var(--text-muted);
      font-size: 0.85rem;
  }
  .modal-input-group input {
      font-size: 1.1rem;
      padding: 6px;
      text-align: center;
      border: 1px solid var(--primary-border);
      width: 100%;
  }
  .modal-eye-title {
      text-align: center;
      font-weight: bold;
      color: var(--primary-dark);
      margin-bottom: 10px;
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 5px;
      font-size: 1.1rem;
  }
  .device-header {
      font-weight: 700; color: var(--primary); margin-bottom: 15px; text-transform: uppercase; font-size: 1.1rem; text-align: center;
  }
  .data-source-lbl {
      font-weight: 600; color: var(--primary-dark); margin-bottom: 5px; margin-top: 15px; display: block;
  }

  /* --- STYLE TEST DE SCHOBER --- */
  .schober-container { display: flex; flex-direction: column; gap: 15px; width: 100%; align-items: center; border: 1px solid #ECEFF1; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
  .schober-group-title { font-weight: bold; font-size: 1rem; color: var(--primary-deep); text-transform: uppercase; margin-bottom: 15px; border-bottom: 2px solid var(--primary-light); display: inline-block; padding-bottom: 5px; }

  /* Nouveaux styles pour les sous-cat√©gories */
  .schober-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; }
  .schober-sub-group { display: flex; flex-direction: column; align-items: center; background: #FAFAFA; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
  .schober-sub-title { font-size: 0.8rem; font-weight: 700; color: #00838F; margin-bottom: 10px; text-align: center; max-width: 140px; min-height: 30px; display:flex; align-items:center; justify-content:center; }

  .schober-grid { display: flex; justify-content: center; gap: 10px; }

  .btn-schober { width: 90px; height: 90px; background-color: #000000; border: 3px solid #455A64; border-radius: 12px; cursor: pointer; position: relative; display: flex; justify-content: center; align-items: center; transition: transform 0.2s, border-color 0.2s; }
  .btn-schober:hover { transform: scale(1.05); border-color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

  /* SVG Styles */
  .sch-cross { stroke: #FF0000; stroke-width: 4; }
  .sch-circle { stroke: #00FF00; stroke-width: 4; fill: none; }
  .sch-faint { opacity: 0.3; stroke-dasharray: 4; }

  .step-instruction { font-size: 1.2rem; color: var(--text-main); margin-bottom: 25px; text-align: center; background: #E1F5FE; padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); }

</style>
</head>
<body onload="window.startAppSequence()">

<div id="modalPatientID" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Identification du Patient</h2>
        <div class="config-grid" style="text-align:left; margin: 20px 0;">
            <div><label>Nom</label><input type="text" id="inName"></div>
            <div><label>Pr√©nom</label><input type="text" id="inForename"></div>
            <div><label>Date Naiss.</label><input type="date" id="inDob"></div>
            <div><label>UID</label><input type="text" id="inUID" readonly style="background:#ECEFF1; color:var(--primary-dark); font-weight:bold; cursor:not-allowed;"></div>
        </div>
        <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; font-size:1.1rem; border-radius:50px;" onclick="window.validatePatientID()">VALIDER</button>
    </div>
</div>

<div id="modalProfileCalc" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 700px;">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Profil Accommodatif</h2>

        <div class="config-grid" style="text-align:left; margin-bottom:15px;">
            <div>
                <label>Rythme des consultations par ann√©e</label>
                <select id="inRhythm"><option value="0">...</option><option value="1">1x/an</option><option value="2">1x/2ans</option><option value="3">< 1x/2ans</option></select>
            </div>
            <div>
                <label>Signes de troubles subjectifs par mois</label>
                <select id="inSigns"><option value="0">0</option><option value="2">3-4</option><option value="3">> 4</option></select>
            </div>
        </div>

        <div class="check-grid" style="margin-bottom:20px;">
            <label class="check-lbl"><input type="checkbox" id="chkMyopia" onchange="window.toggleMyopiaHyper('myopia')"> Myopie > 3 dioptries</label>
            <label class="check-lbl"><input type="checkbox" id="chkHyper" onchange="window.toggleMyopiaHyper('hyper')"> Hyperm√©tropie < 1 dioptrie</label>
            <label class="check-lbl"><input type="checkbox" id="chkNear"> Habitudes de pr√®s</label>
            <label class="check-lbl"><input type="checkbox" id="chkNoSpecs"> Lunettes Mal ou non port√©es</label>
            <label class="check-lbl"><input type="checkbox" id="chkMono"> Monophtalme</label>
        </div>

        <button class="btn-action btn-start" style="padding:15px; font-size:1.1rem;" onclick="window.calculateProfileAndShowData()">CALCUL DU PROFIL ACCOMMODATIF</button>

        <div style="text-align:center; margin:15px 0 5px 0; color:var(--text-muted); font-size:0.9rem;">Ou forcer le profil :</div>
        <div class="force-profile-row">
            <button id="btnProfile1" class="btn-profile p-green" onclick="window.forceProfileAndShowData('1')">Bon (1)</button>
            <button class="btn-profile p-blue" onclick="window.forceProfileAndShowData('2')">Moyen</button>
            <button class="btn-profile p-orange" onclick="window.forceProfileAndShowData('3')">Difficile</button>
            <button class="btn-profile p-red" onclick="window.forceProfileAndShowData('3+')">Tr√®s Diff.</button>
        </div>
    </div>
</div>

<div id="modalEntryMethod" class="modal-overlay hidden">
    <div class="modal-content" style="max-width:500px;">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Saisie des Donn√©es</h2>
        <div class="modal-text">S√©lectionnez l'appareil √† renseigner :</div>
        
        <div style="display:flex; flex-direction:column; gap:15px;">
            <button class="btn-action btn-manual" style="background:#FFF; color:var(--primary-dark); border:2px solid var(--primary-border);" onclick="window.openModal('AutoRef')">
                <strong>AUTO-R√âFRACTOM√àTRE (RA)</strong><br>
                <span style="font-size:0.8rem;">Saisie Sph√®re / Cyl / Axe</span>
            </button>
            
            <button class="btn-action btn-manual" style="background:#FFF; color:#546E7A; border:2px solid #CFD8DC;" onclick="window.openModal('Fronto')">
                <strong>FRONTOFOCOM√àTRE</strong><br>
                <span style="font-size:0.8rem;">Lunettes port√©es</span>
            </button>

            <div style="height:1px; background:#eee; margin:10px 0;"></div>

            <button class="btn-action btn-import" onclick="window.simulateImport()">
                Importer depuis les appareils (Simul.)
            </button>
            
            <button class="btn-action btn-validate" style="margin-top:10px;" onclick="window.finishDataEntry()">
                TERMINER LA SAISIE
            </button>
        </div>
    </div>
</div>
<div id="modalInputAutoRef" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 600px;">
        <h2 style="color:var(--primary); border:none;">Auto-R√©fractom√®tre (RA)</h2>
        
        <div style="display:flex; gap:20px; margin-bottom:20px;">
            <div style="flex:1;">
                <div class="modal-eye-title">≈íIL DROIT</div>
                <div class="modal-input-grid">
                    <div class="modal-input-group"><label>Sph√®re</label><input type="text" id="mod_raOD_sph" placeholder="+/- 0.00" inputmode="decimal" onchange="window.checkSphere(this)"></div>
                    <div class="modal-input-group"><label>Cylindre</label><input type="text" id="mod_raOD_cyl" placeholder="- 0.00" inputmode="decimal" onchange="window.checkCylInput(this)"></div>
                    <div class="modal-input-group"><label>Axe</label><input type="text" id="mod_raOD_axe" placeholder="0¬∞" inputmode="decimal" onchange="window.checkAxis(this)"></div>
                </div>
            </div>
            <div style="flex:1;">
                <div class="modal-eye-title">≈íIL GAUCHE</div>
                <div class="modal-input-grid">
                    <div class="modal-input-group"><label>Sph√®re</label><input type="text" id="mod_raOG_sph" placeholder="+/- 0.00" inputmode="decimal" onchange="window.checkSphere(this)"></div>
                    <div class="modal-input-group"><label>Cylindre</label><input type="text" id="mod_raOG_cyl" placeholder="- 0.00" inputmode="decimal" onchange="window.checkCylInput(this)"></div>
                    <div class="modal-input-group"><label>Axe</label><input type="text" id="mod_raOG_axe" placeholder="0¬∞" inputmode="decimal" onchange="window.checkAxis(this)"></div>
                </div>
            </div>
        </div>

        <button class="btn-action btn-validate" onclick="window.saveAndCloseModal('AutoRef')">VALIDER RA</button>
    </div>
</div>

<div id="modalInputFronto" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 600px;">
        <h2 style="color:#546E7A; border:none;">Frontofocom√®tre</h2>
        
        <div style="display:flex; gap:20px; margin-bottom:20px;">
            <div style="flex:1;">
                <div class="modal-eye-title" style="color:#546E7A; border-color:#CFD8DC;">≈íIL DROIT</div>
                <div class="modal-input-grid">
                    <div class="modal-input-group"><label>Sph√®re</label><input type="text" id="mod_frontoOD_sph" placeholder="+/- 0.00" inputmode="decimal" onchange="window.checkSphere(this)"></div>
                    <div class="modal-input-group"><label>Cylindre</label><input type="text" id="mod_frontoOD_cyl" placeholder="- 0.00" inputmode="decimal" onchange="window.checkCylInput(this)"></div>
                    <div class="modal-input-group"><label>Axe</label><input type="text" id="mod_frontoOD_axe" placeholder="0¬∞" inputmode="decimal" onchange="window.checkAxis(this)"></div>
                </div>
            </div>
            <div style="flex:1;">
                <div class="modal-eye-title" style="color:#546E7A; border-color:#CFD8DC;">≈íIL GAUCHE</div>
                <div class="modal-input-grid">
                    <div class="modal-input-group"><label>Sph√®re</label><input type="text" id="mod_frontoOG_sph" placeholder="+/- 0.00" inputmode="decimal" onchange="window.checkSphere(this)"></div>
                    <div class="modal-input-group"><label>Cylindre</label><input type="text" id="mod_frontoOG_cyl" placeholder="- 0.00" inputmode="decimal" onchange="window.checkCylInput(this)"></div>
                    <div class="modal-input-group"><label>Axe</label><input type="text" id="mod_frontoOG_axe" placeholder="0¬∞" inputmode="decimal" onchange="window.checkAxis(this)"></div>
                </div>
            </div>
        </div>

        <button class="btn-action btn-validate" style="background:#546E7A;" onclick="window.saveAndCloseModal('Fronto')">VALIDER FRONTO</button>
    </div>
</div>

<div id="modalHandedness" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Lat√©ralit√©</h2>
        <div class="modal-text">Le patient est-il droitier ou gaucher ?</div>
        <div style="display:flex; gap:20px; justify-content:center;">
            <button class="btn-action btn-validate" style="width:auto; padding:15px 30px;" onclick="window.setHandedness('OD')">DROITIER</button>
            <button class="btn-action btn-validate" style="width:auto; padding:15px 30px;" onclick="window.setHandedness('OG')">GAUCHER</button>
        </div>
    </div>
</div>

<div id="modalSchoberConfirm" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Confirmation Schober</h2>
        <div id="schoberConfirmText" class="modal-text" style="font-weight:500; color:#37474F; margin-bottom:25px;"></div>
        <div style="display:flex; gap:20px; justify-content:center;">
            <button class="btn-action btn-grey" style="width:auto; padding:15px 30px;" onclick="window.cancelSchober()">ANNULER</button>
            <button class="btn-action btn-validate" style="width:auto; padding:15px 30px;" onclick="window.validateSchober()">VALIDER</button>
        </div>
    </div>
</div>

<div id="modalPosition" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Installation</h2>
        <div class="modal-text">
            Placez le patient derri√®re la t√™te du r√©fracteur en veillant √† ce qu‚Äôil soit confortablement install√© : son front doit √™tre bien appos√© contre l‚Äôappui-front, et ses yeux parfaitement centr√©s dans les oculaires.
            <br><br>
            Assurez-vous √©galement que ses joues ne soient pas en contact avec l‚Äôappareil ‚Äî il doit √™tre possible de glisser un doigt entre ses joues et le r√©fracteur.
        </div>
        <button class="btn-action btn-rules" style="width:auto; padding:15px 40px; font-size:1.1rem; border-radius:50px;" onclick="window.startRulesAndIntro()">R√àGLES DE LECTURE</button>
    </div>
</div>

<div id="modalIntroConfirmation" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); border:none; font-size:1.6rem;">Pr√™t √† commencer ?</h2>
        <div class="modal-text">
            Assurez-vous que le patient a bien compris les r√®gles de lecture que vous venez de lui expliquer.
            <br><br>
            Si c'est le cas, vous pouvez commencer l'examen.
        </div>
        <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; border-radius:50px; font-size:1.1rem;" onclick="window.confirmAndLaunch()">LANCER L'EXAMEN</button>
    </div>
</div>

<div id="modalWarning" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary-deep); border:none; font-size:1.6rem;">Hors Limites</h2>
        <div class="modal-text">La valeur saisie est hors des limites de l‚Äôappareil. Merci de la corriger.</div>
        <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; border-radius:50px;" onclick="window.closeWarningModal()">CORRIGER</button>
    </div>
</div>

  <div id="modalCylTranspose" class="modal-overlay hidden">
    <div class="modal-content" style="border-top: 5px solid #FFA726; max-width: 500px;">
        <h2 style="color:#EF6C00; border:none; font-size:1.4rem; margin-top:0;">Cylindre Positif D√©tect√©</h2>
        <div class="modal-text" style="text-align:left; font-size:1rem; color:#333;">
            Vous avez saisi une valeur positive : <strong><span id="txtPosCylVal" style="color:#D84315;"></span></strong>.<br><br>
            Ce logiciel fonctionne exclusivement en <strong>cylindre n√©gatif</strong>.<br>
            Que souhaitez-vous faire ?
        </div>
        <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button class="btn-action btn-validate" style="background:#0277BD; border-radius:6px; padding:12px;" onclick="window.applyTransposition()">
                <strong>TRANSPOSER LA FORMULE</strong><br>
                <span style="font-size:0.8rem; opacity:0.9;">(Recalcule Sph√®re et Axe math√©matiquement)</span>
            </button>
            <button class="btn-action btn-grey" style="border-radius:6px; padding:12px;" onclick="window.invertCylSign()">
                <strong>JUSTE INVERSER LE SIGNE (+ vers -)</strong><br>
                <span style="font-size:0.8rem; color:#666;">(Si c'est une erreur de frappe)</span>
            </button>
            <button class="btn-action btn-grey" style="background:#fff; border:1px solid #ccc; color:#555; border-radius:6px; padding:10px;" onclick="window.cancelCorrection()">
    Annuler / Corriger manuellement
</button>
        </div>
    </div>
</div>
<div id="modalAskAxis" class="modal-overlay hidden">
    <div class="modal-content" style="border-top: 5px solid #FFA726; max-width: 450px;">
        <h2 style="color:#EF6C00; border:none; font-size:1.4rem;">Axe Manquant</h2>
        
        <div class="modal-text" style="text-align:left;">
            Pour transposer math√©matiquement le cylindre positif, il faut conna√Ætre son axe d'origine.<br><br>
            <span style="color:#D84315; font-weight:bold;">üëâ Entrez l'axe du cylindre POSITIF :</span>
        </div>

        <div style="margin: 20px 0;">
            <input type="number" id="inputTranspAxis" placeholder="Ex: 90" 
                   style="font-size:1.5rem; padding:10px; width:150px; text-align:center; border:2px solid #FFA726; border-radius:8px; font-weight:bold;">
            <div style="font-size:0.8rem; color:#888; margin-top:5px;">(Entre 0 et 180¬∞)</div>
        </div>

        <div style="display:flex; gap:15px; justify-content:center;">
            <button class="btn-action btn-grey" style="width:auto;" onclick="window.closeAskAxisModal()">Annuler</button>
            <button class="btn-action btn-validate" style="width:auto; background:#EF6C00;" onclick="window.validateTranspositionAxis()">VALIDER</button>
        </div>
    </div>
</div>
  <div id="modalDefogLimit" class="modal-overlay hidden">
    <div class="modal-content" style="max-width:700px;">
        <h2 style="color:#D32F2F; border:none; font-size:1.6rem;">‚ö†Ô∏è Votre attention, s'il vous pla√Æt !</h2>
        <div class="modal-text" style="text-align:left; font-size:1rem;">
            <strong>Absence d'am√©lioration de l'acuit√© visuelle apr√®s plusieurs d√©brouillages.</strong><br><br>
            Vous avez effectu√© plusieurs √©tapes de d√©brouillage sans gain significatif d'acuit√© visuelle.<br><br>
            Rappel : R√©p√©tez vos directives au patient, v√©rifiez sa position, nettoyez les lentilles et confirmez les donn√©es de l'AR.<br><br>
            Nous vous recommandons de recommencer l'examen selon l'une des options suivantes :
        </div>
        <div id="defogButtons" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button class="btn-action btn-grey" style="white-space:normal; height:auto; padding:10px; text-align:left;" onclick="window.restartExam()">Le patient n'avait pas bien compris...</button>
            <button class="btn-action btn-validate" style="background:#D32F2F; white-space:normal; height:auto; padding:10px; text-align:left;" onclick="window.prepareCycloStop()">Le patient avait bien compris...</button>
        </div>
        <div id="saveCycloContainer" class="hidden" style="margin-top:20px;"><button class="btn-action btn-validate" style="padding:15px 30px;" onclick="window.savePatientData()">Sauvegarder les donn√©es</button></div>
    </div>
</div>

<div id="modalTqsLimit" class="modal-overlay hidden">
    <div class="modal-content" style="max-width:700px;">
        <h2 style="color:#D32F2F; border:none; font-size:1.6rem;">‚ö†Ô∏è Votre attention, s'il vous pla√Æt !</h2>
        <div class="modal-text" style="text-align:left; font-size:1rem;">
            <strong>Vous venez de brouiller de plus de 1.00 D sur la ligne de 6/10.</strong><br><br>
            Vous avez effectu√© plusieurs √©tapes de brouillage sans pouvoir bloquer l'accommodation du patient.<br><br>
            Rappel : R√©p√©tez vos directives au patient. Il est possible qu'il n'ai pas relu les lettres mais qu'il vous les a r√©p√©t√© de m√©moire. V√©rifiez √©galement sa position, il regarde peut-√™tre en dehors des oculaires.<br><br>
            Nous vous recommandons de recommencer l'examen selon l'une des options suivantes :
        </div>
        <div id="tqsButtons" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button class="btn-action btn-grey" style="white-space:normal; height:auto; padding:10px; text-align:left;" onclick="window.restartExam()">Le patient n'avait pas bien compris...</button>
            <button class="btn-action btn-validate" style="background:#D32F2F; white-space:normal; height:auto; padding:10px; text-align:left;" onclick="window.prepareCycloStopTqs()">Le patient avait bien compris...</button>
        </div>
        <div id="saveCycloContainerTqs" class="hidden" style="margin-top:20px;"><button class="btn-action btn-validate" style="padding:15px 30px;" onclick="window.savePatientData()">Sauvegarder les donn√©es</button></div>
    </div>
</div>

<div id="modalIncoherent" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary-deep); border:none; font-size:1.6rem;">R√©ponse Incoh√©rente</h2>
        <div class="modal-text">Le patient vient de vous donner une r√©ponse incoh√©rente. Il faut refaire cette partie de l'examen.</div>
        <button class="btn-action btn-validate" style="width:auto; padding:15px 40px; border-radius:50px;" onclick="window.restartSb10()">RECOMMENCER CETTE PARTIE DE L'EXAMEN</button>
    </div>
</div>

<div class="app-container">
  <header>
      <h1>Assistant R√©fraction</h1>
  </header>

  <div class="top-banner">
        <div id="patientSummaryContent" style="flex:1;">
            <span style="color:#B0BEC5; font-style:italic;">En attente d'identification...</span>
        </div>
        <div style="display:flex; align-items:center; gap:15px;">
            <div style="text-align:right; line-height:1.1;">
                <div id="displayDate" style="font-size:0.7rem; color:var(--text-muted); text-transform:capitalize;">--</div>
                <div id="displayTime" style="font-size:0.85rem; font-weight:bold; color:var(--text-main);">--:--</div>
            </div>
            <div style="background:#ECEFF1; padding:4px 12px; border-radius:20px; display:flex; align-items:center; gap:6px; border:1px solid #CFD8DC;">
                <svg style="width:16px; height:16px; color:var(--primary-deep);" fill="currentColor" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                <div id="displayChrono" style="font-size:1.1rem; font-weight:bold; font-family:monospace; color:var(--primary-deep);">00:00</div>
            </div>
        </div>
    </div>
<div class="right-panel">

        <div class="exam-header-wrapper">
            <div class="header-left-control">
                <div class="phase-badge">PHASE : <span id="dispPhase">INIT</span></div>
                <div class="control-buttons-row" style="display:flex; justify-content:center; gap:10px;">
                    <button id="btnPilotOD" class="btn-pilot" onclick="window.setEye('OD')">OD</button>
                    <div id="dispMode" class="btn-mode-display">MONOCULAIRE</div>
                    <button id="btnPilotOG" class="btn-pilot" onclick="window.setEye('OG')">OG</button>
                </div>
            </div>

            <div class="header-right-visual">
                <div id="visBoxOD" class="va-box-display" data-eye="OD">--</div>
                <div id="visBoxOG" class="va-box-display" data-eye="OG">--</div>
            </div>
        </div>

        <div class="work-split">
            
            <div class="side-data">
                <div id="examDataStrip" class="exam-data-strip hidden" style="display:flex; gap:5px;">
                     <div id="dataSection" style="display:none;"></div> 

                     <div class="data-col col-passive">
                         <div class="col-title title-ra">AR OD</div>
                         <div class="data-line"><span class="lbl">S</span><input type="text" id="raOD_sph" class="val-input" readonly></div>
                         <div class="data-line"><span class="lbl">C</span><input type="text" id="raOD_cyl" class="val-input" readonly></div>
                         <div class="data-line"><span class="lbl">A</span><input type="text" id="raOD_axe" class="val-input" readonly></div>
                     </div>

                     <div class="data-col col-passive">
                         <div class="col-title">LUN. OD</div>
                         <div class="data-line"><span class="lbl">S</span><input type="text" id="frontoOD_sph" class="val-input" readonly></div>
                         <div class="data-line"><span class="lbl">C</span><input type="text" id="frontoOD_cyl" class="val-input" readonly></div>
                         <div class="data-line"><span class="lbl">A</span><input type="text" id="frontoOD_axe" class="val-input" readonly></div>
                     </div>

                     <div id="subjDispOD" class="data-col col-active">
                         <div class="col-title title-subj">OD (Exam)</div>
                         <div class="data-line"><span class="lbl">S</span><span id="disp_subjOD_sph" class="val-input val-big">--</span></div>
                         <div class="data-line"><span class="lbl">C</span><span id="disp_subjOD_cyl" class="val-input val-big">--</span></div>
                         <div class="data-line"><span class="lbl">A</span><span id="disp_subjOD_axe" class="val-input val-big">--</span></div>
                         <div style="margin-top:5px; border-top:1px solid #eee; padding-top:2px;">
                            <span class="lbl" style="color:var(--primary);">VA</span> 
                            <span id="disp_subjOD_va" style="font-weight:bold; color:var(--primary);">--</span>
                         </div>
                     </div>

                     <div id="subjDispOG" class="data-col col-active">
                         <div class="col-title title-subj">OG (Exam)</div>
                         <div class="data-line"><span class="lbl">S</span><span id="disp_subjOG_sph" class="val-input val-big">--</span></div>
                         <div class="data-line"><span class="lbl">C</span><span id="disp_subjOG_cyl" class="val-input val-big">--</span></div>
                         <div class="data-line"><span class="lbl">A</span><span id="disp_subjOG_axe" class="val-input val-big">--</span></div>
                         <div style="margin-top:5px; border-top:1px solid #eee; padding-top:2px;">
                            <span class="lbl" style="color:var(--primary);">VA</span> 
                            <span id="disp_subjOG_va" style="font-weight:bold; color:var(--primary);">--</span>
                         </div>
                     </div>

                     <div class="data-col col-passive">
                         <div class="col-title">LUN. OG</div>
                         <div class="data-line"><span class="lbl">S</span><input type="text" id="frontoOG_sph" class="val-input" readonly></div>
                         <div class="data-line"><span class="lbl">C</span><input type="text" id="frontoOG_cyl" class="val-input" readonly></div>
                         <div class="data-line"><span class="lbl">A</span><input type="text" id="frontoOG_axe" class="val-input" readonly></div>
                     </div>

                     <div class="data-col col-passive">
                         <div class="col-title title-ra">AR OG</div>
                         <div class="data-line"><span class="lbl">S</span><input type="text" id="raOG_sph" class="val-input" readonly></div>
                         <div class="data-line"><span class="lbl">C</span><input type="text" id="raOG_cyl" class="val-input" readonly></div>
                         <div class="data-line"><span class="lbl">A</span><input type="text" id="raOG_axe" class="val-input" readonly></div>
                     </div>
                </div>
            </div>

            <div class="side-letters">
                
                <div id="waitingMsg" style="text-align:center; color:#B0BEC5;">
                    <p style="font-size:1.5rem;">L'examen commencera ici.</p>
                </div>

                <div id="schoberStep" class="hidden" style="width:100%;">
    <div class="step-instruction">
        <strong>Que voit le patient au test de Schober ?</strong><br>
        <span style="font-size:0.9rem; color:#546E7A;">Cliquez sur l'image correspondant pour d√©terminer le protocole.</span>
    </div>

    <div class="schober-container">
        <div class="schober-group-title">Vision Binoculaire Possible</div>

        <div class="schober-row">
            <div class="schober-sub-group">
                <div class="schober-sub-title">Vision Simultan√©e</div>
                <div class="schober-grid">
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(1, 'bino', 'AUTO')">
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross" />
                            <line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross" />
                            <circle cx="50" cy="50" r="35" class="sch-circle" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="schober-sub-group">
                <div class="schober-sub-title">Neutralisation Intermittente</div>
                <div class="schober-grid">
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(2, 'bino', 'OD')">
                         <div style="position:absolute; top:2px; left:2px; color:#fff; font-size:0.6rem;">OD+</div>
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross" />
                            <line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross" />
                            <circle cx="50" cy="50" r="35" class="sch-circle sch-faint" />
                        </svg>
                    </button>
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(3, 'bino', 'OG')">
                        <div style="position:absolute; top:2px; left:2px; color:#fff; font-size:0.6rem;">OG+</div>
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross sch-faint" />
                            <line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross sch-faint" />
                            <circle cx="50" cy="50" r="35" class="sch-circle" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="schober-container" style="border-color:#FFCDD2; background:#FFEBEE;">
        <div class="schober-group-title" style="color:#D32F2F; border-color:#FFCDD2;">Pas de Vision Binoculaire</div>

        <div class="schober-row">
            <div class="schober-sub-group">
                <div class="schober-sub-title">Alternance Facile</div>
                <div class="schober-grid">
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(4, 'mono', 'OD')">
                         <div style="position:absolute; top:2px; left:2px; color:#fff; font-size:0.6rem;">D√âPART OD</div>
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <path d="M20 20 L40 20 L30 10 Z" fill="#fff"/>
                            <line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross" />
                            <line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross" />
                        </svg>
                    </button>
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(5, 'mono', 'OG')">
                         <div style="position:absolute; top:2px; left:2px; color:#fff; font-size:0.6rem;">D√âPART OG</div>
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <path d="M60 20 L80 20 L70 10 Z" fill="#fff"/>
                            <circle cx="50" cy="50" r="35" class="sch-circle" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="schober-sub-group">
                <div class="schober-sub-title">Alternance difficile ou Neutra.</div>
                <div class="schober-grid">
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(6, 'mono', 'OD')">
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross" />
                            <line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross" />
                        </svg>
                    </button>
                    <button class="btn-schober" onclick="window.confirmSchoberSelection(7, 'mono', 'OG')">
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="35" class="sch-circle" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="schober-sub-group">
                <div class="schober-sub-title">Monophtalme ou Amblyopie</div>
                <div class="schober-grid">
                      <button class="btn-schober" style="border-style:dashed;" onclick="window.confirmSchoberSelection(8, 'mono', 'OD')">
                         <div style="position:absolute; top:2px; left:2px; color:#fff; font-size:0.6rem;">MONO</div>
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <line x1="50" y1="32.5" x2="50" y2="67.5" class="sch-cross" />
                            <line x1="32.5" y1="50" x2="67.5" y2="50" class="sch-cross" />
                        </svg>
                    </button>
                    <button class="btn-schober" style="border-style:dashed;" onclick="window.confirmSchoberSelection(9, 'mono', 'OG')">
                        <div style="position:absolute; top:2px; left:2px; color:#fff; font-size:0.6rem;">MONO</div>
                        <svg width="70" height="70" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="35" class="sch-circle" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

                <div id="examContent" class="hidden" style="width:100%; display:flex; flex-direction:column; align-items:center;">
                    <div id="letterBox" class="letter-display">...</div>
                    <div id="systemMsg" class="message-box">En attente...</div>

                    <div id="axisZone" class="response-area hidden">
                        <div id="jccVisuals" class="jcc-container hidden">
                            <div id="visPos1" class="jcc-visual"><span class="jcc-label">1</span><svg class="arrow-svg" viewBox="0 0 100 100"><path d="M50 10 A40 40 0 0 1 90 50" fill="none" stroke="#116dff" stroke-width="6" marker-end="url(#arrowhead)" /></svg></div>
                            <div id="visPos2" class="jcc-visual"><span class="jcc-label">2</span><svg class="arrow-svg" viewBox="0 0 100 100"><path d="M50 10 A40 40 0 0 0 10 50" fill="none" stroke="#fd7e14" stroke-width="6" marker-end="url(#arrowhead2)" /></svg></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="bottom-interaction-zone">
            
            <div id="standardButtons" class="response-area hidden">
                <p style="margin-bottom:10px; font-weight:600; color:var(--text-muted); margin-top:0;">Combien de lettres lues ?</p>
                <div id="btnContainer" class="btn-grid"></div>
            </div>

            <div id="cadenceButtons" class="response-area hidden">
                <p style="margin-bottom:10px; font-weight:600;">Vitesse de lecture ?</p>
                <div style="display:flex; justify-content:center; gap:15px;">
                    <button class="btn-action btn-tortue" onclick="window.handleCadence('turtle')">üê¢ H√©sitant</button>
                    <button class="btn-action btn-lapin" onclick="window.handleCadence('rabbit')">üêá Fluide</button>
                </div>
            </div>

            <div id="checkPlusZone" class="response-area hidden">
                <div id="stepPlusWrapper">
                    <button id="btnPlus025" class="btn-timer hidden" onclick="window.triggerFogCheck()">TESTER +0.25 (3s)</button>
                    <div id="decisionsPlus" class="decision-row hidden">
                        <button class="btn-decision btn-blue" onclick="window.decidePlus('better')">Mieux avec le verre</button>
                        <button class="btn-decision btn-blue" onclick="window.decidePlus('same')">Pareil</button>
                        <button class="btn-decision btn-orange" onclick="window.decidePlus('worse')">Mieux sans le verre</button>
                        <div class="spacer-btn"></div>
                        <button class="btn-decision btn-grey" onclick="window.relaunchPlus()">Relancer</button>
                    </div>
                </div>
                <div id="stepMinusWrapper" class="hidden">
                    <button id="btnMinus025" class="btn-timer hidden" onclick="window.triggerDefogCheck()">TESTER -0.25 (1.5s)</button>
                    <div id="decisionsMinus" class="decision-row hidden">
                        <button class="btn-decision btn-red" onclick="window.decideMinus('better')">Mieux avec le verre</button>
                        <button class="btn-decision btn-orange" onclick="window.decideMinus('same')">Pareil</button>
                        <button class="btn-decision btn-orange" onclick="window.decideMinus('worse')">Mieux sans le verre</button>
                        <div class="spacer-btn"></div>
                        <button class="btn-decision btn-grey" onclick="window.relaunchFullCheck()">Relancer</button>
                    </div>
                </div>
            </div>

            <div id="axisControls" class="response-area hidden">
                <button id="btnReplayAxis" class="btn-timer hidden" onclick="window.runJccSequence()">R√âP√âTER LA COMPARAISON</button>
                <div id="axisDecisions" class="decision-row hidden">
                    <button class="btn-decision btn-blue" onclick="window.handleJccChoice('pos1')">Mieux 1</button>
                    <button class="btn-decision btn-orange" onclick="window.handleJccChoice('pos2')">Mieux 2</button>
                    <button class="btn-decision btn-green" onclick="window.handleJccChoice('same')">Pareil</button>
                </div>
            </div>

        </div>
</div>
  <svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
    <defs>
      <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#116dff" /></marker>
      <marker id="arrowhead2" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#fd7e14" /></marker>
    </defs>
  </svg>
</div>
  <script>
// =============================================================================
// 1. CONFIGURATION & DONN√âES
// =============================================================================

var ACUITY_TABLE = [
    { va: 0.04, lines: ["U", "P", "F", "V"] },
    { va: 0.05, lines: ["E", "Z", "N", "R"] },
    { va: 0.06, lines: ["H", "U", "D", "V"] },
    { va: 0.08, lines: ["N Z", "P U", "V H"] },
    { va: 0.10, lines: ["D U F", "P H N"] },
    { va: 0.12, lines: ["E N R", "R H P"] },
    { va: 0.16, lines: ["U P H", "V R F"] },
    { va: 0.20, lines: ["N Z", "P R H"] },
    { va: 0.25, lines: ["H D F", "U R Z"] },
    { va: 0.32, lines: ["D F U N R", "R U P E H"] },
    { va: 0.40, lines: ["Z V D F H", "U V N R Z"] },
    { va: 0.50, lines: ["U R N P E", "R U P E H"] },
    { va: 0.60, lines: ["V N R U F", "R H U E P"] },
    { va: 0.80, lines: ["F D U R N", "P R H U E"] },
    { va: 1.00, lines: ["H P Z E V", "H D E P N"] },
    { va: 1.25, lines: ["H E P U R", "E P N R U"] },
    { va: 1.60, lines: ["Z R N V U", "U R N P E"] },
    { va: 2.00, lines: ["V H F D Z", "R N U F D"] }
];

window.NEXT_PROMPTS = ["et ici ?", "lisez moi ces lettres l√†", "et celles-ci ?", "pouvez-vous lire ces lettres ci ?"];

var appState = {
    isRunning: false, activeEye: 'OD', firstEye: 'OD', profile: null, initProfile: null, 
    baseProfile: null, isSpeaking: false,
    subj: { OD: { sphere: 0, cyl: 0, axe: 0, va: "--" }, OG: { sphere: 0, cyl: 0, axe: 0, va: "--" } },
    memCyl: { OD: null, OG: null }, 
    vaIndex: 0, startVaIndex: 0, letterIndex: 0, pendingLetters: null, defoggedInZone: false,
    examPhase: "Sb0.2", patientInfo: { name: "", forename: "", dob: "", age: 0, uid: "" },
    sb02_OD_ok: false, sb02_OG_ok: false, seen025_OD: false, seen025_OG: false,
    sb05_OD_ok: false, sb05_OG_ok: false, sb10_OD_ok: false, sb10_OG_ok: false,
    tqs_attempted_06: false, count06_validations: 0, tqsFogCount: 0, checkStep: null, tempScore: 0, baseSphereValue: 0,
    sb10_line_defog: 0, safety_mode: false, safety_mem_letters: 0, hasRestartedSb10: false, 
    handednessEye: 'OD', pendingSchober: null, 
    saved_sb05: { OD: 0, OG: 0 }, saved_sb10: { OD: 0, OG: 0 },
    axisStep: 20, axisDirectionHistory: [], cylHigh: false, lastInvalidInputId: null 
};

// =============================================================================
// 2. FONCTIONS UTILITAIRES (D√âFINIES EN PREMIER)
// =============================================================================

window.generateShortUID = function() { return "TP" + Math.floor(Math.random()*10000); };
window.getVal = function(id) { var el=document.getElementById(id); return (el && el.value) ? parseFloat(el.value.replace(',','.')) || 0 : 0; };
window.setHTML = function(id, val) { var el=document.getElementById(id); if(el) el.innerHTML=val; };
window.getAgeFromDob = function(dob) { if(!dob) return 0; var d = new Date(dob); var n = new Date(); var a = n.getFullYear() - d.getFullYear(); if(n.getMonth() < d.getMonth() || (n.getMonth()===d.getMonth() && n.getDate() < d.getDate())) a--; return a; };
window.getAgeScore = function(a) { if(a<=10) return 6; if(a<=20) return 5; if(a<=30) return 4; if(a<=50) return 2; if(a<=70) return 1; return 0; };
window.getProfileColor = function(p) { if(p==='1') return '#26A69A'; if(p==='2') return '#42A5F5'; if(p==='3') return '#FFA726'; return '#EF5350'; };
window.startChrono = function() { }; 
window.initClock = function() { };

// V√©rifie si Myope (pour le bouton profil)
window.checkMyopia = function() {
    var s1 = window.getVal('raOD_sph'); var s2 = window.getVal('raOG_sph');
    var btn = document.getElementById('btnProfile1');
    if (btn) { if (s1 < 0 || s2 < 0) { btn.style.display = 'none'; } else { btn.style.display = 'inline-block'; } }
};

window.onRaChanged = function() { 
    window.checkMyopia();
    if (appState.baseProfile === "1") {
        var s1 = window.getVal('raOD_sph'); var s2 = window.getVal('raOG_sph');
        if (s1 < 0 || s2 < 0) { appState.initProfile = "2"; setHTML('displayProfileName', "2"); } 
        else { appState.initProfile = "1"; setHTML('displayProfileName', "1"); }
        var el = document.querySelector('.pat-profile-badge');
        if(el) { el.innerText = "PROFIL " + appState.initProfile; el.style.background = getProfileColor(appState.initProfile); }
    }
};

// Validation Inputs
window.validateNumberInput = function(el) { el.value = el.value.replace(/[^0-9.,-]/g, ''); };
window.closeWarningModal = function() {
    document.getElementById('modalWarning').classList.add('hidden');
    if(appState.lastInvalidInputId) {
        var el = document.getElementById(appState.lastInvalidInputId);
        if(el) { el.value = ""; el.focus(); }
        appState.lastInvalidInputId = null;
    }
};
window.checkSphere = function(el) {
    if(!el.value) return;
    var val = parseFloat(el.value.replace(',', '.'));
    if(isNaN(val)) return;
    if (val < -29.00 || val > 26.75) { appState.lastInvalidInputId = el.id; document.getElementById('modalWarning').classList.remove('hidden'); return; }
    val = Math.round(val * 4) / 4; el.value = val.toFixed(2);
};
window.forceNegativeCyl = function(el) {
    if(!el.value) return;
    var val = parseFloat(el.value.replace(',', '.'));
    if(isNaN(val)) return;
    if(val > 0) val = -val; 
    if (val < -10.00 || val > 0) { appState.lastInvalidInputId = el.id; document.getElementById('modalWarning').classList.remove('hidden'); return; }
    val = Math.round(val * 4) / 4; el.value = val.toFixed(2);
};
function normalizeAxis(val) { val = Math.round(val / 5) * 5; val = (val % 180 + 180) % 180; return val; }
window.checkAxis = function(el) {
    if(!el.value) return; var val = parseFloat(el.value); if(isNaN(val)) return;
    if (val < 0 || val > 180) { appState.lastInvalidInputId = el.id; document.getElementById('modalWarning').classList.remove('hidden'); return; }
    el.value = normalizeAxis(val);
};

// =============================================================================
// 3. WORKFLOW (C'est ici que √ßa bloquait)
// =============================================================================

// Etape 1
window.validatePatientID = function() {
    var dob = document.getElementById('inDob').value;
    if(!dob) { alert("La date de naissance est obligatoire."); return; }
    document.getElementById('modalPatientID').classList.add('hidden');
    document.getElementById('modalEntryMethod').classList.remove('hidden');
};

// Etape 2
window.handleMethodChoice = function(method) {
    document.getElementById('modalEntryMethod').classList.add('hidden');
    if (method === 'manual') window.openDataEntryModal(); else window.simulateImport();
};
window.openDataEntryModal = function() { document.getElementById('modalInputData').classList.remove('hidden'); };
window.simulateImport = function() {
    document.getElementById('mod_raOD_sph').value = "-1.50"; document.getElementById('mod_raOD_cyl').value = "-0.50"; document.getElementById('mod_raOD_axe').value = "180";
    document.getElementById('mod_raOG_sph').value = "-1.75"; document.getElementById('mod_raOG_cyl').value = "-0.25"; document.getElementById('mod_raOG_axe').value = "170";
    document.getElementById('modalInputData').classList.remove('hidden');
};

// Etape 3 : LE FIX EST ICI (TRY CATCH POUR VOIR L'ERREUR)
window.confirmDataAndPosition = function() {
    try {
        // 1. Fermeture modale
        document.getElementById('modalInputData').classList.add('hidden'); 

        // 2. Transfert
        var fields = ['raOD_sph','raOD_cyl','raOD_axe','raOG_sph','raOG_cyl','raOG_axe','frontoOD_sph','frontoOD_cyl','frontoOD_axe','frontoOG_sph','frontoOG_cyl','frontoOG_axe'];
        fields.forEach(function(f) {
            var mod = document.getElementById('mod_'+f);
            var dest = document.getElementById(f);
            // S√©curit√© : si dest n'existe pas, on log l'erreur mais on ne plante pas tout
            if(mod && dest) dest.value = mod.value || (f.includes('axe') ? "0" : "0.00");
        });

        // 3. Check Myopie (Safe Call)
        if(window.onRaChanged) window.onRaChanged();

        // 4. Update Header
        var nom = document.getElementById('inName').value || "-";
        var prenom = document.getElementById('inForename').value || "-";
        var dob = document.getElementById('inDob').value;
        var age = dob ? getAgeFromDob(dob) + " ans" : "-";
        var uid = document.getElementById('inUID').value || "--";

        var summaryHTML = `
            <div class="patient-line">
                <div><span class="pat-name">${nom.toUpperCase()}</span> <span class="pat-forename">${prenom}</span></div>
                <div style="color:#78909C;">${age}</div>
                <div><span class="pat-uid" title="UID">${uid}</span></div>
                <div id="badgeProfilePlace"></div> 
            </div>
        `;
        
        var summaryEl = document.getElementById('patientSummaryContent');
        if(summaryEl) summaryEl.innerHTML = summaryHTML;

        // 5. Affichage Suite
        var strip = document.getElementById('examDataStrip');
        if(strip) strip.classList.remove('hidden');
        
        var handModal = document.getElementById('modalHandedness');
        if(handModal) handModal.classList.remove('hidden');
        else alert("Erreur: Modale Lat√©ralit√© introuvable dans le HTML");

    } catch (e) {
        alert("ERREUR CRITIQUE validation : " + e.message);
        console.error(e);
    }
};

// Etape 4
window.setHandedness = function(handEye) {
    appState.handednessEye = handEye;
    document.getElementById('modalHandedness').classList.add('hidden');
    // On cache le message d'attente s'il existe
    var wait = document.getElementById('waitingMsg'); if(wait) wait.classList.add('hidden'); 
    document.getElementById('schoberStep').classList.remove('hidden');
};

// Etape 5
window.confirmSchoberSelection = function(id, mode, eye) {
    appState.pendingSchober = { mode: mode, eye: eye };
    document.getElementById('modalSchoberConfirm').classList.remove('hidden');
};
window.validateSchober = function() {
    document.getElementById('modalSchoberConfirm').classList.add('hidden');
    var p = appState.pendingSchober;
    if(p) window.handleSchoberChoice(p.mode, p.eye);
};
window.handleSchoberChoice = function(mode, eye) {
    if (eye === 'AUTO') { eye = appState.handednessEye || 'OD'; }
    appState.firstEye = eye; appState.isMonocularExam = (mode === 'mono');
    document.getElementById('schoberStep').classList.add('hidden');
    document.getElementById('modalProfileCalc').classList.remove('hidden');
};

// Etape 6
window.calculateProfileAndShowData = function() {
    var age = getAgeFromDob(document.getElementById('inDob').value);
    var score = getAgeScore(age);
    score += parseInt(document.getElementById('inRhythm').value);
    score += parseInt(document.getElementById('inSigns').value);
    if(document.getElementById('chkMyopia').checked) score += 1;
    if(document.getElementById('chkHyper').checked) score += 1;
    if(document.getElementById('chkNear').checked) score += 1;
    if(document.getElementById('chkNoSpecs').checked) score += 1;
    if(document.getElementById('chkMono').checked) score += 1;
    var p = (score <= 5) ? "1" : (score <= 8) ? "2" : (score <= 12) ? "3" : "3+";
    revealDataSection(p, false); 
};
window.forceProfileAndShowData = function(forcedProfile) {
    var finalProfile = forcedProfile;
    if (forcedProfile === '1') {
        var s1 = getVal('raOD_sph'); var s2 = getVal('raOG_sph');
        if (s1 < 0 || s2 < 0) { finalProfile = '2'; }
    }
    revealDataSection(finalProfile, false);
};
function revealDataSection(profile, inputsEnabled) {
    appState.initProfile = profile; 
    var pColor = getProfileColor(profile);
    var el = document.getElementById('badgeProfilePlace');
    if(el) { el.style.display = 'block'; el.innerHTML = `<span class="pat-profile-badge" style="background:${pColor}">PROFIL ${profile}</span>`; }
    document.getElementById('modalProfileCalc').classList.add('hidden');
    window.openPositioningModal();
}

// Etape 7
window.openPositioningModal = function() { document.getElementById('modalPosition').classList.remove('hidden'); };
window.startRulesAndIntro = function() {
    document.getElementById('modalPosition').classList.add('hidden');
    var raOD = { s: getVal('raOD_sph'), c: getVal('raOD_cyl'), a: getVal('raOD_axe') };
    var raOG = { s: getVal('raOG_sph'), c: getVal('raOG_cyl'), a: getVal('raOG_axe') };
    appState.subj.OD = { sphere: raOD.s, cyl: raOD.c, axe: raOD.a, va: "--" };
    appState.subj.OG = { sphere: raOG.s, cyl: raOG.c, axe: raOG.a, va: "--" };
    window.updateDisplay("Lecture des consignes...");
    var introText = "Pour avoir une bonne mesure de votre vision de loin, il faut lire d‚Äôune mani√®re naturelle.";
    say(introText, function() { document.getElementById('modalIntroConfirmation').classList.remove('hidden'); });
};
window.confirmAndLaunch = function() {
    document.getElementById('modalIntroConfirmation').classList.add('hidden');
    window.triggerFinalStart();
};
window.triggerFinalStart = function() { window.launchExamSequence(); };

// =============================================================================
// 4. AFFICHAGE (UPDATE DISPLAY)
// =============================================================================

window.updateDisplay = function(message) {
    setHTML('disp_subjOD_sph', appState.subj.OD.sphere.toFixed(2)); setHTML('disp_subjOD_cyl', appState.subj.OD.cyl.toFixed(2));
    setHTML('disp_subjOD_axe', appState.subj.OD.axe + "¬∞"); setHTML('disp_subjOD_va', appState.subj.OD.va);
    setHTML('disp_subjOG_sph', appState.subj.OG.sphere.toFixed(2)); setHTML('disp_subjOG_cyl', appState.subj.OG.cyl.toFixed(2));
    setHTML('disp_subjOG_axe', appState.subj.OG.axe + "¬∞"); setHTML('disp_subjOG_va', appState.subj.OG.va);

    var boxOD = document.getElementById('subjDispOD'); var boxOG = document.getElementById('subjDispOG');
    if(boxOD && boxOG) {
        if(appState.activeEye === 'OD') { boxOD.classList.add('col-active'); boxOG.classList.remove('col-active'); } 
        else { boxOD.classList.remove('col-active'); boxOG.classList.add('col-active'); }
    }

    setHTML('dispPhase', appState.examPhase ? appState.examPhase.toUpperCase() : "INIT");
    var modeText = "MONOCULAIRE";
    if (appState.examPhase === "Sb0.5" || (appState.examPhase && appState.examPhase.includes("Check")) || appState.examPhase === "Sb1.0") { modeText = "BIO-MONOCULAIRE"; }
    setHTML('dispMode', modeText);

    var btnPilotOD = document.getElementById('btnPilotOD'); var btnPilotOG = document.getElementById('btnPilotOG');
    if (btnPilotOD && btnPilotOG) {
        var isMono = (appState.examPhase === "Sb0.2");
        btnPilotOD.className = 'btn-pilot'; btnPilotOG.className = 'btn-pilot'; 
        if (appState.activeEye === 'OD') {
            btnPilotOD.classList.add('active'); 
            if (isMono) btnPilotOG.classList.add('closed'); else btnPilotOG.classList.add('open');
        } else {
            btnPilotOG.classList.add('active');
            if (isMono) btnPilotOD.classList.add('closed'); else btnPilotOD.classList.add('open');
        }
    }

    setHTML('visBoxOD', appState.subj.OD.va); setHTML('visBoxOG', appState.subj.OG.va);
    var visOD = document.getElementById('visBoxOD'); var visOG = document.getElementById('visBoxOG');
    if(visOD && visOG) {
        if (appState.activeEye === 'OD') { visOD.classList.add('active-eye'); visOG.classList.remove('active-eye'); } 
        else { visOD.classList.remove('active-eye'); visOG.classList.add('active-eye'); }
    }

    setHTML('valProfile', appState.profile); setHTML('systemMsg', message);
    var sysMsgEl = document.getElementById('systemMsg');
    if(sysMsgEl) {
        if (message.indexOf("VALID√âE") !== -1 || message.indexOf("Valid√©") !== -1) sysMsgEl.classList.add('success-msg'); 
        else sysMsgEl.classList.remove('success-msg');
    }

    if(window.ACUITY_TABLE && appState.vaIndex < ACUITY_TABLE.length) {
        var currentData = ACUITY_TABLE[appState.vaIndex]; 
        var linesArr = currentData.lines; 
        var txt = linesArr[appState.letterIndex % linesArr.length];
        setHTML('letterBox', txt);
        var count = txt.split(' ').length; 
        var btnHTML = "";
        for(var i=0; i<=count; i++) { btnHTML += '<button class="btn-resp" onclick="window.handleResponse('+i+')">'+i+'</button> '; }
        setHTML('btnContainer', btnHTML);

        var isSpecialMode = false;
        var cadBtns = document.getElementById('cadenceButtons');
        var chkPlus = document.getElementById('checkPlusZone');
        var axisCtr = document.getElementById('axisControls');
        if (cadBtns && !cadBtns.classList.contains('hidden')) isSpecialMode = true;
        if (chkPlus && !chkPlus.classList.contains('hidden')) isSpecialMode = true;
        if (axisCtr && !axisCtr.classList.contains('hidden')) isSpecialMode = true;
        var stdBtns = document.getElementById('standardButtons');
        if (stdBtns) {
            if (!isSpecialMode) stdBtns.classList.remove('hidden'); else stdBtns.classList.add('hidden');
        }
    }
};

window.setEye = function(eye) {
    appState.activeEye = eye;
    var currentMsg = document.getElementById('systemMsg') ? document.getElementById('systemMsg').innerText : "";
    window.updateDisplay(currentMsg);
};

// =============================================================================
// 5. MOTEUR EXAMEN (LOGIQUE)
// =============================================================================

window.launchExamSequence = function() {
    try {
        var raOD = { s: getVal('raOD_sph'), c: getVal('raOD_cyl'), a: getVal('raOD_axe') };
        var raOG = { s: getVal('raOG_sph'), c: getVal('raOG_cyl'), a: getVal('raOG_axe') };
        raOD.a = normalizeAxis(raOD.a); raOG.a = normalizeAxis(raOG.a);
        
        var p = appState.initProfile;
        if (p === '1' && (raOD.s < 0 || raOG.s < 0)) { p = '2'; }
        appState.profile = p;

        if (p === "3" || p === "3+") {
            var fogOD = (raOD.s < 0) ? 2.00 : 2.25; var fogOG = (raOG.s < 0) ? 2.00 : 2.25;
            appState.subj.OD = { sphere: raOD.s + fogOD, cyl: raOD.c, axe: raOD.a, va: "--" };
            appState.subj.OG = { sphere: raOG.s + fogOG, cyl: raOG.c, axe: raOG.a, va: "--" };
            appState.examPhase = "Sb0.2"; appState.targetVa = 0.06;
            if (appState.subj.OD.cyl === -0.25) { appState.memCyl.OD = { cyl: -0.25, axe: appState.subj.OD.axe }; appState.subj.OD.cyl = 0; appState.subj.OD.axe = 0; }
            if (appState.subj.OG.cyl === -0.25) { appState.memCyl.OG = { cyl: -0.25, axe: appState.subj.OG.axe }; appState.subj.OG.cyl = 0; appState.subj.OG.axe = 0; }
        } else if (p === "2") {
            var fogOD = (raOD.s < 0) ? 0.75 : 1.00; var fogOG = (raOG.s < 0) ? 0.75 : 1.00;
            appState.subj.OD = { sphere: raOD.s + fogOD, cyl: raOD.c, axe: raOD.a, va: "--" };
            appState.subj.OG = { sphere: raOG.s + fogOG, cyl: raOG.c, axe: raOG.a, va: "--" };
            appState.examPhase = "Sb0.5"; appState.targetVa = 0.32;
        } else {
            appState.subj.OD = { sphere: raOD.s, cyl: raOD.c, axe: raOD.a, va: "--" };
            appState.subj.OG = { sphere: raOG.s + 0.75, cyl: raOG.c, axe: raOG.a, va: "--" };
            appState.saved_sb05 = { OD: raOD.s + 0.75, OG: raOG.s + 0.75 };
            appState.examPhase = "Sb1.0"; appState.targetVa = 0.50;
        }

        appState.isRunning = true;
        appState.activeEye = appState.firstEye; 
        appState.defoggedInZone = false;
        setVaToIndexClosest(appState.targetVa); appState.startVaIndex = appState.vaIndex;

        appState.sb02_OD_ok=false; appState.sb02_OG_ok=false; appState.seen025_OD=false; appState.seen025_OG=false;
        appState.sb05_OD_ok=false; appState.sb05_OG_ok=false; appState.sb10_OD_ok=false; appState.sb10_OG_ok=false;

        if (appState.profile === "2") { appState.sb02_OD_ok = true; appState.sb02_OG_ok = true; }
        else if (appState.profile === "1") { appState.sb02_OD_ok = true; appState.sb02_OG_ok = true; appState.sb05_OD_ok = true; appState.sb05_OG_ok = true; }

        document.getElementById('examContent').classList.remove('hidden');
        window.updateDisplay("Profil " + appState.profile + ". Phase " + appState.examPhase);
        say("C'est parti !");

    } catch(e) { alert("Erreur Lancement: " + e); }
};

window.handleResponse = function(lettersRead) {
    if (appState.isSpeaking) return;
    var wordsLow = ["Ok", "D'accord", "Bien"];
    var wordsHigh = ["Ok", "Bien", "Tr√®s bien", "Parfait"];
    var feedback = (lettersRead <= 3) ? wordsLow[Math.floor(Math.random() * wordsLow.length)] : wordsHigh[Math.floor(Math.random() * wordsHigh.length)];

    if (appState.examPhase === "Sb0.2" || appState.examPhase === "Sb0.5") {
        say(feedback, function() {
            var oldEye = appState.activeEye;
            var oldVa = appState.vaIndex;
            processLogic(lettersRead, 'rabbit');
            if (appState.activeEye !== oldEye) return;
            if (appState.vaIndex !== oldVa) say(window.getRandomPrompt());
        });
        return;
    }

    var currentTxt = ACUITY_TABLE[appState.vaIndex].lines[0];
    var totalLetters = currentTxt.split(' ').length;
    if (totalLetters < 5 || lettersRead < 3) { 
        processLogic(lettersRead, 'rabbit');
        if (!appState.isSpeaking) say(feedback);
    } else { 
        say(feedback);
        askCadence(lettersRead); 
    }
};

window.handleCadence = function(type) {
    if (appState.isSpeaking) return;
    var phaseBefore = appState.examPhase;
    var n = appState.pendingLetters; appState.pendingLetters = null;
    document.getElementById('standardButtons').classList.remove('hidden'); 
    document.getElementById('cadenceButtons').classList.add('hidden');
    processLogic(n, type);
    if (phaseBefore === "Sb1.0" && appState.examPhase === "Sb1.0") say(window.getRandomPrompt());
};

function processLogic(lettersRead, cadence) {
    var currentVA = ACUITY_TABLE[appState.vaIndex].va;
    var currentTxt = ACUITY_TABLE[appState.vaIndex].lines[0];
    var totalLetters = currentTxt.split(' ').length; var isSmallLine = totalLetters < 5;
    var isPassed = false;

    // SB0.2
    if (appState.examPhase === "Sb0.2") {
        if (cadence === 'rabbit') {
            if (isSmallLine) { if (lettersRead === totalLetters) isPassed = true; } 
            else { if (lettersRead >= 3) isPassed = true; }
        } else if (cadence === 'turtle') {
            if (!isSmallLine && lettersRead >= 4) isPassed = true;
        }

        if (isPassed) {
            appState.subj[appState.activeEye].va = currentVA;
            if (currentVA === 0.25) {
                if (appState.activeEye === 'OD') appState.seen025_OD = true; else appState.seen025_OG = true;
                validateSb02(); return;
            }
            if (goNextLine()) updateDisplay("Valid√© -> Suivant"); else updateDisplay("Max Atteint");
            return;
        } else {
             if (currentVA === 0.25) {
                 updateDisplay("Palier 0.25 non franchi -> Sb0.2 valid√©e");
                 setTimeout(function() { validateSb02(); }, 1000); return;
             }
             var currentSph = getTargetEye().sphere;
             var raSph = (appState.activeEye === 'OD') ? getVal('raOD_sph') : getVal('raOG_sph');
             if (currentSph - 0.25 < raSph) { document.getElementById('modalDefogLimit').classList.remove('hidden'); return; }
             if (currentVA >= 0.06 && currentVA <= 0.20) appState.defoggedInZone = true;
             
             getTargetEye().sphere -= 0.25;
             if (lettersRead >= 3 || (isSmallLine && lettersRead > 0)) nextLetters(); 
             updateDisplay("Non vu -> Sph -0.25");
             return;
        }
    }

    // SB0.5
    if (appState.examPhase === "Sb0.5") {
        if (lettersRead >= 3) isPassed = true; else isPassed = false;

        if (currentVA === 0.32 || currentVA === 0.40) {
            if (isPassed) {
                appState.subj[appState.activeEye].va = currentVA;
                if (currentVA === 0.40) {
                    if (appState.tqs_attempted_06) { setVaToIndexClosest(0.50); updateDisplay("0.4 Valid√© -> 0.5"); } 
                    else { setVaToIndexClosest(0.60); updateDisplay("Saut √† 0.6 (Pi√®ge)"); appState.tqs_attempted_06 = true; }
                } else {
                    goNextLine(); updateDisplay("0.3 Valid√© -> 0.4");
                }
            } else {
                getTargetEye().sphere -= 0.25; nextLetters(); updateDisplay("Echec -> -0.25");
            }
            return;
        }
        if (currentVA === 0.60) {
            if (!isPassed) {
                if (appState.tqsFogCount > 0) setVaToIndexClosest(0.40); else setVaToIndexClosest(0.50);
                updateDisplay("Pi√®ge fonctionnel -> Descente");
            } else {
                appState.subj[appState.activeEye].va = currentVA;
                if (appState.tqsFogCount >= 2) { document.getElementById('modalTqsLimit').classList.remove('hidden'); return; }
                getTargetEye().sphere += 0.50; nextLetters(); appState.tqsFogCount++;
                updateDisplay("Pi√®ge √©chou√© -> Brouille +0.50");
            }
            return;
        }
        if (currentVA === 0.50) {
            if (isPassed) { appState.subj[appState.activeEye].va = currentVA; validateSb05(); } 
            else { getTargetEye().sphere -= 0.25; nextLetters(); updateDisplay("Echec 0.5 -> -0.25"); }
            return;
        }
    }

    // STANDARD
    if (cadence === 'rabbit') {
        if (isSmallLine && lettersRead === totalLetters) isPassed = true;
        if (!isSmallLine && lettersRead > 3) isPassed = true;
    }

    // CHECK MINUS
    if (appState.examPhase === "SphereCheckMinus") {
        if (appState.checkStep === "TEST_125_PRE") {
            appState.tempScore = lettersRead; getTargetEye().sphere -= 0.25;
            appState.checkStep = "TEST_125_POST"; nextLetters(); updateDisplay("Ajout -0.25 -> Relire");
        } else if (appState.checkStep === "TEST_125_POST") {
            var gain = lettersRead - appState.tempScore;
            if(appState.safety_mode) {
                var gainSafety = lettersRead - appState.safety_mem_letters;
                if(gainSafety >= 2) {
                     if(isPassed) { appState.safety_mode=false; appState.sb10_line_defog=0; appState.examPhase="Sb1.0"; goNextLine(); updateDisplay("S√©curit√© Pass√©e"); }
                     else { finishSb10ForEye(); }
                } else {
                     getTargetEye().sphere += 0.25; updateDisplay("Revert Safety"); finishSb10ForEye();
                }
                return;
            }
            if (gain >= 3) { appState.examPhase="Sb1.0"; appState.checkStep=null; finishSb10ForEye(); }
            else { getTargetEye().sphere += 0.25; appState.examPhase="Sb1.0"; appState.checkStep=null; finishSb10ForEye(); }
        }
        return;
    }

    // SB1.0
    if (appState.examPhase === "Sb1.0") {
        var sph = getTargetEye().sphere;
        if(appState.safety_mode && sph >= 0) {
             if(lettersRead > appState.safety_mem_letters) {
                 if(isPassed) { appState.safety_mode=false; appState.sb10_line_defog=0; appState.subj[appState.activeEye].va=currentVA; goNextLine(); }
                 else { finishSb10ForEye(); }
             } else {
                 getTargetEye().sphere += 0.25; finishSb10ForEye();
             }
             return;
        }

        if (isPassed) {
            appState.subj[appState.activeEye].va = currentVA;
            if (currentVA < 1.0) { if (goNextLine()) updateDisplay("Suivant"); else updateDisplay("Max"); }
            else { initSphereCheckPlus(); } 
            return;
        } else {
            if (sph >= 0) {
                 if (appState.sb10_line_defog >= 2) {
                      appState.safety_mode = true; appState.safety_mem_letters = lettersRead;
                      initSphereCheckPlus(); return; 
                 }
                 appState.sb10_line_defog++;
            } else {
                 if (appState.sb10_line_defog >= 2) {
                      appState.safety_mode = true; appState.safety_mem_letters = lettersRead;
                      getTargetEye().sphere -= 0.25; initSphereCheckMinus(); return;
                 }
                 appState.sb10_line_defog++;
            }
            getTargetEye().sphere -= 0.25; nextLetters(); updateDisplay("Echec -> -0.25");
            return;
        }
    }
}

// UTILS EXAMEN
function getTargetEye() { return (appState.activeEye === 'OD') ? appState.subj.OD : appState.subj.OG; }
function changeSphereAndRetest(delta) { var target = getTargetEye(); target.sphere += delta; nextLetters(); }
function nextLetters() { appState.letterIndex++; }
function goNextLine() {
    if (appState.vaIndex < ACUITY_TABLE.length - 1) { appState.vaIndex++; appState.letterIndex = 0; return true; }
    return false;
}
function setVaToIndexClosest(target) { for(var i=0; i<ACUITY_TABLE.length; i++) { if(ACUITY_TABLE[i].va >= target) { appState.vaIndex = i; break; } } appState.letterIndex = 0; }
function askCadence(n) { appState.pendingLetters = n; document.getElementById('standardButtons').classList.add('hidden'); document.getElementById('cadenceButtons').classList.remove('hidden'); updateDisplay("> 3 lettres. Cadence ?"); }

function validateSb02() {
    var eye = appState.activeEye;
    if (eye === 'OD') appState.sb02_OD_ok = true; else appState.sb02_OG_ok = true;
    say("On va de l'autre c√¥t√©.", function() {
        if (appState.sb02_OD_ok && appState.sb02_OG_ok) initSb05();
        else {
            appState.activeEye = (eye === 'OD') ? 'OG' : 'OD';
            appState.defoggedInZone = false; appState.vaIndex = appState.startVaIndex;
            appState.letterIndex = 0; updateDisplay("Recherche Sb0.2 (" + appState.activeEye + ")");
            say(window.getRandomPrompt());
        }
    });
}

function initSb05() {
    appState.examPhase = "Sb0.5"; 
    appState.activeEye = appState.firstEye; 
    appState.defoggedInZone = false; 
    appState.tqs_attempted_06 = false; 
    appState.count06_validations = 0; 
    appState.tqsFogCount = 0; 

    if(appState.profile === "2") setVaToIndexClosest(0.32);
    else {
        if (!appState.seen025_OD) { var sOD = appState.subj.OD.sphere; var dOD = (sOD < 0) ? -0.75 : -0.50; appState.subj.OD.sphere += dOD; }
        if (!appState.seen025_OG) { var sOG = appState.subj.OG.sphere; var dOG = (sOG < 0) ? -0.75 : -0.50; appState.subj.OG.sphere += dOG; }
        setVaToIndexClosest(0.32);
    }
    updateDisplay("D√©but Sb0.5");
    say(window.getRandomPrompt());
}

function validateSb05() {
    var eye = appState.activeEye;
    if (eye === 'OD') { appState.sb05_OD_ok = true; appState.saved_sb05.OD = appState.subj.OD.sphere; }
    else { appState.sb05_OG_ok = true; appState.saved_sb05.OG = appState.subj.OG.sphere; }

    say("On va de l'autre c√¥t√©.", function() {
        if (appState.sb05_OD_ok && appState.sb05_OG_ok) initSb10();
        else {
            appState.activeEye = (eye === 'OD') ? 'OG' : 'OD';
            appState.count06_validations = 0; appState.tqs_attempted_06 = false; appState.tqsFogCount = 0;
            setVaToIndexClosest(0.32);
            updateDisplay("Sb0.5 (" + appState.activeEye + ")");
            say(window.getRandomPrompt());
        }
    });
}

function initSb10() {
    appState.examPhase = "Sb1.0"; appState.activeEye = appState.firstEye; appState.defoggedInZone = false;
    var eye = appState.activeEye; var otherEye = (eye === 'OD') ? 'OG' : 'OD';
    appState.subj[otherEye].sphere = appState.saved_sb05[otherEye]; 
    setVaToIndexClosest(0.50);
    var sph = getTargetEye().sphere;
    if (sph < 0) getTargetEye().sphere -= 0.50;
    updateDisplay("D√©but Sb1.0");
    say(window.getRandomPrompt());
}

function finishSb10ForEye() {
    var eye = appState.activeEye;
    setHTML('disp_subj'+eye+'_va', ACUITY_TABLE[appState.vaIndex].va);
    if (eye === 'OD') appState.sb10_OD_ok = true; else appState.sb10_OG_ok = true;
    document.getElementById('checkPlusZone').classList.add('hidden');
    document.getElementById('standardButtons').classList.add('hidden');
    document.getElementById('cadenceButtons').classList.add('hidden');
    document.getElementById('axisZone').classList.remove('hidden');
    initAxisCheck();
}

function initSphereCheckPlus(skipIntro) {
    appState.examPhase = "SphereCheckPlus"; appState.baseSphereValue = getTargetEye().sphere;
    document.getElementById('standardButtons').classList.add('hidden');
    document.getElementById('cadenceButtons').classList.add('hidden');
    document.getElementById('checkPlusZone').classList.remove('hidden');
    document.getElementById('stepPlusWrapper').classList.remove('hidden');
    document.getElementById('decisionsPlus').classList.add('hidden');
    document.getElementById('stepMinusWrapper').classList.add('hidden');
    if(skipIntro) { nextLetters(); window.triggerFogCheck(); }
    else { setTimeout(function() { say("C'est pas mal, mais on va voir si on peut faire un peu mieux", function() { nextLetters(); window.triggerFogCheck(); }); }, 500); }
}

function initSphereCheckMinus() {
    appState.examPhase = "SphereCheckMinus"; appState.checkStep = "TEST_125_PRE";
    if (appState.safety_mode) {
        nextLetters(); updateDisplay("S√©curit√© Myope Check");
        getTargetEye().sphere -= 0.25;
        say("Lisez-moi cette ligne maintenant.");
    } else {
        setVaToIndexClosest(1.25); updateDisplay("Check (-)");
    }
}

// ASYNC TIMING
const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

async function triggerFogCheck() {
    updateLockUI(true); document.getElementById('btnPlus025').disabled = true; 
    const target = getTargetEye(); target.sphere = appState.baseSphereValue; 
    updateDisplay("Check (+): Ref");
    say("Vous pr√©f√©rez comme √ßa ?"); await wait(2500);
    say("Ou si je fais √ßa ?"); await wait(400);
    target.sphere = appState.baseSphereValue + 0.25; updateDisplay("Check (+): +0.25");
    await wait(3000); 
    say("Ou si je reviens ?"); await wait(400);
    target.sphere = appState.baseSphereValue; updateDisplay("Check (+): Ref");
    updateLockUI(false); document.getElementById('decisionsPlus').classList.remove('hidden'); document.getElementById('btnPlus025').disabled = false;
}

async function triggerDefogCheck() {
    updateLockUI(true); document.getElementById('btnMinus025').disabled = true; 
    const target = getTargetEye(); target.sphere = appState.baseSphereValue; 
    updateDisplay("Check (-): Ref");
    say("Vous pr√©f√©rez comme √ßa ?"); await wait(2500);
    say("Ou si je fais √ßa ?"); await wait(400);
    target.sphere = appState.baseSphereValue - 0.25; updateDisplay("Check (-): -0.25");
    await wait(1500);
    say("Ou si je reviens ?"); await wait(400);
    target.sphere = appState.baseSphereValue; updateDisplay("Check (-): Ref");
    updateLockUI(false); document.getElementById('decisionsMinus').classList.remove('hidden'); document.getElementById('btnMinus025').disabled = false;
}

window.decidePlus = function(choice) {
    if (appState.isSpeaking) return;
    if (choice === 'better' || choice === 'same') {
        nextLetters();
        getTargetEye().sphere = appState.baseSphereValue + 0.25; 
        updateDisplay("Accept√© +0.25");
        setTimeout(function() { initSphereCheckPlus(); }, 500);
    } else {
        document.getElementById('stepPlusWrapper').classList.add('hidden'); 
        document.getElementById('decisionsPlus').classList.add('hidden');
        say("Attention, je vais dans l'autre sens.", function() { 
            document.getElementById('stepMinusWrapper').classList.remove('hidden');
            window.triggerDefogCheck(); 
        });
    }
}

window.decideMinus = function(choice) {
    if (appState.isSpeaking) return;
    nextLetters();
    if (choice === 'better') {
        getTargetEye().sphere = appState.baseSphereValue - 0.25;
        alert("On enl√®ve 0.25 et on recommence.");
        initSphereCheckPlus();
    } else {
        document.getElementById('checkPlusZone').classList.add('hidden'); 
        document.getElementById('standardButtons').classList.remove('hidden');
        alert("Valid√© !"); finishSb10ForEye();
    }
}

// AXE
window.initAxisCheck = function() {
    appState.examPhase = "AxisCheck"; var target = getTargetEye(); 
    var cyl = Math.abs(target.cyl); 
    appState.cylHigh = (cyl >= 4.50);
    appState.axisStep = (cyl < 2.50) ? 20 : 10;
    appState.axisDirectionHistory = [];
    document.getElementById('jccVisuals').classList.remove('hidden');
    updateDisplay("Axe: Init CXJ. Cyl=" + cyl.toFixed(2));
    say("Je vais maintenant vous montrer deux positions...", function() {
        setTimeout(function() { runJccSequence(); }, 1000);
    });
};

window.runJccSequence = function() {
    if (appState.isSpeaking) return;
    var p1 = document.getElementById('visPos1'); var p2 = document.getElementById('visPos2');
    document.getElementById('axisDecisions').classList.add('hidden');
    say("Position 1 ?", function() {
        p1.classList.add('active'); p2.classList.remove('active');
        setTimeout(function() {
            say("Position 2 ou pareil ?", function() {
                 p1.classList.remove('active'); p2.classList.add('active');
                 setTimeout(function() { p2.classList.remove('active'); document.getElementById('axisDecisions').classList.remove('hidden'); }, 500);
            });
        }, 2000);
    });
};

window.handleJccChoice = function(choice) {
    if (appState.isSpeaking) return;
    if (choice === 'same') { alert("Axe valid√© !"); return; }
    var target = getTargetEye();
    var rot = (choice === 'pos1') ? -appState.axisStep : appState.axisStep;
    target.axe = normalizeAxis(target.axe + rot);
    updateDisplay("Nouvel Axe : " + target.axe + "¬∞"); 
    nextLetters(); 
    setTimeout(function() { runJccSequence(); }, 1000);
};

// --- D√âMARRAGE ET HELPERS VOIX ---
window.initVoices = function() { if('speechSynthesis' in window) window.speechSynthesis.getVoices(); };
function say(text, callback) {
    if(window.speechSynthesis.speaking) window.speechSynthesis.cancel();
    appState.isSpeaking = true; updateLockUI(true);
    var t = Array.isArray(text) ? text[Math.floor(Math.random()*text.length)] : text;
    var u = new SpeechSynthesisUtterance(t); u.lang='fr-FR'; u.rate=1.1;
    u.onend = function() { appState.isSpeaking=false; updateLockUI(false); if(callback) callback(); };
    window.speechSynthesis.speak(u);
}
function updateLockUI(locked) {
    var btns = document.querySelectorAll('.btn-resp, .btn-action');
    btns.forEach(function(b) { if(locked) b.classList.add('locked'); else b.classList.remove('locked'); });
}
window.getRandomPrompt = function() { return window.NEXT_PROMPTS[Math.floor(Math.random() * window.NEXT_PROMPTS.length)]; };

// --- FORCE STARTUP ---
try {
    window.initVoices();
    var uid = window.generateShortUID();
    var uidEl = document.getElementById('inUID');
    if(uidEl) uidEl.value = uid;
    var mod = document.getElementById('modalPatientID');
    if(mod) mod.classList.remove('hidden');
} catch(e) {
    alert("Erreur de d√©marrage JS : " + e.message);
}
</script>
  
</body>
</html>
